<!DOCTYPE html>
<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="鹤翔万里（TonyCrane）的笔记本" name="description"/>
<link href="https://note.tonycrane.cc/writeups/n1ctf2022/" rel="canonical"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-8.1.4" name="generator"/>
<title>N1CTF 2022 - 鹤翔万里的笔记本</title>
<link href="../../assets/stylesheets/main.bb3983ee.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.e6a45f82.min.css" rel="stylesheet"/>
<link href="../../css/svg_extra.css" rel="stylesheet"/>
<link href="../../css/heti.css" rel="stylesheet"/>
<link href="../../css/toc_extra.css" rel="stylesheet"/>
<link href="../../css/timeline.css" rel="stylesheet"/>
<link href="https://cdn.tonycrane.cc/utils/katex.min.css" rel="stylesheet"/>
<link href="https://cdn.tonycrane.cc/jbmono/jetbrainsmono.css" rel="stylesheet"/>
<link href="https://cdn.tonycrane.cc/lxgw/lxgwscreen.css" rel="stylesheet"/>
<link href="../../css/tasklist.css" rel="stylesheet"/>
<link href="../../css/custom.css" rel="stylesheet"/>
<link href="../../css/card.css" rel="stylesheet"/>
<link href="../../css/flink.css" rel="stylesheet"/>
<link href="../../css/changelog_extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c273de7f67d992cb6aef08c3ddf09bb2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DYETCPM289"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-DYETCPM289",{page_path:e.pathname})})})</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DYETCPM289"></script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<script src="../../js/scheme.js" type="text/javascript"></script>
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#n1ctf-2022-writeup">
            跳转至
          </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="鹤翔万里的笔记本" class="md-header__button md-logo" data-md-component="logo" href="../.." title="鹤翔万里的笔记本">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            鹤翔万里的笔记本
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              N1CTF 2022
            
          </span>
</div>
</div>
</div>
<div class="md-header__options">
<div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon">
<a class="light-mode" href="javascript:toggleScheme();" title="Light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"></path></svg>
</a>
<a class="dark-mode" href="javascript:toggleScheme();" title="Dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"></path></svg>
</a>
<a class="system-mode" href="javascript:toggleScheme();" title="System preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07 19.07 3.5m-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13.51 1.67m-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87.4 1.31M19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35-2.53-2.2m4.33-2.7 1.15-2.77 2.2 2.54-3.35.23m1.15-4.96-1.14-2.78 3.34.24-2.2 2.54M9.63 18.93l2.77 1.15-2.53 2.19-.24-3.34z"></path></svg>
</a>
<a class="unknown-mode" href="javascript:toggleScheme();" title="Unknown scheme">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m15.07 11.25-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41a2 2 0 0 0-2-2 2 2 0 0 0-2 2H8a4 4 0 0 1 4-4 4 4 0 0 1 4 4 3.2 3.2 0 0 1-.93 2.25M13 19h-2v-2h2M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-5.53-4.5-10-10-10z"></path></svg>
</a>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/TonyCrane/note/" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    TonyCrane/note
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        Home
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../cs/">
        Computer Science
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../sec/">
        Security
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../web/">
        Web
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../ctf/">
        CTF
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../">
        Writeups
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../others/">
        Others
      </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="鹤翔万里的笔记本" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="鹤翔万里的笔记本">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2z"></path></svg>
</a>
    鹤翔万里的笔记本
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/TonyCrane/note/" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    TonyCrane/note
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" id="__nav_1" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../..">Home</a>
<label for="__nav_1">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Home" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
          Home
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../changelog/">
        更新记录
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../links/">
        友链
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/">Computer Science</a>
<label for="__nav_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Computer Science" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Computer Science
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" id="__nav_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/pl/">编程语言 &amp; ISA</a>
<label for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="编程语言 &amp; ISA" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
          编程语言 &amp; ISA
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_2" id="__nav_2_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2_2">
          C/C++
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="C/C++" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_2">
<span class="md-nav__icon md-icon"></span>
          C/C++
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/c_cpp/c/">
        C 语言杂项
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/c_cpp/oop/">
        C++ 面向对象
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_3" id="__nav_2_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/pl/python/">Python</a>
<label for="__nav_2_2_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Python" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_3">
<span class="md-nav__icon md-icon"></span>
          Python
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/python/basic/">
        Python 基础语法
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/python/numpy/">
        NumPy
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/python/pil/">
        PIL
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_4" id="__nav_2_2_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/pl/rust/">Rust</a>
<label for="__nav_2_2_4">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Rust" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_4">
<span class="md-nav__icon md-icon"></span>
          Rust
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/rust/basic/">
        Rust 基础语法
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/rust/misc/">
        Rust 杂项随记
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/haskell/">
        Haskell
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/chisel/">
        Chisel
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/asm/">
        x86 汇编语言
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_8" id="__nav_2_2_8" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/pl/riscv/">RISC-V ISA</a>
<label for="__nav_2_2_8">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="RISC-V ISA" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_8">
<span class="md-nav__icon md-icon"></span>
          RISC-V ISA
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/riscv/unprivileged/">
        RISC-V 非特权级 ISA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/riscv/privileged/">
        RISC-V 特权级 ISA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/riscv/paging/">
        RISC-V 页表相关
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_9" id="__nav_2_2_9" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/pl/ppl/">编程语言原理</a>
<label for="__nav_2_2_9">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="编程语言原理" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_9">
<span class="md-nav__icon md-icon"></span>
          编程语言原理
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/ppl/topic1/">
        Lambda 演算
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/ppl/topic2/">
        抽象语法树与归纳法
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/ppl/topic3/">
        静态语义与动态语义
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/ppl/topic4/">
        函数与递归
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/pl/ppl/topic5/">
        数据类型
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" id="__nav_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/system/">计算机系统</a>
<label for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="计算机系统" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
          计算机系统
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_2" id="__nav_2_3_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/system/cs1/">计算机系统 I</a>
<label for="__nav_2_3_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="计算机系统 I" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_3_2">
<span class="md-nav__icon md-icon"></span>
          计算机系统 I
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/topic1/">
        数据的表示
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/topic2/">
        数字逻辑电路基础
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/topic3/">
        组合逻辑电路设计
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/topic4/">
        时序逻辑电路设计
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/topic5/">
        指令集体系结构
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/topic6/">
        处理器
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_2_8" id="__nav_2_3_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3_2_8">
          系统 I 实验部分
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="系统 I 实验部分" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_2_3_2_8">
<span class="md-nav__icon md-icon"></span>
          系统 I 实验部分
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab1-1/">
        系统 I lab1-1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab1-2/">
        系统 I lab1-2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab2-1/">
        系统 I lab2-1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab2-2/">
        系统 I lab2-2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab3/">
        系统 I lab3
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab4-1/">
        系统 I lab4-1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab4-2/">
        系统 I lab4-2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab5-1/">
        系统 I lab5-1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs1/lab5-2/">
        系统 I lab5-2
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_3" id="__nav_2_3_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/system/cs2/">计算机系统 II</a>
<label for="__nav_2_3_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="计算机系统 II" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_3_3">
<span class="md-nav__icon md-icon"></span>
          计算机系统 II
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/topic1/">
        流水线 CPU
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/topic2/">
        操作系统简介
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/topic3/">
        操作系统结构及系统调用
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/topic4/">
        进程与线程
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/topic5/">
        CPU 调度
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/topic6/">
        进程同步
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_3_8" id="__nav_2_3_3_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3_3_8">
          系统 II 实验部分
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="系统 II 实验部分" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_2_3_3_8">
<span class="md-nav__icon md-icon"></span>
          系统 II 实验部分
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/lab1/">
        系统 II lab1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/lab2/">
        系统 II lab2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/lab3/">
        系统 II lab3
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/lab4/">
        系统 II lab4
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/lab5/">
        系统 II lab5
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/lab6/">
        系统 II lab6
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs2/lab7/">
        系统 II lab7
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_4" id="__nav_2_3_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/system/cs3/">计算机系统 III</a>
<label for="__nav_2_3_4">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="计算机系统 III" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_3_4">
<span class="md-nav__icon md-icon"></span>
          计算机系统 III
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs3/topic1/">
        系统量化研究方法
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_4_3" id="__nav_2_3_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3_4_3">
          系统 III 实验部分
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="系统 III 实验部分" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_2_3_4_3">
<span class="md-nav__icon md-icon"></span>
          系统 III 实验部分
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs3/lab1/">
        系统 III lab1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs3/lab2/">
        系统 III lab2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs3/lab3/">
        系统 III lab3
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs3/lab4/">
        系统 III lab4
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/cs3/lab5/">
        系统 III lab5
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/system/pa/">
        ICS PA 实验纪实
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4">
          算法相关
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="算法相关" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
          算法相关
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4_1" id="__nav_2_4_1" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/algorithm/ds/">数据结构基础</a>
<label for="__nav_2_4_1">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="数据结构基础" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_4_1">
<span class="md-nav__icon md-icon"></span>
          数据结构基础
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/algorithm/ds/topic1/">
        算法分析基础
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/algorithm/ds/summary1/">
        基础数据结构
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/algorithm/ds/summary2/">
        排序与哈希
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" id="__nav_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_5">
          人工智能相关
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="人工智能相关" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
          人工智能相关
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/ai/basic/">
        人工智能基础
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" id="__nav_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_6">
          高性能计算相关
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="高性能计算相关" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
          高性能计算相关
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6_1" id="__nav_2_6_1" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/hpc/hpc101/">HPC 101 超算小学期</a>
<label for="__nav_2_6_1">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="HPC 101 超算小学期" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_6_1">
<span class="md-nav__icon md-icon"></span>
          HPC 101 超算小学期
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/hpc/hpc101/vectorized/">
        向量化计算
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/hpc/hpc101/gpu/">
        GPU 编程
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/hpc/hpc101/openmp/">
        OpenMP 基础
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/hpc/hpc101/mpi/">
        MPI 基础
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/hpc/hpc101/ml/">
        机器学习基础
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7">
          理论计算机相关
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="理论计算机相关" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
          理论计算机相关
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7_1" id="__nav_2_7_1" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/tcs/toc/">计算理论</a>
<label for="__nav_2_7_1">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="计算理论" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_7_1">
<span class="md-nav__icon md-icon"></span>
          计算理论
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tcs/toc/topic1/">
        语言、自动机与正则表达式
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tcs/toc/topic2/">
        上下文无关语言
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tcs/toc/topic3/">
        图灵机理论基础
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tcs/toc/topic4/">
        判定问题
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" id="__nav_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_8">
          零散知识点
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="零散知识点" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
          零散知识点
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/regex/">
        正则表达式
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/unicode/">
        Unicode
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9" id="__nav_2_9" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/analysis/">源码剖析</a>
<label for="__nav_2_9">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="源码剖析" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_9">
<span class="md-nav__icon md-icon"></span>
          源码剖析
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/analysis/mkdocs/">
        mkdocs 源码剖析
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10" id="__nav_2_10" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../cs/tools/">工具相关</a>
<label for="__nav_2_10">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="工具相关" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_10">
<span class="md-nav__icon md-icon"></span>
          工具相关
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/toolbox/">
        工具收集
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10_3" id="__nav_2_10_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_10_3">
          命令行工具
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="命令行工具" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_10_3">
<span class="md-nav__icon md-icon"></span>
          命令行工具
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/git/">
        Git 命令备忘
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/shell/">
        Shell 命令备忘
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/docker/">
        Docker 相关备忘
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/gdb/">
        gdb 相关备忘
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10_4" id="__nav_2_10_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_10_4">
          CI 工具
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="CI 工具" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_10_4">
<span class="md-nav__icon md-icon"></span>
          CI 工具
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/action/">
        GitHub Action
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10_5" id="__nav_2_10_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_10_5">
          站点生成工具
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="站点生成工具" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_10_5">
<span class="md-nav__icon md-icon"></span>
          站点生成工具
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/mkdocs/">
        mkdocs 使用记录
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/hexo/">
        hexo 使用记录
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cs/tools/sphinx/">
        sphinx 使用记录
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../sec/">Security</a>
<label for="__nav_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Security" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Security
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" id="__nav_3_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../sec/crypto/">密码学</a>
</div>
<nav aria-label="密码学" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
          密码学
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" id="__nav_3_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../sec/softsec/">软件安全</a>
<label for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="软件安全" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
          软件安全
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../sec/softsec/lab1/">
        软件安全 lab1
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sec/softsec/lab2/">
        软件安全 lab2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sec/softsec/lab3/">
        软件安全 lab3
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sec/softsec/lab4/">
        软件安全 lab4
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sec/softsec/final/">
        软件安全 final lab
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4">
          漏洞复现
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="漏洞复现" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
          漏洞复现
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../sec/vulns/log4j/">
        log4j 漏洞复现
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../web/">Web</a>
<label for="__nav_4">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Web" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Web
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" id="__nav_4_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../web/protocol/">网络协议</a>
<label for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="网络协议" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
          网络协议
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../web/protocol/vmess/">
        VMess
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3">
          排版写作规范
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="排版写作规范" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
          排版写作规范
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../web/typesetting/clreq/">
        中文排版需求
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web/typesetting/tech/">
        中文技术文档风格指南
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web/svg/">
        SVG
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/">CTF</a>
<label for="__nav_5">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="CTF" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          CTF
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" id="__nav_5_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_2">
          misc
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="misc" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_2">
<span class="md-nav__icon md-icon"></span>
          misc
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2_1" id="__nav_5_2_1" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/misc/steg/">隐写术</a>
<label for="__nav_5_2_1">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="隐写术" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_1">
<span class="md-nav__icon md-icon"></span>
          隐写术
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/misc/steg/image/">
        图片隐写
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/misc/steg/audio/">
        音频隐写
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2_2" id="__nav_5_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/misc/escapes/">沙箱逃逸</a>
<label for="__nav_5_2_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="沙箱逃逸" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_2">
<span class="md-nav__icon md-icon"></span>
          沙箱逃逸
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/misc/escapes/pysandbox/">
        Python 沙箱逃逸
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2_3" id="__nav_5_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/misc/forensics/">取证</a>
<label for="__nav_5_2_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="取证" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_3">
<span class="md-nav__icon md-icon"></span>
          取证
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/misc/forensics/mem/">
        内存取证
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2_4" id="__nav_5_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_2_4">
          编码/密码类
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="编码/密码类" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_4">
<span class="md-nav__icon md-icon"></span>
          编码/密码类
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/misc/coding/">
        编码及古典密码
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/misc/qrcode/">
        QRCode
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/misc/esolang/">
        Esolang
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2_5" id="__nav_5_2_5" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/blockchain/">Blockchain</a>
<label for="__nav_5_2_5">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Blockchain" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_5">
<span class="md-nav__icon md-icon"></span>
          Blockchain
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2_5_2" id="__nav_5_2_5_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/blockchain/eth/">Ethereum</a>
<label for="__nav_5_2_5_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Ethereum" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_5_2_5_2">
<span class="md-nav__icon md-icon"></span>
          Ethereum
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/blockchain/eth/basic/">
        以太坊基础
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/blockchain/eth/evm/">
        以太坊虚拟机
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/blockchain/eth/solidity/">
        Solidity 语言
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/blockchain/eth/yul/">
        Yul 语言
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/blockchain/eth/vuln/">
        常见合约漏洞攻击手段
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/blockchain/eth/erc/">
        ERC 标准
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ctf/blockchain/eth/eip/">
        其余重要 EIPs
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2_5_3" id="__nav_5_2_5_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/blockchain/solana/">Solana</a>
</div>
<nav aria-label="Solana" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_5_2_5_3">
<span class="md-nav__icon md-icon"></span>
          Solana
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" id="__nav_5_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3">
          pwn
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="pwn" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_3">
<span class="md-nav__icon md-icon"></span>
          pwn
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3_1" id="__nav_5_3_1" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/pwn/stack/">栈漏洞利用</a>
</div>
<nav aria-label="栈漏洞利用" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_3_1">
<span class="md-nav__icon md-icon"></span>
          栈漏洞利用
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3_2" id="__nav_5_3_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../ctf/pwn/heap/">堆漏洞利用</a>
</div>
<nav aria-label="堆漏洞利用" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_3_2">
<span class="md-nav__icon md-icon"></span>
          堆漏洞利用
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" id="__nav_6" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../">Writeups</a>
<label for="__nav_6">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Writeups" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
          Writeups
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" id="__nav_6_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_2">
          Training
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Training" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_2">
<span class="md-nav__icon md-icon"></span>
          Training
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ethernaut/">
        Ethernaut
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../SecurityInnovation/">
        Security Innovation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sadservers/">
        SadServers
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../AAA/">
        🔒 AAA School Bus
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" id="__nav_6_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_3">
          2021
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="2021" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_3">
<span class="md-nav__icon md-icon"></span>
          2021
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../sysu_msc_puzzle/">
        SYSU MSC Puzzle 2021
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../hackergame2021/">
        USTC Hackergame 2021
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../d0g3/">
        第四届“安洵杯”
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../bytectf2021_final/">
        ByteCTF 2021 Final
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sctf2021/">
        SCTF 2021
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" id="__nav_6_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_4">
          2022
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="2022" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_4">
<span class="md-nav__icon md-icon"></span>
          2022
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../vnctf2022/">
        VNCTF 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tqlctf2022/">
        TQLCTF 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../susctf2022/">
        SUSCTF 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../d3ctf2022/">
        D3CTF 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../%2Actf2022/">
        *CTF 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mrctf2022/">
        MRCTF 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../qwb2022/">
        强网杯 2022 Quals
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tctf2022/">
        TCTF/0CTF 2022
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../hackergame2022/">
        USTC Hackergame 2022
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          N1CTF 2022
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        N1CTF 2022
      </a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
        目录
      </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#utility-payment-service">
    Utility Payment Service
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#simple-staking">
    Simple Staking
  </a>
<nav aria-label="Simple Staking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
    题目合约
  </a>
<nav aria-label="题目合约" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#initialize">
    Initialize
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#register">
    Register
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deposit">
    Deposit
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#withdraw">
    Withdraw
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
    题目交互部分
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
    做法
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#just-find-flag">
    just find flag
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../seccon2022/">
        SECCON 2022 Quals
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../rctf2022/">
        RCTF 2022
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" id="__nav_6_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_5">
          2023
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="2023" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_5">
<span class="md-nav__icon md-icon"></span>
          2023
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../seccon2022final/">
        SECCON 2022 Final
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../xctf2022final/">
        XCTF 2022 Final
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../midnight2023/">
        MidnightSun 2023 Quals
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../aliyunctf2023/">
        AliyunCTF 2023
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ciscn2023/">
        CISCN 2023 Quals
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../seccon2023/">
        SECCON 2023 Quals
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tpctf2023/">
        TPCTF 2023
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" id="__nav_7" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../others/">Others</a>
<label for="__nav_7">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Others" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
          Others
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../others/notes/">
        课程笔记
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_3" id="__nav_7_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../others/subs/">字幕制作系列</a>
<label for="__nav_7_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="字幕制作系列" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_7_3">
<span class="md-nav__icon md-icon"></span>
          字幕制作系列
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../others/subs/ass/">
        ass 标签
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../others/subs/aegisub/automation/">
        Aegisub 自动化
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../others/subs/aegisub/karaoke/">
        Aegisub 卡拉 OK 模板
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../others/subs/ffmpeg/">
        ffmpeg 套件杂记
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_4" id="__nav_7_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../others/troubleshooting/">TroubleShooting</a>
<label for="__nav_7_4">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="TroubleShooting" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_7_4">
<span class="md-nav__icon md-icon"></span>
          TroubleShooting
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../others/troubleshooting/mac/">
        macOS TroubleShooting
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
        目录
      </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#utility-payment-service">
    Utility Payment Service
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#simple-staking">
    Simple Staking
  </a>
<nav aria-label="Simple Staking" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
    题目合约
  </a>
<nav aria-label="题目合约" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#initialize">
    Initialize
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#register">
    Register
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deposit">
    Deposit
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#withdraw">
    Withdraw
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
    题目交互部分
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
    做法
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#just-find-flag">
    just find flag
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<script defer="" src="/js/toc.js"></script>
<link href="/css/fold_toc.css" rel="stylesheet"/>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/TonyCrane/note/tree/master/docs/writeups/n1ctf2022.md" title="编辑此页">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="n1ctf-2022-writeup">N1CTF 2022 Writeup<a class="headerlink" href="#n1ctf-2022-writeup" title="Permanent link">¶</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8V2m6.78 1a.69.69 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38-2.5-2.5z"></path></svg></span> 约<span class="heti-skip"><span class="heti-spacing"> </span>2683<span class="heti-spacing"> </span></span>个字 <span class="twemoji"><svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg></span> <span>838<span class="heti-spacing"> </span></span>行代码 <span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3L12.5 13z"></path></svg></span> 预计阅读时间<span class="heti-skip"><span class="heti-spacing"> </span>19<span class="heti-spacing"> </span></span>分钟</p>
</div>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<p>这次主要做了下<span><span class="heti-spacing"> </span>blockchain</span>，<span>misc<span class="heti-spacing"> </span></span>有个内存取证差一点做出来，也在这里记一下</p>
<p>听说这次的<span class="heti-skip"><span class="heti-spacing"> </span>blockchain<span class="heti-spacing"> </span></span>会设单项奖，应该很有质量。没想到是没接触过的<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>区块链，第一次玩，还挺有意思的，而且题给的做题框架也很全，还算很舒适</p>
<p>感觉<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>还是有很多需要了解的基础知识还是很多的，有时间以后系统学习的时候再记录吧</p>
</div>
<hr/>
<h2 id="utility-payment-service">Utility Payment Service<a class="headerlink" href="#utility-payment-service" title="Permanent link">¶</a></h2>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="https://img.shields.io/badge/-BLOCKCHAIN-orange?style=flat-square"><img alt="" src="https://img.shields.io/badge/-BLOCKCHAIN-orange?style=flat-square"/></a></p>
<p><span>solana<span class="heti-spacing"> </span></span>的合约看起来很长很复杂，附件也是完整的<span class="heti-skip"><span class="heti-spacing"> </span>cargo<span class="heti-spacing"> </span></span>工作区，所以这里不全列出来了。</p>
<details class="question">
<summary><span>processor<span class="heti-spacing"> </span></span>部分</summary>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">use</span><span class="w"> </span><span class="n">borsh</span>::<span class="p">{</span><span class="n">BorshDeserialize</span><span class="p">,</span><span class="w"> </span><span class="n">BorshSerialize</span><span class="p">};</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">use</span><span class="w"> </span><span class="n">solana_program</span>::<span class="p">{</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">account_info</span>::<span class="p">{</span><span class="n">next_account_info</span><span class="p">,</span><span class="w"> </span><span class="n">AccountInfo</span><span class="p">},</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">entrypoint</span>::<span class="n">ProgramResult</span><span class="p">,</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">msg</span><span class="p">,</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">program</span>::<span class="p">{</span><span class="n">invoke</span><span class="p">,</span><span class="w"> </span><span class="n">invoke_signed</span><span class="p">},</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">pubkey</span>::<span class="n">Pubkey</span><span class="p">,</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="n">system_instruction</span><span class="p">,</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">};</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="p">{</span><span class="n">Escrow</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceInstruction</span><span class="p">,</span><span class="w"> </span><span class="n">ESCROW_ACCOUNT_SIZE</span><span class="p">};</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_instruction</span><span class="p">(</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="n">program</span>: <span class="kp">&amp;</span><span class="nc">Pubkey</span><span class="p">,</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="n">accounts</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">AccountInfo</span><span class="p">],</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="k">mut</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ProgramResult</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">ServiceInstruction</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="n">ServiceInstruction</span>::<span class="n">Init</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">init_escrow</span><span class="p">(</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span><span class="p">),</span>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="n">ServiceInstruction</span>::<span class="n">DepositEscrow</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">deposit_escrow</span><span class="p">(</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span>
<a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">        </span><span class="n">ServiceInstruction</span>::<span class="n">WithdrawEscrow</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">withdraw_escrow</span><span class="p">(</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span><span class="p">),</span>
<a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">        </span><span class="n">ServiceInstruction</span>::<span class="n">Pay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">pay_utility_fees</span><span class="p">(</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span>
<a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">}</span>
<a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_escrow</span><span class="p">(</span><span class="n">program</span>: <span class="nc">Pubkey</span><span class="p">,</span><span class="w"> </span><span class="n">user</span>: <span class="nc">Pubkey</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="n">Pubkey</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">"ESCROW"</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">()],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program</span><span class="p">)</span>
<a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="p">}</span>
<a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_reserve</span><span class="p">(</span><span class="n">program</span>: <span class="nc">Pubkey</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="n">Pubkey</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">    </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">"RESERVE"</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program</span><span class="p">)</span>
<a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="p">}</span>
<a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">///</span>
<a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">/// init escrow</span>
<a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">///</span>
<a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="k">fn</span> <span class="nf">init_escrow</span><span class="p">(</span><span class="n">program</span>: <span class="kp">&amp;</span><span class="nc">Pubkey</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">AccountInfo</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">ProgramResult</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">account_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">accounts</span><span class="p">.</span><span class="n">iter</span><span class="p">();</span>
<a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sys_prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">is_signer</span><span class="p">);</span>
<a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data_is_empty</span><span class="p">());</span>
<a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">expected_escrow</span><span class="p">,</span><span class="w"> </span><span class="n">escrow_bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_escrow</span><span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a href="#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">    </span><span class="n">invoke_signed</span><span class="p">(</span>
<a href="#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">    </span><span class="o">&amp;</span><span class="n">system_instruction</span>::<span class="n">create_account</span><span class="p">(</span>
<a href="#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">expected_escrow</span><span class="p">,</span>
<a href="#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">        </span><span class="mi">1</span><span class="p">,</span>
<a href="#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">        </span><span class="n">ESCROW_ACCOUNT_SIZE</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<a href="#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">program</span><span class="p">,</span>
<a href="#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">    </span><span class="p">),</span>
<a href="#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="w">    </span><span class="o">&amp;</span><span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">escrow_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">sys_prog</span><span class="p">.</span><span class="n">clone</span><span class="p">()],</span>
<a href="#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">    </span><span class="o">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="p">[</span><span class="s">"ESCROW"</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">escrow_bump</span><span class="p">]]],</span>
<a href="#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a href="#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Escrow</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-64" id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="w">        </span><span class="n">user</span>: <span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-0-65" id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">        </span><span class="n">amount</span>: <span class="mi">0</span><span class="p">,</span>
<a href="#__codelineno-0-66" id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">        </span><span class="n">bump</span>: <span class="nc">escrow_bump</span><span class="p">,</span>
<a href="#__codelineno-0-67" id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-0-68" id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a href="#__codelineno-0-69" id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">    </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">()[</span><span class="o">..</span><span class="p">]).</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-0-70" id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a href="#__codelineno-0-71" id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-0-72" id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="p">}</span>
<a href="#__codelineno-0-73" id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a href="#__codelineno-0-74" id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">///</span>
<a href="#__codelineno-0-75" id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">/// deposit escrow</span>
<a href="#__codelineno-0-76" id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">///</span>
<a href="#__codelineno-0-77" id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="k">fn</span> <span class="nf">deposit_escrow</span><span class="p">(</span>
<a href="#__codelineno-0-78" id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="w">    </span><span class="n">program</span>: <span class="kp">&amp;</span><span class="nc">Pubkey</span><span class="p">,</span>
<a href="#__codelineno-0-79" id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">    </span><span class="n">accounts</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">AccountInfo</span><span class="p">],</span>
<a href="#__codelineno-0-80" id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="w">    </span><span class="n">deposit_amount</span>: <span class="kt">u16</span><span class="p">,</span>
<a href="#__codelineno-0-81" id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ProgramResult</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-82" id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">account_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">accounts</span><span class="p">.</span><span class="n">iter</span><span class="p">();</span>
<a href="#__codelineno-0-83" id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a href="#__codelineno-0-84" id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-85" id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-86" id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-87" id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sys_prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-88" id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a href="#__codelineno-0-89" id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">is_signer</span><span class="p">);</span>
<a href="#__codelineno-0-90" id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">expected_reserve</span><span class="p">,</span><span class="w"> </span><span class="n">_reserve_bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_reserve</span><span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">);</span>
<a href="#__codelineno-0-91" id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">expected_reserve</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-92" id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">expected_escrow</span><span class="p">,</span><span class="w"> </span><span class="n">_escrow_bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_escrow</span><span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-93" id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">expected_escrow</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-94" id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a href="#__codelineno-0-95" id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">    </span><span class="n">invoke</span><span class="p">(</span>
<a href="#__codelineno-0-96" id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">system_instruction</span>::<span class="n">transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">deposit_amount</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">),</span>
<a href="#__codelineno-0-97" id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span>
<a href="#__codelineno-0-98" id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="w">            </span><span class="n">user</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-0-99" id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">            </span><span class="n">reserve</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-0-100" id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="w">            </span><span class="n">sys_prog</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
<a href="#__codelineno-0-101" id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">        </span><span class="p">],</span>
<a href="#__codelineno-0-102" id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-103" id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a href="#__codelineno-0-104" id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Escrow</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">()[</span><span class="o">..</span><span class="p">])</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-105" id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="w">    </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">deposit_amount</span><span class="p">;</span>
<a href="#__codelineno-0-106" id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="w">    </span><span class="n">escrow_data</span>
<a href="#__codelineno-0-107" id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="w">        </span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">()[</span><span class="o">..</span><span class="p">])</span>
<a href="#__codelineno-0-108" id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-0-109" id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a href="#__codelineno-0-110" id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-0-111" id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="p">}</span>
<a href="#__codelineno-0-112" id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a href="#__codelineno-0-113" id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">///</span>
<a href="#__codelineno-0-114" id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">/// withdraw all balance in escrow</span>
<a href="#__codelineno-0-115" id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">///</span>
<a href="#__codelineno-0-116" id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="k">fn</span> <span class="nf">withdraw_escrow</span><span class="p">(</span><span class="n">program</span>: <span class="kp">&amp;</span><span class="nc">Pubkey</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">AccountInfo</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">ProgramResult</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-117" id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">account_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">accounts</span><span class="p">.</span><span class="n">iter</span><span class="p">();</span>
<a href="#__codelineno-0-118" id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a href="#__codelineno-0-119" id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-120" id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-121" id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-122" id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sys_prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-123" id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a href="#__codelineno-0-124" id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">is_signer</span><span class="p">);</span>
<a href="#__codelineno-0-125" id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">expected_reserve</span><span class="p">,</span><span class="w"> </span><span class="n">reserve_bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_reserve</span><span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">);</span>
<a href="#__codelineno-0-126" id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">expected_reserve</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-127" id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">expected_escrow</span><span class="p">,</span><span class="w"> </span><span class="n">_escrow_bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_escrow</span><span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-128" id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">expected_escrow</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-129" id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a href="#__codelineno-0-130" id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Escrow</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">()[</span><span class="o">..</span><span class="p">])</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-131" id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
<a href="#__codelineno-0-132" id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="w">    </span><span class="n">invoke_signed</span><span class="p">(</span>
<a href="#__codelineno-0-133" id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">system_instruction</span>::<span class="n">transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">),</span>
<a href="#__codelineno-0-134" id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">reserve</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">sys_prog</span><span class="p">.</span><span class="n">clone</span><span class="p">()],</span>
<a href="#__codelineno-0-135" id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="p">[</span><span class="s">"RESERVE"</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">reserve_bump</span><span class="p">]]],</span>
<a href="#__codelineno-0-136" id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-137" id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a href="#__codelineno-0-138" id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="w">    </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-0-139" id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="w">    </span><span class="n">escrow_data</span>
<a href="#__codelineno-0-140" id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">        </span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">()[</span><span class="o">..</span><span class="p">])</span>
<a href="#__codelineno-0-141" id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-0-142" id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a href="#__codelineno-0-143" id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-0-144" id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="p">}</span>
<a href="#__codelineno-0-145" id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a href="#__codelineno-0-146" id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">///</span>
<a href="#__codelineno-0-147" id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">/// pay utility</span>
<a href="#__codelineno-0-148" id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">///</span>
<a href="#__codelineno-0-149" id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="k">fn</span> <span class="nf">pay_utility_fees</span><span class="p">(</span><span class="n">program</span>: <span class="kp">&amp;</span><span class="nc">Pubkey</span><span class="p">,</span><span class="w"> </span><span class="n">accounts</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">AccountInfo</span><span class="p">],</span><span class="w"> </span><span class="n">amount</span>: <span class="kt">u16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ProgramResult</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-150" id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">account_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">accounts</span><span class="p">.</span><span class="n">iter</span><span class="p">();</span>
<a href="#__codelineno-0-151" id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a href="#__codelineno-0-152" id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-153" id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-154" id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-155" id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_sys_prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-156" id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a href="#__codelineno-0-157" id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">is_signer</span><span class="p">);</span>
<a href="#__codelineno-0-158" id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">expected_reserve</span><span class="p">,</span><span class="w"> </span><span class="n">_reserve_bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_reserve</span><span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">);</span>
<a href="#__codelineno-0-159" id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">expected_reserve</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-160" id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">expected_escrow</span><span class="p">,</span><span class="w"> </span><span class="n">_escrow_bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_escrow</span><span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-161" id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">expected_escrow</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a href="#__codelineno-0-162" id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a href="#__codelineno-0-163" id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Escrow</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">()[</span><span class="o">..</span><span class="p">])</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-0-164" id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a href="#__codelineno-0-165" id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">base_fee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15_</span><span class="k">u16</span><span class="p">;</span>
<a href="#__codelineno-0-166" id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-167" id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_fee</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-168" id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="w">            </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">base_fee</span><span class="p">;</span>
<a href="#__codelineno-0-169" id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-170" id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="w">            </span><span class="fm">assert!</span><span class="p">(</span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span>
<a href="#__codelineno-0-171" id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="w">            </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<a href="#__codelineno-0-172" id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-0-173" id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-174" id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="w">        </span><span class="n">msg</span><span class="o">!</span><span class="p">(</span><span class="s">"ABORT: Cannot make payments when the escrow account has a balance less than 10 lamports."</span><span class="p">);</span>
<a href="#__codelineno-0-175" id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-0-176" id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a href="#__codelineno-0-177" id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="w">    </span><span class="n">escrow_data</span>
<a href="#__codelineno-0-178" id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="w">        </span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="n">borrow_mut</span><span class="p">()[</span><span class="o">..</span><span class="p">])</span>
<a href="#__codelineno-0-179" id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-0-180" id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a href="#__codelineno-0-181" id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-0-182" id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="p">}</span>
</code></pre></div>
</details>
<p>可以看出主要有三个方法：</p>
<ul>
<li>Init：初始化并签名<span><span class="heti-spacing"> </span>escrow</span></li>
<li>DepositEscrow：存入<span class="heti-skip"><span class="heti-spacing"> </span>deposit_amount<span class="heti-spacing"> </span></span>金额<ul>
<li>将钱转入<span><span class="heti-spacing"> </span>reserve account</span>（只由<span class="heti-skip"><span class="heti-spacing"> </span>program seed<span class="heti-spacing"> </span></span>生成）</li>
<li>将用户对应<span><span class="heti-spacing"> </span>escrow account</span>（由<span class="heti-skip"><span class="heti-spacing"> </span>program<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>user.key<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>seed<span class="heti-spacing"> </span></span>合成生成）的<span class="heti-skip"><span class="heti-spacing"> </span>amount<span class="heti-spacing"> </span></span>增加<span><span class="heti-spacing"> </span>deposit_amout</span></li>
</ul>
</li>
<li>WithdrawEscrow：将<span class="heti-skip"><span class="heti-spacing"> </span>escrow<span class="heti-spacing"> </span></span>记录的所有金额都转回给用户<ul>
<li>从<span class="heti-skip"><span class="heti-spacing"> </span>reserve account<span class="heti-spacing"> </span></span>转出</li>
</ul>
</li>
<li>Pay：支付，也就是减少用户<span class="heti-skip"><span class="heti-spacing"> </span>escrow<span class="heti-spacing"> </span></span>的<span><span class="heti-spacing"> </span>amount</span>。还是看代码更清晰：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">base_fee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15_</span><span class="k">u16</span><span class="p">;</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">if</span><span class="w"> </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_fee</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">        </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">base_fee</span><span class="p">;</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">);</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">        </span><span class="n">escrow_data</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="n">msg</span><span class="o">!</span><span class="p">(</span><span class="s">"ABORT: Cannot make payments when the escrow account has a balance less than 10 lamports."</span><span class="p">);</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="p">}</span>
</code></pre></div></li>
</ul>
<p>这里存在一个较明显的隐患是<span><span class="heti-spacing"> </span>u16</span>，也就是<span class="heti-skip"><span class="heti-spacing"> </span>16<span class="heti-spacing"> </span></span>位无符号整型。再回头看<span class="heti-skip"><span class="heti-spacing"> </span>lib.rs<span class="heti-spacing"> </span></span>中规定的<span class="heti-skip"><span class="heti-spacing"> </span>Escrow account<span class="heti-spacing"> </span></span>结构体：
</p><div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cp">#[repr(C)]</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="cp">#[derive(BorshSerialize, BorshDeserialize)]</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Escrow</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">user</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">amount</span>: <span class="kt">u16</span><span class="p">,</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">bump</span>: <span class="kt">u8</span><span class="p">,</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="p">}</span>
</code></pre></div>
这里的 amount 也是 u16，存在整型溢出风险。
<p>接着看<span class="heti-skip"><span class="heti-spacing"> </span>main.rs<span class="heti-spacing"> </span></span>中的题目部分：</p>
<details class="question">
<summary>题目交互部分</summary>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">fn</span> <span class="nf">handle_connection</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span>: <span class="nc">TcpStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChallengeBuilder</span>::<span class="n">try_from</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">try_clone</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="c1">// load programs</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">solve_pubkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">input_program</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">program_pubkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">chall_programs</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">"./utility_payment.so"</span><span class="p">])[</span><span class="mi">0</span><span class="p">];</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="c1">// make user</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Keypair</span>::<span class="n">new</span><span class="p">();</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"program pubkey: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">program_pubkey</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"solve pubkey: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">solve_pubkey</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user pubkey: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="c1">// println!("program: {}", program_pubkey);</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="c1">// add accounts and lamports</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">reserve</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_reserve</span><span class="p">(</span><span class="n">program_pubkey</span><span class="p">);</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="c1">// let (escrow, _) =  get_escrow(program_pubkey, user.pubkey());</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">TARGET_AMT</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">60_000</span><span class="p">;</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INIT_BAL</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">RESERVE_BAL</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">1_000_000</span><span class="p">;</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="n">builder</span>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="p">.</span><span class="n">builder</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">        </span><span class="p">.</span><span class="n">add_account_with_lamports</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">(),</span><span class="w"> </span><span class="n">system_program</span>::<span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">INIT_BAL</span><span class="p">);</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">    </span><span class="n">builder</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">        </span><span class="p">.</span><span class="n">builder</span>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">        </span><span class="p">.</span><span class="n">add_account_with_lamports</span><span class="p">(</span><span class="n">reserve</span><span class="p">,</span><span class="w"> </span><span class="n">system_program</span>::<span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">RESERVE_BAL</span><span class="p">);</span>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">challenge</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">lamports</span><span class="p">;</span>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user lamport before: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">    </span><span class="c1">// run solve</span>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">    </span><span class="n">challenge</span><span class="p">.</span><span class="n">input_instruction</span><span class="p">(</span><span class="n">solve_pubkey</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">user</span><span class="p">]).</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">    </span><span class="c1">// check solve</span>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">challenge</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">lamports</span><span class="p">;</span>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user lamport after: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TARGET_AMT</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">read_to_string</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">        </span><span class="fm">writeln!</span><span class="p">(</span>
<a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">            </span><span class="n">socket</span><span class="p">,</span>
<a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">            </span><span class="s">"Flag: {}"</span><span class="p">,</span>
<a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">            </span><span class="n">flag</span>
<a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">        </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>
<a href="#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="p">}</span>
</code></pre></div>
</details>
<p>第一次接触<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>题目，所以逐步解析一下：</p>
<ul>
<li>创建一个<span class="heti-skip"><span class="heti-spacing"> </span>builder<span class="heti-spacing"> </span></span>并获取用户合约以及题目合约（<span>ChallengeBuilder<span class="heti-spacing"> </span></span>来自<span><span class="heti-spacing"> </span>sol-ctf-framework</span><heti-adjacent class="heti-adjacent-half">）</heti-adjacent>：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChallengeBuilder</span>::<span class="n">try_from</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">try_clone</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c1">// load programs</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">solve_pubkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">input_program</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">program_pubkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">chall_programs</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">"./utility_payment.so"</span><span class="p">])[</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div><ul>
<li>这里需要了解的是一个<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>合约在上链的时候需要编译成<span><span class="heti-spacing"> </span>BPF</span>（Berkley Packer Filter）字节码，也就是一个<span class="heti-skip"><span class="heti-spacing"> </span>.so<span class="heti-spacing"> </span></span>文件</li>
<li><span>ChallengeBuilder::input_program<span class="heti-spacing"> </span></span>方法可以通过源码看出首先输入程序长度，然后读取<span class="heti-skip"><span class="heti-spacing"> </span>.so<span class="heti-spacing"> </span></span>的字节序列</li>
</ul>
</li>
<li>创建用户账户并输出一系列<span><span class="heti-spacing"> </span>pubkey</span>：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Keypair</span>::<span class="n">new</span><span class="p">();</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"program pubkey: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">program_pubkey</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"solve pubkey: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">solve_pubkey</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user pubkey: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></li>
<li>根据<span class="heti-skip"><span class="heti-spacing"> </span>program_pubkey<span class="heti-spacing"> </span></span>来找到<span class="heti-skip"><span class="heti-spacing"> </span>reserve<span class="heti-spacing"> </span></span>账户：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">reserve</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_reserve</span><span class="p">(</span><span class="n">program_pubkey</span><span class="p">);</span>
</code></pre></div><ul>
<li>其中<span class="heti-skip"><span class="heti-spacing"> </span>get_reserve<span class="heti-spacing"> </span></span>函数在<span class="heti-skip"><span class="heti-spacing"> </span>processor.rs<span class="heti-spacing"> </span></span>中定义：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_reserve</span><span class="p">(</span><span class="n">program</span>: <span class="nc">Pubkey</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="n">Pubkey</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">"RESERVE"</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program</span><span class="p">)</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="p">}</span>
</code></pre></div></li>
<li>这里需要了解的一个是<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>的账户分为一般账户和<span><span class="heti-spacing"> </span>PDA</span>（Program Derived Address）<ul>
<li><span>PDA<span class="heti-spacing"> </span></span>一般是由程序生成用来记录数据的</li>
<li><span>PDA<span class="heti-spacing"> </span></span>的计算是根据<span class="heti-skip"><span class="heti-spacing"> </span>seed<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>program_id</span>（也就是程序的<span><span class="heti-spacing"> </span>pubkey</span>）做哈希来生成的</li>
<li>但是<span class="heti-skip"><span class="heti-spacing"> </span>PDA<span class="heti-spacing"> </span></span>要保证不是可用的<span><span class="heti-spacing"> </span>Pubkey</span>（这个还没理解<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，所以<span class="heti-skip"><span class="heti-spacing"> </span>hash<span class="heti-spacing"> </span></span>的时候要再加一个参数<span><span class="heti-spacing"> </span>bump</span>：pda = hash(seed, bump, program_id)</li>
<li>寻找一个<span class="heti-skip"><span class="heti-spacing"> </span>PDA<span class="heti-spacing"> </span></span>的时候会从<span class="heti-skip"><span class="heti-spacing"> </span>0<span class="heti-spacing"> </span></span>到<span class="heti-skip"><span class="heti-spacing"> </span>256<span class="heti-spacing"> </span></span>枚举<span><span class="heti-spacing"> </span>bump</span>，第一个可以生成有效<span class="heti-skip"><span class="heti-spacing"> </span>PDA<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>bump<span class="heti-spacing"> </span></span>称为<span><span class="heti-spacing"> </span>canonical bump</span>，而且一般就使用这个<span><span class="heti-spacing"> </span>PDA</span></li>
<li>所以根据相同<span><span class="heti-spacing"> </span>seed</span>、相同<span class="heti-skip"><span class="heti-spacing"> </span>program_id<span class="heti-spacing"> </span></span>生成的<span class="heti-skip"><span class="heti-spacing"> </span>PDA<span class="heti-spacing"> </span></span>也是相同的。<span>Pubkey::find_program_address<span class="heti-spacing"> </span></span>做的就是这个，它的第一个参数是<span><span class="heti-spacing"> </span>seed</span>、第二个参数是<span><span class="heti-spacing"> </span>program_id</span></li>
</ul>
</li>
<li>所以<span class="heti-skip"><span class="heti-spacing"> </span>reserve<span class="heti-spacing"> </span></span>是一个由<span class="heti-skip"><span class="heti-spacing"> </span>RESERVE seed<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>program_pubkey<span class="heti-spacing"> </span></span>生成的<span><span class="heti-spacing"> </span>PDA</span></li>
</ul>
</li>
<li>为<span class="heti-skip"><span class="heti-spacing"> </span>account<span class="heti-spacing"> </span></span>增加初始<span><span class="heti-spacing"> </span>lamports</span>（钱<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">const</span><span class="w"> </span><span class="n">TARGET_AMT</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">60_000</span><span class="p">;</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">const</span><span class="w"> </span><span class="n">INIT_BAL</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="k">const</span><span class="w"> </span><span class="n">RESERVE_BAL</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">1_000_000</span><span class="p">;</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="n">builder</span>
<a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="p">.</span><span class="n">builder</span>
<a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="p">.</span><span class="n">add_account_with_lamports</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">(),</span><span class="w"> </span><span class="n">system_program</span>::<span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">INIT_BAL</span><span class="p">);</span>
<a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="n">builder</span>
<a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="p">.</span><span class="n">builder</span>
<a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">    </span><span class="p">.</span><span class="n">add_account_with_lamports</span><span class="p">(</span><span class="n">reserve</span><span class="p">,</span><span class="w"> </span><span class="n">system_program</span>::<span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">RESERVE_BAL</span><span class="p">);</span>
</code></pre></div><ul>
<li>给<span><span class="heti-spacing"> </span>user 50 lamports</span></li>
<li>给<span><span class="heti-spacing"> </span>reserve 1000000 lamports</span></li>
</ul>
</li>
<li>构建<span><span class="heti-spacing"> </span>challenge</span>、输出<span class="heti-skip"><span class="heti-spacing"> </span>user<span class="heti-spacing"> </span></span>初始<span><span class="heti-spacing"> </span>lamports</span>：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">challenge</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">lamports</span><span class="p">;</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user lamport before: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></li>
<li>接收指令，交给用户合约执行：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">challenge</span><span class="p">.</span><span class="n">input_instruction</span><span class="p">(</span><span class="n">solve_pubkey</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">user</span><span class="p">]).</span><span class="n">unwrap</span><span class="p">();</span>
</code></pre></div><ul>
<li>这里的<span class="heti-skip"><span class="heti-spacing"> </span>input_instruction<span class="heti-spacing"> </span></span>方法也是在<span class="heti-skip"><span class="heti-spacing"> </span>sol-ctf-framework<span class="heti-spacing"> </span></span>中定义的，输入方法较复杂，不过好在题目提供了一个<span class="heti-skip"><span class="heti-spacing"> </span>solve.py<span class="heti-spacing"> </span></span>用来交互输入指令</li>
</ul>
</li>
<li>检查目标，达到则下发<span><span class="heti-spacing"> </span>flag</span>：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">challenge</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">pubkey</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">lamports</span><span class="p">;</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user lamport after: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="k">if</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TARGET_AMT</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">read_to_string</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">        </span><span class="n">socket</span><span class="p">,</span>
<a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">        </span><span class="s">"Flag: {}"</span><span class="p">,</span>
<a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">        </span><span class="n">flag</span>
<a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="p">}</span>
</code></pre></div><ul>
<li>可见目标是使<span class="heti-skip"><span class="heti-spacing"> </span>user<span class="heti-spacing"> </span></span>拥有的<span class="heti-skip"><span class="heti-spacing"> </span>lamports<span class="heti-spacing"> </span></span>大于<span><span class="heti-spacing"> </span>60000 lamports</span></li>
</ul>
</li>
</ul>
<p>这样我们的攻击方式就很明显了：</p>
<ul>
<li>先调用题目合约的<span class="heti-skip"><span class="heti-spacing"> </span>Init<span class="heti-spacing"> </span></span>指令完成初始化（题目已经写好）</li>
<li>再<span><span class="heti-spacing"> </span>deposit 11 lamports</span>，使用户对应的<span class="heti-skip"><span class="heti-spacing"> </span>escrow<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>amount<span class="heti-spacing"> </span></span>记为<span><span class="heti-spacing"> </span>11</span></li>
<li>然后<span><span class="heti-spacing"> </span>pay 11 lamports</span>，这时不会收取<span class="heti-skip"><span class="heti-spacing"> </span>11 lamports<span class="heti-spacing"> </span></span>而是收取基础费用<span><span class="heti-spacing"> </span>15 lamports</span>。<span>escrow<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>amount<span class="heti-spacing"> </span></span>从<span class="heti-skip"><span class="heti-spacing"> </span>11<span class="heti-spacing"> </span></span>减去<span class="heti-skip"><span class="heti-spacing"> </span>15<span class="heti-spacing"> </span></span>发生溢出，溢出到<span><span class="heti-spacing"> </span>65531</span>，此时<span class="heti-skip"><span class="heti-spacing"> </span>withdraw<span class="heti-spacing"> </span></span>的话<span class="heti-skip"><span class="heti-spacing"> </span>reserve<span class="heti-spacing"> </span></span>有<span class="heti-skip"><span class="heti-spacing"> </span>1000000<span class="heti-spacing"> </span></span>足够支付，提出来后也可以达到题目<span class="heti-skip"><span class="heti-spacing"> </span>60000<span class="heti-spacing"> </span></span>的目标</li>
<li>直接<span class="heti-skip"><span class="heti-spacing"> </span>withdraw<span class="heti-spacing"> </span></span>即可</li>
</ul>
<p>所以只需要将这些步骤都照葫芦画瓢写在<span class="heti-skip"><span class="heti-spacing"> </span>processor.rs<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>process_instruction<span class="heti-spacing"> </span></span>中即可：</p>
<details class="success" open="open">
<summary><span>exp<span class="heti-spacing"> </span></span>合约</summary>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_instruction</span><span class="p">(</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="n">_program</span>: <span class="kp">&amp;</span><span class="nc">Pubkey</span><span class="p">,</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="n">accounts</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">AccountInfo</span><span class="p">],</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="n">_data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ProgramResult</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">account_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">accounts</span><span class="p">.</span><span class="n">iter</span><span class="p">();</span>
<a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">utility_program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">escrow_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sys_prog_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_account_info</span><span class="p">(</span><span class="n">account_iter</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>
<a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="n">invoke</span><span class="p">(</span>
<a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">Instruction</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">            </span><span class="n">program_id</span>: <span class="o">*</span><span class="n">utility_program</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">            </span><span class="n">accounts</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span>
<a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">                </span><span class="n">AccountMeta</span>::<span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span>
<a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">                </span><span class="n">AccountMeta</span>::<span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span>
<a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">                </span><span class="n">AccountMeta</span>::<span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span>
<a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">                </span><span class="n">AccountMeta</span>::<span class="n">new_readonly</span><span class="p">(</span><span class="n">system_program</span>::<span class="n">id</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span>
<a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">            </span><span class="p">],</span>
<a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">            </span><span class="n">data</span>: <span class="nc">ServiceInstruction</span>::<span class="n">Init</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">                </span><span class="p">.</span><span class="n">try_to_vec</span><span class="p">()</span>
<a href="#__codelineno-12-24" id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">                </span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span>
<a href="#__codelineno-12-25" id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">        </span><span class="p">},</span>
<a href="#__codelineno-12-26" id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span>
<a href="#__codelineno-12-27" id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">            </span><span class="n">reserve</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-28" id="__codelineno-12-28" name="__codelineno-12-28"></a><span class="w">            </span><span class="n">escrow_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-29" id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">            </span><span class="n">user</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-30" id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="w">            </span><span class="n">sys_prog_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-31" id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="w">        </span><span class="p">],</span>
<a href="#__codelineno-12-32" id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-33" id="__codelineno-12-33" name="__codelineno-12-33"></a>
<a href="#__codelineno-12-34" id="__codelineno-12-34" name="__codelineno-12-34"></a><span class="w">    </span><span class="n">invoke</span><span class="p">(</span>
<a href="#__codelineno-12-35" id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">deposit_escrow</span><span class="p">(</span>
<a href="#__codelineno-12-36" id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="w">            </span><span class="o">*</span><span class="n">utility_program</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-37" id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="w">            </span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-38" id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="w">            </span><span class="o">*</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-39" id="__codelineno-12-39" name="__codelineno-12-39"></a><span class="w">            </span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-40" id="__codelineno-12-40" name="__codelineno-12-40"></a><span class="w">            </span><span class="mi">11</span><span class="p">,</span>
<a href="#__codelineno-12-41" id="__codelineno-12-41" name="__codelineno-12-41"></a><span class="w">        </span><span class="p">),</span>
<a href="#__codelineno-12-42" id="__codelineno-12-42" name="__codelineno-12-42"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span>
<a href="#__codelineno-12-43" id="__codelineno-12-43" name="__codelineno-12-43"></a><span class="w">            </span><span class="n">reserve</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-44" id="__codelineno-12-44" name="__codelineno-12-44"></a><span class="w">            </span><span class="n">escrow_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-45" id="__codelineno-12-45" name="__codelineno-12-45"></a><span class="w">            </span><span class="n">user</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-46" id="__codelineno-12-46" name="__codelineno-12-46"></a><span class="w">            </span><span class="n">sys_prog_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-47" id="__codelineno-12-47" name="__codelineno-12-47"></a><span class="w">        </span><span class="p">],</span>
<a href="#__codelineno-12-48" id="__codelineno-12-48" name="__codelineno-12-48"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-49" id="__codelineno-12-49" name="__codelineno-12-49"></a>
<a href="#__codelineno-12-50" id="__codelineno-12-50" name="__codelineno-12-50"></a><span class="w">    </span><span class="n">invoke</span><span class="p">(</span>
<a href="#__codelineno-12-51" id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">pay_utility_fees</span><span class="p">(</span>
<a href="#__codelineno-12-52" id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="w">            </span><span class="o">*</span><span class="n">utility_program</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-53" id="__codelineno-12-53" name="__codelineno-12-53"></a><span class="w">            </span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-54" id="__codelineno-12-54" name="__codelineno-12-54"></a><span class="w">            </span><span class="o">*</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-55" id="__codelineno-12-55" name="__codelineno-12-55"></a><span class="w">            </span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<a href="#__codelineno-12-56" id="__codelineno-12-56" name="__codelineno-12-56"></a><span class="w">            </span><span class="mi">11</span><span class="p">,</span>
<a href="#__codelineno-12-57" id="__codelineno-12-57" name="__codelineno-12-57"></a><span class="w">        </span><span class="p">),</span>
<a href="#__codelineno-12-58" id="__codelineno-12-58" name="__codelineno-12-58"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span>
<a href="#__codelineno-12-59" id="__codelineno-12-59" name="__codelineno-12-59"></a><span class="w">            </span><span class="n">reserve</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-60" id="__codelineno-12-60" name="__codelineno-12-60"></a><span class="w">            </span><span class="n">escrow_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-61" id="__codelineno-12-61" name="__codelineno-12-61"></a><span class="w">            </span><span class="n">user</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-62" id="__codelineno-12-62" name="__codelineno-12-62"></a><span class="w">            </span><span class="n">sys_prog_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-63" id="__codelineno-12-63" name="__codelineno-12-63"></a><span class="w">        </span><span class="p">],</span><span class="w">        </span>
<a href="#__codelineno-12-64" id="__codelineno-12-64" name="__codelineno-12-64"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-65" id="__codelineno-12-65" name="__codelineno-12-65"></a>
<a href="#__codelineno-12-66" id="__codelineno-12-66" name="__codelineno-12-66"></a><span class="w">    </span><span class="n">invoke</span><span class="p">(</span>
<a href="#__codelineno-12-67" id="__codelineno-12-67" name="__codelineno-12-67"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">withdraw_escrow</span><span class="p">(</span>
<a href="#__codelineno-12-68" id="__codelineno-12-68" name="__codelineno-12-68"></a><span class="w">            </span><span class="o">*</span><span class="n">utility_program</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-12-69" id="__codelineno-12-69" name="__codelineno-12-69"></a><span class="w">            </span><span class="o">*</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-12-70" id="__codelineno-12-70" name="__codelineno-12-70"></a><span class="w">            </span><span class="o">*</span><span class="n">reserve</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-12-71" id="__codelineno-12-71" name="__codelineno-12-71"></a><span class="w">            </span><span class="o">*</span><span class="n">escrow_account</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-12-72" id="__codelineno-12-72" name="__codelineno-12-72"></a><span class="w">        </span><span class="p">),</span>
<a href="#__codelineno-12-73" id="__codelineno-12-73" name="__codelineno-12-73"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span>
<a href="#__codelineno-12-74" id="__codelineno-12-74" name="__codelineno-12-74"></a><span class="w">            </span><span class="n">reserve</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-75" id="__codelineno-12-75" name="__codelineno-12-75"></a><span class="w">            </span><span class="n">escrow_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-76" id="__codelineno-12-76" name="__codelineno-12-76"></a><span class="w">            </span><span class="n">user</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-77" id="__codelineno-12-77" name="__codelineno-12-77"></a><span class="w">            </span><span class="n">sys_prog_account</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-12-78" id="__codelineno-12-78" name="__codelineno-12-78"></a><span class="w">        </span><span class="p">],</span>
<a href="#__codelineno-12-79" id="__codelineno-12-79" name="__codelineno-12-79"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-12-80" id="__codelineno-12-80" name="__codelineno-12-80"></a>
<a href="#__codelineno-12-81" id="__codelineno-12-81" name="__codelineno-12-81"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-12-82" id="__codelineno-12-82" name="__codelineno-12-82"></a><span class="p">}</span>
</code></pre></div>
</details>
<p>之后利用<span><span class="heti-spacing"> </span>cargo build-bpf</span>（需要先安装<span><span class="heti-spacing"> </span>solana</span>）编译出<span class="heti-skip"><span class="heti-spacing"> </span>.so<span class="heti-spacing"> </span></span>文件，再交给<span class="heti-skip"><span class="heti-spacing"> </span>solve.py<span class="heti-spacing"> </span></span>脚本交题即可。</p>
<p>flag: <strong>n1ctf{cashback_……}</strong></p>
<hr/>
<h2 id="simple-staking">Simple Staking<a class="headerlink" href="#simple-staking" title="Permanent link">¶</a></h2>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="https://img.shields.io/badge/-BLOCKCHAIN-orange?style=flat-square"><img alt="" src="https://img.shields.io/badge/-BLOCKCHAIN-orange?style=flat-square"/></a></p>
<p>同样也是<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>合约，不过用了<span><span class="heti-spacing"> </span>anchor lang</span>：<a href="https://www.anchor-lang.com/">https://www.anchor-lang.com/</a> ，有很多奇奇怪怪的写法，但看看文档还挺好懂的</p>
<p>还是详细解析一下：</p>
<h3 id="_1">题目合约<a class="headerlink" href="#_1" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p><span>anchor lang<span class="heti-spacing"> </span></span>的语法看起来就是把处理函数封装在一个<span class="heti-skip"><span class="heti-spacing"> </span>mod<span class="heti-spacing"> </span></span>中然后用 <code class="highlight"><span class="cp">#[program]</span></code> 宏来处理。</p>
<p>这个<span class="heti-skip"><span class="heti-spacing"> </span>mod<span class="heti-spacing"> </span></span>中的每个函数都会被处理成一个指令，它们第一个参数都是一个<span class="heti-skip"><span class="heti-spacing"> </span>Context<span class="heti-spacing"> </span></span>泛型，其依赖的是针对每种指令的结构体<span><span class="heti-spacing"> </span>Accounts</span>（即<span><span class="heti-spacing"> </span>Context</span><accounts><heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，然后在函数内部可以利用<span class="heti-skip"><span class="heti-spacing"> </span>ctx.accounts.?<span class="heti-spacing"> </span></span>来获取对应结构体中的各个<span><span class="heti-spacing"> </span>account</span>。</accounts></p>
<p>结构体的定义会使用 <code class="highlight"><span class="cp">#[derive(Accounts)]</span></code> 宏来进行处理。其中成员也可以使用 <code class="highlight"><span class="cp">#[account()]</span></code> 宏进行限定，如果输入不满足限定则会报错，具体写法和意义可以看官方文档。</p>
<h4 id="initialize">Initialize<a class="headerlink" href="#initialize" title="Permanent link">¶</a></h4>
<ul>
<li>处理函数是空的，也就是说所有操作都在<span class="heti-skip"><span class="heti-spacing"> </span>Initialize<span class="heti-spacing"> </span></span>结构体中进行
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">_ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">Initialize</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="p">}</span>
</code></pre></div></li>
<li><span>Initialize<span class="heti-spacing"> </span></span>结构体字段：<ul>
<li>catalog：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="cp">#[account(</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="cp">    init,</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="cp">    seeds = [ b</span><span class="s">"CATALOG"</span><span class="cp"> ],</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="cp">    bump,   </span>
<a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="cp">    payer = payer,</span>
<a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="cp">    space = Catalog::SIZE,</span>
<a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="cp">)]</span>
<a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="k">pub</span><span class="w"> </span><span class="n">catalog</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Catalog</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div><ul>
<li><span>init<span class="heti-spacing"> </span></span>表示这个<span class="heti-skip"><span class="heti-spacing"> </span>account<span class="heti-spacing"> </span></span>需要初始化（而且不能重复进行）</li>
<li><span>seeds<span class="heti-spacing"> </span></span>表示用这个<span class="heti-skip"><span class="heti-spacing"> </span>seed<span class="heti-spacing"> </span></span>来找<span><span class="heti-spacing"> </span>PDA</span></li>
<li><span>bump<span class="heti-spacing"> </span></span>表示要记录下<span><span class="heti-spacing"> </span>canonical bump</span>（可以通过 <code class="highlight"><span class="o">*</span><span class="n">ctx</span><span class="p">.</span><span class="n">bumps</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"catalog"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span></code> 来获取这个<span><span class="heti-spacing"> </span>bump</span></li>
<li><span>payer<span class="heti-spacing"> </span></span>表示创建账号要用的<span><span class="heti-spacing"> </span>payer</span></li>
<li><span>space<span class="heti-spacing"> </span></span>用来确定大小，由<span class="heti-skip"><span class="heti-spacing"> </span>Catalog<span class="heti-spacing"> </span></span>规定</li>
<li>这个账户存的信息（data）是<span class="heti-skip"><span class="heti-spacing"> </span>Catalog<span class="heti-spacing"> </span></span>结构体的内容（序列化后）<span>Catalog<span class="heti-spacing"> </span></span>定义：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="cp">#[account]</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="cp">#[repr(C, align(8))]</span>
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="cp">#[derive(Default)]</span>
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Catalog</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">orgs</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ids</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="p">}</span>
<a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="k">impl</span><span class="w"> </span><span class="n">Catalog</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span>
<a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAXIMUM_STRING_SIZE</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXIMUM_CATALOG_SIZE</span><span class="w">   </span><span class="c1">// orgs: Vec&lt;String&gt;,</span>
<a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAXIMUM_STRING_SIZE</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXIMUM_CATALOG_SIZE</span><span class="p">;</span><span class="w">  </span><span class="c1">//  ids: Vec&lt;String&gt;,</span>
<a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="p">}</span>
</code></pre></div></li>
</ul>
</li>
<li>reserve：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="cp">#[account(</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="cp">    init,</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="cp">    seeds = [ b</span><span class="s">"RESERVE"</span><span class="cp"> ],</span>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="cp">    bump,</span>
<a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="cp">    payer = payer,</span>
<a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="cp">    token::mint = mint,</span>
<a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="cp">    token::authority = reserve</span>
<a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="cp">)]</span>
<a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="k">pub</span><span class="w"> </span><span class="n">reserve</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">TokenAccount</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div><ul>
<li>与前面同理</li>
<li>这是一个<span><span class="heti-spacing"> </span>TokenAccount</span>，其定义在<span class="heti-skip"><span class="heti-spacing"> </span>spl_token<span class="heti-spacing"> </span></span>中，是一个类似<span class="heti-skip"><span class="heti-spacing"> </span>ERC20<span class="heti-spacing"> </span></span>的代币</li>
</ul>
</li>
<li>其它：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">pub</span><span class="w"> </span><span class="n">mint</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Mint</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="cp">#[account(mut)]</span>
<a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="k">pub</span><span class="w"> </span><span class="n">payer</span>: <span class="nc">Signer</span><span class="o">&lt;'</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="k">pub</span><span class="w"> </span><span class="n">token_program</span>: <span class="nc">Program</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div><ul>
<li><span>mint<span class="heti-spacing"> </span></span>为<span class="heti-skip"><span class="heti-spacing"> </span>Token<span class="heti-spacing"> </span></span>合约的<span class="heti-skip"><span class="heti-spacing"> </span>mint<span class="heti-spacing"> </span></span>账户，用来给<span class="heti-skip"><span class="heti-spacing"> </span>reserve<span class="heti-spacing"> </span></span>提供参数<span><span class="heti-spacing"> </span>token::mint</span></li>
<li><span>payer<span class="heti-spacing"> </span></span>也是为前面两个提供参数</li>
<li><span>token_program<span class="heti-spacing"> </span></span>是<span class="heti-skip"><span class="heti-spacing"> </span>spl token<span class="heti-spacing"> </span></span>的<span><span class="heti-spacing"> </span>ID</span></li>
<li><span>system_program<span class="heti-spacing"> </span></span>是题目合约的<span><span class="heti-spacing"> </span>ID</span></li>
<li><span>rent<span class="heti-spacing"> </span></span>是<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>系统的<span><span class="heti-spacing"> </span>rent ID</span>（不用管这个）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="register">Register<a class="headerlink" href="#register" title="Permanent link">¶</a></h4>
<ul>
<li><span>Register<span class="heti-spacing"> </span></span>结构体：<ul>
<li>catalog：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="cp">#[account(</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="cp">    mut,</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="cp">    seeds = [ b</span><span class="s">"CATALOG"</span><span class="cp"> ],</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="cp">    bump</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="cp">)]</span>
<a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="k">pub</span><span class="w"> </span><span class="n">catalog</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Catalog</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div><ul>
<li>根据这个<span class="heti-skip"><span class="heti-spacing"> </span>seed<span class="heti-spacing"> </span></span>来获取，同样记录<span><span class="heti-spacing"> </span>bump</span></li>
</ul>
</li>
<li>employee_record：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="cp">#[account(</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="cp">    init,</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="cp">    seeds = [user.key().as_ref()],</span>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="cp">    bump,</span>
<a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="cp">    payer = user,</span>
<a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="cp">    space = EmployeeRecord::SIZE,</span>
<a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="cp">)]</span>
<a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="k">pub</span><span class="w"> </span><span class="n">employee_record</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">EmployeeRecord</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div><ul>
<li>和前面<span class="heti-skip"><span class="heti-spacing"> </span>Initialize<span class="heti-spacing"> </span></span>的同理</li>
<li>其中<span class="heti-skip"><span class="heti-spacing"> </span>EmployeeRecord<span class="heti-spacing"> </span></span>结构体：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="cp">#[account]</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="cp">#[repr(C, align(8))]</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="cp">#[derive(Default)]</span>
<a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">EmployeeRecord</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">org</span>: <span class="nb">String</span><span class="p">,</span>
<a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">id</span>: <span class="nb">String</span><span class="p">,</span>
<a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">key</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="p">}</span>
<a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="k">impl</span><span class="w"> </span><span class="n">EmployeeRecord</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span>
<a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAXIMUM_STRING_SIZE</span><span class="w">   </span><span class="c1">// orgs: String,</span>
<a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAXIMUM_STRING_SIZE</span><span class="w">   </span><span class="c1">//  ids: String,</span>
<a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w">                       </span><span class="c1">//  key: Pubkey</span>
<a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="p">}</span>
</code></pre></div></li>
</ul>
</li>
<li>其它：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="cp">#[account(mut)]</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="k">pub</span><span class="w"> </span><span class="n">user</span>: <span class="nc">Signer</span><span class="o">&lt;'</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div></li>
</ul>
</li>
<li>处理函数：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">register</span><span class="p">(</span><span class="n">ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">Register</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">org_name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">employee_id</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="n">msg</span><span class="o">!</span><span class="p">(</span><span class="s">"[CHALL] register: org {}, id {}"</span><span class="p">,</span><span class="w"> </span><span class="n">org_name</span><span class="p">,</span><span class="w"> </span><span class="n">employee_id</span><span class="p">);</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">        </span><span class="n">org_name</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXIMUM_STRING_SIZE</span><span class="p">,</span>
<a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">        </span><span class="n">CoreError</span>::<span class="n">StringTooLong</span>
<a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a>
<a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">        </span><span class="n">employee_id</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXIMUM_STRING_SIZE</span><span class="p">,</span>
<a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">        </span><span class="n">CoreError</span>::<span class="n">StringTooLong</span>
<a href="#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a>
<a href="#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">catalog</span><span class="p">;</span>
<a href="#__codelineno-22-14" id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<a href="#__codelineno-22-15" id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="n">orgs</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">org_name</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="n">ids</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">employee_id</span><span class="p">)</span><span class="w"> </span><span class="p">),</span>
<a href="#__codelineno-22-16" id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">        </span><span class="n">CoreError</span>::<span class="n">DuplicatedEmployee</span>
<a href="#__codelineno-22-17" id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-22-18" id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">    </span><span class="n">catalog</span><span class="p">.</span><span class="n">orgs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">org_name</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<a href="#__codelineno-22-19" id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">    </span><span class="n">catalog</span><span class="p">.</span><span class="n">ids</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">employee_id</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<a href="#__codelineno-22-20" id="__codelineno-22-20" name="__codelineno-22-20"></a>
<a href="#__codelineno-22-21" id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee_record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">employee_record</span><span class="p">;</span>
<a href="#__codelineno-22-22" id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">();</span>
<a href="#__codelineno-22-23" id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="w">    </span><span class="n">employee_record</span><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">org_name</span><span class="p">;</span>
<a href="#__codelineno-22-24" id="__codelineno-22-24" name="__codelineno-22-24"></a><span class="w">    </span><span class="n">employee_record</span><span class="p">.</span><span class="n">id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">employee_id</span><span class="p">;</span>
<a href="#__codelineno-22-25" id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="w">    </span><span class="n">employee_record</span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employee_key</span><span class="p">;</span>
<a href="#__codelineno-22-26" id="__codelineno-22-26" name="__codelineno-22-26"></a>
<a href="#__codelineno-22-27" id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-22-28" id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="p">}</span>
</code></pre></div><ul>
<li>首先验证<span class="heti-skip"><span class="heti-spacing"> </span>org_name<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>employee_id<span class="heti-spacing"> </span></span>的长度</li>
<li>检查<span class="heti-skip"><span class="heti-spacing"> </span>(org_name, employee_id)<span class="heti-spacing"> </span></span>是否在<span class="heti-skip"><span class="heti-spacing"> </span>catalog<span class="heti-spacing"> </span></span>中存在，存在则报错</li>
<li>将<span class="heti-skip"><span class="heti-spacing"> </span>(org_name, employee_id)<span class="heti-spacing"> </span></span>添加到<span class="heti-skip"><span class="heti-spacing"> </span>catalog<span class="heti-spacing"> </span></span>中</li>
<li>修改<span><span class="heti-spacing"> </span>employee_record</span></li>
</ul>
</li>
</ul>
<h4 id="deposit">Deposit<a class="headerlink" href="#deposit" title="Permanent link">¶</a></h4>
<ul>
<li><span>Deposit<span class="heti-spacing"> </span></span>结构体<ul>
<li>vault：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="cp">#[account(</span>
<a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="cp">    init_if_needed,</span>
<a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="cp">    seeds = [org_name.as_bytes(), employee_id.as_bytes()],</span>
<a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="cp">    bump,</span>
<a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="cp">    space = Vault::SIZE,</span>
<a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="cp">    payer = user </span>
<a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="cp">)]</span>
<a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="k">pub</span><span class="w"> </span><span class="n">vault</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Vault</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div><ul>
<li>通过<span class="heti-skip"><span class="heti-spacing"> </span>[org_name, employee_id]<span class="heti-spacing"> </span></span>这个<span class="heti-skip"><span class="heti-spacing"> </span>seed<span class="heti-spacing"> </span></span>获取<span><span class="heti-spacing"> </span>PDA</span></li>
<li><span>Vault<span class="heti-spacing"> </span></span>定义：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="cp">#[account]</span>
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="cp">#[repr(C, align(8))]</span>
<a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="cp">#[derive(Default)]</span>
<a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Vault</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span>: <span class="kt">u64</span><span class="p">,</span>
<a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="p">}</span>
<a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="k">impl</span><span class="w"> </span><span class="n">Vault</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="c1">// DISCRIMINATOR_SIZE</span>
<a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">                   </span><span class="c1">// u64</span>
<a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="p">}</span>
</code></pre></div></li>
</ul>
</li>
<li>employee_record：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="cp">#[account(</span>
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="cp">    seeds = [user.key().as_ref()],</span>
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="cp">    bump,</span>
<a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="cp">    constraint = employee_record.org == org_name,</span>
<a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="cp">    constraint = employee_record.id == employee_id,</span>
<a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="cp">    constraint = employee_record.key == user.key(),</span>
<a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="cp">)]</span>
<a href="#__codelineno-25-8" id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="k">pub</span><span class="w"> </span><span class="n">employee_record</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">EmployeeRecord</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div><ul>
<li>这里有新出现的<span><span class="heti-spacing"> </span>constraint</span>，传参时会检查其内容是否为<span><span class="heti-spacing"> </span>true</span>，不是的话就报错然后<span><span class="heti-spacing"> </span>revert</span></li>
</ul>
</li>
<li>其它
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="cp">#[account(</span>
<a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="cp">    mut,</span>
<a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="cp">    seeds = [ b</span><span class="s">"RESERVE"</span><span class="cp"> ],</span>
<a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="cp">    bump,</span>
<a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="cp">    constraint = reserve.mint == mint.key(),</span>
<a href="#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="cp">)]</span>
<a href="#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="k">pub</span><span class="w"> </span><span class="n">reserve</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">TokenAccount</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-26-8" id="__codelineno-26-8" name="__codelineno-26-8"></a>
<a href="#__codelineno-26-9" id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="cp">#[account(</span>
<a href="#__codelineno-26-10" id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="cp">    mut,</span>
<a href="#__codelineno-26-11" id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="cp">    constraint = user_token_account.owner == user.key(),</span>
<a href="#__codelineno-26-12" id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="cp">    constraint = user_token_account.mint  == mint.key()</span>
<a href="#__codelineno-26-13" id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="cp">)]</span>
<a href="#__codelineno-26-14" id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="k">pub</span><span class="w"> </span><span class="n">user_token_account</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">TokenAccount</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-26-15" id="__codelineno-26-15" name="__codelineno-26-15"></a>
<a href="#__codelineno-26-16" id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="k">pub</span><span class="w"> </span><span class="n">mint</span>: <span class="nc">Account</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Mint</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-26-17" id="__codelineno-26-17" name="__codelineno-26-17"></a>
<a href="#__codelineno-26-18" id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="cp">#[account(mut)]</span>
<a href="#__codelineno-26-19" id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="k">pub</span><span class="w"> </span><span class="n">user</span>: <span class="nc">Signer</span><span class="o">&lt;'</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-26-20" id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="k">pub</span><span class="w"> </span><span class="n">token_program</span>: <span class="nc">Program</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-26-21" id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span>
<a href="#__codelineno-26-22" id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;'</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span>
</code></pre></div></li>
</ul>
</li>
<li>处理函数：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">deposit</span><span class="p">(</span><span class="n">ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">Deposit</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">org_name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">employee_id</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">    </span><span class="n">msg</span><span class="o">!</span><span class="p">(</span><span class="s">"[CHALL] deposit"</span><span class="p">);</span>
<a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">vault</span><span class="p">;</span>
<a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee_record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">employee_record</span><span class="p">;</span>
<a href="#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user</span><span class="p">;</span>
<a href="#__codelineno-27-6" id="__codelineno-27-6" name="__codelineno-27-6"></a>
<a href="#__codelineno-27-7" id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<a href="#__codelineno-27-8" id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="n">key</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">employee_record</span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">org_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">employee_record</span><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">employee_record</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-27-9" id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">        </span><span class="n">CoreError</span>::<span class="n">UnknownEmployee</span>
<a href="#__codelineno-27-10" id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-27-11" id="__codelineno-27-11" name="__codelineno-27-11"></a>
<a href="#__codelineno-27-12" id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">deposit_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CpiContext</span>::<span class="n">new</span><span class="p">(</span>
<a href="#__codelineno-27-13" id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">token_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-27-14" id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">        </span><span class="n">Transfer</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-27-15" id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">            </span><span class="n">from</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user_token_account</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-27-16" id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">            </span><span class="n">to</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">reserve</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-27-17" id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">            </span><span class="n">authority</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">()</span>
<a href="#__codelineno-27-18" id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-27-19" id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-27-20" id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="w">    </span><span class="n">token</span>::<span class="n">transfer</span><span class="p">(</span><span class="n">deposit_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-27-21" id="__codelineno-27-21" name="__codelineno-27-21"></a>
<a href="#__codelineno-27-22" id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">    </span><span class="n">vault</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<a href="#__codelineno-27-23" id="__codelineno-27-23" name="__codelineno-27-23"></a>
<a href="#__codelineno-27-24" id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-27-25" id="__codelineno-27-25" name="__codelineno-27-25"></a><span class="p">}</span>
</code></pre></div><ul>
<li>先试一系列检查，检查输入是否合法</li>
<li>然后调用<span class="heti-skip"><span class="heti-spacing"> </span>spl token<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>transfer<span class="heti-spacing"> </span></span>指令来从<span class="heti-skip"><span class="heti-spacing"> </span>user_token_account<span class="heti-spacing"> </span></span>转<span class="heti-skip"><span class="heti-spacing"> </span>amount<span class="heti-spacing"> </span></span>个<span class="heti-skip"><span class="heti-spacing"> </span>token<span class="heti-spacing"> </span></span>给<span><span class="heti-spacing"> </span>reserve</span></li>
<li>为<span class="heti-skip"><span class="heti-spacing"> </span>vault<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>amount<span class="heti-spacing"> </span></span>增加<span><span class="heti-spacing"> </span>amount</span>（这个<span class="heti-skip"><span class="heti-spacing"> </span>vault<span class="heti-spacing"> </span></span>是根据<span class="heti-skip"><span class="heti-spacing"> </span>seed [org_name, employee_id]<span class="heti-spacing"> </span></span>找到的<span><span class="heti-spacing"> </span>PDA</span>）</li>
</ul>
</li>
</ul>
<h4 id="withdraw">Withdraw<a class="headerlink" href="#withdraw" title="Permanent link">¶</a></h4>
<ul>
<li><span>Withdraw<span class="heti-spacing"> </span></span>结构体<ul>
<li>其内容和<span class="heti-skip"><span class="heti-spacing"> </span>Deposit<span class="heti-spacing"> </span></span>几乎一致</li>
<li>区别在于<span class="heti-skip"><span class="heti-spacing"> </span>Deposit<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>user<span class="heti-spacing"> </span></span>在这里叫做<span><span class="heti-spacing"> </span>payer</span>，不过用处应该没变</li>
</ul>
</li>
<li>处理函数：
    <div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">withdraw</span><span class="p">(</span><span class="n">ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">Withdraw</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">org_name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">employee_id</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">    </span><span class="n">msg</span><span class="o">!</span><span class="p">(</span><span class="s">"[CHALL] withdraw"</span><span class="p">);</span>
<a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">vault</span><span class="p">;</span>
<a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee_record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">employee_record</span><span class="p">;</span>
<a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">payer</span><span class="p">.</span><span class="n">key</span><span class="p">();</span>
<a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a>
<a href="#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<a href="#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">        </span><span class="n">payer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">employee_record</span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">org_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">employee_record</span><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">employee_record</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-28-9" id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">        </span><span class="n">CoreError</span>::<span class="n">UnknownEmployee</span>
<a href="#__codelineno-28-10" id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-28-11" id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span>
<a href="#__codelineno-28-12" id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">        </span><span class="n">vault</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span>
<a href="#__codelineno-28-13" id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="w">        </span><span class="n">CoreError</span>::<span class="n">InsufficientBalance</span>
<a href="#__codelineno-28-14" id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-28-15" id="__codelineno-28-15" name="__codelineno-28-15"></a>
<a href="#__codelineno-28-16" id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve_bump</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="n">ctx</span><span class="p">.</span><span class="n">bumps</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"reserve"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()];</span>
<a href="#__codelineno-28-17" id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">signer_seeds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a href="#__codelineno-28-18" id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="w">        </span><span class="s">b"RESERVE"</span><span class="p">,</span>
<a href="#__codelineno-28-19" id="__codelineno-28-19" name="__codelineno-28-19"></a><span class="w">        </span><span class="n">reserve_bump</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()</span>
<a href="#__codelineno-28-20" id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="w">    </span><span class="p">];</span>
<a href="#__codelineno-28-21" id="__codelineno-28-21" name="__codelineno-28-21"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">signer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">signer_seeds</span><span class="p">[</span><span class="o">..</span><span class="p">]];</span>
<a href="#__codelineno-28-22" id="__codelineno-28-22" name="__codelineno-28-22"></a>
<a href="#__codelineno-28-23" id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">withdraw_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CpiContext</span>::<span class="n">new_with_signer</span><span class="p">(</span>
<a href="#__codelineno-28-24" id="__codelineno-28-24" name="__codelineno-28-24"></a><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">token_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-28-25" id="__codelineno-28-25" name="__codelineno-28-25"></a><span class="w">        </span><span class="n">Transfer</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-28-26" id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="w">            </span><span class="n">from</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">reserve</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-28-27" id="__codelineno-28-27" name="__codelineno-28-27"></a><span class="w">            </span><span class="n">to</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user_account</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-28-28" id="__codelineno-28-28" name="__codelineno-28-28"></a><span class="w">            </span><span class="n">authority</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">reserve</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">()</span>
<a href="#__codelineno-28-29" id="__codelineno-28-29" name="__codelineno-28-29"></a><span class="w">        </span><span class="p">},</span>
<a href="#__codelineno-28-30" id="__codelineno-28-30" name="__codelineno-28-30"></a><span class="w">        </span><span class="n">signer</span>
<a href="#__codelineno-28-31" id="__codelineno-28-31" name="__codelineno-28-31"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-28-32" id="__codelineno-28-32" name="__codelineno-28-32"></a><span class="w">    </span><span class="n">token</span>::<span class="n">transfer</span><span class="p">(</span><span class="n">withdraw_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-28-33" id="__codelineno-28-33" name="__codelineno-28-33"></a>
<a href="#__codelineno-28-34" id="__codelineno-28-34" name="__codelineno-28-34"></a><span class="w">    </span><span class="n">vault</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<a href="#__codelineno-28-35" id="__codelineno-28-35" name="__codelineno-28-35"></a>
<a href="#__codelineno-28-36" id="__codelineno-28-36" name="__codelineno-28-36"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-28-37" id="__codelineno-28-37" name="__codelineno-28-37"></a><span class="p">}</span>
</code></pre></div><ul>
<li>同样做了很多检查</li>
<li>利用<span class="heti-skip"><span class="heti-spacing"> </span>spl token<span class="heti-spacing"> </span></span>合约从<span class="heti-skip"><span class="heti-spacing"> </span>reserve transfer amount token<span class="heti-spacing"> </span></span>给<span><span class="heti-spacing"> </span>user_account</span></li>
<li>给<span class="heti-skip"><span class="heti-spacing"> </span>vault.amount<span class="heti-spacing"> </span></span>减少<span><span class="heti-spacing"> </span>amount</span></li>
</ul>
</li>
</ul>
<h3 id="_2">题目交互部分<a class="headerlink" href="#_2" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<details class="question">
<summary>题目交互代码</summary>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle_connection</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span>: <span class="nc">TcpStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChallengeBuilder</span>::<span class="n">try_from</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">try_clone</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a>
<a href="#__codelineno-29-4" id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">chall_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">add_program</span><span class="p">(</span><span class="s">"./chall/target/deploy/chall.so"</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">chall</span>::<span class="n">ID</span><span class="p">));</span>
<a href="#__codelineno-29-5" id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">solve_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">input_program</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-6" id="__codelineno-29-6" name="__codelineno-29-6"></a>
<a href="#__codelineno-29-7" id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">chall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">().</span><span class="k">await</span><span class="p">;</span>
<a href="#__codelineno-29-8" id="__codelineno-29-8" name="__codelineno-29-8"></a>
<a href="#__codelineno-29-9" id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">    </span><span class="c1">// -------------------------------------------------------------------------</span>
<a href="#__codelineno-29-10" id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="w">    </span><span class="c1">// [setup env] initialize</span>
<a href="#__codelineno-29-11" id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="w">    </span><span class="c1">// -------------------------------------------------------------------------</span>
<a href="#__codelineno-29-12" id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">program_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall_id</span><span class="p">;</span>
<a href="#__codelineno-29-13" id="__codelineno-29-13" name="__codelineno-29-13"></a>
<a href="#__codelineno-29-14" id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span><span class="p">.</span><span class="n">add_mint</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-15" id="__codelineno-29-15" name="__codelineno-29-15"></a>
<a href="#__codelineno-29-16" id="__codelineno-29-16" name="__codelineno-29-16"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payer_keypair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">chall</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">payer</span><span class="p">;</span>
<a href="#__codelineno-29-17" id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payer_keypair</span><span class="p">.</span><span class="n">pubkey</span><span class="p">();</span>
<a href="#__codelineno-29-18" id="__codelineno-29-18" name="__codelineno-29-18"></a>
<a href="#__codelineno-29-19" id="__codelineno-29-19" name="__codelineno-29-19"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user_keypair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Keypair</span>::<span class="n">new</span><span class="p">();</span>
<a href="#__codelineno-29-20" id="__codelineno-29-20" name="__codelineno-29-20"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_keypair</span><span class="p">.</span><span class="n">pubkey</span><span class="p">();</span>
<a href="#__codelineno-29-21" id="__codelineno-29-21" name="__codelineno-29-21"></a><span class="w">    </span><span class="n">chall</span>
<a href="#__codelineno-29-22" id="__codelineno-29-22" name="__codelineno-29-22"></a><span class="w">        </span><span class="p">.</span><span class="n">run_ix</span><span class="p">(</span><span class="n">system_instruction</span>::<span class="n">transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="mi">100_000_000_000</span><span class="p">))</span>
<a href="#__codelineno-29-23" id="__codelineno-29-23" name="__codelineno-29-23"></a><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-24" id="__codelineno-29-24" name="__codelineno-29-24"></a>
<a href="#__codelineno-29-25" id="__codelineno-29-25" name="__codelineno-29-25"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">b"CATALOG"</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program_id</span><span class="p">).</span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-29-26" id="__codelineno-29-26" name="__codelineno-29-26"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">b"RESERVE"</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program_id</span><span class="p">).</span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-29-27" id="__codelineno-29-27" name="__codelineno-29-27"></a>
<a href="#__codelineno-29-28" id="__codelineno-29-28" name="__codelineno-29-28"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Accounts created...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a href="#__codelineno-29-29" id="__codelineno-29-29" name="__codelineno-29-29"></a>
<a href="#__codelineno-29-30" id="__codelineno-29-30" name="__codelineno-29-30"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">instruction</span>::<span class="n">Initialize</span><span class="w"> </span><span class="p">{};</span>
<a href="#__codelineno-29-31" id="__codelineno-29-31" name="__codelineno-29-31"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ix_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">accounts</span>::<span class="n">Initialize</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-32" id="__codelineno-29-32" name="__codelineno-29-32"></a><span class="w">        </span><span class="n">catalog</span><span class="p">,</span>
<a href="#__codelineno-29-33" id="__codelineno-29-33" name="__codelineno-29-33"></a><span class="w">        </span><span class="n">reserve</span><span class="p">,</span>
<a href="#__codelineno-29-34" id="__codelineno-29-34" name="__codelineno-29-34"></a><span class="w">        </span><span class="n">mint</span><span class="p">,</span>
<a href="#__codelineno-29-35" id="__codelineno-29-35" name="__codelineno-29-35"></a><span class="w">        </span><span class="n">payer</span><span class="p">,</span>
<a href="#__codelineno-29-36" id="__codelineno-29-36" name="__codelineno-29-36"></a><span class="w">        </span><span class="n">token_program</span>: <span class="nc">spl_token</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-37" id="__codelineno-29-37" name="__codelineno-29-37"></a><span class="w">        </span><span class="n">system_program</span>: <span class="nc">solana_program</span>::<span class="n">system_program</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-38" id="__codelineno-29-38" name="__codelineno-29-38"></a><span class="w">        </span><span class="n">rent</span>: <span class="nc">solana_program</span>::<span class="n">sysvar</span>::<span class="n">rent</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-39" id="__codelineno-29-39" name="__codelineno-29-39"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-29-40" id="__codelineno-29-40" name="__codelineno-29-40"></a>
<a href="#__codelineno-29-41" id="__codelineno-29-41" name="__codelineno-29-41"></a><span class="w">    </span><span class="n">chall</span>
<a href="#__codelineno-29-42" id="__codelineno-29-42" name="__codelineno-29-42"></a><span class="w">        </span><span class="p">.</span><span class="n">run_ix</span><span class="p">(</span><span class="n">Instruction</span>::<span class="n">new_with_bytes</span><span class="p">(</span>
<a href="#__codelineno-29-43" id="__codelineno-29-43" name="__codelineno-29-43"></a><span class="w">            </span><span class="n">program_id</span><span class="p">,</span>
<a href="#__codelineno-29-44" id="__codelineno-29-44" name="__codelineno-29-44"></a><span class="w">            </span><span class="o">&amp;</span><span class="n">ix</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<a href="#__codelineno-29-45" id="__codelineno-29-45" name="__codelineno-29-45"></a><span class="w">            </span><span class="n">ix_accounts</span><span class="p">.</span><span class="n">to_account_metas</span><span class="p">(</span><span class="nb">None</span><span class="p">),</span>
<a href="#__codelineno-29-46" id="__codelineno-29-46" name="__codelineno-29-46"></a><span class="w">        </span><span class="p">))</span>
<a href="#__codelineno-29-47" id="__codelineno-29-47" name="__codelineno-29-47"></a><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-48" id="__codelineno-29-48" name="__codelineno-29-48"></a>
<a href="#__codelineno-29-49" id="__codelineno-29-49" name="__codelineno-29-49"></a><span class="w">    </span><span class="c1">// -------------------------------------------------------------------------</span>
<a href="#__codelineno-29-50" id="__codelineno-29-50" name="__codelineno-29-50"></a><span class="w">    </span><span class="c1">// [setup env] register</span>
<a href="#__codelineno-29-51" id="__codelineno-29-51" name="__codelineno-29-51"></a><span class="w">    </span><span class="c1">// -------------------------------------------------------------------------</span>
<a href="#__codelineno-29-52" id="__codelineno-29-52" name="__codelineno-29-52"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">org_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"product"</span><span class="p">);</span>
<a href="#__codelineno-29-53" id="__codelineno-29-53" name="__codelineno-29-53"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"employ_A"</span><span class="p">);</span>
<a href="#__codelineno-29-54" id="__codelineno-29-54" name="__codelineno-29-54"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">instruction</span>::<span class="n">Register</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-55" id="__codelineno-29-55" name="__codelineno-29-55"></a><span class="w">        </span><span class="n">org_name</span>: <span class="nc">org_name</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-29-56" id="__codelineno-29-56" name="__codelineno-29-56"></a><span class="w">        </span><span class="n">employee_id</span>: <span class="nc">employee_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-29-57" id="__codelineno-29-57" name="__codelineno-29-57"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-29-58" id="__codelineno-29-58" name="__codelineno-29-58"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee_record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">payer</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program_id</span><span class="p">).</span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-29-59" id="__codelineno-29-59" name="__codelineno-29-59"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reg_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">accounts</span>::<span class="n">Register</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-60" id="__codelineno-29-60" name="__codelineno-29-60"></a><span class="w">        </span><span class="n">catalog</span><span class="p">,</span>
<a href="#__codelineno-29-61" id="__codelineno-29-61" name="__codelineno-29-61"></a><span class="w">        </span><span class="n">employee_record</span><span class="p">,</span>
<a href="#__codelineno-29-62" id="__codelineno-29-62" name="__codelineno-29-62"></a><span class="w">        </span><span class="n">user</span>: <span class="nc">payer</span><span class="p">,</span>
<a href="#__codelineno-29-63" id="__codelineno-29-63" name="__codelineno-29-63"></a><span class="w">        </span><span class="n">system_program</span>: <span class="nc">solana_program</span>::<span class="n">system_program</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-64" id="__codelineno-29-64" name="__codelineno-29-64"></a><span class="w">        </span><span class="n">rent</span>: <span class="nc">solana_program</span>::<span class="n">sysvar</span>::<span class="n">rent</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-65" id="__codelineno-29-65" name="__codelineno-29-65"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-29-66" id="__codelineno-29-66" name="__codelineno-29-66"></a><span class="w">    </span><span class="n">chall</span>
<a href="#__codelineno-29-67" id="__codelineno-29-67" name="__codelineno-29-67"></a><span class="w">        </span><span class="p">.</span><span class="n">run_ix</span><span class="p">(</span><span class="n">Instruction</span>::<span class="n">new_with_bytes</span><span class="p">(</span>
<a href="#__codelineno-29-68" id="__codelineno-29-68" name="__codelineno-29-68"></a><span class="w">            </span><span class="n">program_id</span><span class="p">,</span>
<a href="#__codelineno-29-69" id="__codelineno-29-69" name="__codelineno-29-69"></a><span class="w">            </span><span class="o">&amp;</span><span class="n">ix</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<a href="#__codelineno-29-70" id="__codelineno-29-70" name="__codelineno-29-70"></a><span class="w">            </span><span class="n">reg_accounts</span><span class="p">.</span><span class="n">to_account_metas</span><span class="p">(</span><span class="nb">None</span><span class="p">),</span>
<a href="#__codelineno-29-71" id="__codelineno-29-71" name="__codelineno-29-71"></a><span class="w">        </span><span class="p">))</span>
<a href="#__codelineno-29-72" id="__codelineno-29-72" name="__codelineno-29-72"></a><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-73" id="__codelineno-29-73" name="__codelineno-29-73"></a>
<a href="#__codelineno-29-74" id="__codelineno-29-74" name="__codelineno-29-74"></a><span class="w">    </span><span class="c1">// -------------------------------------------------------------------------</span>
<a href="#__codelineno-29-75" id="__codelineno-29-75" name="__codelineno-29-75"></a><span class="w">    </span><span class="c1">// [setup env] deposits 1_000</span>
<a href="#__codelineno-29-76" id="__codelineno-29-76" name="__codelineno-29-76"></a><span class="w">    </span><span class="c1">// -------------------------------------------------------------------------</span>
<a href="#__codelineno-29-77" id="__codelineno-29-77" name="__codelineno-29-77"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payer_token_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span><span class="p">.</span><span class="n">add_token_account</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mint</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">payer</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-78" id="__codelineno-29-78" name="__codelineno-29-78"></a><span class="w">    </span><span class="n">chall</span>
<a href="#__codelineno-29-79" id="__codelineno-29-79" name="__codelineno-29-79"></a><span class="w">        </span><span class="p">.</span><span class="n">mint_to</span><span class="p">(</span><span class="mi">1_000_</span><span class="k">u64</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mint</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">payer_token_account</span><span class="p">)</span>
<a href="#__codelineno-29-80" id="__codelineno-29-80" name="__codelineno-29-80"></a><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-81" id="__codelineno-29-81" name="__codelineno-29-81"></a>
<a href="#__codelineno-29-82" id="__codelineno-29-82" name="__codelineno-29-82"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span>
<a href="#__codelineno-29-83" id="__codelineno-29-83" name="__codelineno-29-83"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">org_name</span><span class="p">.</span><span class="n">clone</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="n">employee_id</span><span class="p">.</span><span class="n">clone</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">()],</span>
<a href="#__codelineno-29-84" id="__codelineno-29-84" name="__codelineno-29-84"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">program_id</span><span class="p">,</span>
<a href="#__codelineno-29-85" id="__codelineno-29-85" name="__codelineno-29-85"></a><span class="w">    </span><span class="p">)</span>
<a href="#__codelineno-29-86" id="__codelineno-29-86" name="__codelineno-29-86"></a><span class="w">    </span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-29-87" id="__codelineno-29-87" name="__codelineno-29-87"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">instruction</span>::<span class="n">Deposit</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-88" id="__codelineno-29-88" name="__codelineno-29-88"></a><span class="w">        </span><span class="n">org_name</span>: <span class="nc">org_name</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-29-89" id="__codelineno-29-89" name="__codelineno-29-89"></a><span class="w">        </span><span class="n">employee_id</span>: <span class="nc">employee_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<a href="#__codelineno-29-90" id="__codelineno-29-90" name="__codelineno-29-90"></a><span class="w">        </span><span class="n">amount</span>: <span class="mi">500_</span><span class="k">u64</span><span class="p">,</span>
<a href="#__codelineno-29-91" id="__codelineno-29-91" name="__codelineno-29-91"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-29-92" id="__codelineno-29-92" name="__codelineno-29-92"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ix_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">accounts</span>::<span class="n">Deposit</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-93" id="__codelineno-29-93" name="__codelineno-29-93"></a><span class="w">        </span><span class="n">vault</span><span class="p">,</span>
<a href="#__codelineno-29-94" id="__codelineno-29-94" name="__codelineno-29-94"></a><span class="w">        </span><span class="n">employee_record</span><span class="p">,</span>
<a href="#__codelineno-29-95" id="__codelineno-29-95" name="__codelineno-29-95"></a><span class="w">        </span><span class="n">reserve</span><span class="p">,</span>
<a href="#__codelineno-29-96" id="__codelineno-29-96" name="__codelineno-29-96"></a><span class="w">        </span><span class="n">user_token_account</span>: <span class="nc">payer_token_account</span><span class="p">,</span>
<a href="#__codelineno-29-97" id="__codelineno-29-97" name="__codelineno-29-97"></a><span class="w">        </span><span class="n">mint</span><span class="p">,</span>
<a href="#__codelineno-29-98" id="__codelineno-29-98" name="__codelineno-29-98"></a><span class="w">        </span><span class="n">user</span>: <span class="nc">payer</span><span class="p">,</span>
<a href="#__codelineno-29-99" id="__codelineno-29-99" name="__codelineno-29-99"></a><span class="w">        </span><span class="n">token_program</span>: <span class="nc">spl_token</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-100" id="__codelineno-29-100" name="__codelineno-29-100"></a><span class="w">        </span><span class="n">system_program</span>: <span class="nc">solana_program</span>::<span class="n">system_program</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-101" id="__codelineno-29-101" name="__codelineno-29-101"></a><span class="w">        </span><span class="n">rent</span>: <span class="nc">solana_program</span>::<span class="n">sysvar</span>::<span class="n">rent</span>::<span class="n">ID</span><span class="p">,</span>
<a href="#__codelineno-29-102" id="__codelineno-29-102" name="__codelineno-29-102"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-29-103" id="__codelineno-29-103" name="__codelineno-29-103"></a><span class="w">    </span><span class="n">chall</span>
<a href="#__codelineno-29-104" id="__codelineno-29-104" name="__codelineno-29-104"></a><span class="w">        </span><span class="p">.</span><span class="n">run_ix</span><span class="p">(</span><span class="n">Instruction</span>::<span class="n">new_with_bytes</span><span class="p">(</span>
<a href="#__codelineno-29-105" id="__codelineno-29-105" name="__codelineno-29-105"></a><span class="w">            </span><span class="n">program_id</span><span class="p">,</span>
<a href="#__codelineno-29-106" id="__codelineno-29-106" name="__codelineno-29-106"></a><span class="w">            </span><span class="o">&amp;</span><span class="n">ix</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<a href="#__codelineno-29-107" id="__codelineno-29-107" name="__codelineno-29-107"></a><span class="w">            </span><span class="n">ix_accounts</span><span class="p">.</span><span class="n">to_account_metas</span><span class="p">(</span><span class="nb">None</span><span class="p">),</span>
<a href="#__codelineno-29-108" id="__codelineno-29-108" name="__codelineno-29-108"></a><span class="w">        </span><span class="p">))</span>
<a href="#__codelineno-29-109" id="__codelineno-29-109" name="__codelineno-29-109"></a><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-110" id="__codelineno-29-110" name="__codelineno-29-110"></a>
<a href="#__codelineno-29-111" id="__codelineno-29-111" name="__codelineno-29-111"></a><span class="w">    </span><span class="c1">// TDOD: comment out</span>
<a href="#__codelineno-29-112" id="__codelineno-29-112" name="__codelineno-29-112"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span><span class="p">.</span><span class="n">read_token_account</span><span class="p">(</span><span class="n">reserve</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-113" id="__codelineno-29-113" name="__codelineno-29-113"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reserve_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reserve_account</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
<a href="#__codelineno-29-114" id="__codelineno-29-114" name="__codelineno-29-114"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span>
<a href="#__codelineno-29-115" id="__codelineno-29-115" name="__codelineno-29-115"></a><span class="w">        </span><span class="s">"</span><span class="se">\n</span><span class="s">vault = {}</span><span class="se">\n</span><span class="s">reserve balance = {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a href="#__codelineno-29-116" id="__codelineno-29-116" name="__codelineno-29-116"></a><span class="w">        </span><span class="n">vault</span><span class="p">,</span><span class="w"> </span><span class="n">reserve_balance</span>
<a href="#__codelineno-29-117" id="__codelineno-29-117" name="__codelineno-29-117"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-29-118" id="__codelineno-29-118" name="__codelineno-29-118"></a><span class="w">    </span><span class="c1">// ----------------------------------------------------------------------------</span>
<a href="#__codelineno-29-119" id="__codelineno-29-119" name="__codelineno-29-119"></a><span class="w">    </span><span class="c1">// [setup env] done</span>
<a href="#__codelineno-29-120" id="__codelineno-29-120" name="__codelineno-29-120"></a><span class="w">    </span><span class="c1">// ----------------------------------------------------------------------------</span>
<a href="#__codelineno-29-121" id="__codelineno-29-121" name="__codelineno-29-121"></a>
<a href="#__codelineno-29-122" id="__codelineno-29-122" name="__codelineno-29-122"></a>
<a href="#__codelineno-29-123" id="__codelineno-29-123" name="__codelineno-29-123"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">init_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100_</span><span class="k">u64</span><span class="p">;</span>
<a href="#__codelineno-29-124" id="__codelineno-29-124" name="__codelineno-29-124"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user_record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">program_id</span><span class="p">).</span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-29-125" id="__codelineno-29-125" name="__codelineno-29-125"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user_token_account_pubkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span><span class="p">.</span><span class="n">add_token_account</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mint</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-126" id="__codelineno-29-126" name="__codelineno-29-126"></a><span class="w">    </span><span class="n">chall</span>
<a href="#__codelineno-29-127" id="__codelineno-29-127" name="__codelineno-29-127"></a><span class="w">        </span><span class="p">.</span><span class="n">mint_to</span><span class="p">(</span><span class="n">init_amount</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mint</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user_token_account_pubkey</span><span class="p">)</span>
<a href="#__codelineno-29-128" id="__codelineno-29-128" name="__codelineno-29-128"></a><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-129" id="__codelineno-29-129" name="__codelineno-29-129"></a>
<a href="#__codelineno-29-130" id="__codelineno-29-130" name="__codelineno-29-130"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-131" id="__codelineno-29-131" name="__codelineno-29-131"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user_record: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">user_record</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-132" id="__codelineno-29-132" name="__codelineno-29-132"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"catalog: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">catalog</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-133" id="__codelineno-29-133" name="__codelineno-29-133"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"mint: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">mint</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-134" id="__codelineno-29-134" name="__codelineno-29-134"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"user_token_account: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">user_token_account_pubkey</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-135" id="__codelineno-29-135" name="__codelineno-29-135"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"reserve: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">reserve</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-136" id="__codelineno-29-136" name="__codelineno-29-136"></a>
<a href="#__codelineno-29-137" id="__codelineno-29-137" name="__codelineno-29-137"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bump_budget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ComputeBudgetInstruction</span>::<span class="n">request_units</span><span class="p">(</span><span class="mi">10_000_000</span><span class="k">u32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="k">u32</span><span class="p">);</span>
<a href="#__codelineno-29-138" id="__codelineno-29-138" name="__codelineno-29-138"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">solve_ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span><span class="p">.</span><span class="n">read_instruction</span><span class="p">(</span><span class="n">solve_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-139" id="__codelineno-29-139" name="__codelineno-29-139"></a><span class="w">    </span><span class="n">chall</span>
<a href="#__codelineno-29-140" id="__codelineno-29-140" name="__codelineno-29-140"></a><span class="w">        </span><span class="p">.</span><span class="n">run_ixs_full</span><span class="p">(</span>
<a href="#__codelineno-29-141" id="__codelineno-29-141" name="__codelineno-29-141"></a><span class="w">            </span><span class="o">&amp;</span><span class="p">[</span><span class="n">bump_budget</span><span class="p">,</span><span class="w"> </span><span class="n">solve_ix</span><span class="p">],</span>
<a href="#__codelineno-29-142" id="__codelineno-29-142" name="__codelineno-29-142"></a><span class="w">            </span><span class="o">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">user_keypair</span><span class="p">],</span>
<a href="#__codelineno-29-143" id="__codelineno-29-143" name="__codelineno-29-143"></a><span class="w">            </span><span class="o">&amp;</span><span class="n">user_keypair</span><span class="p">.</span><span class="n">pubkey</span><span class="p">(),</span>
<a href="#__codelineno-29-144" id="__codelineno-29-144" name="__codelineno-29-144"></a><span class="w">        </span><span class="p">)</span>
<a href="#__codelineno-29-145" id="__codelineno-29-145" name="__codelineno-29-145"></a><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-146" id="__codelineno-29-146" name="__codelineno-29-146"></a>
<a href="#__codelineno-29-147" id="__codelineno-29-147" name="__codelineno-29-147"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user_token_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span><span class="p">.</span><span class="n">read_token_account</span><span class="p">(</span><span class="n">user_token_account_pubkey</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-148" id="__codelineno-29-148" name="__codelineno-29-148"></a><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span>
<a href="#__codelineno-29-149" id="__codelineno-29-149" name="__codelineno-29-149"></a><span class="w">        </span><span class="n">socket</span><span class="p">,</span>
<a href="#__codelineno-29-150" id="__codelineno-29-150" name="__codelineno-29-150"></a><span class="w">        </span><span class="s">"player_account_amount: {:?}"</span><span class="p">,</span>
<a href="#__codelineno-29-151" id="__codelineno-29-151" name="__codelineno-29-151"></a><span class="w">        </span><span class="n">user_token_account</span><span class="p">.</span><span class="n">amount</span>
<a href="#__codelineno-29-152" id="__codelineno-29-152" name="__codelineno-29-152"></a><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-153" id="__codelineno-29-153" name="__codelineno-29-153"></a>
<a href="#__codelineno-29-154" id="__codelineno-29-154" name="__codelineno-29-154"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span>
<a href="#__codelineno-29-155" id="__codelineno-29-155" name="__codelineno-29-155"></a><span class="w">        </span><span class="s">"</span><span class="se">\n</span><span class="s">player_account_amount balance = {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a href="#__codelineno-29-156" id="__codelineno-29-156" name="__codelineno-29-156"></a><span class="w">        </span><span class="n">user_token_account</span><span class="p">.</span><span class="n">amount</span>
<a href="#__codelineno-29-157" id="__codelineno-29-157" name="__codelineno-29-157"></a><span class="w">    </span><span class="p">);</span>
<a href="#__codelineno-29-158" id="__codelineno-29-158" name="__codelineno-29-158"></a>
<a href="#__codelineno-29-159" id="__codelineno-29-159" name="__codelineno-29-159"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">user_token_account</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">init_amount</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-160" id="__codelineno-29-160" name="__codelineno-29-160"></a><span class="w">        </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"congrats!"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-161" id="__codelineno-29-161" name="__codelineno-29-161"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">"FLAG"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-162" id="__codelineno-29-162" name="__codelineno-29-162"></a><span class="w">            </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"flag: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-163" id="__codelineno-29-163" name="__codelineno-29-163"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-164" id="__codelineno-29-164" name="__codelineno-29-164"></a><span class="w">            </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">"flag not found, please contact admin"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-29-165" id="__codelineno-29-165" name="__codelineno-29-165"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-29-166" id="__codelineno-29-166" name="__codelineno-29-166"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-29-167" id="__codelineno-29-167" name="__codelineno-29-167"></a>
<a href="#__codelineno-29-168" id="__codelineno-29-168" name="__codelineno-29-168"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-29-169" id="__codelineno-29-169" name="__codelineno-29-169"></a><span class="p">}</span>
</code></pre></div>
</details>
<ul>
<li>读取题目合约和用户输入合约</li>
<li>增加<span><span class="heti-spacing"> </span>mint</span>、payer、<span>user<span class="heti-spacing"> </span></span>账户<ul>
<li>初始给<span><span class="heti-spacing"> </span>user 100_000_000_000 lamports</span></li>
</ul>
</li>
<li>获取属于题目合约的<span class="heti-skip"><span class="heti-spacing"> </span>catalog<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>reserve PDA</span></li>
<li>调用题目合约的<span class="heti-skip"><span class="heti-spacing"> </span>Initialize<span class="heti-spacing"> </span></span>指令</li>
<li>调用<span><span class="heti-spacing"> </span>Register</span>，<span>org_name<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>employee_id<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>("product", "employ_A")</span></li>
<li>创建<span><span class="heti-spacing"> </span>payer_token_account</span>，初始给其<span><span class="heti-spacing"> </span>1000 token</span></li>
<li>获取<span class="heti-skip"><span class="heti-spacing"> </span>seed ("product", "employ_A")<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>PDA<span class="heti-spacing"> </span></span>作为<span><span class="heti-spacing"> </span>vault</span>，调用<span><span class="heti-spacing"> </span>Deposit</span>，<span>amount<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>500 token</span></li>
<li>创建<span class="heti-skip"><span class="heti-spacing"> </span>user_record<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>user_token_account</span>，向其中初始转<span><span class="heti-spacing"> </span>100 token</span></li>
<li>输出一系列<span><span class="heti-spacing"> </span>pubkey</span></li>
<li>读取指令，调用用户合约</li>
<li>获取<span class="heti-skip"><span class="heti-spacing"> </span>user_token_account<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>token<span class="heti-spacing"> </span></span>个数，如果多于<span class="heti-skip"><span class="heti-spacing"> </span>100<span class="heti-spacing"> </span></span>个则输出<span><span class="heti-spacing"> </span>flag</span></li>
</ul>
<h3 id="_3">做法<a class="headerlink" href="#_3" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p>这题的答题交互也给了，是<span class="heti-skip"><span class="heti-spacing"> </span>rust<span class="heti-spacing"> </span></span>代码，写好了直接改下<span class="heti-skip"><span class="heti-spacing"> </span>tcp<span class="heti-spacing"> </span></span>地址然后<span class="heti-skip"><span class="heti-spacing"> </span>cargo run<span class="heti-spacing"> </span></span>就可以打了。</p>
<p>主要的解法还是在<span class="heti-skip"><span class="heti-spacing"> </span>solve/programs/solve/src/lib.rs<span class="heti-spacing"> </span></span>中编写。</p>
<p>题给了一个初始化指令和其结构体的定义，在里面补充就可以。原有的是一个调用<span class="heti-skip"><span class="heti-spacing"> </span>Register<span class="heti-spacing"> </span></span>的代码，<span>register<span class="heti-spacing"> </span></span>了<span class="heti-skip"><span class="heti-spacing"> </span>("product", "employ_B")<span class="heti-spacing"> </span></span>这个<span><span class="heti-spacing"> </span>record</span>。</p>
<p>找了很长时间没看出漏洞在哪。但<span class="heti-skip"><span class="heti-spacing"> </span>solana<span class="heti-spacing"> </span></span>的官方文档中<a href="https://docs.solana.com/developing/programming-model/calling-between-programs#hash-based-generated-program-addresses">关于<span class="heti-skip"><span class="heti-spacing"> </span>PDA seed<span class="heti-spacing"> </span></span>的描述</a>里面有一个<span><span class="heti-spacing"> </span>warning</span>：</p>
<blockquote>
<p><strong>Warning:</strong> Because of the way the seeds are hashed there is a potential for program address collisions for the same program id. The seeds are hashed sequentially which means that seeds {"abcdef"}, {"abc", "def"}, and {"ab", "cd", "ef"} will all result in the same program address given the same program id. Since the chance of collision is local to a given program id, the developer of that program must take care to choose seeds that do not collide with each other. For seed schemes that are susceptible to this type of hash collision, a common remedy is to insert separators between seeds, e.g. transforming {"abc", "def"} into {"abc", "-", "def"}.</p>
</blockquote>
<p>大体意思就是，如果<span class="heti-skip"><span class="heti-spacing"> </span>seed<span class="heti-spacing"> </span></span>有多个的话，计算的时候是直接拼接起来的，<span>["abcdef"]<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>["abc", "def"]</span>、<span>["ab", "cdef"]<span class="heti-spacing"> </span></span>算出来的<span class="heti-skip"><span class="heti-spacing"> </span>PDA<span class="heti-spacing"> </span></span>是一样的。</p>
<p>而题目中获取<span class="heti-skip"><span class="heti-spacing"> </span>vault<span class="heti-spacing"> </span></span>用的<span class="heti-skip"><span class="heti-spacing"> </span>seed<span class="heti-spacing"> </span></span>是<span><span class="heti-spacing"> </span>[org_name, employee_id]</span>，这里就存在了拼接。既然我们不能使用同样的<span class="heti-skip"><span class="heti-spacing"> </span>(org_name, employee_id)<span class="heti-spacing"> </span></span>来注册、获取到其记录有<span class="heti-skip"><span class="heti-spacing"> </span>500 token<span class="heti-spacing"> </span></span>的<span><span class="heti-spacing"> </span>vault</span>，但我们可以用另一对<span class="heti-skip"><span class="heti-spacing"> </span>(org_name, employee_id)<span class="heti-spacing"> </span></span>来完成注册、并在<span class="heti-skip"><span class="heti-spacing"> </span>withdraw<span class="heti-spacing"> </span></span>获取<span class="heti-skip"><span class="heti-spacing"> </span>vault<span class="heti-spacing"> </span></span>的时候使其拼接起来和题目中的一样来获取到那个<span class="heti-skip"><span class="heti-spacing"> </span>500 token<span class="heti-spacing"> </span></span>的<span><span class="heti-spacing"> </span>vault</span>。</p>
<p>所以我们注册一个<span class="heti-skip"><span class="heti-spacing"> </span>("produc", "temploy_A")<span class="heti-spacing"> </span></span>然后直接<span class="heti-skip"><span class="heti-spacing"> </span>withdraw<span class="heti-spacing"> </span></span>就可以了：</p>
<details class="success" open="open">
<summary><span>exp<span class="heti-spacing"> </span></span>合约<span class="heti-skip"><span class="heti-spacing"> </span>initialize<span class="heti-spacing"> </span></span>指令</summary>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">Initialize</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a>
<a href="#__codelineno-30-3" id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"produc"</span><span class="p">);</span>
<a href="#__codelineno-30-4" id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"temploy_A"</span><span class="p">);</span>
<a href="#__codelineno-30-5" id="__codelineno-30-5" name="__codelineno-30-5"></a>
<a href="#__codelineno-30-6" id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">accounts</span>::<span class="n">Register</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-30-7" id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="w">        </span><span class="n">catalog</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">catalog</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-8" id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">        </span><span class="n">employee_record</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user_record</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-9" id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">        </span><span class="n">user</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-10" id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">        </span><span class="n">system_program</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">system_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-11" id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">        </span><span class="n">rent</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">rent</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-12" id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-30-13" id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CpiContext</span>::<span class="n">new</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">chall</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="p">);</span>
<a href="#__codelineno-30-14" id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="w">    </span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">register</span><span class="p">(</span><span class="n">cpi_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">o1</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-30-15" id="__codelineno-30-15" name="__codelineno-30-15"></a>
<a href="#__codelineno-30-16" id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"produc"</span><span class="p">);</span>
<a href="#__codelineno-30-17" id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"temploy_A"</span><span class="p">);</span>
<a href="#__codelineno-30-18" id="__codelineno-30-18" name="__codelineno-30-18"></a>
<a href="#__codelineno-30-19" id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">accounts</span>::<span class="n">Withdraw</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-30-20" id="__codelineno-30-20" name="__codelineno-30-20"></a><span class="w">        </span><span class="n">vault</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">vault</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-21" id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">        </span><span class="n">employee_record</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user_record</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-22" id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="w">        </span><span class="n">reserve</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">reserve</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-23" id="__codelineno-30-23" name="__codelineno-30-23"></a><span class="w">        </span><span class="n">user_account</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user_token_account</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-24" id="__codelineno-30-24" name="__codelineno-30-24"></a><span class="w">        </span><span class="n">mint</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">mint</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-25" id="__codelineno-30-25" name="__codelineno-30-25"></a><span class="w">        </span><span class="n">payer</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-26" id="__codelineno-30-26" name="__codelineno-30-26"></a><span class="w">        </span><span class="n">token_program</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">token_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-27" id="__codelineno-30-27" name="__codelineno-30-27"></a><span class="w">        </span><span class="n">system_program</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">system_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-28" id="__codelineno-30-28" name="__codelineno-30-28"></a><span class="w">        </span><span class="n">rent</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">rent</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span>
<a href="#__codelineno-30-29" id="__codelineno-30-29" name="__codelineno-30-29"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-30-30" id="__codelineno-30-30" name="__codelineno-30-30"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CpiContext</span>::<span class="n">new</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">chall</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="p">);</span>
<a href="#__codelineno-30-31" id="__codelineno-30-31" name="__codelineno-30-31"></a><span class="w">    </span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">withdraw</span><span class="p">(</span><span class="n">cpi_ctx</span><span class="p">,</span><span class="w"> </span><span class="n">o1</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a href="#__codelineno-30-32" id="__codelineno-30-32" name="__codelineno-30-32"></a>
<a href="#__codelineno-30-33" id="__codelineno-30-33" name="__codelineno-30-33"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a href="#__codelineno-30-34" id="__codelineno-30-34" name="__codelineno-30-34"></a><span class="p">}</span>
</code></pre></div>
</details>
<p>然后交互的<span class="heti-skip"><span class="heti-spacing"> </span>main.rs<span class="heti-spacing"> </span></span>中还有一处获取参数<span class="heti-skip"><span class="heti-spacing"> </span>vault<span class="heti-spacing"> </span></span>的地方也需要改一下：
</p><div class="highlight"><pre><span></span><code><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">vault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span>
<a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="s">b"produc"</span><span class="p">,</span><span class="w"> </span><span class="s">b"temploy_A"</span><span class="p">],</span>
<a href="#__codelineno-31-3" id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">chall_id</span><span class="p">,</span>
<a href="#__codelineno-31-4" id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">    </span><span class="p">).</span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
<p>其它沿用给的交互就可以了。这样<span class="heti-skip"><span class="heti-spacing"> </span>main.rs<span class="heti-spacing"> </span></span>中输入指令，调用<span class="heti-skip"><span class="heti-spacing"> </span>exp<span class="heti-spacing"> </span></span>合约的<span class="heti-skip"><span class="heti-spacing"> </span>Initialize<span class="heti-spacing"> </span></span>指令，其中<span class="heti-skip"><span class="heti-spacing"> </span>withdraw<span class="heti-spacing"> </span></span>了，结束后检查<span class="heti-skip"><span class="heti-spacing"> </span>token amount<span class="heti-spacing"> </span></span>就会比原先更多了。</p>
<p>flag: <strong>n1ctf{I_sh0uld_h4ve_ch0s3n_4_b3tt3r_se3d_de5ign}</strong></p>
<hr/>
<h2 id="just-find-flag">just find flag<a class="headerlink" href="#just-find-flag" title="Permanent link">¶</a></h2>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="https://img.shields.io/badge/-MISC-informational?style=flat-square"><img alt="" src="https://img.shields.io/badge/-MISC-informational?style=flat-square"/></a></p>
<p>一道<span class="heti-skip"><span class="heti-spacing"> </span>Windows<span class="heti-spacing"> </span></span>内存取证题，差了一步没做出来。结束后补完了。</p>
<p>内存取证直接上手先<span class="heti-skip"><span class="heti-spacing"> </span>strings<span class="heti-spacing"> </span></span>一把梭，发现了<span><span class="heti-spacing"> </span>flag.zip</span>、flag.txt。是一个压缩包，直接从十六进制里把它完整内容扒出来，发现有密码，而且是真密码，六位数密码爆不出来。</p>
<p>继续<span class="heti-skip"><span class="heti-spacing"> </span>volatility<span class="heti-spacing"> </span></span>一把梭，<span>imageinfo<span class="heti-spacing"> </span></span>出来是<span class="heti-skip"><span class="heti-spacing"> </span>Win7<span class="heti-spacing"> </span></span>系统，一些没用的指令输出就不在这里写了</p>
<p>在执行<span class="heti-skip"><span class="heti-spacing"> </span>consoles<span class="heti-spacing"> </span></span>指令的时候发现了：
</p><div class="highlight"><pre><span></span><code><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a>**************************************************
<a href="#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a>ConsoleProcess: conhost.exe Pid: 2480
<a href="#__codelineno-32-3" id="__codelineno-32-3" name="__codelineno-32-3"></a>Console: 0xff656200 CommandHistorySize: 50
<a href="#__codelineno-32-4" id="__codelineno-32-4" name="__codelineno-32-4"></a>HistoryBufferCount: 2 HistoryBufferMax: 4
<a href="#__codelineno-32-5" id="__codelineno-32-5" name="__codelineno-32-5"></a>OriginalTitle: %SystemRoot%\system32\cmd.exe
<a href="#__codelineno-32-6" id="__codelineno-32-6" name="__codelineno-32-6"></a>Title: C:\Windows\system32\cmd.exe - C:\Python27\python.exe  -m SimpleHTTPServer
<a href="#__codelineno-32-7" id="__codelineno-32-7" name="__codelineno-32-7"></a>AttachedProcess: python.exe Pid: 2052 Handle: 0x8c
<a href="#__codelineno-32-8" id="__codelineno-32-8" name="__codelineno-32-8"></a>AttachedProcess: cmd.exe Pid: 2336 Handle: 0x60
<a href="#__codelineno-32-9" id="__codelineno-32-9" name="__codelineno-32-9"></a>----
<a href="#__codelineno-32-10" id="__codelineno-32-10" name="__codelineno-32-10"></a>CommandHistory: 0x37ed10 Application: python.exe Flags: Allocated
<a href="#__codelineno-32-11" id="__codelineno-32-11" name="__codelineno-32-11"></a>CommandCount: 0 LastAdded: -1 LastDisplayed: -1
<a href="#__codelineno-32-12" id="__codelineno-32-12" name="__codelineno-32-12"></a>FirstCommand: 0 CommandCountMax: 50
<a href="#__codelineno-32-13" id="__codelineno-32-13" name="__codelineno-32-13"></a>ProcessHandle: 0x8c
<a href="#__codelineno-32-14" id="__codelineno-32-14" name="__codelineno-32-14"></a>----
<a href="#__codelineno-32-15" id="__codelineno-32-15" name="__codelineno-32-15"></a>CommandHistory: 0x37e9c0 Application: cmd.exe Flags: Allocated, Reset
<a href="#__codelineno-32-16" id="__codelineno-32-16" name="__codelineno-32-16"></a>CommandCount: 3 LastAdded: 2 LastDisplayed: 2
<a href="#__codelineno-32-17" id="__codelineno-32-17" name="__codelineno-32-17"></a>FirstCommand: 0 CommandCountMax: 50
<a href="#__codelineno-32-18" id="__codelineno-32-18" name="__codelineno-32-18"></a>ProcessHandle: 0x60
<a href="#__codelineno-32-19" id="__codelineno-32-19" name="__codelineno-32-19"></a>Cmd #0 at 0x382d60: echo "Stucked? You can ask WallPaper god for help."
<a href="#__codelineno-32-20" id="__codelineno-32-20" name="__codelineno-32-20"></a>Cmd #1 at 0x35e3a0: cd Desktop
<a href="#__codelineno-32-21" id="__codelineno-32-21" name="__codelineno-32-21"></a>Cmd #2 at 0x382dd0: C:\Python27\python.exe -m SimpleHTTPServer
<a href="#__codelineno-32-22" id="__codelineno-32-22" name="__codelineno-32-22"></a>----
<a href="#__codelineno-32-23" id="__codelineno-32-23" name="__codelineno-32-23"></a>Screen 0x360f70 X:80 Y:300
<a href="#__codelineno-32-24" id="__codelineno-32-24" name="__codelineno-32-24"></a>Dump:
<a href="#__codelineno-32-25" id="__codelineno-32-25" name="__codelineno-32-25"></a>Microsoft Windows [Version 6.1.7601]
<a href="#__codelineno-32-26" id="__codelineno-32-26" name="__codelineno-32-26"></a>Copyright (c) 2009 Microsoft Corporation.  All rights reserved.
<a href="#__codelineno-32-27" id="__codelineno-32-27" name="__codelineno-32-27"></a>
<a href="#__codelineno-32-28" id="__codelineno-32-28" name="__codelineno-32-28"></a>C:\Users\dora&gt;echo "Stucked? You can ask WallPaper god for help."
<a href="#__codelineno-32-29" id="__codelineno-32-29" name="__codelineno-32-29"></a>"Stucked? You can ask WallPaper god for help."
<a href="#__codelineno-32-30" id="__codelineno-32-30" name="__codelineno-32-30"></a>
<a href="#__codelineno-32-31" id="__codelineno-32-31" name="__codelineno-32-31"></a>C:\Users\dora&gt;cd Desktop
<a href="#__codelineno-32-32" id="__codelineno-32-32" name="__codelineno-32-32"></a>
<a href="#__codelineno-32-33" id="__codelineno-32-33" name="__codelineno-32-33"></a>C:\Users\dora\Desktop&gt;C:\Python27\python.exe -m SimpleHTTPServer
<a href="#__codelineno-32-34" id="__codelineno-32-34" name="__codelineno-32-34"></a>Serving HTTP on 0.0.0.0 port 8000 ...
<a href="#__codelineno-32-35" id="__codelineno-32-35" name="__codelineno-32-35"></a>192.168.17.129 - - [05/Nov/2022 03:08:43] "GET /mem.zip HTTP/1.1" 200 -
</code></pre></div>
有一句 "Stucked? You can ask WallPaper god for help."。所以在 strings 里面再搜 Wallpaper，发现有相关文件，继续 volatility 梭：
<div class="highlight"><pre><span></span><code><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a>volatility<span class="w"> </span>-f<span class="w"> </span>mem.raw<span class="w"> </span>--profile<span class="o">=</span>Win7SP1x64<span class="w"> </span>filescan<span class="w"> </span>&gt;<span class="w"> </span>files.txt
</code></pre></div>
有很多很多文件，在里面搜一下发现了两个 Wallpaper 路径下的文件：
<div class="highlight"><pre><span></span><code><a href="#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a>Offset(P)            #Ptr   #Hnd Access Name
<a href="#__codelineno-34-2" id="__codelineno-34-2" name="__codelineno-34-2"></a>------------------ ------ ------ ------ ----
<a href="#__codelineno-34-3" id="__codelineno-34-3" name="__codelineno-34-3"></a>...
<a href="#__codelineno-34-4" id="__codelineno-34-4" name="__codelineno-34-4"></a>0x000000007eee11c0     10      0 R--r-- \Device\HarddiskVolume1\Windows\Web\Wallpaper\Windows\img0.jpg
<a href="#__codelineno-34-5" id="__codelineno-34-5" name="__codelineno-34-5"></a>...
<a href="#__codelineno-34-6" id="__codelineno-34-6" name="__codelineno-34-6"></a>0x000000007fc48f20     16      0 R--r-d \Device\HarddiskVolume1\Windows\Web\Wallpaper\Windows\img0.jpeg
<a href="#__codelineno-34-7" id="__codelineno-34-7" name="__codelineno-34-7"></a>...
</code></pre></div>
然后分别用 <code>volatility -f mem.raw --profile=Win7SP1x64 dumpfiles -Q &lt;Offset&gt; --dump-dir=./</code> 提取，发现上面一张是 Win7 经典壁纸，下面一张是：
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/writeups/n1ctf2022/img1.jpeg"><img alt="" src="/assets/images/writeups/n1ctf2022/img1.jpeg"/></a>
<p>然后这里卡住了，找了很长时间也找不出他说的没有<span class="heti-skip"><span class="heti-spacing"> </span>Desktop<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>full path<span class="heti-spacing"> </span></span>是什么。</p>
<p>赛后听说是要用<span class="heti-skip"><span class="heti-spacing"> </span>volatility<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>mtfparser<span class="heti-spacing"> </span></span>指令，试了一下，确实是有的：
</p><div class="highlight"><pre><span></span><code><a href="#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a>volatility<span class="w"> </span>-f<span class="w"> </span>mem.raw<span class="w"> </span>--profile<span class="o">=</span>Win7SP1x64<span class="w"> </span>mftparser<span class="w"> </span>&gt;<span class="w"> </span>mftparser.txt
</code></pre></div>
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/writeups/n1ctf2022/img2.png"><img alt="" src="/assets/images/writeups/n1ctf2022/img2.png"/></a>
有个路径 <code>PROGRA~2\WINDOW~2\ACCESS~1\flag.zip</code>，可以推测出这个缩写实际上是 <code>C:\Program Files (x86)\Windows NT\Accessories\flag.zip</code>。所以压缩包的密码就是（<code>\f</code> 就是要这样放着不管，题目给了 note 了）：
<div class="highlight"><pre><span></span><code><a href="#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="sa">b</span><span class="s2">"C:\Program Files (x86)\Windows NT\Accessories</span><span class="se">\f</span><span class="s2">lag.zip"</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<a href="#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="c1"># 0d3ba7db468bdbd4f93a88c97ba7bef1</span>
</code></pre></div>
解压出来就是 flag 了。
<p>反正还是<span class="heti-skip"><span class="heti-spacing"> </span>volatility<span class="heti-spacing"> </span></span>不熟练，记下了。<span>Windows<span class="heti-spacing"> </span></span>下一些删掉了的文件可以尝试用<span class="heti-skip"><span class="heti-spacing"> </span>mtfparser<span class="heti-spacing"> </span></span>来搜一下。</p>
<hr/>
<div class="md-source-file">
<small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2022年11月7日 19:06:21</span>
<br/>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2022年11月7日 19:06:21</span>
</small>
</div>
<script async="" crossorigin="anonymous" data-category="General" data-category-id="DIC_kwDOGnfbUc4CPrf4" data-emit-metadata="0" data-input-position="bottom" data-lang="zh-CN" data-mapping="pathname" data-reactions-enabled="1" data-repo="TonyCrane/note" data-repo-id="R_kgDOGnfbUQ" data-theme="light" src="https://giscus.app/client.js">
</script>
<script>
                      if (document.querySelector("body").getAttribute("data-md-color-scheme") === "slate") {
                        var giscus = document.querySelector("script[src*=giscus]")
                        giscus.setAttribute("data-theme", "https://gcore.jsdelivr.net/gh/TonyCrane/note/docs/css/giscus.css") 
                      }
                    </script>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" data-md-state="hidden" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path></svg>
              回到页面顶部
            </a>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="上一页: USTC Hackergame 2022" class="md-footer__link md-footer__link--prev" href="../hackergame2022/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                上一页
              </span>
              USTC Hackergame 2022
            </div>
</div>
</a>
<a aria-label="下一页: SECCON 2022 Quals" class="md-footer__link md-footer__link--next" href="../seccon2022/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                下一页
              </span>
              SECCON 2022 Quals
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2022-2023 <a href="https://github.com/TonyCrane" rel="noopener" target="_blank">TonyCrane</a>
</div>
  
  
    Powered by
    <a href="https://www.mkdocs.org/" rel="noopener" target="_blank">
      MkDocs
    </a>
    with theme
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material
    </a>
    modified by
    <a href="https://github.com/TonyCrane" rel="noopener" target="_blank">
      TonyCrane
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/TonyCrane/" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
<a class="md-social__link" href="https://blog.tonycrane.cc/" rel="noopener" target="_blank" title="blog.tonycrane.cc">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg>
</a>
<a class="md-social__link" href="https://tonycrane.cc/" rel="noopener" target="_blank" title="tonycrane.cc">
<svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><path d="M280.37 148.26 96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47 488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top"], "search": "../../assets/javascripts/workers/search.361d90f1.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script>
<script src="https://cdn.tonycrane.cc/utils/katex.min.js"></script>
<script src="../../js/katex.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>
