
  <!doctype html>
  <html lang="zh" class="no-js">
    <head>
      
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        
          <meta name="description" content="鹤翔万里（TonyCrane）的笔记本">
        
        
        
          <link rel="canonical" href="https://note.tonycrane.cc/cs/pl/rust/basic/">
        
        <link rel="icon" href="../../../../assets/images/favicon.png">
        <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.1.4">
      
      
        
          <title>Rust 基础语法 - 鹤翔万里的笔记本</title>
        
      
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/main.bb3983ee.min.css">
        
          
          <link rel="stylesheet" href="../../../../assets/stylesheets/palette.e6a45f82.min.css">
          
        
      
      
      
        
          
          <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
          <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=JetBrains+Mono:300,400,400i,700%7CJetBrains+Mono&display=fallback">
          <style>:root{--md-text-font:"JetBrains Mono";--md-code-font:"JetBrains Mono"}</style>
        
      
      
        <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
      
        <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css">
      
        <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
      
        <link rel="stylesheet" href="../../../../css/tasklist.css">
      
        <link rel="stylesheet" href="../../../../css/custom.css">
      
        <link rel="stylesheet" href="../../../../css/card.css">
      
        <link rel="stylesheet" href="../../../../css/flink.css">
      
      
        <link rel="stylesheet" href="/css/counter.css">
      
      <script>__md_scope=new URL("../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
      
        
  


  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c273de7f67d992cb6aef08c3ddf09bb2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DYETCPM289"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-DYETCPM289",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DYETCPM289"></script>


      
      
    </head>
    
    
      
      
        
      
      
      
      
      <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
    
      <script src="../../../../js/scheme.js" type="text/javascript"></script>
      
      
        <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
      
      <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
      <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
      <label class="md-overlay" for="__drawer"></label>
      <div data-md-component="skip">
        
          
          <a href="#rust" class="md-skip">
            跳转至
          </a>
        
      </div>
      <div data-md-component="announce">
        
      </div>
      
      
        

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="鹤翔万里的笔记本" class="md-header__button md-logo" aria-label="鹤翔万里的笔记本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            鹤翔万里的笔记本
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Rust 基础语法
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon">
          <a
            href="javascript:toggleScheme();"
            title="Light mode"
            class="light-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
          </a>
          <a
            href="javascript:toggleScheme();"
            title="Dark mode"
            class="dark-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
          </a>
          <a
            href="javascript:toggleScheme();"
            title="System preference"
            class="system-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07 19.07 3.5m-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13.51 1.67m-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87.4 1.31M19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35-2.53-2.2m4.33-2.7 1.15-2.77 2.2 2.54-3.35.23m1.15-4.96-1.14-2.78 3.34.24-2.2 2.54M9.63 18.93l2.77 1.15-2.53 2.19-.24-3.34z"/></svg>
          </a>
           <a
            href="javascript:toggleScheme();"
            title="Unknown scheme"
            class="unknown-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m15.07 11.25-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41a2 2 0 0 0-2-2 2 2 0 0 0-2 2H8a4 4 0 0 1 4-4 4 4 0 0 1 4 4 3.2 3.2 0 0 1-.93 2.25M13 19h-2v-2h2M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-5.53-4.5-10-10-10z"/></svg>
          </a>
      </div>
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/TonyCrane/note/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    TonyCrane/note
  </div>
</a>
      </div>
    
  </nav>
  
</header>
      
      <div class="md-container" data-md-component="container">
        
        
          
            
              
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../" class="md-tabs__link md-tabs__link--active">
        Computer Science
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../ctf/" class="md-tabs__link">
        CTF
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../writeups/" class="md-tabs__link">
        Writeups
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../others/" class="md-tabs__link">
        Others
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../links/" class="md-tabs__link">
        Links
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
            
          
        
        <main class="md-main" data-md-component="main">
          <div class="md-main__inner md-grid">
            
              
                <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                  <div class="md-sidebar__scrollwrap">
                    <div class="md-sidebar__inner">
                      
                        

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="鹤翔万里的笔记本" class="md-nav__button md-logo" aria-label="鹤翔万里的笔记本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2z"/></svg>

    </a>
    鹤翔万里的笔记本
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/TonyCrane/note/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    TonyCrane/note
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../..">Home</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../">Computer Science</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Computer Science" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Computer Science
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">编程语言 & ISA</a>
          
            <label for="__nav_2_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="编程语言 & ISA" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          编程语言 & ISA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_2" type="checkbox" id="__nav_2_2_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../python/">Python</a>
          
            <label for="__nav_2_2_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Python" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_2">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../python/basic/" class="md-nav__link">
        Python 基础语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../python/numpy/" class="md-nav__link">
        NumPy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../python/pil/" class="md-nav__link">
        PIL
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_3" type="checkbox" id="__nav_2_2_3" checked>
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Rust</a>
          
            <label for="__nav_2_2_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Rust" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_3">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Rust 基础语法
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Rust 基础语法
      </a>
      
        
  
  <nav class="md-nav md-nav--secondary " aria-label="目录">
    
    
    
      
    
    
      <label class="md-nav__title" for="__toc">
        <span class="md-nav__icon md-icon"></span>
        目录
      </label>
      <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    变量
  </a>
  
    <nav class="md-nav" aria-label="变量">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    标识符命名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    变量绑定与可变性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    变量解构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    常量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    变量遮蔽
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    基本类型
  </a>
  
    <nav class="md-nav" aria-label="基本类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    整型
  </a>
  
    <nav class="md-nav" aria-label="整型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    布尔类型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    浮点型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    运算
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    序列
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    字符类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    单元类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    语句与表达式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    所有权与借用
  </a>
  
    <nav class="md-nav" aria-label="所有权与借用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    所有权
  </a>
  
    <nav class="md-nav" aria-label="所有权">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#string" class="md-nav__link">
    String 类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    所有权转移
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    函数传值与返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    引用与借用
  </a>
  
    <nav class="md-nav" aria-label="引用与借用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    避免悬垂引用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    复合类型
  </a>
  
    <nav class="md-nav" aria-label="复合类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    字符串
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    元组
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    结构体
  </a>
  
    <nav class="md-nav" aria-label="结构体">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    简化创建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    更新结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    元组结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    单元结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    打印结构体
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    枚举
  </a>
  
    <nav class="md-nav" aria-label="枚举">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option" class="md-nav__link">
    Option
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    数组
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    流程控制
  </a>
  
    <nav class="md-nav" aria-label="流程控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    分支
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    循环
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    模式匹配
  </a>
  
    <nav class="md-nav" aria-label="模式匹配">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#match" class="md-nav__link">
    match 语句
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-let-while-let" class="md-nav__link">
    if let / while let
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matches" class="md-nav__link">
    matches! 宏
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generics" class="md-nav__link">
    泛型 Generics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trait" class="md-nav__link">
    特征 Trait
  </a>
  
    <nav class="md-nav" aria-label="特征 Trait">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    特征对象
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    关联类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    默认泛型类型参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    同名方法调用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trait-trait" class="md-nav__link">
    trait 定义中的 trait 约束
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    绕过孤儿规则
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    集合类型
  </a>
  
    <nav class="md-nav" aria-label="集合类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector" class="md-nav__link">
    Vector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hashmap" class="md-nav__link">
    HashMap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    类型转换
  </a>
  
    <nav class="md-nav" aria-label="类型转换">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    方法调用时的强制类型转换
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    返回值与错误处理
  </a>
  
    <nav class="md-nav" aria-label="返回值与错误处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#panic" class="md-nav__link">
    panic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result" class="md-nav__link">
    Result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    包和模块
  </a>
  
    <nav class="md-nav" aria-label="包和模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crate-package" class="md-nav__link">
    crate 与 package
  </a>
  
    <nav class="md-nav" aria-label="crate 与 package">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package" class="md-nav__link">
    典型 package 结构
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module" class="md-nav__link">
    模块 Module
  </a>
  
    <nav class="md-nav" aria-label="模块 Module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    代码可见性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use" class="md-nav__link">
    use 引入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    使用第三方包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    受限可见性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    三种模块目录组织方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    注释与文档
  </a>
  
    <nav class="md-nav" aria-label="注释与文档">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    文档注释
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    格式化输出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    生命周期
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    闭包和迭代器
  </a>
  
    <nav class="md-nav" aria-label="闭包和迭代器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    闭包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    迭代器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    深入类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    智能指针
  </a>
  
    <nav class="md-nav" aria-label="智能指针">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deref-trait" class="md-nav__link">
    Deref trait
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drop-trait" class="md-nav__link">
    Drop trait
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box" class="md-nav__link">
    Box
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rc-arc" class="md-nav__link">
    Rc 与 Arc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cell-refcell" class="md-nav__link">
    Cell 与 RefCell
  </a>
  
    <nav class="md-nav" aria-label="Cell 与 RefCell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cell" class="md-nav__link">
    Cell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refcell" class="md-nav__link">
    RefCell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#weak" class="md-nav__link">
    Weak 弱引用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    多线程并发编程
  </a>
  
    <nav class="md-nav" aria-label="多线程并发编程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    使用线程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    全局变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    错误处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe" class="md-nav__link">
    unsafe
  </a>
  
    <nav class="md-nav" aria-label="unsafe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    解引用裸指针
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe_1" class="md-nav__link">
    调用 unsafe 或外部函数
  </a>
  
    <nav class="md-nav" aria-label="调用 unsafe 或外部函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsafe_2" class="md-nav__link">
    unsafe 函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffi" class="md-nav__link">
    FFI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe-trait" class="md-nav__link">
    实现 unsafe trait
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#union" class="md-nav__link">
    访问 union 中字段
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macro" class="md-nav__link">
    macro 宏编程
  </a>
  
    <nav class="md-nav" aria-label="macro 宏编程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    声明式宏
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    过程宏
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    测试
  </a>
  
    <nav class="md-nav" aria-label="测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    断言
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    编写测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    
  </nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        Rust 杂项随记
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../c_cpp/" class="md-nav__link">
        C/C++
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/" class="md-nav__link">
        Haskell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asm/" class="md-nav__link">
        x86 汇编语言
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_7" type="checkbox" id="__nav_2_2_7" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../riscv/">RISC-V ISA</a>
          
            <label for="__nav_2_2_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="RISC-V ISA" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_7">
          <span class="md-nav__icon md-icon"></span>
          RISC-V ISA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../riscv/unprivileged/" class="md-nav__link">
        RISC-V 非特权级 ISA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../riscv/privileged/" class="md-nav__link">
        RISC-V 特权级 ISA
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../system/">计算机系统</a>
          
            <label for="__nav_2_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="计算机系统" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          计算机系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_2" type="checkbox" id="__nav_2_3_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../system/cs1/">计算机系统 I</a>
          
            <label for="__nav_2_3_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="计算机系统 I" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_3_2">
          <span class="md-nav__icon md-icon"></span>
          计算机系统 I
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../system/cs1/topic1/" class="md-nav__link">
        数据的表示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../system/cs1/topic2/" class="md-nav__link">
        数字逻辑电路基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../system/cs1/topic3/" class="md-nav__link">
        组合逻辑电路设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../system/cs1/topic4/" class="md-nav__link">
        时序逻辑电路设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../system/cs1/topic5/" class="md-nav__link">
        指令集体系结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../system/cs1/topic6/" class="md-nav__link">
        处理器
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_3" type="checkbox" id="__nav_2_3_3" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../system/cs2/">计算机系统 II</a>
          
            <label for="__nav_2_3_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="计算机系统 II" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_3_3">
          <span class="md-nav__icon md-icon"></span>
          计算机系统 II
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../system/cs2/topic1/" class="md-nav__link">
        流水线 CPU
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../web/">网络相关</a>
          
            <label for="__nav_2_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="网络相关" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          网络相关
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4_2" type="checkbox" id="__nav_2_4_2" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../web/protocol/">网络协议</a>
          
            <label for="__nav_2_4_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="网络协议" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_4_2">
          <span class="md-nav__icon md-icon"></span>
          网络协议
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/protocol/vmess/" class="md-nav__link">
        VMess
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/svg/" class="md-nav__link">
        SVG
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/log4j_vuln/" class="md-nav__link">
        log4j 漏洞复现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_5">
          算法相关
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="算法相关" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          算法相关
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5_1" type="checkbox" id="__nav_2_5_1" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../algorithm/ds/">数据结构基础</a>
          
            <label for="__nav_2_5_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="数据结构基础" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_5_1">
          <span class="md-nav__icon md-icon"></span>
          数据结构基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../algorithm/ds/topic1/" class="md-nav__link">
        算法分析基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../algorithm/ds/topic2/" class="md-nav__link">
        列表、栈、队列
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_6">
          人工智能相关
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="人工智能相关" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          人工智能相关
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6_1" type="checkbox" id="__nav_2_6_1" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ai/basic/">人工智能基础</a>
          
            <label for="__nav_2_6_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="人工智能基础" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_6_1">
          <span class="md-nav__icon md-icon"></span>
          人工智能基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/basic/topic1/" class="md-nav__link">
        逻辑与推理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/basic/topic2/" class="md-nav__link">
        搜索求解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" type="checkbox" id="__nav_2_7" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../hpc/">高性能计算</a>
          
            <label for="__nav_2_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="高性能计算" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          高性能计算
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7_2" type="checkbox" id="__nav_2_7_2" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_7_2">
          HPC 101 超算小学期
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HPC 101 超算小学期" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_7_2">
          <span class="md-nav__icon md-icon"></span>
          HPC 101 超算小学期
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../hpc/hpc101/vectorized/" class="md-nav__link">
        向量化计算
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../hpc/hpc101/gpu/" class="md-nav__link">
        GPU 编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../hpc/hpc101/openmp/" class="md-nav__link">
        OpenMP 基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../hpc/hpc101/mpi/" class="md-nav__link">
        MPI 基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../hpc/hpc101/ml/" class="md-nav__link">
        机器学习基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" type="checkbox" id="__nav_2_8" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_8">
          零散知识点
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="零散知识点" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          零散知识点
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../regex/" class="md-nav__link">
        正则表达式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../unicode/" class="md-nav__link">
        Unicode
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9" type="checkbox" id="__nav_2_9" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../analysis/">源码剖析</a>
          
            <label for="__nav_2_9">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="源码剖析" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          源码剖析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/mkdocs/" class="md-nav__link">
        mkdocs 源码剖析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10" type="checkbox" id="__nav_2_10" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../tools/">工具相关</a>
          
            <label for="__nav_2_10">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="工具相关" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          工具相关
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/toolbox/" class="md-nav__link">
        工具收集
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10_3" type="checkbox" id="__nav_2_10_3" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_10_3">
          命令行工具
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="命令行工具" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_10_3">
          <span class="md-nav__icon md-icon"></span>
          命令行工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/git/" class="md-nav__link">
        Git 命令备忘
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/shell/" class="md-nav__link">
        Shell 命令备忘
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/docker/" class="md-nav__link">
        Docker 相关备忘
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/gdb/" class="md-nav__link">
        gdb 相关备忘
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10_4" type="checkbox" id="__nav_2_10_4" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_10_4">
          CI 工具
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="CI 工具" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_10_4">
          <span class="md-nav__icon md-icon"></span>
          CI 工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/action/" class="md-nav__link">
        GitHub Action
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10_5" type="checkbox" id="__nav_2_10_5" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_10_5">
          站点生成工具
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="站点生成工具" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_10_5">
          <span class="md-nav__icon md-icon"></span>
          站点生成工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/mkdocs/" class="md-nav__link">
        mkdocs 使用记录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/hexo/" class="md-nav__link">
        hexo 使用记录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/sphinx/" class="md-nav__link">
        sphinx 使用记录
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../ctf/">CTF</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="CTF" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          CTF
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../ctf/steg/">隐写术</a>
          
            <label for="__nav_3_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="隐写术" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          隐写术
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ctf/steg/image/" class="md-nav__link">
        图片隐写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ctf/steg/audio/" class="md-nav__link">
        音频隐写
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../ctf/escapes/">沙箱逃逸</a>
          
            <label for="__nav_3_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="沙箱逃逸" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          沙箱逃逸
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ctf/escapes/pysandbox/" class="md-nav__link">
        Python 沙箱逃逸
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../ctf/forensics/">取证</a>
          
            <label for="__nav_3_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="取证" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          取证
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ctf/forensics/mem/" class="md-nav__link">
        内存取证
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ctf/coding/" class="md-nav__link">
        编码与密码
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ctf/qrcode/" class="md-nav__link">
        QRCode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ctf/esolang/" class="md-nav__link">
        Esolang
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_8" type="checkbox" id="__nav_3_8" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../ctf/eth/">Ethereum</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Ethereum" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_8">
          <span class="md-nav__icon md-icon"></span>
          Ethereum
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../writeups/">Writeups</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Writeups" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Writeups
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Training
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Training" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Training
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/ethernaut/" class="md-nav__link">
        Ethernaut
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/SecurityInnovation/" class="md-nav__link">
        Security Innovation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/sadservers/" class="md-nav__link">
        SadServers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/AAA/" class="md-nav__link">
        🔒 AAA School Bus
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/sysu_msc_puzzle/" class="md-nav__link">
        SYSU MSC Puzzle 2021
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/hackergame2021/" class="md-nav__link">
        USTC Hackergame 2021
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/d0g3/" class="md-nav__link">
        第四届“安洵杯”
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/bytectf2021_final/" class="md-nav__link">
        ByteCTF 2021 Final
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/sctf2021/" class="md-nav__link">
        SCTF 2021
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4">
          2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="2022" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/vnctf2022/" class="md-nav__link">
        VNCTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/tqlctf2022/" class="md-nav__link">
        TQLCTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/susctf2022/" class="md-nav__link">
        SUSCTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/d3ctf2022/" class="md-nav__link">
        D3CTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/%2Actf2022/" class="md-nav__link">
        *CTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/mrctf2022/" class="md-nav__link">
        MRCTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/qwb2022/" class="md-nav__link">
        强网杯 2022 Quals
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/tctf2022/" class="md-nav__link">
        TCTF/0CTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/hackergame2022/" class="md-nav__link">
        USTC Hackergame 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/n1ctf2022/" class="md-nav__link">
        N1CTF 2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../writeups/seccon2022/" class="md-nav__link">
        SECCON 2022 Quals
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../others/">Others</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Others" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Others
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../others/notes/" class="md-nav__link">
        课程笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../others/troubleshooting/">TroubleShooting</a>
          
            <label for="__nav_5_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="TroubleShooting" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          TroubleShooting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../others/troubleshooting/mac/" class="md-nav__link">
        macOS TroubleShooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../links/">Links</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Links" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Links
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                      
                    </div>
                  </div>
                </div>
              
              
                <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                  <div class="md-sidebar__scrollwrap">
                    <div class="md-sidebar__inner">
                      
                        
  
  <nav class="md-nav md-nav--secondary " aria-label="目录">
    
    
    
      
    
    
      <label class="md-nav__title" for="__toc">
        <span class="md-nav__icon md-icon"></span>
        目录
      </label>
      <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    变量
  </a>
  
    <nav class="md-nav" aria-label="变量">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    标识符命名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    变量绑定与可变性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    变量解构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    常量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    变量遮蔽
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    基本类型
  </a>
  
    <nav class="md-nav" aria-label="基本类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    整型
  </a>
  
    <nav class="md-nav" aria-label="整型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    布尔类型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    浮点型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    运算
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    序列
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    字符类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    单元类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    语句与表达式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    所有权与借用
  </a>
  
    <nav class="md-nav" aria-label="所有权与借用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    所有权
  </a>
  
    <nav class="md-nav" aria-label="所有权">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#string" class="md-nav__link">
    String 类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    所有权转移
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    函数传值与返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    引用与借用
  </a>
  
    <nav class="md-nav" aria-label="引用与借用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    避免悬垂引用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    复合类型
  </a>
  
    <nav class="md-nav" aria-label="复合类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    字符串
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    元组
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    结构体
  </a>
  
    <nav class="md-nav" aria-label="结构体">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    简化创建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    更新结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    元组结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    单元结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    打印结构体
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    枚举
  </a>
  
    <nav class="md-nav" aria-label="枚举">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option" class="md-nav__link">
    Option
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    数组
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    流程控制
  </a>
  
    <nav class="md-nav" aria-label="流程控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    分支
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    循环
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    模式匹配
  </a>
  
    <nav class="md-nav" aria-label="模式匹配">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#match" class="md-nav__link">
    match 语句
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-let-while-let" class="md-nav__link">
    if let / while let
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matches" class="md-nav__link">
    matches! 宏
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generics" class="md-nav__link">
    泛型 Generics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trait" class="md-nav__link">
    特征 Trait
  </a>
  
    <nav class="md-nav" aria-label="特征 Trait">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    特征对象
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    关联类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    默认泛型类型参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    同名方法调用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trait-trait" class="md-nav__link">
    trait 定义中的 trait 约束
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    绕过孤儿规则
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    集合类型
  </a>
  
    <nav class="md-nav" aria-label="集合类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector" class="md-nav__link">
    Vector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hashmap" class="md-nav__link">
    HashMap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    类型转换
  </a>
  
    <nav class="md-nav" aria-label="类型转换">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    方法调用时的强制类型转换
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    返回值与错误处理
  </a>
  
    <nav class="md-nav" aria-label="返回值与错误处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#panic" class="md-nav__link">
    panic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result" class="md-nav__link">
    Result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    包和模块
  </a>
  
    <nav class="md-nav" aria-label="包和模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crate-package" class="md-nav__link">
    crate 与 package
  </a>
  
    <nav class="md-nav" aria-label="crate 与 package">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package" class="md-nav__link">
    典型 package 结构
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module" class="md-nav__link">
    模块 Module
  </a>
  
    <nav class="md-nav" aria-label="模块 Module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    代码可见性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use" class="md-nav__link">
    use 引入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    使用第三方包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    受限可见性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    三种模块目录组织方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    注释与文档
  </a>
  
    <nav class="md-nav" aria-label="注释与文档">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    文档注释
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    格式化输出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    生命周期
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    闭包和迭代器
  </a>
  
    <nav class="md-nav" aria-label="闭包和迭代器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    闭包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    迭代器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    深入类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    智能指针
  </a>
  
    <nav class="md-nav" aria-label="智能指针">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deref-trait" class="md-nav__link">
    Deref trait
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drop-trait" class="md-nav__link">
    Drop trait
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box" class="md-nav__link">
    Box
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rc-arc" class="md-nav__link">
    Rc 与 Arc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cell-refcell" class="md-nav__link">
    Cell 与 RefCell
  </a>
  
    <nav class="md-nav" aria-label="Cell 与 RefCell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cell" class="md-nav__link">
    Cell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refcell" class="md-nav__link">
    RefCell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#weak" class="md-nav__link">
    Weak 弱引用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    多线程并发编程
  </a>
  
    <nav class="md-nav" aria-label="多线程并发编程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    使用线程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    全局变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    错误处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe" class="md-nav__link">
    unsafe
  </a>
  
    <nav class="md-nav" aria-label="unsafe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    解引用裸指针
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe_1" class="md-nav__link">
    调用 unsafe 或外部函数
  </a>
  
    <nav class="md-nav" aria-label="调用 unsafe 或外部函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsafe_2" class="md-nav__link">
    unsafe 函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffi" class="md-nav__link">
    FFI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe-trait" class="md-nav__link">
    实现 unsafe trait
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#union" class="md-nav__link">
    访问 union 中字段
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macro" class="md-nav__link">
    macro 宏编程
  </a>
  
    <nav class="md-nav" aria-label="macro 宏编程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    声明式宏
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    过程宏
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    测试
  </a>
  
    <nav class="md-nav" aria-label="测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    断言
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    编写测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    
  </nav>
                      
                    </div>
                  </div>
                </div>
                <script src="/js/toc.js" defer></script>
                <link rel="stylesheet" href="/css/fold_toc.css">
              
            
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
<a href="https://github.com/TonyCrane/note/tree/master/docs/cs/pl/rust/basic.md" title="编辑此页" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="rust">Rust 语法基础<a class="headerlink" href="#rust" title="Permanent link">&para;</a></h1>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<p>基础语法，第二遍学的时候做了点笔记</p>
<p>参考：</p>
<ul>
<li>Rust 圣经，<a href="https://course.rs/">course.rs</a></li>
<li>The Rust Programming Language，<a href="https://doc.rust-lang.org/book/">https://doc.rust-lang.org/book/</a></li>
</ul>
</div>
<h2 id="_1">变量<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="_2">标识符命名<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li>原生标识符（raw identifiers）<ul>
<li>关键字不能作为标识符名称</li>
<li>加上 <code class="highlight"><span class="n">r</span>#<span class="w"></span></code> 前缀后可以使用，比如 <code class="highlight"><span class="n">r</span>#<span class="k">match</span><span class="w"></span></code></li>
</ul>
</li>
<li>命名规范：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">惯例方式</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">模块 Modules</td>
<td align="left"><code>snake_case</code></td>
</tr>
<tr>
<td align="left">类型 Types</td>
<td align="left"><code>UpperCamelCase</code></td>
</tr>
<tr>
<td align="left">特征 Traits</td>
<td align="left"><code>UpperCamelCase</code></td>
</tr>
<tr>
<td align="left">枚举 Enumerations</td>
<td align="left"><code>UpperCamelCase</code></td>
</tr>
<tr>
<td align="left">结构体 Structs</td>
<td align="left"><code>UpperCamelCase</code></td>
</tr>
<tr>
<td align="left">函数 Functions</td>
<td align="left"><code>snake_case</code></td>
</tr>
<tr>
<td align="left">方法 Methods</td>
<td align="left"><code>snake_case</code></td>
</tr>
<tr>
<td align="left">通用构造器 General constructors</td>
<td align="left"><code>new</code> or <code>with_more_details</code></td>
</tr>
<tr>
<td align="left">转换构造器 Conversion constructors</td>
<td align="left"><code>from_some_other_type</code></td>
</tr>
<tr>
<td align="left">宏 Macros</td>
<td align="left"><code>snake_case!</code></td>
</tr>
<tr>
<td align="left">局部变量 Local variables</td>
<td align="left"><code>snake_case</code></td>
</tr>
<tr>
<td align="left">静态类型 Statics</td>
<td align="left"><code>SCREAMING_SNAKE_CASE</code></td>
</tr>
<tr>
<td align="left">常量 Constants</td>
<td align="left"><code>SCREAMING_SNAKE_CASE</code></td>
</tr>
<tr>
<td align="left">类型参数 Type parameters</td>
<td align="left"><code>UpperCamelCase</code>，通常使用一个大写字母: T</td>
</tr>
<tr>
<td align="left">生命周期 Lifetimes</td>
<td align="left">通常使用小写字母: 'a，'de，'src</td>
</tr>
</tbody>
</table>
<h3 id="_3">变量绑定与可变性<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>rust 使用 let 关键字来进行变量绑定，即 <code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span></code></p>
<p>而 rust 的变量默认是不可变（immutable）的，使之变成可变的需要在 let 后面加上 mut，如果后面不会改变的变量被声明为了 mutable 的，编译器会给出警告</p>
<p>存在没有使用的变量的话编译器也会给出警告，在变量名前加上单下划线即可忽略</p>
<h3 id="_4">变量解构<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>类似于 python 的元素解包
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>: <span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span><span class="w"> </span><span class="c1">// c = 1, d = 4</span>
</code></pre></div></p>
<h3 id="_5">常量<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>常量使用 const 关键字来定义，且必须指定类型，命名通常为蛇形全大写，const 后面也不允许使用 mut，可以在任意作用域内声明
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">const</span><span class="w"> </span><span class="n">MAX_VALUE</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="mi">100_000</span><span class="p">;</span><span class="w"></span>
</code></pre></div></p>
<h3 id="_6">变量遮蔽<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>rust 中可以重复声明同一名称的变量，这会再次分配内存，并完全遮蔽掉前面的同名变量</p>
<h2 id="_7">基本类型<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="_8">整型<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>i<em>长度</em>（有符号）、u<em>长度</em>（无符号）</p>
<ul>
<li>i8、i16、i32、i64、i128、u8、u16、u32、u64、u128</li>
<li>isize、usize 长度由 CPU 决定，32 位 CPU 则是 32 位，64 位 CPU 则是 64 位</li>
<li>整型字面量中间可以插入 _</li>
<li>字面量结尾可以接类型，例如 <code class="highlight"><span class="mi">10</span><span class="k">i32</span><span class="p">,</span><span class="w"> </span><span class="mi">10_</span><span class="k">i32</span><span class="w"></span></code></li>
<li>字面量，十六进制 0x...、八进制 0o...、二进制 0b...、字节（仅 u8）b'A'</li>
<li>整型默认使用 i32 类型</li>
<li>使用 as 来转换类型，例如 <code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u16</span> <span class="o">=</span><span class="w"> </span><span class="mi">1_</span><span class="k">u8</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">;</span><span class="w"></span></code></li>
</ul>
<p>debug 模式编译时产生溢出会 panic，而在 release 模式下则不会 panic，按照补码循环溢出。但不能依赖这种行为，想要这样的效果应该标准库的一些方法：</p>
<ul>
<li>wrapping_<em>*</em> 方法，按照补码循环溢出，例如 <code class="highlight"><span class="n">a</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span></code></li>
<li>checked_<em>*</em> 方法，如果产生溢出了，则会返回 None</li>
<li>overflowing_<em>*</em> 方法，返回结果以及指示是否溢出的布尔值</li>
<li>saturating_<em>*</em> 方法，如果会溢出则保持在最大/最小值上</li>
</ul>
<h4 id="_9">布尔类型<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>类型名为 bool，值为 true 或 false，占用 1 字节内存</p>
<h3 id="_10">浮点型<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<ul>
<li>f32 单精度浮点型、f64 双精度浮点型，默认情况下为 f64</li>
<li>应该避免判断浮点数相等</li>
<li>可以使用 .is_nan() 方法来判断一个数值是否是 NaN</li>
<li>数值上也可以使用方法，比如 <code class="highlight"><span class="mf">3.14_</span><span class="k">f32</span><span class="p">.</span><span class="n">round</span><span class="p">()</span><span class="w"></span></code></li>
</ul>
<h3 id="_11">运算<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<ul>
<li><code>+ - * / %</code>：加减乘除取模</li>
<li><code>&amp; | ^ ! &lt;&lt; &gt;&gt;</code>：位运算</li>
<li>同样类型才能进行计算、类型转换必须是显式的</li>
<li>其它运算可以通过方法实现，.pow() 计算指数，.log() 取对数、.div_euclid() 整除、.div_floor() 等等</li>
</ul>
<h3 id="_12">序列<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>在 for 循环中常用，用来生成连续的数值，仅可以使用整数、字符等连续的类型，例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="o">..</span><span class="p">.;</span><span class="w"> </span><span class="c1">// i = 1, 2, 3, 4</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sc">&#39;a&#39;</span><span class="o">..=</span><span class="sc">&#39;d&#39;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="o">..</span><span class="p">.;</span><span class="w"> </span><span class="c1">// i = &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="_13">字符类型<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>rust 中的字符类型是 char，字面量写法为单引号（双引号表示字符串）</p>
<ul>
<li>一个 char 占四个字节（而不是 C/C++ 中的一个字节）</li>
<li>所有 unicode 码元都是一个字符</li>
<li>直接存储 unicode 值（即 UCS-4），而不使用 UTF-8 编码</li>
</ul>
<h3 id="_14">单元类型<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<ul>
<li>单元类型就是 ()，唯一的值也是 ()，不占内存</li>
<li>main 函数返回的就是单元类型 ()</li>
</ul>
<h3 id="_15">语句与表达式<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<ul>
<li>简单理解就是，带分号的是一个语句，不带分号的是一个表达式，能返回值的就是表达式</li>
<li>表达式可以是语句的一部分，比如 <code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span></code> 中 1 就是一个表达式，而整体是一个语句</li>
<li>函数调用是表达式，因为会有返回值，即使“无”返回值也会返回单元类型</li>
<li>用大括号包裹的返回一个值的语句块也是表达式：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="p">};</span><span class="w"></span>
</code></pre></div></li>
</ul>
<h3 id="_16">函数<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="n">i</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">j</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="c1">// 不带分号，返回值；带分号了会返回 ()</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>定义函数使用关键字 fn</li>
<li>函数名、参数名使用蛇形命名</li>
<li>必须显式指定参数类型，除了返回 () 外要显式指定返回值类型</li>
<li>中途返回使用 return 关键字（带不带分号均可）</li>
<li>永不返回的函数类型为 !（相当于 python 类型标注中的 NoReturn），一般用于一定会抛出 panic 的函数或者无限循环：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">fn</span> <span class="nf">dead_end</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">fn</span> <span class="nf">forever</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/*...*/</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
<h2 id="_17">所有权与借用<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h2>
<h3 id="_18">所有权<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<ol>
<li>Rust 中每一个值都被一个变量所拥有，该变量被称为值的所有者</li>
<li>一个值同时只能被一个变量所拥有，或者说一个值只能拥有一个所有者</li>
<li>当所有者（变量）离开作用域范围时，这个值将被丢弃（drop）</li>
</ol>
<p>其中作用域的概念和其他语言类似</p>
<h4 id="string">String 类型<a class="headerlink" href="#string" title="Permanent link">&para;</a></h4>
<p><code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;abc&quot;</span><span class="w"></span></code> 中 s 的类型为 <code class="highlight"><span class="o">&amp;</span><span class="kt">str</span><span class="w"></span></code>，并不是 String，"abc" 是被硬编码的不可变的字面量。存储的时候是一个指针和字符串长度</p>
<p>而 String 则是通过堆来动态分配内存。比如 <code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span><span class="w"></span></code>，调用 String 的 from 方法来创建一个 String</p>
<p>如果 s 是 mut 的，则可以通过 <code class="highlight"><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span><span class="w"></span></code> 来追加字面量</p>
<h4 id="_19">所有权转移<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
因为 i32 存储在栈上，所以可以直接拷贝，x 和 y 都为 1，但
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
String 存储在堆上，为 y 赋值本应拷贝地址作浅复制，但这样同一个 String 就有了两个所有者（x 和 y），这是所有权规则不允许的。因此这时 x 会失效，也就是将 String 的所有权转移给 y，后面无法再使用 x 变量。这种操作叫做移动（move）而非拷贝
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;abc&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
这种情况，因为使用的是 &amp;str 而不是 String，所以 x 仅引用了存储在内存中的字符串，并不对它持有所有权，因此 <code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"></span></code> 时对存在栈上的引用进行了拷贝，而不需要移动。所以这之后 x 和 y 均可用</p>
<ul>
<li>rust 永远不会自动创建数据的深拷贝</li>
<li>使用 .clone() 可以深拷贝存在堆上的数据，但性能降低
    <div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w"> </span><span class="c1">// 后面 x、y 均可用，因为是所有的是不同数据</span>
</code></pre></div></li>
</ul>
<h4 id="_20">函数传值与返回<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>向函数中传值也会发生移动或者复制
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="c1">// 这里 s 将不能使用</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="k">fn</span> <span class="nf">print</span><span class="p">(</span><span class="n">string</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"> </span><span class="c1">// s 的所有权到这里</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="p">}</span><span class="w"> </span><span class="c1">// string 被释放</span>
</code></pre></div>
从上面的例子可以看出，s 对于 String 的所有权在函数传值调用时被移动给了 print 函数的 string 变量。然后随着 print 函数的结束，string 作用域结束，这个值内存被 drop。并且由于在调用时 s 被移动了，所以在调用后 s 将不能被使用。若想在调用后继续使用 s，一种方法是将 s.clone() 传给 print，另一种方法则是利用返回：
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"> </span><span class="c1">// 这里 s 可用</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="k">fn</span> <span class="nf">print</span><span class="p">(</span><span class="n">string</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="n">string</span><span class="w"></span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
函数在返回的时候也会移动所有权，比如上面例子中，print 函数结束后，将 string 移动了出去，赋值给了 s，这时 s 就拿到了返回值的所有权，后面仍可以继续使用。但这要求 s 是 mut 的（因为发生了变化），或者使用变量遮蔽（<code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span></code>）</p>
<h3 id="_21">引用与借用<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>rust 中也有引用的概念，获取一个变量的引用也称为借用（borrowing），使用 &amp; 来进行引用，* 来解引用：
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="kp">&amp;</span><span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="c1">// 引用类型</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
也可以通过借用来进行函数调用，从而维持参数的所有权：
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span><span class="w">    </span><span class="c1">// 创建 s 的引用，并传入</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"> </span><span class="c1">// s 仍可用</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="n">string</span>: <span class="kp">&amp;</span><span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"> </span><span class="c1">// 接收引用</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="n">string</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w">  </span><span class="c1">// 直接调用方法</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="p">}</span><span class="w"> </span><span class="c1">// string 离开作用域，但它并不拥有任何值，所以不会发生什么</span>
</code></pre></div>
但是此时的引用是不可变引用，也就是说，不能在 func 函数中进行 <code class="highlight"><span class="n">string</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span><span class="w"></span></code></p>
<p>使用 &amp;mut 可以创建可变引用，例如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"> </span><span class="c1">// 创建 s 的可变引用</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="c1">// 输出 abc...</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="n">string</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 接收可变引用</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="n">string</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 可以进行更改</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
但是对于可变引用，rust 有一些限制：</p>
<ul>
<li>在同一个作用域内，一个数据只能有一个可变引用</li>
<li>可变引用和不可变引用不能同时存在</li>
</ul>
<p>这样做的目的是避免产生数据竞争，以及防止不可变引用的值被可变引用所改变</p>
<p>以及如果存在引用，且后面用到了这个引用，则被引用的即使是 mut 的，也不能被修改，例如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="c1">//borrow later used here</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// assignment to borrowed `x` occurs here</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="p">);</span><span class="w"> </span><span class="c1">// borrow later used here</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
则会产生如上注释中的错误，而如果在 <code class="highlight"><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span></code> 后面没有再用到 y，则是可以通过编译正常更改 x 的</p>
<p>以及如下代码也会编译错误：
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="p">);</span><span class="w"> </span><span class="c1">// cannot borrow `x` as immutable because it is also borrowed as mutable</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
因为在传入宏时，实际上对 x 进行了借用，因此同时存在了可变和不可变的引用，导致报错</p>
<h4 id="_22">避免悬垂引用<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>悬垂引用（dangling references）也称悬垂指针，意思是指针指向的值被释放掉了，导致指针指的位置不存在期望的内容。rust 不会允许这种情况发生，比如
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">fn</span> <span class="nf">dangle</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="o">&amp;</span><span class="n">s</span><span class="w"></span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
这里返回了 s 的引用，但是在函数结束后 s 离开了作用域，被释放掉了，所以返回的其实是悬垂引用，rust 编译器将不会通过</p>
<h2 id="_23">复合类型<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h2>
<h3 id="_24">字符串<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<ul>
<li>&amp;str 与 String 是两个不同的类型</li>
<li>可以使用 &amp;s[a..b] 的方式来获取切片的引用，切片使用的是前面的 range 类型，语法和 python 的切片类似，同样可以省略头尾<ul>
<li>对一个 String 使用切片获得的引用类型也是 &amp;str</li>
<li>切片是按字节进行的，需要精确切到字符边界。例如对中文字符串进行切片，&amp;s[0..3] 会切出一个汉字字符，而 &amp;s[0..2] 没切完整会导致 panic</li>
</ul>
</li>
<li>字符是 UCS-4 编码，字符串是 UTF-8 编码（每个字符字节数不定）</li>
<li>String 与 &amp;str 转换<ul>
<li>&amp;str -&gt; String<ul>
<li>String::from("...")</li>
<li>"...".to_string()</li>
</ul>
</li>
<li>String -&gt; &amp;str<ul>
<li>&amp;s / &amp;s[..]</li>
<li>s.as_str()</li>
</ul>
</li>
</ul>
</li>
<li>String 操作<ul>
<li>.push('a') 追加字符 / .push_str("...") 追加字符串</li>
<li>.insert(n, 'a') 在索引 n 的位置插入字符 / .insert(n, "...") 同理插入字符串</li>
<li>.replace("aaa", "AAA") 全局替换所有 "aaa" 到 "AAA"，返回替换后的新字符串，原字符串不变</li>
<li>.replacen("aaa", "AAA") 同上，但只替换 n 次</li>
<li>.replace_range(a..b, "...") 将索引 a..b 的范围替换为新字符串 "..."，直接操作原字符串</li>
<li>.pop() 删除并返回最后一个字符，返回值为一个 Option，若字符串为空则返回 None</li>
<li>.remove(n) 删除以索引 n 开头的一个字符</li>
<li>.truncate(n) 删除索引 n 开头及之后的所有字符</li>
<li>.clear() 清空字符串</li>
<li>使用 + 或 += 连接一个 &amp;str 字符串（不能是 String）<ul>
<li>+ 运算符左侧的变量将失效，因为所有权转移到了 .add() 方法中然后被释放</li>
</ul>
</li>
<li>可以使用 <code>let s = format!("{} {}", s1, s2)</code> 来连接创建新的字符串</li>
</ul>
</li>
<li>字符串转义<ul>
<li>"\x.." 十六进制表示，必须在 \x00 到 \x7f 之间</li>
<li>"\u{....}" 用 codepoint 表示一个 unicode 字符</li>
<li>可以直接换行，但从下一行行首开始就记录文本（也就是不当作缩进忽略），行尾加  不换行，且下一行行首空格忽略</li>
<li>其它转义和其它语言均类似</li>
<li>r"..." 中的  不参与转义（和 python 类似）</li>
<li>r#"..."# 中的双引号不会提前结束字符串（也就相当于不需要转义双引号）</li>
<li>r##"..."## 中的 "# 也不会提前结束字符串（双引号前后的井号加多少都可以，只需要匹配即可）</li>
</ul>
</li>
<li>操作 UTF-8 字符串<ul>
<li>循环遍历字符可以使用 <code class="highlight"><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">.</span><span class="n">chars</span><span class="p">()</span><span class="w"></span></code></li>
<li>循环遍历字节可以使用 <code class="highlight"><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">.</span><span class="n">bytes</span><span class="p">()</span><span class="w"></span></code></li>
<li>其它操作标准库中没有，需要通过别的 crates</li>
</ul>
</li>
</ul>
<h3 id="_25">元组<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<ul>
<li>长度固定，元素顺序及类型固定的复合类型，例如 <code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">t</span>: <span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1.1</span><span class="p">);</span><span class="w"></span></code></li>
<li>使用模式匹配获取元组中的值：<code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"></span></code></li>
<li>使用 . 来访问元组内容：<code>t.0 == 1</code></li>
</ul>
<h3 id="_26">结构体<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>使用 struct 关键字来定义结构体，指明字段名与类型：
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">struct</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="n">age</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="n">email</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
创建结构体实例时每个字段都需要初始化，且顺序可以打乱：
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">user1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="n">age</span>: <span class="mi">19_</span><span class="k">u32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;TonyCrane&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">    </span><span class="n">email</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;tonycrane@foxmail.com&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="p">};</span><span class="w"></span>
</code></pre></div>
访问结构体字段直接使用 . 就可以。修改某一字段需要将整个结构体标记为 mut，无法将某一字段单独标记为 mut</p>
<p>另外，在结构体中使用引用类型需要用到生命周期</p>
<h4 id="_27">简化创建<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">fn</span> <span class="nf">build_user</span><span class="p">(</span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">age</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">        </span><span class="n">name</span><span class="p">,</span><span class="w">  </span><span class="c1">// name: name 缩写</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">        </span><span class="n">age</span><span class="p">,</span><span class="w">   </span><span class="c1">// age: age 缩写</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">        </span><span class="n">email</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
当参数名和字段名相同的时候可以省略掉内容</p>
<h4 id="_28">更新结构体<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<p>通过已有结构体实例创建新实例：
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">user2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="n">email</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;another@example.com&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="o">..</span><span class="n">user1</span><span class="w"> </span><span class="c1">// 必须写在后面</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="p">};</span><span class="w"></span>
</code></pre></div>
将 user1 除了 email 之外的字段<strong>移动</strong>到 user2 中。因为这是移动，所以发生了所有权的转移，导致 user1.name 后面不能被使用。但因为 u32 实现了 Copy trait，所以 user1.age 仍可以使用。并且 user1.email 所有权并没有转移，仍然可以使用</p>
<h4 id="_29">元组结构体<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<p>可以定义像元组一样没有字段名的结构体：
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">struct</span> <span class="nc">Point</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</code></pre></div></p>
<h4 id="_30">单元结构体<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<p>像单元类型一样，没有任何字段和属性的结构体。作用上来看就是不关心数据，但关心行为（后面 impl 之类的）
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">struct</span> <span class="nc">UnitLikeStruct</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnitLikeStruct</span><span class="p">;</span><span class="w"></span>
</code></pre></div></p>
<h4 id="_31">打印结构体<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<p>结构体不能直接被放在 {} 中打印，因为没有实现 Display trait</p>
<p>一种方便的输出方式是利用 <code class="highlight"><span class="cp">#[derive(Debug)]</span><span class="w"></span></code> 来自动实现 Debug trait 来利用 {:?} 格式化或 dbg! 宏进行 debug 打印：
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">struct</span> <span class="nc">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="n">width</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="n">height</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">width</span>: <span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="n">height</span>: <span class="mi">50</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span><span class="w"> </span><span class="c1">// 输出到 stderr 流中</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
输出为：
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>Rectangle { width: 30, height: 50 }
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>[src/main.rs:10] rect = Rectangle {
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    width: 30,
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    height: 50,
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>}
</code></pre></div></p>
<h3 id="_32">枚举<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>使用 enum 关键字来定义枚举类型，用 :: 来访问成员，可以包含值：
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">enum</span> <span class="nc">Message</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="n">Quit</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="n">Move</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="kt">i32</span> <span class="p">},</span><span class="w"></span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="n">Write</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="n">ChangeColor</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span>::<span class="n">Quit</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span>::<span class="n">Move</span><span class="p">{</span><span class="w"> </span><span class="n">x</span>: <span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mi">1</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">m3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span>::<span class="n">ChangeColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h4 id="option">Option<a class="headerlink" href="#option" title="Permanent link">&para;</a></h4>
<p>类似 Haskell 中的 Maybe，定义是：
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">enum</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
使用时无需添加 Option:: 前缀，提取值可以使用模式匹配</p>
<h3 id="_33">数组<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<ul>
<li>rust 中数组长度固定，必须有相同类型，存储线性排列在栈上，速度快</li>
<li>一个数组的类型是 [<em>元素类型</em>; <em>元素个数</em>]，例如 <code class="highlight"><span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"></span></code> 表示包含 5 个 i32 的数组</li>
<li>使用同一个重复元素初始化数组，例 <code class="highlight"><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"></span></code> 即 a 为包含 5 个 3 的数组</li>
<li>索引使用 []，与其它语言相同</li>
<li>越界访问会触发 panic</li>
<li>和字符串一样可以创建切片引用</li>
</ul>
<h2 id="_34">流程控制<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h2>
<h3 id="_35">分支<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<ul>
<li>if - else if - else 结构</li>
<li>条件不需要加括号</li>
<li>if 语句块是表达式，可以用来赋值</li>
</ul>
<h3 id="_36">循环<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<ul>
<li>for 循环<ul>
<li>for ... in ... 结构</li>
<li>in 后面的集合一般需要使用引用，否则会将所有权移至 for 块内（实现了 Copy trait 的除外）</li>
<li>循环中修改元素的话一般需要使用可变引用</li>
<li>带索引循环
    <div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>仅循环多少次：<code class="highlight"><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="w"></span></code> 循环 10 次</li>
<li>可以使用 continue 和 break 控制循环</li>
</ul>
</li>
<li>while 循环<ul>
<li>没什么特别的</li>
</ul>
</li>
<li>loop 循环<ul>
<li>不会自动停止，需要靠 break</li>
<li>是一个表达式，可以利用 break 来返回一个值
    <div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="n">cnt</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">        </span><span class="k">break</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="p">};</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
<p>rust 中可以使用 label 来指定多重循环中 break 或 continue 哪一层循环：
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="o">&#39;</span><span class="na">outer</span>: <span class="nc">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Outer: #i = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">    </span><span class="o">&#39;</span><span class="na">inner</span>: <span class="nc">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Inner: #j = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="nl">&#39;outer</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="nl">&#39;outer</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="nl">&#39;inner</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h2 id="_37">模式匹配<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h2>
<p>rust 中有很多模式匹配，比如 let 语句、for 循环本身就相当于模式匹配：
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
以及函数参数：
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>: <span class="kp">&amp;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="c1">// x 和 y 会从这一个参数中匹配出来</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
除此之外还有一些专门利用模式匹配的语法：</p>
<h3 id="match">match 语句<a class="headerlink" href="#match" title="Permanent link">&para;</a></h3>
<p>类似 python 的 match-case 语句，以及 Haskell 的模式匹配以及守卫语法
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">match</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="n">pattern1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">expression1</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="n">pattern2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">        </span><span class="n">statements1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">        </span><span class="n">statements2</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">        </span><span class="n">expression2</span><span class="w"></span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">    </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">    </span><span class="n">pattern3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">pattern4</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">expression3</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">expression4</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<ul>
<li>整个 match 语句块是一个表达式</li>
<li>match 必须穷举出所有模式，未列出的剩余部分使用通配符 _ 表示其它所有可能性<ul>
<li>_ 不会被绑定，可以多次使用，其匹配到的值都会被忽略</li>
</ul>
</li>
<li>match 的每一个分支都必须是一个表达式，且所有分支的表达式返回值类型需要相同</li>
<li>| 表示或，即匹配二者中的一个即可</li>
<li>可以利用模式匹配来绑定新变量</li>
<li>序列也可以作为模式，比如 x = 5 就可以匹配模式 1..=5</li>
<li>可以使用 .. 来忽略剩余值
    <div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">z</span>: <span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="k">match</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;x is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="k">match</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Some numbers: {}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>可以在模式后面增加额外的 if 条件，称为匹配守卫（match guard）
    <div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="k">match</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;less than five: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>在有 | 的情况下，if 语句的条件会作用于所有的模式，而不是最后一个</li>
</ul>
</li>
<li>可以使用 @ 来为字段绑定变量，比如上面的例子里第一个匹配可以写为 <code class="highlight"><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">5</span><span class="p">)</span><span class="w"></span></code><ul>
<li>Rust 1.53 新语法：如 <code class="highlight"><span class="n">num</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span></code> 将 1 或 2 绑定到 num 变量上</li>
<li>Rust 1.56 新语法：和 Haskell 中 @ 用法类似，在解构的同时保留原值，如
    <div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="n">x</span>: <span class="nc">px</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="nc">py</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="n">x</span>: <span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mi">20</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="c1">// p = Point {x: 10, y: 20}, px = 10, py = 20</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="if-let-while-let">if let / while let<a class="headerlink" href="#if-let-while-let" title="Permanent link">&para;</a></h3>
<p>只需要匹配一个模式、忽略其它模式时，可以使用 if let 语句来简化，比如下面代码
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="k">match</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;!&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
可以写为
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 是一个等号，不是双等号</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;!&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
与之相似的是 while let 语句，只要匹配就一直进行循环，例如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="c1">// ...</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;pop {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h3 id="matches">matches! 宏<a class="headerlink" href="#matches" title="Permanent link">&para;</a></h3>
<p>仅仅需要判断一个值是否和一个模式匹配的话可以使用 matches! 宏：
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="fm">matches!</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">pattern</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
如果匹配则返回 true，否则返回 false</p>
<h2 id="_38">方法<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h2>
<p>Rust 中使用 impl 块来为结构体定义方法，可以当作，struct 定义“类”的属性，impl 块中定义“类”的方法
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">StructName</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"> </span>-&gt; <span class="nc">StructName</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">        </span><span class="n">StructName</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">            </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.)</span><span class="w"> </span>-&gt; <span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<ul>
<li>一个方法的第一个参数为 self 等，表示自身，且服从所有权规则<ul>
<li>self：将调用者的所有权转移到方法中，少用（类型为 <code class="highlight"><span class="bp">Self</span><span class="w"></span></code>，表示结构体自身类型）</li>
<li>&amp;self：在方法中使用调用者的不可变借用，常用（实际上是 <code class="highlight"><span class="bp">self</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="w"></span></code> 的语法糖）</li>
<li>&amp;mut self：在方法中使用调用者的可变借用，常用</li>
</ul>
</li>
<li>方法名可以与字段名相同（一般用来实现 getter）</li>
<li>rust 会为 &amp;self 等自动引用与解引用</li>
<li>impl 块中没有 self 参数的函数称为关联函数（如上面的 new）<ul>
<li>不能使用 . 来以方法的形式调用</li>
<li>应该使用 :: 来调用（相当于调用这个结构体命名空间中的函数）</li>
<li>new 一般用来作为构造器，即从参数返回一个结构体</li>
</ul>
</li>
<li>可以在多个 impl 块中为同一个结构体定义方法</li>
<li>impl 也可以为枚举类型定义方法</li>
</ul>
<h2 id="generics">泛型 Generics<a class="headerlink" href="#generics" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">fn</span> <span class="nf">add</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">std</span>::<span class="n">ops</span>::<span class="n">Add</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w">         </span><span class="c1">// ^ 保证可以 T 相加并得到 T 类型的结果</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><code class="highlight"><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span></code> 为一个函数规定一个泛型 T，冒号后面接需要的 trait 来添加限制</li>
<li>可以通识定义多个泛型，用逗号隔开即可</li>
<li>结构体、枚举等都可以使用泛型
    <div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">struct</span> <span class="nc">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="n">x</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">    </span><span class="n">y</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="c1">//... 这里可以使用 T</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="k">enum</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">    </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>可以为带泛型的结构体针对某一具体类型实现方法：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">Point</span><span class="o">&lt;</span><span class="kt">f32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="c1">// only for Point&lt;f32&gt;</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>调用泛型函数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">struct</span> <span class="nc">SGen</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span>: <span class="nc">SGen</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">    </span><span class="n">func</span><span class="p">(</span><span class="n">SGen</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">));</span><span class="w">         </span><span class="c1">// 隐式指定类型参数 T 为 char</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="n">func</span>::<span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SGen</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">));</span><span class="w"> </span><span class="c1">// 显式指定类型参数 T 为 char</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>const 泛型，定义一个基于值的泛型参数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">..</span><span class="p">.,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arr</span>: <span class="p">[</span><span class="n">T</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>const 泛型参数只能接受不带其它泛型参数的实参</li>
</ul>
</li>
</ul>
<h2 id="trait">特征 Trait<a class="headerlink" href="#trait" title="Permanent link">&para;</a></h2>
<p>特征类似于 python 中的抽象基类，规定一些必须有的方法，但差别还是很大</p>
<ul>
<li>定义 trait
    <div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func1</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">..</span><span class="p">.;</span><span class="w"> </span><span class="c1">// 分号结尾，不用写函数内容</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func2</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="c1">// 提供默认实现</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>pub 关键字使之可以从外部导入</li>
<li>trait 块中对于需要实现的方法可以只写签名，也可以将函数写完整来提供一个默认实现</li>
</ul>
</li>
<li>为类型实现特征
    <div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func1</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>孤儿规则：为 A 类型实现特征 T，则 A 和 T 中至少有一个在当前作用域中定义，例如不可以为标准库中的类型实现其它标准库中的特征。确保某一库中的代码不会被在被使用的时候破坏</li>
<li>如果一个特征的方法都有默认实现，则花括号内可以不写任何东西</li>
</ul>
</li>
<li>特征约束<ul>
<li>参数里直接写特征是泛型的一个语法糖，以下两行代码效果一样
    <div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="n">arg</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">MyTrait</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div></li>
<li>参数里有特征时不会强制所有这样的参数为同一类型，比如以下三行代码 1 和 2 等价、和 3 不等价
    <div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">MyTrait</span><span class="p">,</span><span class="w"> </span><span class="n">U</span>: <span class="nc">MyTrait</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="nc">U</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">MyTrait</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div></li>
<li>多重约束
    <div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="n">arg</span>: <span class="kp">&amp;</span><span class="p">(</span><span class="k">impl</span><span class="w"> </span><span class="n">Trait1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Trait2</span><span class="p">))</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Trait1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Trait2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div></li>
<li>where 约束
    <div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">u</span>: <span class="kp">&amp;</span><span class="nc">U</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">T</span>: <span class="nc">Trait1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Trait2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Trait3</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">          </span><span class="n">U</span>: <span class="nc">Trait4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Trait5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Trait6</span><span class="w"></span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="p">{}</span><span class="w"></span>
</code></pre></div></li>
<li>函数返回值可以只说实现了某个特征的类型，而不明确规定
    <div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>derive 可以派生特征，使用默认实现，如前面写过的 <code class="highlight"><span class="cp">#[derive(Debug)]</span><span class="w"></span></code><ul>
<li>Debug、PartialEq、Eq、PartialOrd、Ord、Clone、Copy、Hash、Default</li>
<li>多个的话中间逗号分隔</li>
</ul>
</li>
<li>调用实现了某一特征的类型的方法时需要先用 use 将特征引入</li>
<li>例子<ul>
<li>为 Point 实现加法
    <div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">Add</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="k">struct</span> <span class="nc">Point</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Add</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">    </span><span class="n">x</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">    </span><span class="n">y</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Add</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// 关联类型</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">p</span>: <span class="nc">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">        </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">            </span><span class="n">x</span>: <span class="nc">self</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">            </span><span class="n">y</span>: <span class="nc">self</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>为 Point 实现格式化输出
    <div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="k">impl</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;({}, {})&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="_39">特征对象<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>比如使用一个 Vec 来存储实现同一个特征的不同类型的时候，就需要用到特征对象，例如 <code class="highlight"><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">MyTrait</span><span class="o">&gt;&gt;</span><span class="w"></span></code></p>
<ul>
<li>使用泛型来代替的话，Vec 中的所有值类型必须一致</li>
<li>只能使用 &amp; 引用或者使用 Box 智能指针来创建特征对象<ul>
<li><code>&amp;dyn MyTrait</code> 在用的时候需要用 &amp; 借用</li>
<li><code>Box&lt;dyn MyTrait&gt;</code> 在用的时候需要通过 Box::new(...) 来基于某个值创建智能指针</li>
<li>创建的时候不需要加 dyn</li>
<li>不使用这两种方法的话，大小会未知，但 &amp;dyn 和 Box&lt;dyn>  大小都已知</li>
<li>dyn 代表动态分发（dynamic dispatch）</li>
</ul>
</li>
<li>特征对象的限制：只有对象安全的特征才能创建特征对象<ul>
<li>对象安全：<ul>
<li>方法的返回类型不能是 Self</li>
<li>方法没有任何泛型参数</li>
</ul>
</li>
<li>Clone 特征的 clone 方法返回的就是 Self，因此它不是对象安全的。<code class="highlight"><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Clone</span><span class="o">&gt;</span><span class="w"></span></code> 的写法会报错</li>
</ul>
</li>
</ul>
<h3 id="_40">关联类型<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>关联类型定义 trait 块中，可以在后续的方法中使用该类型。例如 Iterator 的定义：
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">Iterator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>这种写法比为 Iterator 增加一个泛型更有可读性，而且写起来也简便</p>
<h3 id="_41">默认泛型类型参数<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>例如 Add 这个 trait：
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="k">trait</span><span class="w"> </span><span class="n">Add</span><span class="o">&lt;</span><span class="n">RHS</span><span class="o">=</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">RHS</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>Add 的 RHS 泛型参数带有一个默认值 Self，也就是说，在 impl 的时候，如果不为 Add 指定类型，则默认 RHS 是 Self，即要加的东西类型和被加的东西类型一致。例如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">struct</span> <span class="nc">Point</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="w">    </span><span class="n">x</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">    </span><span class="n">y</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="k">impl</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 默认就是要加 Point</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="nc">Point</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Point</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h3 id="_42">同名方法调用<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>当一个类型的方法与它实现的 trait 的方法名重名时，直接调用会调用类型上的方法。想要调用 trait 上的方法时需要使用 :: 来显式调用，如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="k">trait</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="k">trait</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="k">struct</span> <span class="nc">C</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="k">impl</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="k">impl</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="k">impl</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">func</span><span class="p">();</span><span class="w">       </span><span class="c1">// C</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="w">    </span><span class="n">A</span>::<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span><span class="w">    </span><span class="c1">// A</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="w">    </span><span class="n">B</span>::<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span><span class="w">    </span><span class="c1">// B</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="w">    </span><span class="n">C</span>::<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span><span class="w">    </span><span class="c1">// C 与第一个相同，但显式调用</span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>这样调用的一个条件是方法的第一个参数是 self（又叫方法接收器 receiver），但如果是关联函数的话，就没有这个 receiver，rust 也就自然不知道是调用哪个类型实现的特征上的方法</p>
<p>这时需要使用完全限定语法：
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Trait</span><span class="o">&gt;</span>::<span class="n">function</span><span class="p">(</span><span class="n">receiver_if_method</span><span class="p">,</span><span class="w"> </span><span class="n">next_arg</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.);</span><span class="w"></span>
</code></pre></div>
例如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">trait</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="k">struct</span> <span class="nc">B</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="k">impl</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="k">impl</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">    </span><span class="n">B</span>::<span class="n">func</span><span class="p">();</span><span class="w">          </span><span class="c1">// B</span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="c1">//  A::func();          // 报错</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="w">    </span><span class="o">&lt;</span><span class="n">B</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span>::<span class="n">func</span><span class="p">();</span><span class="w">   </span><span class="c1">// A</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h3 id="trait-trait">trait 定义中的 trait 约束<a class="headerlink" href="#trait-trait" title="Permanent link">&para;</a></h3>
<p>如果在定义特征 A 的时候需要使用特征 B 的方法，则 A 和 B 都要实现（实现了就好，先后无所谓）。在定义 A 的时候就可以在后面加上约束 B：
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="k">trait</span><span class="w"> </span><span class="n">A</span>: <span class="nc">B</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h3 id="_43">绕过孤儿规则<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>绕过孤儿规则，也就是在外部类型上实现外部特征，一种方法是使用 newtype 模式，即创建一个元祖结构体来包装外部类型，这样就构造了一个在当前作用域内的新类型</p>
<p>比如想要为 <code class="highlight"><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"></span></code> 实现 Display trait，二者都在标准库中，无法直接实现。使用 newtype 模式：
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="k">struct</span> <span class="nc">Wrapper</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="k">impl</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Wrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[{}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wrapper</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">),</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;def&quot;</span><span class="p">)]);</span><span class="w"></span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;w = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h2 id="_44">集合类型<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h2>
<h3 id="vector">Vector<a class="headerlink" href="#vector" title="Permanent link">&para;</a></h3>
<ul>
<li>动态数组，类型 Vec&lt;T></li>
<li>创建<ul>
<li>使用 Vec::new() 创建<ul>
<li>如果预先知道容量，可以使用 Vec::with_capacity(cap) 创建，会提升性能</li>
</ul>
</li>
<li>使用 vec! 宏来创建，同时给予初值
    <div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span><span class="w"> </span><span class="c1">// 自动推断类型</span>
</code></pre></div></li>
<li>使用 Vec::from(...) 来从数组创建</li>
</ul>
</li>
<li>Vector 类型在移出作用域后会自动删除，其存储的内容也会被删除</li>
<li>操作<ul>
<li>.push(...) 在末尾添加元素</li>
<li>.pop() 剔除末尾元素</li>
<li>.extend(...) 扩展</li>
<li>.len() 获取长度</li>
<li>可以使用切片来借用元素（越界会 panic）</li>
<li>.get(index) 来根据索引访问元素，返回类型是 Option&lt;&amp;T>（越界返回 None）</li>
<li><code class="highlight"><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="w"></span></code> 遍历</li>
<li>利用 enum 或特征对象来存储不同类型的</li>
</ul>
</li>
</ul>
<h3 id="hashmap">HashMap<a class="headerlink" href="#hashmap" title="Permanent link">&para;</a></h3>
<ul>
<li>存储键值对，类型 HashMap&lt;K, V></li>
<li>需要使用 std::collections::HashMap 引入</li>
<li>key 一定要实现 Hash 和 Eq trait<ul>
<li>f32 和 f64 不可以</li>
</ul>
</li>
<li>创建<ul>
<li>HashMap::new()</li>
<li>HashMap::with_capacity(cap)</li>
<li>使用迭代器和 collect
    <div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">lst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[(</span><span class="n">key1</span><span class="p">,</span><span class="w"> </span><span class="n">value1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">key2</span><span class="p">,</span><span class="w"> </span><span class="n">value2</span><span class="p">),</span><span class="w"> </span><span class="o">..</span><span class="p">.];</span><span class="w"></span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">map</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lst</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>操作<ul>
<li>.insert(key, value) 插入一个键值对</li>
<li>.get(key) 获取值，返回 Option&lt;V> 类型</li>
<li>直接使用 [key] 获取值，没有 key 会 panic</li>
<li>.entry(key).or_insert(value)<ul>
<li>如果存在 key，则返回 key 对应的值</li>
<li>如果不存在 key，则插入 key-value 键值对</li>
<li>返回一个 &amp;mut V 引用，可以直接修改 map 中内容</li>
</ul>
</li>
<li>.contains_key(key) 查询是否存在 key</li>
</ul>
</li>
</ul>
<h2 id="_45">类型转换<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h2>
<ul>
<li>一般情况下（方法调用除外）Rust 不会进行隐式的类型转换</li>
<li>使用 as <em>type</em> 进行显式的转换</li>
<li>超过最大值会溢出，如 300_i32 as i8 会得到 44，而不会 panic</li>
<li>内存地址转换为指针
    <div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">values</span>: <span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">p1</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">first_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"> </span><span class="c1">// 将 p1 内存地址转换为一个整数</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">second_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">second_address</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="c1">// 访问该地址指向的下一个整数 p2</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="w">    </span><span class="o">*</span><span class="n">p2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
<li>TryInto 转换<ul>
<li>use std::convert::TryInto，但不必要，在 prelude 中</li>
<li>TryInto trait 有 .try_into 方法，返回一个 Result，使用 .unwrap() 提取
    <div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u16</span> <span class="o">=</span><span class="w"> </span><span class="mi">1500</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u8</span> <span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div></li>
<li>大类型转换为小类型会返回 Err(e)</li>
</ul>
</li>
</ul>
<h3 id="_46">方法调用时的强制类型转换<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>例如在调用 a.func() 时（a 的类型为 T），编译器会进行以下操作</p>
<ol>
<li>尝试值方法调用，即 T::func(a)</li>
<li>如果上一步无法完成，则尝试引用方法调用，即<ul>
<li>&lt;&amp;T>::func(a)</li>
<li>&lt;&amp;mut T>::func(a)</li>
</ul>
</li>
<li>如果上一步仍然无法完成，则试着解引用 T，如果 T 满足 Deref&lt;Target = U>，即 T 可以被解引用为 U，则编译器会使用 U 类型尝试调用（从 1 开始同样的步骤），称为解引用方法调用</li>
<li>如果 T 不能被解引用，且 T 是一个定长类型，则编译器会尝试将 T 转为不定长类型（例如 [i32; 2] 转为 [i32]）</li>
<li>如果上面都不行，则不能通过编译</li>
</ol>
<details class="example" open="open">
<summary>例 1</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">array</span>: <span class="nc">Rc</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="p">[</span><span class="n">T</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.;</span><span class="w"></span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="c1">// 可以获取第一个元素</span>
</code></pre></div>
<p>会进行以下步骤：</p>
<ol>
<li>array[0] 实际上表示 array.index(0)（Index trait）</li>
<li>检查 array 是否实现 Index 特征，Rc&lt;Box&lt;[T; 3]>> 没有实现，尝试不可变引用和可变引用，都没有实现，无法调用</li>
<li>尝试解引用 array，变为 Box&lt;[T; 3]> 类型，对其调用 .index(0)</li>
<li>Box&lt;[T; 3]>、&amp;Box&lt;[T; 3]>、&amp;mut Box&lt;[T; 3]> 都没有实现 Index，无法调用</li>
<li>解引用 Box&lt;[T; 3]>，得到 [T; 3]</li>
<li>[T; 3] 也没有实现 Index（只有数组切片才可以通过索引访问），引用、解引用都不行</li>
<li>将定长 [T; 3] 转为不定长 [T]，也就是数组切片，它实现了 Index，可以调用 .index(0) 方法</li>
</ol>
</details>
<details class="example">
<summary>例 2</summary>
<p>已知 clone 方法的签名是 <code class="highlight"><span class="k">fn</span> <span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="p">;</span><span class="w"></span></code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Clone</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cloned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
上述代码中因为 value 本身是 &amp;T 类型，所以可以直接调用 clone 方法得到一个 T 类型的 cloned
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cloned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
上述代码虽然没有为 T 限制 Clone 特征，但是仍然可以通过编译。这时无法直接调用 value.clone()，所以会尝试进行引用方法调用，此时 T 变为 &amp;T，&amp;T 实现了 Clone 特征，所以可以调用，但这时 clone 的签名相当于 <code class="highlight"><span class="k">fn</span> <span class="nf">clone</span><span class="p">(</span><span class="o">&amp;&amp;</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">T</span><span class="w"></span></code>，所以最后得到的结果 cloned 的类型为 &amp;T</p>
</details>
<h2 id="_47">返回值与错误处理<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h2>
<p>Rust 认为的两种错误：</p>
<ul>
<li>可恢复错误，只影响用户自身的操作，不会对系统产生影响</li>
<li>不可恢复错误，全局性或者系统性的错误，对于系统影响很大</li>
</ul>
<p>Rust 推荐可恢复错误使用 Result&lt;T, E> 返回值等待后续处理异常，不可恢复错误直接 panic 终端程序</p>
<h3 id="panic">panic<a class="headerlink" href="#panic" title="Permanent link">&para;</a></h3>
<ul>
<li>可以通过 panic! 宏来直接抛出一个 panic</li>
<li>运行时带有 RUST_BACKTRACE=1 环境变量的话，会显示回溯栈（需要开启 debug 标志）</li>
<li>panic 时有两种方式来终止：<ul>
<li>栈展开：回溯栈上数据和函数调用，可以提供充分报错信息和栈调用信息</li>
<li>直接终止：不清理数据，直接退出程序，交给系统来清理</li>
<li>默认情况是栈展开</li>
<li>直接终止编译出的可执行文件更小，可以在 release 时指定使用直接终止：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">[profile.release]</span><span class="w"></span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="n">panic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;abort&#39;</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>如果是 main 线程 panic 了，则程序终止。如果子线程 panic 了，则线程终止，main 线程仍然运行，程序不会结束</li>
</ul>
<h3 id="result">Result<a class="headerlink" href="#result" title="Permanent link">&para;</a></h3>
<p>Result 是一个枚举类型，定义为：
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="k">enum</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<ul>
<li>使用 match 来处理 Result 类型<ul>
<li>例如 IO 错误，可以对于 Err(error) 再匹配 error.kind()，其可能的值在 std::io::ErrorKind 中</li>
<li>可以配合 panic，将 error 用 debug 模式（{:?}）进行输出</li>
</ul>
</li>
<li>对于 Result，如果失败就 panic<ul>
<li>使用 .unwrap()：如果是 Err 则会 panic，并输出错误内容</li>
<li>使用 .expect("...")：同样 panic，但会显示为 panicked at '...: <em>Err 内容</em>'</li>
</ul>
</li>
<li><code>?</code> 传播错误<ul>
<li>在函数中判断 Result，并传递返回 Err 可以写为
    <div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="s">&quot;test.txt&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">    </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>其中 match-return Err 部分可以利用 ? 来简写：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;test.txt&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div></li>
<li>? 在返回 Err 的时候会自动转换错误类型，例如：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="s">&quot;test.txt&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>在 ? 处理返回错误的时候，得到的是 std::io::Error 类型，? 可以自动调用 From trait 的 from 方法，将 std::io::Error 转为需要的 Box&lt;dyn std::error::Error></li>
</ul>
</li>
<li>? 可以进行链式调用：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="w">    </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="s">&quot;test.txt&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>对于这个操作，Rust 标准库提供了 std::fs::read_to_string(filename) 函数，而且返回的就是 Result&lt;String, std::io::Error></li>
</ul>
</li>
</ul>
</li>
<li>? 结合 Option<ul>
<li>和 Result 同理，? 也适用于 Option 的返回，也就是得到 None 就立即返回 None，否则展开出 Some 中的值</li>
</ul>
</li>
<li>main 函数返回值<ul>
<li>main 函数可以有返回值类型 Result&lt;(), Box&lt;dyn std::error::Error>></li>
<li>只有声明了这种返回值的 main 函数中才可以使用 ? 来提前探测错误终止 main 函数：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="s">&quot;test.txt&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>try! 宏<ul>
<li>? 的早期版本，避免使用</li>
<li>定义：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="w">    </span><span class="p">(</span><span class="cp">$e</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">match</span><span class="w"> </span><span class="cp">$e</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span>::<span class="n">std</span>::<span class="n">convert</span>::<span class="nb">From</span>::<span class="n">from</span><span class="p">(</span><span class="n">err</span><span class="p">)),</span><span class="w"></span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">    </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>使用方法，以下两行等价：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">try</span><span class="o">!</span><span class="p">(</span><span class="n">func</span><span class="p">());</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="_48">包和模块<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h2>
<h3 id="crate-package">crate 与 package<a class="headerlink" href="#crate-package" title="Permanent link">&para;</a></h3>
<ul>
<li>crate 是一个独立的可编译单元，可以编译出可执行文件或者一个库</li>
<li>package 是 cargo 创建的包含 Cargo.toml 的“项目”，可以包含因为功能性被组织在一起的一个 crate 或多个 crate<ul>
<li>一个 package 只能包含一个库（library）类型的 crate，可以包含多个二进制类型的 crate</li>
<li>cargo new 默认创建的就是二进制 package<ul>
<li>src/main.rs 是二进制 crate 的根文件，其包名和所属 package 相同，入口点在 main 函数</li>
</ul>
</li>
<li>cargo new &lt;<em>name</em>> --lib 创建库 package<ul>
<li>库 package 只能作为第三方库被引用，不能使用 cargo run 运行</li>
<li>src/lib.rs 是库类型同名 crate 的根文件</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="package">典型 package 结构<a class="headerlink" href="#package" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>.
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>├── Cargo.toml
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>├── Cargo.lock
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>├── src
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>│   ├── main.rs    // 默认二进制 crate（编译生成 package 同名可执行文件）
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>│   ├── lib.rs     // 唯一库 crate
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>│   └── bin        // 其余二进制 crate（分别生成文件名同名可执行文件）
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>│       └── main1.rs
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>│       └── main2.rs
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>├── tests     // 集成测试
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>│   └── some_integration_tests.rs
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>├── benches   // 基准性能测试 benchmark 文件
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>│   └── simple_bench.rs
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>└── examples  // 示例
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a>    └── simple_example.rs
</code></pre></div>
<h3 id="module">模块 Module<a class="headerlink" href="#module" title="Permanent link">&para;</a></h3>
<ul>
<li>在 lib.rs 中使用 mod 关键字创建模块，后接模块名</li>
<li>mod 可以嵌套，模块中可以定义各种 rust 类型</li>
<li>src/main.rs 和 src/lib.rs 称为 crate root</li>
<li>模块使用 :: 逐级访问<ul>
<li>crate 指根，使用 crate 也就相当于使用绝对路径</li>
<li>super 指父模块（上一级），相当于文件系统中的 ..</li>
<li>self 指自身模块</li>
</ul>
</li>
</ul>
<p>如下 lib.rs：
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="k">mod</span> <span class="nn">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="w">    </span><span class="k">mod</span> <span class="nn">B</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="w">        </span><span class="k">fn</span> <span class="nf">func_a</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="w">            </span><span class="bp">self</span>::<span class="n">func_b</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="w">        </span><span class="k">fn</span> <span class="nf">func_b</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="w">            </span><span class="k">super</span>::<span class="n">C</span>::<span class="n">func_c</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a><span class="w">    </span><span class="k">mod</span> <span class="nn">C</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a><span class="w">        </span><span class="k">fn</span> <span class="nf">func_c</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a><span class="w">    </span><span class="k">crate</span>::<span class="n">A</span>::<span class="n">B</span>::<span class="n">func_a</span><span class="p">();</span><span class="w"> </span><span class="c1">// 绝对路径引用</span>
<a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a><span class="w">    </span><span class="n">A</span>::<span class="n">B</span>::<span class="n">func_b</span><span class="p">();</span><span class="w">        </span><span class="c1">// 相对路径引用</span>
<a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a><span class="w">    </span><span class="bp">self</span>::<span class="n">A</span>::<span class="n">C</span>::<span class="n">func_c</span><span class="p">();</span><span class="w">  </span>
<a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
它的模块树为：
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>crate
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>  ├── func
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>  └── A
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>      ├── B
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>      │   ├── func_a
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>      │   └── func_b
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>      └── C
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>          └── func_c
</code></pre></div></p>
<ul>
<li>仅使用 mod <em>name</em>; 将创建一个模块，并从同目录下同名的 <em>name</em>.rs 中加载模块内容</li>
</ul>
<h4 id="_49">代码可见性<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h4>
<ul>
<li>默认情况下，所有类型（函数、方法、结构体、枚举……）都是私有的</li>
<li>父模块无法访问子模块中的私有项，而子模块可以访问父模块及更上层的模块的私有项</li>
<li>使用 pub 关键字将模块、函数等标为对外可见的</li>
<li>结构体与枚举的可见性<ul>
<li>仅将结构体设置为 pub，其内部所有字段仍然是私有的</li>
<li>仅将枚举设置为 pub，则其内部所有字段都对外可见</li>
</ul>
</li>
</ul>
<h4 id="use">use 引入<a class="headerlink" href="#use" title="Permanent link">&para;</a></h4>
<ul>
<li>使用 use 关键字来引入模块或类型，来简化调用</li>
<li>要避免同名调用</li>
<li>使用 as 来设置别名解决冲突问题，例如：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="nb">Result</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">IoResult</span><span class="p">;</span><span class="w"></span>
</code></pre></div></li>
<li>利用 use 导出，如：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="k">mod</span> <span class="nn">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">B</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func_b</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="k">pub</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">A</span>::<span class="n">B</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="w">    </span><span class="n">B</span>::<span class="n">func_b</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>从外部调用的时候也可以直接使用 B 模块</li>
</ul>
</li>
<li>可以使用 {} 来简化
    <div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="p">{</span><span class="w"></span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="w">    </span><span class="n">HashMap</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span><span class="n">BTreeMap</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w">    </span><span class="n">HashSet</span><span class="w"></span>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span><span class="n">cmp</span>::<span class="n">Ordering</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">};</span><span class="w"></span>
</code></pre></div><ul>
<li>{} 中可以使用 self：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Write</span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="c1">// 即 use std::io 以及 use std::io::Write</span>
</code></pre></div></li>
</ul>
</li>
<li>使用 * 引入模块下所有公开项，如 <code class="highlight"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span></code>，但要小心名称冲突</li>
</ul>
<h4 id="_50">使用第三方包<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h4>
<p>例如使用 rand 包：</p>
<ol>
<li>修改 Cargo.toml，在 [dependencies] 中添加 rand = "0.8.3"</li>
<li>在代码中使用 rand::... 即可
    <div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="k">use</span><span class="w"> </span><span class="n">rand</span>::<span class="n">Rng</span><span class="p">;</span><span class="w"> </span><span class="c1">// trait</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">().</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">101</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ol>
<p>可以在 <a href="https://crates.io">crates.io</a> 或 <a href="https://lib.rs">lib.rs</a> 中检索使用第三方包</p>
<h4 id="_51">受限可见性<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<ul>
<li><code class="highlight"><span class="k">pub</span><span class="w"></span></code> 表示无任何限制的完全可见</li>
<li><code class="highlight"><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"></span></code> 表示在当前包内可见</li>
<li><code class="highlight"><span class="k">pub</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"></span></code> 表示在当前模块中可见</li>
<li><code class="highlight"><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"></span></code> 表示在父模块中可见</li>
<li><code class="highlight"><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span></code> 表示在 &lt;path> 代表的模块中可见</li>
</ul>
<h4 id="_52">三种模块目录组织方式<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h4>
<ul>
<li>Rust 2015
    <div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>.
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>├── lib.rs
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>└── foo/
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>    ├── mod.rs
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>    └── bar.rs
</code></pre></div><ul>
<li>lib.rs 中 mod foo; 会引入 foo/mod.rs 中内容</li>
<li>需要在 foo/mod.rs 中继续为 bar.rs 创建同名 mod</li>
</ul>
</li>
<li>Rust 2018
    <div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>.
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>├── lib.rs
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>├── foo.rs
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>└── foo/
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>    └── bar.rs
</code></pre></div><ul>
<li>lib.rs 中 mod foo; 会引入 foo.rs</li>
<li>在 foo.rs 中 mod bar;</li>
<li>与 2015 的模式相比就相当于将 mod.rs 提到文件夹外的同名文件了</li>
</ul>
</li>
<li>使用 #[path = ...] 创建模块（慎用）
    <div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>.
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>├── lib.rs       
<a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>└── pkg/        // 任意
<a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>    ├── foo.rs
<a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>    └── bar.rs
</code></pre></div><ul>
<li>lib.rs 中在 mod foo; 前指定路径：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="cp">#[path = </span><span class="s">&quot;./pkg/foo.rs&quot;</span><span class="cp">]</span><span class="w"></span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">foo</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="cp">#[path = </span><span class="s">&quot;./pkg/bar.rs&quot;</span><span class="cp">]</span><span class="w"></span>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">bar</span><span class="p">;</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="_53">注释与文档<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h2>
<p>Rust 中注释分为两类：</p>
<ul>
<li>代码注释：说明某一段代码的作用（// 行注释和 /* ... */ 块注释）</li>
<li>文档注释：使用 markdown 语法，描述项目、介绍功能、生成文档<ul>
<li>包和模块注释：说明当前包和模块的功能</li>
</ul>
</li>
</ul>
<h3 id="_54">文档注释<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<ul>
<li>文档行注释 /// 与文档块注释 /** ... */<ul>
<li>文档注释需要位于库类型的 crate 中</li>
<li>可以使用 markdown 语法，以及代码块高亮显示</li>
<li>写在被注释类型上方</li>
<li>被注释的对象需要 pub 对外可见</li>
<li>文档注释中可以直接使用多个一级标题，常用的有<ul>
<li># Examples</li>
<li># Panics：描述函数可能会出现的 panic 情况</li>
<li># Errors：描述可能会出现的错误以及触发情况</li>
<li># Safety：unsafe 代码需要注意的使用条件</li>
</ul>
</li>
</ul>
</li>
<li>包/模块级别行注释 //! 与包/模块级别块注释 /*! ... */<ul>
<li>写在 crate root 的最上方</li>
</ul>
</li>
<li>使用 cargo doc 构建文档，生成在 target/doc 目录下<ul>
<li>使用 cargo doc --open 构建并打开</li>
</ul>
</li>
<li>文档测试<ul>
<li>文档注释中的代码块可以用作测试，直接写 assert 等宏就可以</li>
<li>使用 cargo test 会进行测试，并显示 "Doc-tests ..."</li>
<li>预期会造成 panic 等代码块需要在代码块语言后加上 should_panic：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="sd">/// # Panics</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="sd">/// </span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="sd">/// ```rust,should_panic</span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="sd">/// ...</span>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="sd">/// ```</span>
</code></pre></div></li>
<li>仅测试，不显示在文档中的行开头加 # 就可以：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="sd">/// ```</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="sd">/// # fn try_main() -&gt; Result&lt;(), String&gt; {</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="sd">/// let res = ...::func()?;</span>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="sd">/// #     Ok(())</span>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="sd">/// # }</span>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="sd">/// # fn main() {</span>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="sd">/// #     try_main().unwrap();</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="sd">/// # }</span>
</code></pre></div><ul>
<li>如上述例子，最终在文档中只会显示 let 那一行，但在进行 doc-test 时全部代码都会运行</li>
</ul>
</li>
</ul>
</li>
<li>代码跳转（自动链接）<ul>
<li>文档中写 [`Option`] 会在文档中创建一个指向标准库中 Option 类型的链接</li>
<li>也可以指定具体的路径来创建指向自己代码或其它库中指定项的链接</li>
<li>同名项可以标示类型：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="sd">/// 跳转到结构体  [`Foo`](struct@Foo)</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bar</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a><span class="sd">/// 跳转到同名函数 [`Foo`](fn@Foo)</span>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a>
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a><span class="sd">/// 跳转到同名宏 [`foo!`]</span>
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">Foo</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>
<a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a><span class="cp">#[macro_export]</span><span class="w"></span>
<a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a><span class="w">  </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>文档搜索别名
    <div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="cp">#[doc(alias = </span><span class="s">&quot;x&quot;</span><span class="cp">)]</span><span class="w"></span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="cp">#[doc(alias = </span><span class="s">&quot;big&quot;</span><span class="cp">)]</span><span class="w"></span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BigX</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a><span class="cp">#[doc(alias(</span><span class="s">&quot;y&quot;</span><span class="cp">, </span><span class="s">&quot;big&quot;</span><span class="cp">))]</span><span class="w"></span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BigY</span><span class="p">;</span><span class="w"></span>
</code></pre></div><ul>
<li>如上代码，在文档中搜索的时候，搜索 x 就会命中 BigX</li>
</ul>
</li>
</ul>
<h2 id="_55">格式化输出<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h2>
<p>Rust 的格式化就比较类似于 python 的 format 了</p>
<ul>
<li>格式化宏<ul>
<li>print!：格式化文本到标准输出，不换行</li>
<li>println!：格式化文本到标准输出，换行</li>
<li>format!：格式化文本，返回 String</li>
<li>eprint! 与 eprintln!：格式化到标准错误输出</li>
</ul>
</li>
<li>占位符<ul>
<li>{} 适用于实现了 std::fmt::Display trait 的类型，用于展示给用户</li>
<li>{:?} 适用于实现了 std::fmt::Debug trait 的类型，用于调试</li>
<li>{:#?} 同上，不过显示更优美（自动换行一类）</li>
</ul>
</li>
<li>实现 Display trait
    <div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="k">impl</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;...{}...&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.)</span><span class="w"></span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>只能为当前作用域中的类型实现 Display trait</li>
<li>为外部类型实现 Display 可以使用 newtype 模式</li>
</ul>
</li>
<li>位置参数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt;&quot;12&quot;</span>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{1}{0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt;&quot;21&quot;</span>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="w">    </span><span class="c1">// =&gt; Alice, this is Bob. Bob, this is Alice</span>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{0}, this is {1}. {1}, this is {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bob&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{1}{}{0}{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt; 2112</span>
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>对于 {:?} 或 {:#?}，将位置参数加在冒号前就可以</li>
</ul>
</li>
<li>具名参数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{argument}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt; &quot;test&quot;</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{name} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt; &quot;2 1&quot;</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{a} {c} {b}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt; &quot;a 3 b&quot;</span>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>带名称的参数只能放在不带名称的后面</li>
</ul>
</li>
<li>格式化参数<ul>
<li>宽度填充<ul>
<li>字符串
    <div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="c1">//-----------------------------------</span>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="c1">// 以下全部输出 &quot;Hello x    !&quot;</span>
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a><span class="c1">// 为&quot;x&quot;后面填充空格，补齐宽度5</span>
<a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:5}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a><span class="c1">// 使用参数5来指定宽度</span>
<a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:1$}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a><span class="c1">// 使用x作为占位符输出内容，同时使用5作为宽度</span>
<a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {1:0$}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a><span class="c1">// 使用有名称的参数作为宽度</span>
<a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:width$}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a><span class="c1">//-----------------------------------</span>
<a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a>
<a id="__codelineno-100-13" name="__codelineno-100-13" href="#__codelineno-100-13"></a><span class="c1">// 使用参数5为参数x指定宽度，同时在结尾输出参数5 =&gt; Hello x    !5</span>
<a id="__codelineno-100-14" name="__codelineno-100-14" href="#__codelineno-100-14"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:1$}!{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
<li>数字
    <div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="c1">// 宽度是5 =&gt; Hello     5!</span>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:5}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="c1">// 显式的输出正号 =&gt; Hello +5!</span>
<a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:+}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a><span class="c1">// 宽度5，使用0进行填充 =&gt; Hello 00005!</span>
<a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:05}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="c1">// 负号也要占用一位宽度 =&gt; Hello -0005!</span>
<a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:05}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
<li>对齐
    <div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="c1">// 以下全部都会补齐5个字符的长度</span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="c1">// 左对齐 =&gt; Hello x    !</span>
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:&lt;5}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a><span class="c1">// 右对齐 =&gt; Hello     x!</span>
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:&gt;5}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a><span class="c1">// 居中对齐 =&gt; Hello   x  !</span>
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:^5}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a><span class="c1">// 对齐并使用指定符号填充 =&gt; Hello x&amp;&amp;&amp;&amp;!</span>
<a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a><span class="c1">// 指定符号填充的前提条件是必须有对齐字符</span>
<a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:&amp;&lt;5}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>精度
    <div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.1415926</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="c1">// 保留小数点后两位 =&gt; 3.14</span>
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:.2}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a><span class="c1">// 带符号保留小数点后两位 =&gt; +3.14</span>
<a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:+.2}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a><span class="c1">// 不带小数 =&gt; 3</span>
<a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:.0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a><span class="c1">// 通过参数来设定精度 =&gt; 3.1416，相当于{:.4}</span>
<a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:.1$}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a>
<a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;abcded&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a><span class="c1">// 保留字符串前三个字符 =&gt; abc</span>
<a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:.3}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a><span class="c1">// {:.*}接收两个参数，第一个是精度，第二个是被格式化的值 =&gt; Hello abc!</span>
<a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello {:.*}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;abcdefg&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
<li>进制
    <div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="c1">// 二进制 =&gt; 0b11011!</span>
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:#b}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="c1">// 八进制 =&gt; 0o33!</span>
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:#o}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="c1">// 十进制 =&gt; 27!</span>
<a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="c1">// 小写十六进制 =&gt; 0x1b!</span>
<a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:#x}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a><span class="c1">// 大写十六进制 =&gt; 0x1B!</span>
<a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:#X}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a>
<a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a><span class="c1">// 不带前缀的十六进制 =&gt; 1b!</span>
<a id="__codelineno-104-13" name="__codelineno-104-13" href="#__codelineno-104-13"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:x}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-104-14" name="__codelineno-104-14" href="#__codelineno-104-14"></a>
<a id="__codelineno-104-15" name="__codelineno-104-15" href="#__codelineno-104-15"></a><span class="c1">// 使用0填充二进制，宽度为10 =&gt; 0b00011011!</span>
<a id="__codelineno-104-16" name="__codelineno-104-16" href="#__codelineno-104-16"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:#010b}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
<li>指数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:2e}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt; 1e9</span>
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:2E}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">);</span><span class="w"> </span><span class="c1">// =&gt; 1E9</span>
</code></pre></div></li>
<li>指针地址
    <div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:p}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">())</span><span class="w"> </span><span class="c1">// =&gt; 0x600002324050</span>
</code></pre></div></li>
<li>输出 { 或 } 要写两次进行转义</li>
</ul>
</li>
<li>1.58 中新增捕获环境值<ul>
<li>类似 python 中的 f-string，不过不需要特殊标注</li>
<li>捕获变量可以替换在任何位置
    <div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_format</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">get_scores</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{name}: {score:width$.precision$}&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>panic! 在 2021 版本下才可以这样使用</li>
</ul>
</li>
</ul>
<h2 id="_56">生命周期<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h2>
<ul>
<li>存在多个引用时，编译器有时会无法自动推导生命周期，需要手动标注</li>
<li>生命周期是为编译器而标注，并不会改变任何引用的实际作用域</li>
<li>生命周期以 ' 开头，名称往往是单独的小写字母（如 <code class="highlight"><span class="o">&#39;</span><span class="na">a</span><span class="w"></span></code>）
    <div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="o">&amp;</span><span class="kt">i32</span><span class="w">        </span><span class="c1">// i32 类型的引用</span>
<a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">i32</span><span class="w">     </span><span class="c1">// 带有显示生命周期 &#39;a 的 i32 引用</span>
<a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="c1">// 带有显示生命周期 &#39;a 的 i32 可变引用</span>
</code></pre></div></li>
<li>函数签名中使用生命周期需要先像泛型一样声明
    <div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span> <span class="p">{}</span><span class="w"></span>
</code></pre></div><ul>
<li>表示两个参数以及返回引用至少和 'a 活得一样久</li>
<li>两个参数的真实生命周期可能是不一样的，只需要不小于 'a 就可以</li>
<li>调用的时候不必标注生命周期</li>
</ul>
</li>
<li>生命周期语法用来将函数的多个引用参数和返回值的作用域关联到一起，避免了悬垂引用<ul>
<li>返回值是引用时，其生命周期只能来自参数，来自函数体内部的话就是悬垂引用</li>
</ul>
</li>
<li>结构体中生命周期<ul>
<li>结构体中使用生命周期可以保证内部引用类型的参数活得比结构体本身长
    <div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="k">struct</span> <span class="nc">MyStruct</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="w">    </span><span class="n">string</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>如下例即是结构体获得比内部参数长，会报错：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a><span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="w">        </span><span class="n">string</span>: <span class="nc">string</span><span class="p">.</span><span class="n">as_str</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a><span class="w">    </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>生命周期消除<ul>
<li>有时编译器可以自动推测生命周期，不需要显示标注</li>
<li>消除规则（推测规则）<ul>
<li>默认情况下每一个引用参数都会获得一个独自的生命周期</li>
<li>如果只有一个输入生命周期（参数的生命周期，即只有一个引用类型参数），则该生命周期会被赋给所有输出生命周期</li>
<li>如果存在多个输入生命周期，但其中一个是 <code class="highlight"><span class="o">&amp;</span><span class="bp">self</span><span class="w"></span></code> 或 <code class="highlight"><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="w"></span></code>，则 self 的生命周期会被赋给所有输出生命周期</li>
</ul>
</li>
<li>闭包不会遵循这个规则</li>
<li>impl 块生命周期消除（即省略）<ul>
<li>impl 块中没有用到的生命周期可以使用 '_ 来进行省略：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span>
<a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a><span class="k">impl</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
<li>为带有生命周期的结构体实现方法<ul>
<li>需要像泛型一样为 impl 和结构体名都标注上生命周期
    <div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyStruct</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">another_str</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">another_str</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">string</span><span class="w"></span>
<a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>上面例子中可以不为 method 标注生命周期，因为根据上面消除规则的第一和第三条，会自动推测为返回值标上和 <code class="highlight"><span class="o">&amp;</span><span class="bp">self</span><span class="w"></span></code> 一样的生命周期</li>
</ul>
</li>
</ul>
</li>
<li>生命周期约束<ul>
<li>如想要为上面 method 的返回值赋上和 another_str 一样的生命周期，则需要保证这个生命周期要比 self 的生命周期小，使用 <code class="highlight"><span class="o">&#39;</span><span class="na">a</span>: <span class="o">&#39;</span><span class="na">b</span></code> 语法来表示 'a 一定不小于 'b
    <div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span>: <span class="o">&#39;</span><span class="na">b</span><span class="p">,</span><span class="w"> </span><span class="o">&#39;</span><span class="na">b</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyStruct</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">method</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">another</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">b</span> <span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">b</span> <span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">another</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">string</span><span class="w"></span>
<a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>或者使用 where 来单独对一个方法进行约束：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyStruct</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">method</span><span class="o">&lt;&#39;</span><span class="na">b</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">another</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">b</span> <span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">b</span> <span class="kt">str</span>
<a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a>        <span class="nc">where</span><span class="w"> </span><span class="o">&#39;</span><span class="na">a</span>: <span class="o">&#39;</span><span class="na">b</span>
<a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a>    <span class="p">{</span><span class="w"></span>
<a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">another</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">string</span><span class="w"></span>
<a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-115-8" name="__codelineno-115-8" href="#__codelineno-115-8"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>T: 'a 表示类型 T 必须获得比 'a 久：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="k">struct</span> <span class="nc">Ref</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a><span class="w">    </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">T</span><span class="w"></span>
<a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>静态生命周期<ul>
<li>和整个程序活得一样久的引用可以使用 'static 来标注（例如字符串字面量）</li>
<li>&amp;'static 仅针对引用，而不是持有该引用的变量</li>
<li>取悦编译器可以使用 T: 'static，即使 T 不是 static 的
    <div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="k">fn</span> <span class="nf">static_bound</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Display</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;String&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a><span class="w">    </span><span class="n">static_bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>NLL（Non-Lexical Lifetime）规则<ul>
<li>Rust 1.31 后引用的生命周期从借用处开始一直持续到 <strong>最后一次使用的地方</strong></li>
</ul>
</li>
<li>Reborrow 再借用
    <div class="highlight"><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="p">{</span><span class="n">x</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">rr</span>: <span class="kp">&amp;</span><span class="nc">Point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rr</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a><span class="n">r</span><span class="p">.</span><span class="n">move_to</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span><span class="w"></span>
</code></pre></div><ul>
<li>可变借用和不可变的它的再借用可以同时存在，但是不能在再借用的生命周期内使用可变借用。也就是上面例子中在 rr 的生命周期内不能使用 r（rr 的生命周期由于 NLL 规则，到第一个 println! 的时候就已经结束了，后面可以继续使用 r）</li>
</ul>
</li>
</ul>
<h2 id="_57">闭包和迭代器<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h2>
<h3 id="_58">闭包<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<ul>
<li>一种匿名函数，可以赋值给变量也可以作为参数传递给函数，但可以捕获调用者作用域中的值
    <div class="highlight"><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">y</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
</code></pre></div></li>
<li>闭包语法：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="o">|</span><span class="n">para1</span><span class="p">,</span><span class="w"> </span><span class="n">para2</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="w">    </span><span class="n">statement1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="w">    </span><span class="n">statement2</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a><span class="w">    </span><span class="n">expression</span><span class="w"></span>
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="o">|</span><span class="n">para1</span><span class="p">,</span><span class="w"> </span><span class="n">para2</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="o">|</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
</code></pre></div></li>
<li>类型推导<ul>
<li>闭包不会作为 api 对外提供，可以直接依靠编译器的类型推导能力，无需手动标注
    ```rust
    let sum = |x, y| x + y;
    let v = sum(1, 2) // 编译器通过这句推导出类型
    ````</li>
<li>但当闭包只声明没有使用时，编译器并不能推导出类型，需要手动标注</li>
<li>当编译器推导出一种类型之后，就会一直使用该类型，而不能将闭包当作泛型使用</li>
</ul>
</li>
<li>结构体中存储闭包
    <div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="k">struct</span> <span class="nc">Cacher</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">T</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">E</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a><span class="w">          </span><span class="n">E</span>: <span class="nb">Copy</span>
<a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a><span class="w">    </span><span class="n">query</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a><span class="w">    </span><span class="n">value</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>闭包类型一定要通过泛型来定义，因为不同实现的类型都是不一样的，要求仅仅是实现 Fn(E) -&gt; E 这个 trait，即输入 E 返回 E</li>
</ul>
</li>
<li>三种 Fn trait<ul>
<li>FnOnce：只能运行一次（会带走被捕获变量的所有权）<ul>
<li>带走所有权的例子：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">y</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// 报错，因为所有权进入了闭包中    </span>
</code></pre></div></li>
<li>仅实现了 FnOnce 的闭包在调用时会转移所有权，不能调用两次：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="k">fn</span> <span class="nf">fn_once</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">func</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span>
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a><span class="w">    </span><span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a><span class="w">    </span><span class="n">func</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 报错</span>
<a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>但是给 F 加一个 Copy 的约束则可以调用多次</li>
</ul>
</li>
<li>在参数列表前加 move 关键字强制闭包获取捕获变量的所有权（聚焦于如何捕获变量）</li>
</ul>
</li>
<li>FnMut：以可变借用方式捕获环境中的值<ul>
<li>直接调用时需要将闭包标记为 mut
    <div class="highlight"><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">update_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">st</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="n">st</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a><span class="n">update_string</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
<li>当作变量时不需要标记为 mut
    <div class="highlight"><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="k">fn</span> <span class="nf">exec</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 这里需要 mut</span>
<a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a><span class="w">    </span><span class="n">f</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">update_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">st</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="n">st</span><span class="p">);</span><span class="w"> </span><span class="c1">// 这里不需要 mut</span>
<a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a><span class="w">    </span><span class="n">exec</span><span class="p">(</span><span class="n">update_string</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>Fn：以不可变借用的方式捕获环境中的值</li>
<li>一个闭包实现了哪种 Fn trait 取决于该闭包<strong>如何使用</strong>被捕获的变量，而不是如何捕获。而 move 则关注于如何捕获，有 move 则强制获取所有权<ul>
<li>使用了 move 关键字仍然可以实现 Fn trait（当闭包对于捕获变量的使用仅仅是不可变借用时）</li>
</ul>
</li>
<li>三种 Fn 的关系
    <div class="highlight"><pre><span></span><code><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">Fn</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span>: <span class="nb">FnMut</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;rust-call&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="nc">Args</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a>
<a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">FnMut</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span>: <span class="nb">FnOnce</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a><span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;rust-call&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="nc">Args</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a>
<a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-126-11" name="__codelineno-126-11" href="#__codelineno-126-11"></a><span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;rust-call&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="nc">Args</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-126-12" name="__codelineno-126-12" href="#__codelineno-126-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>所有闭包都会实现 FnOnce trait，因为至少可以被调用一次</li>
<li>没有移出捕获变量所有权的闭包自动实现 FnMut trait</li>
<li>不需要对捕获变量进行改变的闭包自动实现 Fn trait</li>
<li>实现 Fn 的前提是实现 FnMut，实现 FnMut 的前提是实现 FnOnce</li>
<li>Fn 获取 &amp;self、FnMut 获取 &amp;mut self、FnOnce 获取 self</li>
<li>建议先使用 Fn，然后靠编译器来判断正误以及如何选择</li>
</ul>
</li>
</ul>
</li>
<li>闭包作为返回值<ul>
<li>不能使用 Fn(...) -&gt; ... 作为返回值，因为它是特征，没有固定内存大小</li>
<li>可以使用 impl Fn(...) -&gt; ... 作为返回值</li>
<li>可以使用特征对象，即 Box&lt;dyn Fn(...) -> ...> 的形式</li>
</ul>
</li>
</ul>
<h3 id="_59">迭代器<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<ul>
<li>for 循环遍历数组实际上是在数组上调用了 into_iter 方法（来自 IntoIterator trait）</li>
<li>Iterator trait
    <div class="highlight"><pre><span></span><code><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">Iterator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>next 方法有值时返回 Some(...)，迭代结束则返回 None</li>
<li>手动迭代必须声明迭代器为 mut</li>
<li>仅需要实现 next 方法，其它方法有默认实现</li>
</ul>
</li>
<li>IntoIterator trait<ul>
<li>Iterator 自动实现 IntoIterator
    <div class="highlight"><pre><span></span><code><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">I</span>: <span class="nb">Iterator</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">IntoIterator</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span>::<span class="n">Item</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a><span class="w">    </span><span class="k">type</span> <span class="nc">IntoIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a><span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">into_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">I</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>into_iter、iter、iter_mut<ul>
<li>.into_iter 会夺走所有权</li>
<li>.iter 是不可变借用，调用 next 返回 Some(&amp;T)</li>
<li>.iter_mut 是可变借用，调用 next 返回 Some(&amp;mut T)</li>
</ul>
</li>
<li>消费者适配器<ul>
<li>内部调用了 next 的迭代器方法，会消耗迭代器上元素，返回其它值，称为消费者适配器</li>
<li>例如 .sum 方法，内部调用 next 来对所有元素求和，也会拿走迭代器的所有权</li>
<li>collect 方法可以将迭代器中的值收集到集合类型中，但需要先标注要收集到的类型
    <div class="highlight"><pre><span></span><code><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">v</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iterator</span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>迭代器适配器<ul>
<li>迭代器适配器或返回新的迭代器</li>
<li>例如 .map .filter .zip</li>
<li>可以进行链式调用，一般使用 collect 收尾收集元素</li>
</ul>
</li>
</ul>
<h2 id="_60">深入类型<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h2>
<ul>
<li>newtype<ul>
<li>即使用一个元组结构体来包装</li>
<li>可以为外部类型实现外部 trait</li>
<li>可以具有更好的可读性，以及可以实现类型异化</li>
</ul>
</li>
<li>类型别名<ul>
<li>如 <code class="highlight"><span class="k">type</span> <span class="nc">Meters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="w"></span></code></li>
<li>仅仅是别名，并不是全新类型，即上面 Meters 类型和 u32 在编译器眼里没有区别</li>
<li>可以增加可读性、简化代码</li>
</ul>
</li>
<li>用不返回类型 !<ul>
<li>对于 match，各分支返回的类型需要一致，但如果有分支返回 ! 类型，则可以忽略这个分支</li>
</ul>
</li>
<li>定长类型与不定长类型<ul>
<li>定长类型自动实现 Sized trait，并且在使用泛型的时候会自动添加 Sized 约束</li>
<li>不定长类型（动态大小类型，DST），包括切片、str、特征等（Vec 等集合类型是定长的，因为在栈上存储的信息定长）<ul>
<li>DST 无法单独使用，只能通过引用或者 Box 来间接使用，如将特征封装为特征对象</li>
<li>?Size 特征表示既有可能是固定大小类型也有可能是 DST：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div></li>
<li>将 str 包裹为 Box&lt;str> 不能直接使用 Box::new("..." as str)，因为这里并不能知道 str 的大小。可以使用 .into() 来让编译器来转换类型（将 &amp;str 转为 Box）
    <div class="highlight"><pre><span></span><code><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">s</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">();</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
<li>整数与枚举的类型转换
    <div class="highlight"><pre><span></span><code><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="k">enum</span> <span class="nc">MyEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a><span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a><span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>将枚举转换为整数可以直接使用 as：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyEnum</span>::<span class="n">A</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
</code></pre></div></li>
<li>整数转为枚举则相对复杂，有几种方法<ul>
<li>使用第三方库：num-traits num-derive 或 num_enums 等</li>
<li>使用 TryFrom trait
    <div class="highlight"><pre><span></span><code><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">convert</span>::<span class="n">TryFrom</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="k">impl</span><span class="w"> </span><span class="n">TryFrom</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">try_from</span><span class="p">(</span><span class="n">v</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-134-6" name="__codelineno-134-6" href="#__codelineno-134-6"></a><span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MyEnum</span>::<span class="n">A</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">MyEnum</span>::<span class="n">A</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-134-7" name="__codelineno-134-7" href="#__codelineno-134-7"></a><span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MyEnum</span>::<span class="n">B</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">MyEnum</span>::<span class="n">B</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-134-8" name="__codelineno-134-8" href="#__codelineno-134-8"></a><span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MyEnum</span>::<span class="n">C</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">MyEnum</span>::<span class="n">C</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-134-9" name="__codelineno-134-9" href="#__codelineno-134-9"></a><span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(()),</span><span class="w"></span>
<a id="__codelineno-134-10" name="__codelineno-134-10" href="#__codelineno-134-10"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-134-11" name="__codelineno-134-11" href="#__codelineno-134-11"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-134-12" name="__codelineno-134-12" href="#__codelineno-134-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>为 MyEnum 实现了 TryFrom&lt;i32> 后就可以调用 i32.try_into() 来尝试转为 MyEnum 了
    <div class="highlight"><pre><span></span><code><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">try_into</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">EyEnum</span>::<span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.,</span><span class="w"></span>
<a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>使用 unsafe transmute 转换
    <div class="highlight"><pre><span></span><code><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="cp">#[repr(i32)]</span><span class="w"> </span><span class="c1">// 规定内部存储为 i32</span>
<a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="k">enum</span> <span class="nc">MyEnum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a>
<a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="nc">MyEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="_61">智能指针<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h2>
<ul>
<li>引用仅是借用数据，而智能指针往往可以拥有指向的数据</li>
<li>智能指针实现了 Deref 和 Drop trait<ul>
<li>Deref 让智能指针可以像引用一样工作</li>
<li>Drop 允许指定智能指针超出作用域后自动执行的代码</li>
</ul>
</li>
</ul>
<h3 id="deref-trait">Deref trait<a class="headerlink" href="#deref-trait" title="Permanent link">&para;</a></h3>
<ul>
<li><code class="highlight"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">Deref</span><span class="w"></span></code></li>
<li>实现了 Deref 之后就可以使用 * 解引用了
    <div class="highlight"><pre><span></span><code><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">Deref</span><span class="w"></span>
<a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a><span class="k">struct</span> <span class="nc">MyBox</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyBox</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">MyBox</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MyBox</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Deref</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyBox</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-137-7" name="__codelineno-137-7" href="#__codelineno-137-7"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-137-8" name="__codelineno-137-8" href="#__codelineno-137-8"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">deref</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">Self</span>::<span class="n">Target</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-137-9" name="__codelineno-137-9" href="#__codelineno-137-9"></a><span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<a id="__codelineno-137-10" name="__codelineno-137-10" href="#__codelineno-137-10"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-137-11" name="__codelineno-137-11" href="#__codelineno-137-11"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>deref 返回内部值的正常引用，可以使用 * 来解引用</li>
<li>对 MyBox 进行解引用时实际上调用的是 <code class="highlight"><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">deref</span><span class="p">())</span><span class="w"></span></code></li>
</ul>
</li>
<li>参数中隐式 Deref 转换
    <div class="highlight"><pre><span></span><code><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyBox</span>::<span class="n">new</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a><span class="w">    </span><span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>调用时 &amp;s: &amp;MyBox<String\> -> &amp;String -&gt; &amp;str</li>
</ul>
</li>
<li>引用归一化<ul>
<li>智能指针会从结构体中脱壳出来得到内部的引用类型</li>
<li>多重引用可以归一化
    <div class="highlight"><pre><span></span><code><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Deref</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a><span class="w">    </span><span class="k">type</span> <span class="nc">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">deref</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a><span class="w">        </span><span class="o">*</span><span class="bp">self</span><span class="w">  </span><span class="c1">// 这里 self 是 &amp;&amp;T 类型</span>
<a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>DerefMut 与 Deref<ul>
<li>当 T: Deref&lt;Target=U> 时，&amp;T 可以转换为 &amp;U、&amp;mut T 也可以转换为 &amp;U（rust 可以把可变引用隐式转换为不可变引用）</li>
<li>当 T: DerefMut&lt;Target=U> 时，&amp;mut T 可以转换为 &amp;mut U</li>
<li>实现 DerefMut trait 需要先实现 Deref
    <div class="highlight"><pre><span></span><code><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">DerefMut</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">DerefMut</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyBox</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">deref_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Target</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="drop-trait">Drop trait<a class="headerlink" href="#drop-trait" title="Permanent link">&para;</a></h3>
<ul>
<li>变量离开作用域的时候会自动执行 Drop trait 的 drop 方法</li>
<li>可以为结构体自定义 drop
    <div class="highlight"><pre><span></span><code><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="k">struct</span> <span class="nc">A</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a><span class="k">struct</span> <span class="nc">B</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;drop A&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;drop B&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a><span class="k">struct</span> <span class="nc">C</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a><span class="w">    </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a><span class="w">    </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a><span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;drop C&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-141-12" name="__codelineno-141-12" href="#__codelineno-141-12"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;end&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-141-13" name="__codelineno-141-13" href="#__codelineno-141-13"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-141-14" name="__codelineno-141-14" href="#__codelineno-141-14"></a><span class="c1">// end</span>
<a id="__codelineno-141-15" name="__codelineno-141-15" href="#__codelineno-141-15"></a><span class="c1">// drop C</span>
<a id="__codelineno-141-16" name="__codelineno-141-16" href="#__codelineno-141-16"></a><span class="c1">// drop A</span>
<a id="__codelineno-141-17" name="__codelineno-141-17" href="#__codelineno-141-17"></a><span class="c1">// drop B</span>
</code></pre></div><ul>
<li>drop 方法借用目标使用的是可变引用，不会拿走所有权</li>
<li>结构体每个字段都会 drop</li>
<li>先声明的变量后 drop、结构体内部按顺序依次 drop</li>
<li>即使 C 不手动实现 Drop，也会调用到 A 和 B 的 drop，因为会为 C 提供默认的 Drop 实现</li>
</ul>
</li>
<li>.drop 函数不能手动调用，因为它是借用，后面依然可以访问原值，但是可能已经被清理了<ul>
<li>使用 std::mem::drop 函数（在 prelude 中）来手动 drop</li>
<li>std::mem::drop 的签名：<code class="highlight"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">drop</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"></span></code></li>
<li>这个 drop 是一个空实现，它可以带走目标的所有权，然后这个函数直接结束，目标的作用域也就结束了，导致自动调用 drop 方法来释放</li>
</ul>
</li>
<li>无法为同一个类型实现 Copy 和 Drop</li>
</ul>
<h3 id="box">Box<a class="headerlink" href="#box" title="Permanent link">&para;</a></h3>
<ul>
<li>Box&lt;T> 允许将一个值分配到堆上，然后在栈上保留一个智能指针指向堆上数据</li>
<li>可以将数据分配到堆上
    <div class="highlight"><pre><span></span><code><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;a = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="c1">// 利用 Deref 自动解引用</span>
<a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// 表达式中需要手动解引用</span>
</code></pre></div><ul>
<li>但是 Box::new 会先在栈上分配空间然后移到堆上，比如 Box::new([0; 1000000000000]) 会报错栈溢出</li>
</ul>
</li>
<li>避免栈上数据拷贝<ul>
<li>栈上数据所有权转移的时候会拷贝一份数据，但在堆上时堆上数据不会拷贝，仅仅需要拷贝一份栈上的指针即可完成所有权转移</li>
</ul>
</li>
<li>将 DST 变为固定大小类型<ul>
<li>如递归类型，rust 不知道递归类型需要多少空间，但包裹一层 Box 则可以变成固定大小
    <div class="highlight"><pre><span></span><code><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a><span class="k">enum</span> <span class="nc">List</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a><span class="w">    </span><span class="n">Cons</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a><span class="w">    </span><span class="n">Nil</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>将特征转为特征对象</li>
<li>Box::leak<ul>
<li>消费掉 Box，并强制目标值从内存中泄露</li>
<li>例如将 String 类型变成拥有 'static 生命周期的 &amp;str 类型
    <div class="highlight"><pre><span></span><code><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a><span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a><span class="w">    </span><span class="nb">Box</span>::<span class="n">leak</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">into_boxed_str</span><span class="p">())</span><span class="w"></span>
<a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="rc-arc">Rc 与 Arc<a class="headerlink" href="#rc-arc" title="Permanent link">&para;</a></h3>
<ul>
<li>Rc 即引用计数（reference counting），记录一个数据被引用的次数来确定数据是否被使用，当引用次数归零，则清理释放</li>
<li>使用 clone 来复制智能指针并增加引用计数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">rc</span>::<span class="n">Rc</span><span class="w"></span>
<a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rc</span>::<span class="n">new</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rc</span>::<span class="n">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Rc</span>::<span class="n">strong_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Rc</span>::<span class="n">strong_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">));</span><span class="w"></span>
</code></pre></div><ul>
<li>使用 Rc::strong_count 来获取计数</li>
</ul>
</li>
<li>Rc 在离开作用域时会被释放，并将引用数据的计数减一</li>
<li>Rc 是指向底层数据的不可变引用，无法通过它来修改数据</li>
<li>Rc 只能用在同一线程内部，多线程之间共享需要使用 Arc（Atomic Rc），其 api 一致但是线程安全的，不过效率会有所降低<ul>
<li>需要 <code class="highlight"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="w"></span></code></li>
</ul>
</li>
</ul>
<h3 id="cell-refcell">Cell 与 RefCell<a class="headerlink" href="#cell-refcell" title="Permanent link">&para;</a></h3>
<p>Cell&lt;T> 适用于 T 实现 Copy 的情况，而没有 Copy 的话则不能使用 Cell 只能使用 RefCell。二者都可以达到内部可变性的效果</p>
<p>Rust 规定一个结构体中的字段要么都是 immutable 要么都是 mutable，而不能将部分字段标记为 mutable。但可以使用 Cell 或 RefCell 包裹想要可变的字段，这样就实现了 immutable 结构体中部分字段可变的效果而不必将整个结构体标记为 mutable</p>
<h4 id="cell">Cell<a class="headerlink" href="#cell" title="Permanent link">&para;</a></h4>
<ul>
<li><code class="highlight"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">Cell</span><span class="p">;</span><span class="w"></span></code></li>
<li>.get() 取值（Copy 出来）</li>
<li>可以使用 .set() 设置新值而不需要将其标记为 mut
    <div class="highlight"><pre><span></span><code><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;abcd&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="n">c</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;efgh&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="c1">// abcd efgh</span>
</code></pre></div></li>
<li>例：<ul>
<li>下面代码会报错：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
<li>而下面的不会：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-148-4" name="__codelineno-148-4" href="#__codelineno-148-4"></a><span class="n">x</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-148-5" name="__codelineno-148-5" href="#__codelineno-148-5"></a><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
</code></pre></div><ul>
<li>这里 x 也不必声明为 mut，y z 都是 x 的不可变引用，可以共存</li>
<li>但可以通过 x y z 来改变 cell 中的值</li>
</ul>
</li>
</ul>
</li>
<li>Cell 没有性能损耗</li>
<li>Rust 1.37 中增加了两个方法，可以很好地解决借用冲突：<ul>
<li>Cell::from_mut，将 &amp;mut T 转为 &amp;Cell&lt;T></li>
<li>Cell::as_slice_of_cells，将 &amp;Cell&lt;[T]> 转为 &amp;[Cell&lt;T>]</li>
</ul>
</li>
</ul>
<h4 id="refcell">RefCell<a class="headerlink" href="#refcell" title="Permanent link">&para;</a></h4>
<ul>
<li><code class="highlight"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">RefCell</span><span class="p">;</span><span class="w"></span></code></li>
<li>可以使编译期可变和不可变引用共存</li>
<li>使用时可变和不可变引用一样不能共存，会 panic，并不能依次绕过借用规则</li>
<li>与 Cell 提供值相比，RefCell 提供引用<ul>
<li>.borrow() 创建不可变引用、.borrow_mut() 创建可变引用</li>
</ul>
</li>
<li>RefCell 适用于编译期误报或者一个引用在多处使用难以管理借用关系时</li>
<li>可以利用 RefCell 来创建一个不是 mut 但是内部值可变的东西
    <div class="highlight"><pre><span></span><code><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">RefCell</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Messenger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nb">String</span><span class="p">);</span><span class="w"> </span><span class="c1">// 定义时不是 &amp;mut self</span>
<a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MsgQueue</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-149-6" name="__codelineno-149-6" href="#__codelineno-149-6"></a><span class="w">    </span><span class="n">msg_cache</span>: <span class="nc">RefCell</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-149-7" name="__codelineno-149-7" href="#__codelineno-149-7"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-149-8" name="__codelineno-149-8" href="#__codelineno-149-8"></a><span class="k">impl</span><span class="w"> </span><span class="n">Messenger</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MsgQueue</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-149-9" name="__codelineno-149-9" href="#__codelineno-149-9"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-149-10" name="__codelineno-149-10" href="#__codelineno-149-10"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">msg_cache</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="c1">// self 不是 mut 的，msg_cache 也就不是 mut 的</span>
<a id="__codelineno-149-11" name="__codelineno-149-11" href="#__codelineno-149-11"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-149-12" name="__codelineno-149-12" href="#__codelineno-149-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>Rc 和 RefCell 组合使用，可以同时拥有多个所有者并实现数据的可变性：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">RefCell</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">rc</span>::<span class="n">Rc</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rc</span>::<span class="n">new</span><span class="p">(</span><span class="n">RefCell</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()));</span><span class="w"></span>
<a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-150-6" name="__codelineno-150-6" href="#__codelineno-150-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-150-7" name="__codelineno-150-7" href="#__codelineno-150-7"></a><span class="w">    </span><span class="n">s2</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push_str</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-150-8" name="__codelineno-150-8" href="#__codelineno-150-8"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}</span><span class="se">\n</span><span class="s">{:?}</span><span class="se">\n</span><span class="s">{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-150-9" name="__codelineno-150-9" href="#__codelineno-150-9"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>会输出三遍 <code>RefCell { value: "......" }</code></li>
<li>组合使用性能其实很高</li>
</ul>
</li>
</ul>
<h3 id="weak">Weak 弱引用<a class="headerlink" href="#weak" title="Permanent link">&para;</a></h3>
<ul>
<li><code class="highlight"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">rc</span>::<span class="n">Weak</span><span class="w"></span></code></li>
<li>使用 Rc 配合 RefCell 会构造出两个指针互相指也就是循环引用的情况，可能会造成引用计数无法清零不会 drop 从而造成内存泄漏</li>
<li>使用 Weak 可以解决循环引用的问题，它并不保证引用关系会存在，与 Rc 相比，它的特点：<ul>
<li>不会计数</li>
<li>不拥有值的所有权</li>
<li>不会阻止值的释放（Rc 只有当计数为 0 时才能 drop）</li>
</ul>
</li>
<li>Weak 在使用时需要先调用 upgrade 方法得到一个 Option&lt;Rc&lt;T>> 类型的值（当引用值存在时返回 Some(rc)，取出 Rc 使用，不存在时返回 None）</li>
<li>在 Rc&lt;T> 上调用 downgrade 方法即可获得 Weak&lt;T>，同时会计入到该 Rc 的一个 weak_count 上</li>
<li>当会造成循环引用时，将其中一支换为 Weak 即可避免</li>
</ul>
<h2 id="_62">多线程并发编程<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h2>
<h3 id="_63">使用线程<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<ul>
<li>创建线程<ul>
<li>使用 std::thread::spawn 创建线程</li>
<li>线程内部代码使用闭包来执行</li>
<li>main 线程结束则程序立即结束不会等到子线程全部结束</li>
<li>thread::sleep 休眠当前线程指定时间
<div class="highlight"><pre><span></span><code><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">Duration</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a><span class="w">    </span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-151-5" name="__codelineno-151-5" href="#__codelineno-151-5"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-151-6" name="__codelineno-151-6" href="#__codelineno-151-6"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;hi number {} from the spawned thread!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-151-7" name="__codelineno-151-7" href="#__codelineno-151-7"></a><span class="w">            </span><span class="n">thread</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-151-8" name="__codelineno-151-8" href="#__codelineno-151-8"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-151-9" name="__codelineno-151-9" href="#__codelineno-151-9"></a><span class="w">    </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-151-10" name="__codelineno-151-10" href="#__codelineno-151-10"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-151-11" name="__codelineno-151-11" href="#__codelineno-151-11"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;hi number {} from the main thread!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-151-12" name="__codelineno-151-12" href="#__codelineno-151-12"></a><span class="w">        </span><span class="n">thread</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-151-13" name="__codelineno-151-13" href="#__codelineno-151-13"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-151-14" name="__codelineno-151-14" href="#__codelineno-151-14"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>等待子线程结束<ul>
<li>spawn 会返回一个 JoinHandle&lt;()> 类型的值，可以在其上调用 .join 方法来阻塞当前线程
<div class="highlight"><pre><span></span><code><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"></span>
<a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a><span class="n">handle</span><span class="p">.</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>线程闭包中捕获变量<ul>
<li>创建线程的闭包中不能直接使用当前线程中的变量，因为无法确定创建的新线程会存活多久，可能在借用变量创建新线程，在新线程运行时，借用的原值已经被 drop</li>
<li>因此使用捕获变量的话一定要在参数列表前加上 move 关键字来强制转移所有权（也就是说当前线程后面将不可以在使用这个变量）</li>
</ul>
</li>
<li>barrier<ul>
<li>在多个线程内同步，即等待各线程执行到同一位置后再继续执行</li>
<li>使用 std::sync::Barrier，需要通过 Arc 来分配到各个线程中</li>
<li>调用其 .wait() 方法来对所有使用了 barrier 对线程进行同步
<div class="highlight"><pre><span></span><code><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="p">{</span><span class="n">Arc</span><span class="p">,</span><span class="w"> </span><span class="n">Barrier</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-153-4" name="__codelineno-153-4" href="#__codelineno-153-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-153-5" name="__codelineno-153-5" href="#__codelineno-153-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">barrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Barrier</span>::<span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-153-6" name="__codelineno-153-6" href="#__codelineno-153-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..=</span><span class="mi">5</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-153-7" name="__codelineno-153-7" href="#__codelineno-153-7"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">barrier</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-153-8" name="__codelineno-153-8" href="#__codelineno-153-8"></a><span class="w">        </span><span class="n">handles</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-153-9" name="__codelineno-153-9" href="#__codelineno-153-9"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;before wait&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-153-10" name="__codelineno-153-10" href="#__codelineno-153-10"></a><span class="w">            </span><span class="n">b</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-153-11" name="__codelineno-153-11" href="#__codelineno-153-11"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;after wait&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-153-12" name="__codelineno-153-12" href="#__codelineno-153-12"></a><span class="w">        </span><span class="p">}))</span><span class="w"></span>
<a id="__codelineno-153-13" name="__codelineno-153-13" href="#__codelineno-153-13"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-153-14" name="__codelineno-153-14" href="#__codelineno-153-14"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-153-15" name="__codelineno-153-15" href="#__codelineno-153-15"></a><span class="w">        </span><span class="n">handle</span><span class="p">.</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-153-16" name="__codelineno-153-16" href="#__codelineno-153-16"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-153-17" name="__codelineno-153-17" href="#__codelineno-153-17"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>线程局部变量<ul>
<li>标准库 thread_local 宏<ul>
<li>通过宏来创建一个生命周期为 'static 的线程局部变量</li>
<li>每个线程访问时都会使用它的初始值，且各线程间彼此不干扰</li>
<li>线程内部使用这个变量的 with 方法来获取值进行操作
<div class="highlight"><pre><span></span><code><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">RefCell</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-154-3" name="__codelineno-154-3" href="#__codelineno-154-3"></a><span class="fm">thread_local!</span><span class="p">(</span><span class="k">static</span><span class="w"> </span><span class="n">FOO</span>: <span class="nc">RefCell</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RefCell</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-154-4" name="__codelineno-154-4" href="#__codelineno-154-4"></a><span class="n">FOO</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">|</span><span class="n">f</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<a id="__codelineno-154-5" name="__codelineno-154-5" href="#__codelineno-154-5"></a><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-154-6" name="__codelineno-154-6" href="#__codelineno-154-6"></a><span class="w">    </span><span class="n">FOO</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="o">|</span><span class="n">f</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<a id="__codelineno-154-7" name="__codelineno-154-7" href="#__codelineno-154-7"></a><span class="p">}).</span><span class="n">join</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>第三方库 thread-local</li>
</ul>
</li>
</ul>
<p><strong>TODO：歇逼了，以后有时间有耐心了再看多线程</strong></p>
<h2 id="_64">全局变量<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h2>
<ul>
<li>编译期初始化<ul>
<li>静态常量<ul>
<li>使用 const 定义，必须指定类型，命名一般全大写</li>
<li>可以在任意作用域定义，生命周期贯穿整个程序</li>
<li>赋值只能是在编译期就能计算的表达式</li>
<li>不允许出现重复定义</li>
</ul>
</li>
<li>静态变量<ul>
<li>使用 static 定义，必须指定类型，命名一般全大写</li>
<li>必须使用 unsafe 语句块才能访问和修改 static 变量</li>
<li>只有在同一线程内或者不在乎多线程中数据准确性时才应该使用全局静态变量</li>
<li>赋值只能是在编译期就能计算的表达式</li>
<li>静态变量不会被内联，且整个程序中只有一个实例</li>
<li>存储在静态变量中的值需要实现 Sync trait</li>
</ul>
</li>
<li>原子类型<ul>
<li>可以作为全局计数器，且是线程安全的
<div class="highlight"><pre><span></span><code><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="p">{</span><span class="n">AtomicUsize</span><span class="p">.</span><span class="w"> </span><span class="n">Ordering</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a><span class="k">static</span><span class="w"> </span><span class="n">VAR</span>: <span class="nc">AtomicUsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AtomicUsize</span>::<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-155-3" name="__codelineno-155-3" href="#__codelineno-155-3"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-155-4" name="__codelineno-155-4" href="#__codelineno-155-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">100</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-155-5" name="__codelineno-155-5" href="#__codelineno-155-5"></a><span class="w">        </span><span class="n">VAR</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Relaxed</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-155-6" name="__codelineno-155-6" href="#__codelineno-155-6"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-155-7" name="__codelineno-155-7" href="#__codelineno-155-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
<li>运行期初始化<ul>
<li>使用 lazy_static 包中的 lazy_static 宏</li>
<li>使用 Box::leak</li>
</ul>
</li>
</ul>
<h2 id="_65">错误处理<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h2>
<ul>
<li>组合器<ul>
<li>.or() .and() 对两个 Option / Result 进行类似布尔类型的操作返回其中一个，如：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a><span class="nb">None</span><span class="p">.</span><span class="n">or</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c1">// -&gt; Some(1)</span>
<a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a><span class="nb">Ok</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">).</span><span class="n">and</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;err&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// -&gt; Err(&quot;err&quot;)</span>
</code></pre></div></li>
<li>.or_else() .and_then() 第二个表达式是一个返回 Option / Result 的闭包，其他和 or and 用法一样</li>
<li>.filter() 可以对 Option 进行过滤
    <div class="highlight"><pre><span></span><code><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-157-2" name="__codelineno-157-2" href="#__codelineno-157-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-157-3" name="__codelineno-157-3" href="#__codelineno-157-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-157-4" name="__codelineno-157-4" href="#__codelineno-157-4"></a><span class="kd">let</span><span class="w"> </span><span class="n">fn_is_even</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="kt">i8</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-157-5" name="__codelineno-157-5" href="#__codelineno-157-5"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fn_is_even</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w">  </span><span class="c1">// Some(3) -&gt; 3 is not even -&gt; None</span>
<a id="__codelineno-157-6" name="__codelineno-157-6" href="#__codelineno-157-6"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">s2</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fn_is_even</span><span class="p">),</span><span class="w"> </span><span class="n">s2</span><span class="p">);</span><span class="w"> </span><span class="c1">// Some(6) -&gt; 6 is even -&gt; Some(6)</span>
<a id="__codelineno-157-7" name="__codelineno-157-7" href="#__codelineno-157-7"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fn_is_even</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w">   </span><span class="c1">// None -&gt; no value -&gt; None</span>
</code></pre></div></li>
<li>.map() .map_err()<ul>
<li>.map() 根据闭包将 Some 或 Ok 中的值更改为另一个
    <div class="highlight"><pre><span></span><code><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="nb">Some</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">chars</span><span class="p">().</span><span class="n">count</span><span class="p">())</span><span class="w"> </span><span class="c1">// -&gt; Some(3)</span>
</code></pre></div></li>
<li>.map_err() 同理，是将 Err 中的值更改为另一个</li>
</ul>
</li>
<li>.map_or() .map_or_else()<ul>
<li>.map_or() 包含两个参数，当调用者是 Ok / Some 时，执行第二个参数中的闭包，返回闭包的返回值；当调用者是 Err / None 时返回第一个参数作为默认值</li>
<li>.map_or_else() 类似 map_or，不过第一个参数即默认值也使用闭包来提供</li>
</ul>
</li>
<li>.ok_or() .ok_or_else()<ul>
<li>.ok_or() 将 Option 转换为 Result
    <div class="highlight"><pre><span></span><code><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// -&gt; Ok(1)</span>
<a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a><span class="nb">None</span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// -&gt; Err(&quot;...&quot;)</span>
</code></pre></div></li>
<li>.ok_or_else() 类似，但参数由闭包来提供</li>
</ul>
</li>
</ul>
</li>
<li>自定义错误类型<ul>
<li>std::error::Error trait 定义
    <div class="highlight"><pre><span></span><code><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="p">{</span><span class="n">Debug</span><span class="p">,</span><span class="w"> </span><span class="n">Display</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Error</span>: <span class="nc">Debug</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">source</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="p">(</span><span class="n">Error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* 有默认实现 */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>由此可见，自定义错误类型只需要自动 derive Debug，然后手动实现一下 Display trait</li>
</ul>
</li>
<li>自定义错误类型
    <div class="highlight"><pre><span></span><code><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a><span class="k">struct</span> <span class="nc">MyError</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a><span class="k">impl</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-161-5" name="__codelineno-161-5" href="#__codelineno-161-5"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-161-6" name="__codelineno-161-6" href="#__codelineno-161-6"></a><span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my error&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-161-7" name="__codelineno-161-7" href="#__codelineno-161-7"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-161-8" name="__codelineno-161-8" href="#__codelineno-161-8"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-161-9" name="__codelineno-161-9" href="#__codelineno-161-9"></a><span class="k">fn</span> <span class="nf">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">MyError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-161-10" name="__codelineno-161-10" href="#__codelineno-161-10"></a><span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">MyError</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-161-11" name="__codelineno-161-11" href="#__codelineno-161-11"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>错误转换 From trait
    <div class="highlight"><pre><span></span><code><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a><span class="k">struct</span> <span class="nc">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a><span class="w">    </span><span class="n">message</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a><span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a><span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">error</span>: <span class="nc">io</span>::<span class="n">Error</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a><span class="w">        </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a><span class="w">            </span><span class="n">message</span>: <span class="nc">error</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-162-10" name="__codelineno-162-10" href="#__codelineno-162-10"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-162-11" name="__codelineno-162-11" href="#__codelineno-162-11"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-162-12" name="__codelineno-162-12" href="#__codelineno-162-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>这样实现了之后就可以在 ? 的时候支持自动将 io::Error 转换成 MyError</li>
</ul>
</li>
</ul>
</li>
<li>归一化错误类型<ul>
<li>例如将 std::env::VarError 和 std::io::Error 归一化为同一种类型</li>
<li>可以使用特征对象</li>
<li>可以自定义 enum 错误类型，但是代码较复杂</li>
<li>可以使用第三方包 thiserror 来简化自定义错误类型集合
    <div class="highlight"><pre><span></span><code><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a><span class="cp">#[derive(thiserror::Error, Debug)]</span><span class="w"></span>
<a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a><span class="k">enum</span> <span class="nc">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a><span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Environment variable not found&quot;</span><span class="cp">)]</span><span class="w"></span>
<a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a><span class="w">    </span><span class="n">EnvironmentVariableNotFound</span><span class="p">(</span><span class="cp">#[from]</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">VarError</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-163-5" name="__codelineno-163-5" href="#__codelineno-163-5"></a><span class="w">    </span><span class="cp">#[error(transparent)]</span><span class="w"></span>
<a id="__codelineno-163-6" name="__codelineno-163-6" href="#__codelineno-163-6"></a><span class="w">    </span><span class="n">IOError</span><span class="p">(</span><span class="cp">#[from]</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Error</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-163-7" name="__codelineno-163-7" href="#__codelineno-163-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>可以使用第三方包 anyhow 中的 anyhow::Result&lt;T>，不关心错误消息</li>
</ul>
</li>
</ul>
<h2 id="unsafe">unsafe<a class="headerlink" href="#unsafe" title="Permanent link">&para;</a></h2>
<p>unsafe 代码块有五种能力</p>
<ul>
<li>解引用裸指针</li>
<li>调用一个 unsafe 或外部的函数</li>
<li>访问或修改一个可变的静态变量（前面介绍过了）</li>
<li>实现一个 unsafe trait</li>
<li>访问 union 中的字段</li>
</ul>
<p>但 unsafe 代码块仍然受 rust 的安全支持，它并不能绕过 rust 的借用检查，也不能关闭任何 rust 的安全检查</p>
<h3 id="_66">解引用裸指针<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<ul>
<li>裸指针<ul>
<li>裸指针不适用 Rust 的借用规则，同时拥有一个数据的可变和不可变指针</li>
<li>裸指针不能保证指向合法的内存</li>
<li>裸指针可以是 null</li>
<li>裸指针没有实现任何自动的回收（drop）</li>
<li>裸指针可以使用加减法（对地址操作），但是这不会考虑单元大小，建议对裸指针调用 .add 方法（会自动乘单元大小）</li>
</ul>
</li>
<li>创建裸指针<ul>
<li>创建裸指针是 safe 的，不需要写在 unsafe 块中</li>
<li>裸指针有两种写法：<code class="highlight"><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"></span></code> 和 <code class="highlight"><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"></span></code> 分别表示 T 类型的不可变指针和可变指针（这里的 * 仅仅是记号，不表示解引用的含义）</li>
<li>基于引用创建裸指针
    <div class="highlight"><pre><span></span><code><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-164-3" name="__codelineno-164-3" href="#__codelineno-164-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
</code></pre></div></li>
<li>基于内存地址创建裸指针
    <div class="highlight"><pre><span></span><code><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x012345</span><span class="k">usize</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
</code></pre></div><ul>
<li>相当危险，但创建这样的裸指针仍然是 safe 的，只要不解引用</li>
</ul>
</li>
<li>基于智能指针创建裸指针
    <div class="highlight"><pre><span></span><code><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-166-2" name="__codelineno-166-2" href="#__codelineno-166-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">b</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-166-3" name="__codelineno-166-3" href="#__codelineno-166-3"></a><span class="kd">let</span><span class="w"> </span><span class="n">c</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
</code></pre></div></li>
<li>调用方法创建裸指针<ul>
<li>例如 String 的 .as_ptr() 和 .as_mut_ptr() 方法</li>
</ul>
</li>
</ul>
</li>
<li>解引用裸指针<ul>
<li>在 unsafe 块中可以直接使用 * 对裸指针进行解引用</li>
</ul>
</li>
</ul>
<h3 id="unsafe_1">调用 unsafe 或外部函数<a class="headerlink" href="#unsafe_1" title="Permanent link">&para;</a></h3>
<h4 id="unsafe_2">unsafe 函数<a class="headerlink" href="#unsafe_2" title="Permanent link">&para;</a></h4>
<ul>
<li>使用 unsafe fn 定义</li>
<li>不能直接调用，只能在 unsafe 块中调用，即要确保认识到了正在调用的是一个不安全的函数</li>
<li>包含 unsafe 块的函数不必都标记为 unsafe 函数，因为有些函数虽然用了 unsafe，但操作实际上是完全安全的（编译器保守认为其不安全）</li>
</ul>
<h4 id="ffi">FFI<a class="headerlink" href="#ffi" title="Permanent link">&para;</a></h4>
<ul>
<li>即 Foreign Function Interface，用来和其他语言进行交互</li>
<li>rust 调用 c<ul>
<li>需要在 rust 代码中写明要调用的函数签名</li>
<li>调用必须在 unsafe 块中进行</li>
<li>例如调用 C 标准库中的 abs 函数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-167-2" name="__codelineno-167-2" href="#__codelineno-167-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">abs</span><span class="p">(</span><span class="n">input</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-167-3" name="__codelineno-167-3" href="#__codelineno-167-3"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-167-4" name="__codelineno-167-4" href="#__codelineno-167-4"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-167-5" name="__codelineno-167-5" href="#__codelineno-167-5"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;abs(-1) = {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-167-6" name="__codelineno-167-6" href="#__codelineno-167-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>c 调用 rust
    <div class="highlight"><pre><span></span><code><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call_from_c</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-168-3" name="__codelineno-168-3" href="#__codelineno-168-3"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Call from C&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-168-4" name="__codelineno-168-4" href="#__codelineno-168-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>使用 extern 创建一个接口</li>
<li><code class="highlight"><span class="cp">#[no_mangle]</span><span class="w"></span></code> 告诉编译器不要修饰函数名</li>
</ul>
</li>
<li>实用工具<ul>
<li>自动生成 FFI 接口<ul>
<li>生成 rust 调用 c 的代码：<a href="https://github.com/rust-lang/rust-bindgen"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></span> rust-lang/rust-bindgen</a></li>
<li>从 rust 代码生成 c bindings：<a href="https://github.com/eqrion/cbindgen"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></span> eqrion/cbindgen</a></li>
</ul>
</li>
<li>与 C++ 代码交互（是安全的）：<a href="https://github.com/dtolnay/cxx"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></span> dtolnay/cxx</a></li>
</ul>
</li>
</ul>
<h3 id="unsafe-trait">实现 unsafe trait<a class="headerlink" href="#unsafe-trait" title="Permanent link">&para;</a></h3>
<ul>
<li>至少有一个方法包含编译器无法验证的内容的 trait 会被标为 unsafe</li>
<li>定义使用 unsafe trait 定义</li>
<li>实现方法使用 unsafe impl</li>
</ul>
<h3 id="union">访问 union 中字段<a class="headerlink" href="#union" title="Permanent link">&para;</a></h3>
<ul>
<li>类似结构体，但所有字段共用同一个存储空间，即向一个字段中写入值回覆盖其它字段
    <div class="highlight"><pre><span></span><code><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a><span class="k">union</span> <span class="nc">MyUnion</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a><span class="w">    </span><span class="n">f1</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a><span class="w">    </span><span class="n">f2</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-169-5" name="__codelineno-169-5" href="#__codelineno-169-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>访问 union 字段是不安全的，因为 rust 无法保证当前存储在 union 实例中的数据类型，但写入是安全的</li>
</ul>
<h2 id="macro">macro 宏编程<a class="headerlink" href="#macro" title="Permanent link">&para;</a></h2>
<h3 id="_67">声明式宏<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<ul>
<li>使用 macro_rules! 进行定义，匹配代码并生成代码
    <div class="highlight"><pre><span></span><code><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a><span class="cp">#[macro_export]</span><span class="w"></span>
<a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">myvec</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-170-3" name="__codelineno-170-3" href="#__codelineno-170-3"></a><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="cp">$(</span><span class="w"> </span><span class="cp">$x</span>:<span class="nc">expr</span><span class="w"> </span><span class="p">),</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-170-4" name="__codelineno-170-4" href="#__codelineno-170-4"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-170-5" name="__codelineno-170-5" href="#__codelineno-170-5"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">tmp_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-170-6" name="__codelineno-170-6" href="#__codelineno-170-6"></a><span class="w">            </span><span class="cp">$(</span><span class="w"></span>
<a id="__codelineno-170-7" name="__codelineno-170-7" href="#__codelineno-170-7"></a><span class="w">                </span><span class="n">tmp_vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="cp">$x</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-170-8" name="__codelineno-170-8" href="#__codelineno-170-8"></a><span class="w">            </span><span class="p">)</span><span class="o">*</span><span class="w"></span>
<a id="__codelineno-170-9" name="__codelineno-170-9" href="#__codelineno-170-9"></a><span class="w">            </span><span class="n">tmp_vec</span><span class="w"></span>
<a id="__codelineno-170-10" name="__codelineno-170-10" href="#__codelineno-170-10"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-170-11" name="__codelineno-170-11" href="#__codelineno-170-11"></a><span class="w">    </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-170-12" name="__codelineno-170-12" href="#__codelineno-170-12"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>宏名称不必加 !，但调用时需要加</li>
<li><code class="highlight"><span class="cp">#[macro_export]</span><span class="w"></span></code> 用于导出宏，让其它包可以引入使用</li>
<li>进行输入代码的模式匹配，使用 <code class="highlight"><span class="p">(</span><span class="w"> </span><span class="cp">$(</span><span class="w"> </span><span class="cp">$x</span>:<span class="nc">expr</span><span class="w"> </span><span class="p">),</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"></span></code> 匹配多个以 , 分隔的表达式，每个记为 $x 供后面代码中使用，* 代表前面的模式可以出现任意次（包括 0）</li>
<li>=&gt; 后面是要生成的目标代码</li>
<li>可以使用 <code class="highlight"><span class="n">myvec</span><span class="o">!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"></span></code> 创建 Vec，也可以使用 <code class="highlight"><span class="n">myvec</span><span class="o">!</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"></span></code> 或 <code class="highlight"><span class="n">myvec</span><span class="o">!</span><span class="p">{</span><span class="o">..</span><span class="p">.}</span><span class="w"></span></code>，这三者等价</li>
</ul>
</li>
<li>详细用法 TODO：<a href="https://veykril.github.io/tlborm/">https://veykril.github.io/tlborm/</a></li>
</ul>
<h3 id="_68">过程宏<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<ul>
<li>过程宏的定义必须放入独立的 lib crate 中</li>
<li>自定义 derive 过程宏<ul>
<li>在当前 crate 根目录下创建一个新的 lib crate 用于编写宏</li>
<li>新的 Cargo.toml 中需要添加
    <div class="highlight"><pre><span></span><code><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a><span class="k">[lib]</span><span class="w"></span>
<a id="__codelineno-171-2" name="__codelineno-171-2" href="#__codelineno-171-2"></a><span class="n">proc-macro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<a id="__codelineno-171-3" name="__codelineno-171-3" href="#__codelineno-171-3"></a>
<a id="__codelineno-171-4" name="__codelineno-171-4" href="#__codelineno-171-4"></a><span class="k">[dependencies]</span><span class="w"></span>
<a id="__codelineno-171-5" name="__codelineno-171-5" href="#__codelineno-171-5"></a><span class="n">syn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="w"></span>
<a id="__codelineno-171-6" name="__codelineno-171-6" href="#__codelineno-171-6"></a><span class="n">quote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="w"></span>
</code></pre></div></li>
<li>lib.rs
    <div class="highlight"><pre><span></span><code><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">proc_macro</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-172-2" name="__codelineno-172-2" href="#__codelineno-172-2"></a>
<a id="__codelineno-172-3" name="__codelineno-172-3" href="#__codelineno-172-3"></a><span class="k">use</span><span class="w"> </span><span class="n">proc_macro</span>::<span class="n">TokenStream</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-172-4" name="__codelineno-172-4" href="#__codelineno-172-4"></a><span class="k">use</span><span class="w"> </span><span class="n">quote</span>::<span class="n">quote</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-172-5" name="__codelineno-172-5" href="#__codelineno-172-5"></a><span class="k">use</span><span class="w"> </span><span class="n">syn</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-172-6" name="__codelineno-172-6" href="#__codelineno-172-6"></a>
<a id="__codelineno-172-7" name="__codelineno-172-7" href="#__codelineno-172-7"></a><span class="cp">#[proc_macro_derive(HelloMacro)]</span><span class="w"></span>
<a id="__codelineno-172-8" name="__codelineno-172-8" href="#__codelineno-172-8"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">hello_macro_derive</span><span class="p">(</span><span class="n">input</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-172-9" name="__codelineno-172-9" href="#__codelineno-172-9"></a><span class="w">    </span><span class="c1">// 基于 input 构建 AST 语法树</span>
<a id="__codelineno-172-10" name="__codelineno-172-10" href="#__codelineno-172-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syn</span>::<span class="n">parse</span><span class="p">(</span><span class="n">input</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-172-11" name="__codelineno-172-11" href="#__codelineno-172-11"></a>
<a id="__codelineno-172-12" name="__codelineno-172-12" href="#__codelineno-172-12"></a><span class="w">    </span><span class="c1">// 构建特征实现代码</span>
<a id="__codelineno-172-13" name="__codelineno-172-13" href="#__codelineno-172-13"></a><span class="w">    </span><span class="n">impl_hello_macro</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ast</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-172-14" name="__codelineno-172-14" href="#__codelineno-172-14"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>impl_hello_macro 函数
    <div class="highlight"><pre><span></span><code><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a><span class="k">fn</span> <span class="nf">impl_hello_macro</span><span class="p">(</span><span class="n">ast</span>: <span class="kp">&amp;</span><span class="nc">syn</span>::<span class="n">DeriveInput</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-173-2" name="__codelineno-173-2" href="#__codelineno-173-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ast</span><span class="p">.</span><span class="n">ident</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-173-3" name="__codelineno-173-3" href="#__codelineno-173-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quote</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-173-4" name="__codelineno-173-4" href="#__codelineno-173-4"></a><span class="w">        </span><span class="k">impl</span><span class="w"> </span><span class="n">HelloMacro</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>#<span class="n">name</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-173-5" name="__codelineno-173-5" href="#__codelineno-173-5"></a><span class="w">            </span><span class="k">fn</span> <span class="nf">hello_macro</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-173-6" name="__codelineno-173-6" href="#__codelineno-173-6"></a><span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello, Macro! My name is {}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="fm">stringify!</span><span class="p">(</span>#<span class="n">name</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-173-7" name="__codelineno-173-7" href="#__codelineno-173-7"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-173-8" name="__codelineno-173-8" href="#__codelineno-173-8"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-173-9" name="__codelineno-173-9" href="#__codelineno-173-9"></a><span class="w">    </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-173-10" name="__codelineno-173-10" href="#__codelineno-173-10"></a><span class="w">    </span><span class="n">gen</span><span class="p">.</span><span class="n">into</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-173-11" name="__codelineno-173-11" href="#__codelineno-173-11"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>读取 ast，使用 quote 生成代码，然后调用 .into 转换成 TokenStream</li>
</ul>
</li>
<li>导入这个 crate 之后就可以使用 <code class="highlight"><span class="cp">#[derive(HelloMacro)]</span><span class="w"></span></code> 生成代码自动实现 HelloMacro 了</li>
</ul>
</li>
<li>类属性宏（attribute-like macros）<ul>
<li>例如修饰一个函数：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a><span class="cp">#[route(GET, </span><span class="s">&quot;/&quot;</span><span class="cp">)]</span><span class="w"></span>
<a id="__codelineno-174-2" name="__codelineno-174-2" href="#__codelineno-174-2"></a><span class="k">fn</span> <span class="nf">index</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>也需要一个独立的 crate 来定义，定义函数：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="cp">#[proc_macro_attribute]</span><span class="w"></span>
<a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">route</span><span class="p">(</span><span class="n">attr</span>: <span class="nc">TokenStream</span><span class="p">,</span><span class="w"> </span><span class="n">item</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-175-3" name="__codelineno-175-3" href="#__codelineno-175-3"></a><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-175-4" name="__codelineno-175-4" href="#__codelineno-175-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>attr 是属性包含的内容，如上例子中的 GET, "/"</li>
<li>item 是标注的项，如上例子中的 fn index() { ... } 即整个函数体</li>
</ul>
</li>
</ul>
</li>
<li>类函数宏<ul>
<li>和声明宏的使用方式类似，但和前两种过程宏的定义方式类似</li>
<li>例如如下调用解析 SQL 语句：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sql</span><span class="o">!</span><span class="p">(</span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">posts</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
</code></pre></div><ul>
<li>需要对 SQL 语句进行解析，macro_rules 难以实现</li>
</ul>
</li>
<li>类函数宏定义形式：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a><span class="cp">#[proc_macro]</span><span class="w"></span>
<a id="__codelineno-177-2" name="__codelineno-177-2" href="#__codelineno-177-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">sql</span><span class="p">(</span><span class="n">input</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-177-3" name="__codelineno-177-3" href="#__codelineno-177-3"></a><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-177-4" name="__codelineno-177-4" href="#__codelineno-177-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>TODO<ul>
<li>过程宏：<a href="https://github.com/dtolnay/proc-macro-workshop">https://github.com/dtolnay/proc-macro-workshop</a>、<a href="https://blog.turbo.fish/">https://blog.turbo.fish/</a></li>
<li>声明宏：<a href="https://veykril.github.io/tlborm/">https://veykril.github.io/tlborm/</a>、<a href="https://zjp-cn.github.io/tlborm/">https://zjp-cn.github.io/tlborm/</a></li>
</ul>
</li>
</ul>
<h2 id="_69">测试<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h2>
<h3 id="_70">断言<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<ul>
<li>assert_eq! 宏用于判断两个表达式的值是否相等<ul>
<li>不相等当前线程会直接 panic</li>
<li>可以从第三个参数开始补充格式化输出额外信息
    <div class="highlight"><pre><span></span><code><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;额外信息：a = {}...&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>assert_ne! 宏类似，不过相等会 panic</li>
<li>assert! 宏用于判断传入的布尔表达式是否为 true，为 false 的话会 panic</li>
<li>debug_assert_eq! debug_assert_ne! debug_assert! 宏用法相同，但是只会在 Debug 模式下运行，例如 cargo run --release 就不会执行这些断言</li>
</ul>
<h3 id="_71">编写测试<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<ul>
<li>rust 只会能 lib crate 进行测试，而无法对 bin crate 测试</li>
<li>单元测试<ul>
<li>定义一个 mod 并标记为 test：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a><span class="cp">#[cfg(test)]</span><span class="w"></span>
<a id="__codelineno-179-2" name="__codelineno-179-2" href="#__codelineno-179-2"></a><span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-179-3" name="__codelineno-179-3" href="#__codelineno-179-3"></a><span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>
<a id="__codelineno-179-4" name="__codelineno-179-4" href="#__codelineno-179-4"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">test1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-179-5" name="__codelineno-179-5" href="#__codelineno-179-5"></a><span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-179-6" name="__codelineno-179-6" href="#__codelineno-179-6"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-179-7" name="__codelineno-179-7" href="#__codelineno-179-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
<li>panic 了则不通过</li>
<li>对于测试函数添加一个 <code class="highlight"><span class="cp">#[should_panic]</span><span class="w"></span></code> 可以标记 panic 为期望结果，不 panic 则不通过<ul>
<li>可以使用 expected 参数来表示期望得到的 panic 字符串
    <div class="highlight"><pre><span></span><code><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a><span class="cp">#[test]</span><span class="w"></span>
<a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a><span class="cp">#[should_panic(expected=</span><span class="s">&quot;...&quot;</span><span class="cp">)]</span><span class="w"></span>
<a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a><span class="k">fn</span> <span class="nf">test2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a><span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<a id="__codelineno-180-5" name="__codelineno-180-5" href="#__codelineno-180-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>可以使用 Result 作为返回值，返回 Err 则不通过，可以这样来实现测试的链式调用，但 <code class="highlight"><span class="cp">#[should_panic]</span><span class="w"></span></code> 在此时将不可用</li>
<li>使用 <code class="highlight"><span class="cp">#[ignore]</span><span class="w"></span></code> 来忽略当前测试<ul>
<li>cargo test 时传入 --ignored 可以执行忽略的测试</li>
</ul>
</li>
</ul>
</li>
<li>集成测试<ul>
<li>tests 目录用来专门存放集成测试，cargo 会从中寻找测试文件，在测试时都会运行</li>
<li>每个文件内部不需要 <code class="highlight"><span class="cp">#[cfg(test)]</span><span class="w"></span></code> 以及不需要创建 mod</li>
<li>cargo test --test name 来仅测试 tests/name.rs 文件</li>
<li>tests 目录下的子目录中的文件不会被当作独立的包也不会有测试输出，可以通过子目录创建模块来存放测试时会使用但不希望被测试的代码</li>
</ul>
</li>
<li>cargo test<ul>
<li>cargo test 执行所有测试<ul>
<li>单元测试、集成测试、文档测试</li>
</ul>
</li>
<li>使用 -- 附加参数<ul>
<li>-- 后加 --test-threads=... 来指定进行测试的线程数</li>
<li>-- 后加 --show-output 来输出标准输出中内容<ul>
<li>默认情况下测试时如果通过则标准输出的内容不会显示出来</li>
</ul>
</li>
<li>-- 后加 --ignored 来仅运行忽略的测试</li>
<li>-- 后加 --no-run 仅编译出测试二进制文件而不运行</li>
</ul>
</li>
<li>运行部分测试<ul>
<li>cargo test name 来运行函数名里包含 name 的测试函数<ul>
<li>模块名也包含在其中，所以可以依此分模块进行测试</li>
</ul>
</li>
</ul>
</li>
<li>Cargo.toml 中加入 [dev-dependencies] 指定仅在 test 时会用到的依赖</li>
<li>cargo test 时会生成可运行测试的二进制文件，保存在 target/debug/deps/ 中</li>
</ul>
</li>
<li>基准测试 benchmark<ul>
<li>官方 benchmark<ul>
<li>只能在非 stable 版本下使用，需要引入特性 <code class="highlight"><span class="cp">#![feature(test)]</span><span class="w"></span></code></li>
<li>和 test 一样写在 <code class="highlight"><span class="cp">#[cfg(test)]</span><span class="w"></span></code> 中，但不标记为 <code class="highlight"><span class="cp">#[test]</span><span class="w"></span></code> 而是 <code class="highlight"><span class="cp">#[bench]</span><span class="w"></span></code>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a><span class="cp">#[bench]</span><span class="w"></span>
<a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a><span class="k">fn</span> <span class="nf">bench_test</span><span class="p">(</span><span class="n">b</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Bencher</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a><span class="w">    </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="o">..</span><span class="p">.);</span><span class="w"></span>
<a id="__codelineno-181-4" name="__codelineno-181-4" href="#__codelineno-181-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div><ul>
<li>初始化代码要写在 iter 之外，否则会多次循环</li>
</ul>
</li>
<li>cargo test 会执行 benchmark 部分但不会有性能测试的输出结果</li>
<li>通过 cargo bench 来执行 benchmark 代码，此时非 bench 的 test 会被 ignore</li>
<li>LLVM 会将没有副作用的函数直接优化删掉，可以使用 test::black_box 来包裹防止被优化，如
    <div class="highlight"><pre><span></span><code><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-182-2" name="__codelineno-182-2" href="#__codelineno-182-2"></a><span class="w">    </span><span class="n">test</span>::<span class="n">black_box</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">test</span>::<span class="n">black_box</span><span class="p">(</span><span class="n">arg</span><span class="p">)));</span><span class="w"></span>
<a id="__codelineno-182-3" name="__codelineno-182-3" href="#__codelineno-182-3"></a><span class="p">})</span><span class="w"></span>
</code></pre></div></li>
</ul>
</li>
<li>使用 criterion.rs（推荐）<ul>
<li>可以有更多的分析信息</li>
<li>官方文档：<a href="https://bheisler.github.io/criterion.rs/book/getting_started.html">https://bheisler.github.io/criterion.rs/book/getting_started.html</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  
    <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2022年8月30日 11:32:57</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2022年8月29日 21:47:20</span>
      
    
  </small>
</div>
  

                  
                    <script src="https://giscus.app/client.js"
                            data-repo="TonyCrane/note"
                            data-repo-id="R_kgDOGnfbUQ"
                            data-category="General"
                            data-category-id="DIC_kwDOGnfbUc4CPrf4"
                            data-mapping="pathname"
                            data-reactions-enabled="1"
                            data-emit-metadata="0"
                            data-input-position="bottom"
                            data-theme="light"
                            data-lang="zh-CN"
                            crossorigin="anonymous"
                            async>
                    </script>
                    <script>
                      if (document.querySelector("body").getAttribute("data-md-color-scheme") === "slate") {
                        var giscus = document.querySelector("script[src*=giscus]")
                        giscus.setAttribute("data-theme", "https://gcore.jsdelivr.net/gh/TonyCrane/note/docs/css/giscus.css") 
                      }
                    </script>
                  
                
              </article>
            </div>
          </div>
          
            <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
              回到页面顶部
            </a>
          
        </main>
        
          <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../" class="md-footer__link md-footer__link--prev" aria-label="上一页: Rust" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Rust
            </div>
          </div>
        </a>
      
      
        
        <a href="../misc/" class="md-footer__link md-footer__link--next" aria-label="下一页: Rust 杂项随记" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Rust 杂项随记
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 <a href="https://github.com/TonyCrane"  target="_blank" rel="noopener">TonyCrane</a>
    </div>
  
  
    Powered by
    <a href="https://www.mkdocs.org/" target="_blank" rel="noopener">
      MkDocs
    </a>
    with theme
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material
    </a>
    modified by
    <a href="https://github.com/TonyCrane" target="_blank" rel="noopener">
      TonyCrane
    </a>
  
</div>
  
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/TonyCrane/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://blog.tonycrane.cc/" target="_blank" rel="noopener" title="blog.tonycrane.cc" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://tonycrane.cc/" target="_blank" rel="noopener" title="tonycrane.cc" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26 96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47 488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
        
      </div>
      <div class="md-dialog" data-md-component="dialog">
        <div class="md-dialog__inner md-typeset"></div>
      </div>
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.annotate", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.361d90f1.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
      
      
        <script src="../../../../assets/javascripts/bundle.289a2a4b.min.js"></script>
        
          <script src="https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
        
          <script src="../../../../js/katex.js"></script>
        
      
    </body>
  </html>
  